<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAFADA | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f7fa; color: #333; -webkit-tap-highlight-color: transparent; }
        
        /* ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏µ‡∏™‡∏ß‡∏¢‡πÜ */
        .thai-card {
            background: linear-gradient(135deg, #00416A 0%, #E4E5E6 100%); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏î‡πâ */
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            box-shadow: 0 15px 35px rgba(38, 208, 206, 0.2);
        }
        
        .glass-panel { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .btn-main { background: linear-gradient(90deg, #1a2980 0%, #26d0ce 100%); color: white; transition: all 0.3s; }
        .btn-main:active { transform: scale(0.95); }
        
        /* Animation */
        .fade-up { animation: fadeUp 0.6s ease-out; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="loader" class="fixed inset-0 z-[999] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-24 h-24 mb-4">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center font-bold text-blue-800 text-xl">F</div>
        </div>
        <p class="text-blue-800 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
        <p class="text-xs text-gray-400 mt-2" id="loadStatus">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>

    <div id="authPage" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-sm fade-up">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-blue-900 mb-2">FAFADA</h1>
                    <p class="text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-xl">
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                        <button onclick="ui.tab('login')" id="btnTLogin" class="flex-1 py-2 rounded-lg font-bold bg-white text-blue-800 shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button onclick="ui.tab('reg')" id="btnTReg" class="flex-1 py-2 rounded-lg font-bold text-gray-400">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                    </div>

                    <form id="fLogin" onsubmit="app.login(event)" class="space-y-4">
                        <input id="lEmail" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                        <input type="password" id="lPass" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                        <button class="w-full btn-main py-3 rounded-xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                    </form>

                    <form id="fReg" onsubmit="app.reg(event)" class="space-y-4 hidden">
                        <input id="rName" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á" required>
                        <input id="rEmail" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                        <input type="password" id="rPass" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" required>
                        <button class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transition">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                        <p class="text-xs text-center text-gray-400">*‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏• farisxuma1@gmail.com ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="mainPage" class="hidden flex-col h-screen overflow-hidden">
        
        <div class="bg-white px-6 py-4 flex justify-between items-center shadow-sm z-20">
            <div class="flex items-center gap-3" onclick="ui.modal('profile')">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold border border-blue-200">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-800 leading-tight" id="navName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                    <p class="text-[10px] text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</p>
                </div>
            </div>
            <button onclick="app.logout()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition">
                <i class="fas fa-power-off"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 pb-24 space-y-6">
            
            <div id="newsAlert" class="hidden bg-white border-l-4 border-yellow-400 p-4 rounded-xl shadow-sm flex items-start gap-3 fade-up">
                <i class="fas fa-bullhorn text-yellow-500 mt-1"></i>
                <div>
                    <h3 id="newsHead" class="font-bold text-sm text-gray-800">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h3>
                    <p id="newsBody" class="text-xs text-gray-500 mt-1">...</p>
                </div>
            </div>

            <div class="thai-card rounded-3xl p-6 text-white relative overflow-hidden h-48 flex flex-col justify-between shadow-2xl transform transition hover:scale-[1.02]">
                <div class="absolute right-0 top-0 p-4 opacity-20"><i class="fas fa-wifi text-3xl rotate-90"></i></div>
                <div>
                    <p class="text-blue-100 text-xs font-medium mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</p>
                    <h1 class="text-4xl font-bold tracking-tight">‡∏ø <span id="uBal">0.00</span></h1>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-blue-200 uppercase">Account ID</p>
                        <p class="font-mono text-sm tracking-widest opacity-90" id="uID">....</p>
                    </div>
                    <div class="bg-white/20 backdrop-blur px-3 py-1 rounded-full text-[10px] border border-white/20">Active</div>
                </div>
            </div>

            <div class="glass-panel p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-wallet text-blue-600"></i> ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                
                <div class="flex bg-gray-100 p-1 rounded-xl mb-4">
                    <button onclick="ui.txnType('deposit')" id="bDep" class="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-blue-700 shadow transition">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button onclick="ui.txnType('withdraw')" id="bWdr" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400 hover:text-red-500 transition">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>

                <div id="bankInfo" class="hidden mb-4 bg-blue-50 border border-blue-100 rounded-xl p-3 animate-pulse">
                    <p class="text-xs font-bold text-blue-800 mb-1">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ:</p>
                    <p id="txtBank" class="text-sm text-blue-600 whitespace-pre-line font-medium">-</p>
                </div>

                <form onsubmit="app.submitTxn(event)">
                    <div class="relative mb-3">
                        <span class="absolute left-4 top-3.5 text-gray-400 font-bold">‡∏ø</span>
                        <input type="number" id="amt" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" step="0.01" min="1" required oninput="app.calc()">
                    </div>
                    
                    <div id="feeBox" class="hidden px-2 mb-4">
                        <div class="flex justify-between text-xs text-red-500 mb-1">
                            <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (<span id="feePc">0</span>%)</span>
                            <span id="feeVal">0</span>
                        </div>
                        <div class="flex justify-between text-sm font-bold text-gray-700 border-t border-dashed border-gray-300 pt-1">
                            <span>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</span>
                            <span id="netVal">0</span>
                        </div>
                    </div>

                    <button id="btnSub" class="w-full btn-main py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </form>
            </div>

            <div class="glass-panel p-6 min-h-[300px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500">Real-time</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <tbody id="tbHist" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="noData" class="hidden py-8 text-center text-gray-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
            </div>

            <a id="linkContact" href="#" target="_blank" class="block w-full bg-white border border-blue-100 text-blue-600 font-bold text-center py-3 rounded-xl shadow-sm hover:bg-blue-50 hidden">
                <i class="fab fa-line text-green-500 mr-1"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
            </a>

        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative fade-up">
            <button onclick="ui.closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            
            <h2 class="text-xl font-bold mb-4 text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-blue-50 rounded-full mx-auto flex items-center justify-center text-3xl text-blue-600 mb-2 border-4 border-white shadow">
                    <i class="fas fa-user"></i>
                </div>
                <p id="pfName" class="font-bold text-lg">...</p>
                <p id="pfEmail" class="text-xs text-gray-500">...</p>
            </div>

            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-4">
                <p class="text-xs font-bold text-orange-700 mb-2"><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</p>
                <form onsubmit="app.saveProfile(event)" class="space-y-3">
                    <input id="inpBank" class="w-full text-xs p-2 border border-orange-200 rounded focus:outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£)" required>
                    <input id="inpAcc" class="w-full text-xs p-2 border border-orange-200 rounded focus:outline-none" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" required>
                    <input id="inpFb" class="w-full text-xs p-2 border border-orange-200 rounded focus:outline-none" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå Facebook/Line" required>
                    <button class="w-full bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-2 rounded shadow transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CONFIG ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419", measurementId: "G-Q73X8Q841W" };
        
        const fb = initializeApp(firebaseConfig);
        const auth = getAuth(fb);
        const db = getFirestore(fb);

        let user = null, userData = null, sysConfig = {}, txnType = 'deposit';

        // --- UI CONTROLLER ---
        window.ui = {
            tab: (t) => {
                if(t==='login'){ 
                    document.getElementById('fLogin').classList.remove('hidden'); document.getElementById('fReg').classList.add('hidden'); 
                    document.getElementById('btnTLogin').className="flex-1 py-2 rounded-lg font-bold bg-white text-blue-800 shadow transition";
                    document.getElementById('btnTReg').className="flex-1 py-2 rounded-lg font-bold text-gray-400 transition";
                } else {
                    document.getElementById('fLogin').classList.add('hidden'); document.getElementById('fReg').classList.remove('hidden');
                    document.getElementById('btnTReg').className="flex-1 py-2 rounded-lg font-bold bg-green-500 text-white shadow transition";
                    document.getElementById('btnTLogin').className="flex-1 py-2 rounded-lg font-bold text-gray-400 transition";
                }
            },
            txnType: (t) => {
                txnType = t;
                const bD=document.getElementById('bDep'), bW=document.getElementById('bWdr'), fee=document.getElementById('feeBox'), bnk=document.getElementById('bankInfo'), sub=document.getElementById('btnSub');
                if(t==='deposit'){
                    bD.className="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-blue-700 shadow transition transform scale-105";
                    bW.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400 hover:text-red-500 transition opacity-70";
                    fee.classList.add('hidden'); bnk.classList.remove('hidden');
                    sub.innerHTML='<i class="fas fa-arrow-down"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'; sub.className="w-full btn-main py-3.5 rounded-xl font-bold shadow-lg transition";
                } else {
                    bW.className="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-red-600 shadow transition transform scale-105";
                    bD.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400 hover:text-blue-500 transition opacity-70";
                    fee.classList.remove('hidden'); bnk.classList.add('hidden');
                    sub.innerHTML='<i class="fas fa-paper-plane"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'; sub.className="w-full bg-red-500 hover:bg-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg transition";
                }
                app.calc();
            },
            modal: (m) => document.getElementById('modal').classList.remove('hidden'),
            closeModal: () => document.getElementById('modal').classList.add('hidden'),
            showPage: (p) => {
                document.getElementById('loader').classList.add('hidden');
                if(p==='auth'){ document.getElementById('authPage').classList.remove('hidden'); document.getElementById('mainPage').classList.add('hidden'); }
                else { document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainPage').classList.remove('hidden'); }
            }
        };

        // --- APP LOGIC ---
        window.app = {
            login: async(e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); }catch(err){ Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); } },
            reg: async(e)=>{ e.preventDefault(); const n=document.getElementById('rName').value, em=document.getElementById('rEmail').value, pw=document.getElementById('rPass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,pw); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:em,displayName:n,role:em==='farisxuma1@gmail.com'?'admin':'user',balance:0,createdAt:new Date(),bankName:'',bankAcc:'',contactLink:''}); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); }catch(err){ Swal.fire('Error',err.message,'error'); } },
            logout: ()=>Swal.fire({title:'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',showCancelButton:true}).then(r=>{if(r.isConfirmed)signOut(auth).then(()=>location.reload())}),
            
            calc: ()=>{
                const v = parseFloat(document.getElementById('amt').value)||0;
                if(txnType==='withdraw'){
                    const pc = sysConfig.feePercent || 5;
                    const fee = v*(pc/100);
                    document.getElementById('feePc').innerText = pc;
                    document.getElementById('feeVal').innerText = '-'+fee.toLocaleString();
                    document.getElementById('netVal').innerText = (v-fee).toLocaleString();
                }
            },

            submitTxn: async(e)=>{
                e.preventDefault(); const v=parseFloat(document.getElementById('amt').value);
                if(v<=0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warning');
                
                if(txnType==='withdraw'){
                    if(v > userData.balance) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô','error');
                    if(!userData.bankAcc || !userData.contactLink) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô','warning').then(()=>ui.modal('profile'));
                }

                try {
                    Swal.showLoading();
                    const fee = txnType==='withdraw' ? v*((sysConfig.feePercent||5)/100) : 0;
                    await addDoc(collection(db,"transactions"), {
                        uid:user.uid, email:userData.email, userDisplayName:userData.displayName,
                        userBank:(userData.bankName||'')+' '+(userData.bankAcc||''), userFb:userData.contactLink||'',
                        type:txnType, amount:v, fee:fee, netAmount:v-fee, status:'pending', timestamp:new Date()
                    });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö','success');
                    document.getElementById('amt').value=''; app.calc();
                }catch(err){ Swal.fire('Error',err.message,'error'); }
            },

            saveProfile: async(e)=>{
                e.preventDefault();
                try{
                    await updateDoc(doc(db,"users",user.uid),{ bankName:document.getElementById('inpBank').value, bankAcc:document.getElementById('inpAcc').value, contactLink:document.getElementById('inpFb').value });
                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success'); ui.closeModal();
                }catch(err){ Swal.fire('Error','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
            }
        };

        // --- INIT & REALTIME (‡πÅ‡∏Å‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πâ‡∏≤‡∏á) ---
        
        // 1. Force Unlock Timout (‡∏ñ‡πâ‡∏≤ Firebase ‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÄ‡∏•‡∏¢ ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á)
        setTimeout(() => {
            const l = document.getElementById('loader');
            if(!l.classList.contains('hidden')){
                document.getElementById('loadStatus').innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥...";
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ User ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Auth state ‡∏Ñ‡πâ‡∏≤‡∏á
                if(!user) { ui.showPage('auth'); }
            }
        }, 5000);

        onAuthStateChanged(auth, u => {
            if(u) {
                user = u;
                // Load User Data
                onSnapshot(doc(db,"users",u.uid), s=>{
                    if(s.exists()){ 
                        userData=s.data(); 
                        document.getElementById('navName').innerText=userData.displayName;
                        document.getElementById('uBal').innerText=userData.balance.toLocaleString('th-TH',{minimumFractionDigits:2});
                        document.getElementById('uID').innerText=u.uid.slice(0,4)+"  **** "+u.uid.slice(-4);
                        // Profile Data
                        document.getElementById('pfName').innerText=userData.displayName;
                        document.getElementById('pfEmail').innerText=userData.email;
                        document.getElementById('inpBank').value=userData.bankName||'';
                        document.getElementById('inpAcc').value=userData.bankAcc||'';
                        document.getElementById('inpFb').value=userData.contactLink||'';
                        ui.showPage('main');
                    }
                });

                // Load Config
                onSnapshot(doc(db,"system","config"), s=>{
                    if(s.exists()){
                        sysConfig=s.data();
                        document.getElementById('txtBank').innerText = sysConfig.adminBank || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
                        const btn = document.getElementById('linkContact');
                        if(sysConfig.contactLink){ btn.href=sysConfig.contactLink; btn.classList.remove('hidden'); }
                    }
                });

                // Load History (Client Sort ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Index ‡∏Ñ‡πâ‡∏≤‡∏á)
                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid)), s=>{
                    let l=[]; s.forEach(d=>l.push(d.data())); l.sort((a,b)=>b.timestamp-a.timestamp);
                    const tb=document.getElementById('tbHist'); tb.innerHTML='';
                    if(l.length===0) document.getElementById('noData').classList.remove('hidden');
                    else document.getElementById('noData').classList.add('hidden');

                    l.forEach(x=>{
                        const isD=x.type==='deposit', c=isD?'text-green-600':'text-red-600';
                        const st=x.status==='pending'?'<span class="text-yellow-600 bg-yellow-100 px-2 rounded-lg text-xs">‡∏£‡∏≠</span>':(x.status==='completed'?'<span class="text-green-600 bg-green-100 px-2 rounded-lg text-xs">‡πÄ‡∏™‡∏£‡πá‡∏à</span>':'<span class="text-red-600 bg-red-100 px-2 rounded-lg text-xs">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>');
                        tb.innerHTML+=`
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-4">
                                <div class="font-bold text-gray-700">${isD?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'}</div>
                                <div class="text-[10px] text-gray-400">${new Date(x.timestamp.seconds*1000).toLocaleString('th-TH')}</div>
                            </td>
                            <td class="p-4 text-right font-bold ${c}">${isD?'+':'-'}${x.amount.toLocaleString()}</td>
                            <td class="p-4 text-right">${st}</td>
                        </tr>`;
                    });
                });

                // Load News
                onSnapshot(query(collection(db,"announcements"), orderBy("createdAt","desc"), limit(1)), s=>{
                    if(!s.empty){
                        const n=s.docs[0].data();
                        document.getElementById('newsAlert').classList.remove('hidden');
                        document.getElementById('newsHead').innerText=n.title;
                        document.getElementById('newsBody').innerText=n.content;
                    }
                });

            } else { ui.showPage('auth'); }
        });
    </script>
</body>
</html>
