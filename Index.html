<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA Wallet - เข้าสู่ระบบ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style> body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; } </style>
</head>
<body class="text-slate-800">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 animate-pulse">กำลังโหลดข้อมูล FAFADA...</p>
    </div>

    <div id="authSection" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden">
            <div class="flex">
                <button onclick="toggleAuth('login')" id="tabLogin" class="flex-1 py-4 font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-600">เข้าสู่ระบบ</button>
                <button onclick="toggleAuth('register')" id="tabRegister" class="flex-1 py-4 font-bold text-slate-400 hover:bg-slate-50">สมัครสมาชิก</button>
            </div>
            
            <div class="p-8">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <h2 class="text-2xl font-bold mb-2">ยินดีต้อนรับ</h2>
                    <p class="text-slate-500 mb-6 text-sm">จัดการธุรกรรมของคุณได้อย่างปลอดภัย</p>
                    <input type="email" id="loginEmail" placeholder="อีเมล" class="w-full mb-4 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="loginPass" placeholder="รหัสผ่าน" class="w-full mb-6 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">เข้าสู่ระบบ</button>
                </form>

                <form id="registerForm" onsubmit="handleRegister(event)" class="hidden">
                    <h2 class="text-2xl font-bold mb-2">สร้างบัญชีใหม่</h2>
                    <p class="text-slate-500 mb-6 text-sm">เริ่มต้นใช้งานกระเป๋าเงินออนไลน์</p>
                    <input type="text" id="regName" placeholder="ชื่อที่แสดง (Display Name)" class="w-full mb-4 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <input type="email" id="regEmail" placeholder="อีเมล" class="w-full mb-4 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <input type="password" id="regPass" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)" class="w-full mb-6 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">สมัครสมาชิก</button>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboardSection" class="min-h-screen hidden">
        <nav class="bg-white shadow sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
                <span class="text-xl font-bold text-blue-800 tracking-wider">FAFADA</span>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="navName" class="font-bold text-sm">User</div>
                        <div id="navEmail" class="text-xs text-slate-500">email@example.com</div>
                    </div>
                    <button onclick="handleLogout()" class="text-slate-500 hover:text-red-500"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-4 py-8">
            <div id="newsBox" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 hidden rounded-r-lg">
                <div class="flex items-start">
                    <i class="fas fa-bullhorn text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <h4 id="newsTitle" class="font-bold text-yellow-800">ประกาศ</h4>
                        <p id="newsContent" class="text-sm text-yellow-700 mt-1"></p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white shadow-lg mb-8 relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white opacity-10"><i class="fas fa-wallet fa-8x"></i></div>
                <p class="text-blue-200 mb-1">ยอดเงินคงเหลือสุทธิ</p>
                <h1 class="text-5xl font-bold mb-4">฿ <span id="userBalance">0.00</span></h1>
                <div class="inline-flex items-center bg-white/20 px-3 py-1 rounded-full text-xs backdrop-blur-sm">
                    <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span> สถานะปกติ (Active)
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md h-fit">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">ทำรายการ</h3>
                    
                    <div class="flex bg-slate-100 p-1 rounded-lg mb-6">
                        <button onclick="setTxnType('deposit')" id="btnDep" class="flex-1 py-2 rounded font-bold text-sm bg-white shadow text-green-600 transition">ฝากเงิน</button>
                        <button onclick="setTxnType('withdraw')" id="btnWdr" class="flex-1 py-2 rounded font-bold text-sm text-slate-500 hover:text-red-600 transition">ถอนเงิน</button>
                    </div>

                    <form onsubmit="submitTransaction(event)">
                        <label class="block text-sm font-medium text-slate-600 mb-2">ระบุจำนวนเงิน</label>
                        <div class="relative mb-4">
                            <span class="absolute left-3 top-2.5 text-slate-400">฿</span>
                            <input type="number" id="txnAmount" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="0.00" step="0.01" min="1" required oninput="calcFee()">
                        </div>

                        <div id="feeInfo" class="hidden bg-red-50 p-3 rounded border border-red-100 mb-4 text-sm">
                            <div class="flex justify-between text-red-500 mb-1"><span>หักค่าธรรมเนียม (5%)</span><span id="txtFee">0.00</span></div>
                            <div class="flex justify-between font-bold text-slate-800 pt-1 border-t border-red-200"><span>จะได้รับสุทธิ</span><span id="txtNet">0.00</span></div>
                        </div>

                        <button type="submit" id="btnSubmit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">ยืนยันการฝากเงิน</button>
                    </form>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">ประวัติธุรกรรมล่าสุด</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">ประเภท</th>
                                    <th class="px-4 py-3">วันที่</th>
                                    <th class="px-4 py-3 text-right">จำนวน</th>
                                    <th class="px-4 py-3 text-center">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="text-sm divide-y divide-slate-100">
                                </tbody>
                        </table>
                        <div id="noHistory" class="text-center py-8 text-slate-400 hidden">ไม่มีรายการ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.firebasestorage.app",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419",
            measurementId: "G-Q73X8Q841W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let txnType = 'deposit';

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const unsub = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        
                        // ถ้าเป็น Admin ให้ไล่ไปหน้า admin.html
                        if (userData.role === 'admin') {
                            window.location.href = 'admin.html';
                            return;
                        }

                        renderDashboard();
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('dashboardSection').classList.remove('hidden');
                    }
                    document.getElementById('loader').classList.add('hidden');
                });
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // UI Functions
        function renderDashboard() {
            document.getElementById('navName').textContent = userData.displayName;
            document.getElementById('navEmail').textContent = userData.email;
            document.getElementById('userBalance').textContent = userData.balance.toLocaleString('th-TH', {minimumFractionDigits: 2});
            
            loadHistory();
            loadNews();
        }

        window.toggleAuth = (mode) => {
            if(mode === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-600";
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-slate-400 hover:bg-slate-50";
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-green-600 bg-green-50 border-b-2 border-green-600";
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-slate-400 hover:bg-slate-50";
            }
        }

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch(err) { alert("Login Failed: " + err.message); }
        }

        window.handleRegister = async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const role = email === 'farisxuma1@gmail.com' ? 'admin' : 'user';
                await setDoc(doc(db, "users", res.user.uid), {
                    uid: res.user.uid, email, displayName: name, role, balance: 0, createdAt: new Date()
                });
                alert("สมัครสมาชิกสำเร็จ!");
            } catch(err) { alert("Error: " + err.message); }
        }

        window.handleLogout = () => signOut(auth);

        // Transaction Logic
        window.setTxnType = (type) => {
            txnType = type;
            const btnDep = document.getElementById('btnDep');
            const btnWdr = document.getElementById('btnWdr');
            const btnSubmit = document.getElementById('btnSubmit');
            const feeInfo = document.getElementById('feeInfo');

            if(type === 'deposit') {
                btnDep.className = "flex-1 py-2 rounded font-bold text-sm bg-white shadow text-green-600 transition";
                btnWdr.className = "flex-1 py-2 rounded font-bold text-sm text-slate-500 hover:text-red-600 transition";
                btnSubmit.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition";
                btnSubmit.textContent = "ยืนยันการฝากเงิน";
                feeInfo.classList.add('hidden');
            } else {
                btnWdr.className = "flex-1 py-2 rounded font-bold text-sm bg-white shadow text-red-600 transition";
                btnDep.className = "flex-1 py-2 rounded font-bold text-sm text-slate-500 hover:text-green-600 transition";
                btnSubmit.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition";
                btnSubmit.textContent = "ยืนยันการถอนเงิน";
                feeInfo.classList.remove('hidden');
            }
            calcFee();
        }

        window.calcFee = () => {
            const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
            if(txnType === 'withdraw') {
                const fee = amount * 0.05;
                document.getElementById('txtFee').textContent = fee.toLocaleString();
                document.getElementById('txtNet').textContent = (amount - fee).toLocaleString();
            }
        }

        window.submitTransaction = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('txnAmount').value);
            if(amount <= 0) return alert("ยอดเงินต้องมากกว่า 0");
            if(txnType === 'withdraw' && amount > userData.balance) return alert("เงินไม่พอ");

            let fee = txnType === 'withdraw' ? amount * 0.05 : 0;

            try {
                await addDoc(collection(db, "transactions"), {
                    uid: currentUser.uid,
                    email: userData.email,
                    userDisplayName: userData.displayName,
                    type: txnType,
                    amount: amount,
                    fee: fee,
                    netAmount: amount - fee,
                    status: 'pending',
                    timestamp: new Date()
                });
                alert("ส่งคำขอเรียบร้อย");
                document.getElementById('txnAmount').value = "";
                calcFee();
            } catch(err) { alert(err.message); }
        }

        // Load History
        function loadHistory() {
            const q = query(collection(db, "transactions"), where("uid", "==", currentUser.uid), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = "";
                if(snapshot.empty) {
                    document.getElementById('noHistory').classList.remove('hidden');
                } else {
                    document.getElementById('noHistory').classList.add('hidden');
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const color = t.type === 'deposit' ? 'text-green-600' : 'text-red-600';
                        const sign = t.type === 'deposit' ? '+' : '-';
                        let statusHtml = '';
                        if(t.status === 'pending') statusHtml = '<span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs">รออนุมัติ</span>';
                        else if(t.status === 'completed') statusHtml = '<span class="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs">สำเร็จ</span>';
                        else statusHtml = '<span class="px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs">ปฏิเสธ</span>';

                        const tr = `
                            <tr class="hover:bg-slate-50">
                                <td class="px-4 py-3 font-bold ${color}">${t.type === 'deposit' ? 'ฝาก' : 'ถอน'}</td>
                                <td class="px-4 py-3 text-slate-500">${new Date(t.timestamp.seconds*1000).toLocaleDateString('th-TH')}</td>
                                <td class="px-4 py-3 text-right font-mono font-bold ${color}">${sign}${t.amount.toLocaleString()}</td>
                                <td class="px-4 py-3 text-center">${statusHtml}</td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    });
                }
            });
        }

        async function loadNews() {
            const q = query(collection(db, "announcements"), orderBy("createdAt", "desc"));
            const snaps = await getDocs(q);
            if(!snaps.empty) {
                const news = snaps.docs[0].data();
                document.getElementById('newsBox').classList.remove('hidden');
                document.getElementById('newsTitle').textContent = news.title;
                document.getElementById('newsContent').textContent = news.content;
            }
        }
    </script>
</body>
</html>
