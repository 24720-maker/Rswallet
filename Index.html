<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITANIUM ARENA - NEXT GEN</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Prompt:wght@200;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #D4AF37; --primary: #6366f1; --bg: #050b14; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); color: #e2e8f0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-display { font-family: 'Outfit', sans-serif; }
        
        /* GLASS UI */
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; }
        .btn-gold { background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%); color: #000; font-weight: 800; border-radius: 16px; transition: 0.2s; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .btn-gold:active { transform: scale(0.96); }
        
        .input-cyber { background: rgba(0, 0, 0, 0.4); border: 1px solid #334155; padding: 14px; border-radius: 16px; color: white; outline: none; transition: 0.3s; width: 100%; }
        .input-cyber:focus { border-color: var(--gold); }

        /* GAME UI */
        .rps-item { width: 85px; height: 85px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; transition: 0.3s; }
        .rps-item.selected { border-color: var(--gold); background: rgba(212, 175, 55, 0.2); box-shadow: 0 0 20px var(--gold); transform: scale(1.1); }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 0.65rem; font-weight: bold; }
        .nav-item.active { color: var(--gold); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }

        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .ready-badge { padding: 4px 12px; border-radius: 99px; font-size: 0.7rem; font-weight: 800; }
        .is-ready { background: #10b981; color: #fff; }
        .not-ready { background: #334155; color: #94a3b8; }
    </style>
</head>
<body class="pb-24">

    <div id="loader"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-[#D4AF37]"></i></div>

    <div id="view-auth" class="fixed inset-0 z-[100] bg-[#020617] flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm glass-card p-8 animate__animated animate__fadeIn">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black font-display text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-700">ZONE.</h1>
                <p class="text-slate-500 text-xs tracking-[0.4em] uppercase mt-2">Premium Gaming Arena</p>
            </div>
            <div id="login-form" class="space-y-4">
                <input id="l-email" class="input-cyber text-center" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                <input id="l-pass" type="password" class="input-cyber text-center" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button onclick="Auth.login()" class="btn-gold w-full py-4 text-lg mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏±‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
                <button onclick="UI.toggleAuth('reg')" class="w-full text-slate-500 text-xs mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
            <div id="reg-form" class="hidden space-y-4">
                <input id="r-name" class="input-cyber" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡πÄ‡∏Å‡∏°">
                <input id="r-email" class="input-cyber" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                <input id="r-pass" type="password" class="input-cyber" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button onclick="Auth.reg()" class="btn-gold w-full py-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
                <button onclick="UI.toggleAuth('log')" class="w-full text-slate-500 text-xs mt-4">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden max-w-md mx-auto min-h-screen">
        <nav class="sticky top-0 z-40 bg-[#050b14]/90 backdrop-blur-xl border-b border-white/5 p-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500 to-yellow-700 flex items-center justify-center font-bold text-black text-xl shadow-lg">Z</div>
                <div>
                    <p id="u-name" class="font-bold text-sm leading-none mb-1">Guest</p>
                    <p class="text-[10px] text-emerald-400 font-bold tracking-wider">‚óè ONLINE</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[9px] text-slate-500 font-bold tracking-widest uppercase">Credits</p>
                <p class="font-display text-xl font-bold text-yellow-400 leading-none">‡∏ø<span id="u-credit">0</span></p>
            </div>
        </nav>

        <main class="p-5 space-y-6">
            <section id="p-lobby" class="animate__animated animate__fadeIn space-y-6">
                <div class="glass-card p-5 border-l-4 border-yellow-500 relative overflow-hidden">
                    <h2 class="text-2xl font-black italic relative z-10">BATTLE LOBBY</h2>
                    <p class="text-slate-400 text-xs relative z-10">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                    <i class="fa-solid fa-bolt-lightning absolute -right-4 -bottom-4 text-7xl text-yellow-500/10"></i>
                </div>

                <div class="glass-card p-4 flex gap-2 border-dashed border-2 border-white/10">
                    <input id="gift-code" class="bg-transparent w-full outline-none text-yellow-500 font-bold tracking-widest" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ">
                    <button onclick="Wallet.redeem()" class="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold text-xs">‡∏£‡∏±‡∏ö</button>
                </div>

                <div id="room-list" class="grid gap-4 pb-20">
                    </div>
            </section>

            <section id="p-game" class="hidden min-h-[75vh] flex flex-col animate__animated animate__fadeIn">
                <div class="glass-card p-4 flex justify-between items-center mb-8">
                    <div class="text-center w-1/3">
                        <p id="p1-name" class="text-[10px] text-slate-500 font-bold mb-1 truncate px-2">ME</p>
                        <div id="p1-ready-badge" class="ready-badge not-ready mx-auto w-max mb-2">‡∏£‡∏≠</div>
                        <p id="p1-score" class="text-4xl font-display font-black text-white">0</p>
                    </div>
                    <div class="text-2xl font-black text-slate-700 italic">VS</div>
                    <div class="text-center w-1/3">
                        <p id="p2-name" class="text-[10px] text-slate-500 font-bold mb-1 truncate px-2">ENEMY</p>
                        <div id="p2-ready-badge" class="ready-badge not-ready mx-auto w-max mb-2">‡∏£‡∏≠</div>
                        <p id="p2-score" class="text-4xl font-display font-black text-white">0</p>
                    </div>
                </div>

                <div class="flex-1 flex flex-col justify-center items-center">
                    <div id="g-status-text" class="text-2xl font-bold text-yellow-500 animate-pulse mb-8">‡∏£‡∏≠‡∏Å‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°...</div>
                    
                    <button id="btn-ready" onclick="Game.setReady()" class="btn-gold px-12 py-4 text-xl shadow-2xl animate__animated animate__pulse animate__infinite">I'M READY!</button>

                    <div id="g-controls" class="hidden grid grid-cols-3 gap-6 animate__animated animate__fadeInUp">
                        <div onclick="Game.play('rock')" id="btn-rock" class="rps-item text-blue-400">‚úä</div>
                        <div onclick="Game.play('paper')" id="btn-paper" class="rps-item text-yellow-400">‚úã</div>
                        <div onclick="Game.play('scissors')" id="btn-scissors" class="rps-item text-pink-400">‚úåÔ∏è</div>
                    </div>

                    <div id="g-result-moves" class="hidden flex gap-10 text-6xl animate__animated animate__bounceIn">
                        <div id="m-p1">‚úä</div>
                        <div id="m-p2">‚úã</div>
                    </div>
                </div>

                <button onclick="Game.leave()" class="mt-auto text-xs text-slate-600 hover:text-red-500 transition"><i class="fa-solid fa-arrow-left"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            </section>

            <section id="p-finance" class="hidden space-y-6 animate__animated animate__fadeIn">
                <div class="flex gap-2 p-1 bg-slate-900 rounded-2xl">
                    <button onclick="UI.tabFin('dep')" id="t-dep" class="flex-1 py-3 rounded-xl font-bold text-sm bg-yellow-500 text-black">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button onclick="UI.tabFin('wit')" id="t-wit" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-500">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>

                <div id="fin-dep" class="glass-card p-6 space-y-4">
                    <div class="bg-yellow-500/10 p-3 rounded-xl border border-yellow-500/20 text-[10px] text-yellow-500 text-center font-bold">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏™‡∏•‡∏¥‡∏õ</div>
                    <div id="admin-banks" class="space-y-2"></div>
                    <input id="dep-amt" type="number" class="input-cyber text-center text-3xl font-display" placeholder="0.00">
                    <input id="dep-time" class="input-cyber text-center" placeholder="‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 14.30)">
                    <button onclick="Wallet.submit('deposit')" class="btn-gold w-full py-4 text-lg mt-4">‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
                </div>

                <div id="fin-wit" class="hidden glass-card p-8 text-center space-y-4">
                    <p class="text-xs text-slate-500 uppercase tracking-widest">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</p>
                    <h2 class="text-5xl font-display font-bold" id="wit-max">0.00</h2>
                    <input id="wit-amt" type="number" class="input-cyber text-center text-3xl mt-6" placeholder="0">
                    <button onclick="Wallet.submit('withdraw')" class="btn-gold w-full py-4 text-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô</button>
                </div>
            </section>

            <section id="p-profile" class="hidden space-y-6 animate__animated animate__fadeIn">
                <div class="glass-card p-6 space-y-4">
                    <h3 class="text-lg font-bold text-yellow-500 border-b border-white/5 pb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                    <div><label class="text-[10px] text-slate-500 font-bold ml-1">DISPLAY NAME</label><input id="pf-name" class="input-cyber mt-1"></div>
                    <div><label class="text-[10px] text-slate-500 font-bold ml-1">FACEBOOK LINK</label><input id="pf-fb" class="input-cyber mt-1" placeholder="facebook.com/username"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] text-slate-500 font-bold ml-1">BANK NAME</label><input id="pf-bank" class="input-cyber mt-1" placeholder="KBANK"></div>
                        <div><label class="text-[10px] text-slate-500 font-bold ml-1">ACCOUNT NO.</label><input id="pf-acc" class="input-cyber mt-1" placeholder="xxx-x-xxxxx-x"></div>
                    </div>
                    <button onclick="User.save()" class="btn-gold w-full py-4 mt-2">SAVE CHANGES</button>
                </div>
                <button onclick="Auth.logout()" class="w-full py-4 bg-red-900/20 text-red-500 rounded-2xl border border-red-500/20 font-bold text-sm">LOGOUT</button>
            </section>
        </main>

        <nav class="bottom-nav">
            <div onclick="UI.page('lobby')" id="nav-lobby" class="nav-item active"><i class="fa-solid fa-gamepad"></i><span>‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ</span></div>
            <div onclick="UI.page('wallet')" id="nav-wallet" class="nav-item"><i class="fa-solid fa-wallet"></i><span>‡∏ù‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô</span></div>
            <div onclick="UI.page('profile')" id="nav-profile" class="nav-item"><i class="fa-solid fa-user-circle"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
            <div onclick="UI.contact()" class="nav-item"><i class="fa-brands fa-line text-emerald-400"></i><span>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span></div>
        </nav>
    </div>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let user = null, userData = {}, config = {}, curRoomId = null;

        // --- 2. AUTH ---
        auth.onAuthStateChanged(u => {
            document.getElementById('loader').style.display='none';
            if(u) {
                user = u;
                document.getElementById('view-auth').style.display='none';
                document.getElementById('view-app').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('view-auth').style.display='flex';
                document.getElementById('view-app').classList.add('hidden');
            }
        });

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e => Swal.fire('Error', e.message, 'error')),
            reg: () => {
                const n=document.getElementById('r-name').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
                if(!n||!e||p.length<6) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
                auth.createUserWithEmailAndPassword(e, p).then(c => db.ref('users/'+c.user.uid).set({name:n, email:e, balance:0, bank:'-', acc:'-', fb_link:''})).catch(e => Swal.fire('Error', e.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        // --- 3. SYSTEM CORE ---
        const App = {
            init: () => {
                // User Listener
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    const b = userData.balance || 0;
                    document.getElementById('u-balance').innerText = b.toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('wit-max').innerText = b.toLocaleString();
                    document.getElementById('u-name').innerText = userData.name;
                    document.getElementById('u-avatar').src = `https://ui-avatars.com/api/?name=${userData.name}&background=D4AF37&color=000&bold=true`;
                    document.getElementById('pf-name').value = userData.name;
                    document.getElementById('pf-fb').value = userData.fb_link;
                    document.getElementById('pf-bank').value = userData.bank;
                    document.getElementById('pf-acc').value = userData.acc;
                });

                // Config Listener
                db.ref('settings').on('value', s => {
                    config = s.val() || {};
                    const bArea = document.getElementById('admin-banks'); bArea.innerHTML='';
                    if(config.banks) Object.values(config.banks).forEach(b => {
                        bArea.innerHTML += `<div class="bg-black/40 p-3 rounded-xl border border-white/5 flex justify-between items-center text-xs"><div><b>${b.name}</b><br><span class="text-yellow-500 font-bold">${b.acc}</span></div><button onclick="UI.copy('${b.acc}')" class="text-[9px] bg-slate-800 px-2 py-1 rounded">COPY</button></div>`;
                    });
                });

                // Lobby Listener
                db.ref('rooms').on('value', s => {
                    const list = document.getElementById('room-list'); list.innerHTML = '';
                    s.forEach(doc => {
                        const r = doc.val();
                        if(r.status === 'open' || r.status === 'waiting') {
                            list.innerHTML += `<div class="glass-card p-5 animate__animated animate__fadeInUp flex justify-between items-center"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center text-2xl border border-white/5">üéÆ</div><div><h4 class="font-bold text-white text-sm">${r.name}</h4><p class="text-[10px] text-yellow-500 font-bold">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: ‡∏ø${r.bet}</p></div></div><button onclick="Game.join('${doc.key}', ${r.bet})" class="btn-gold px-6 py-2 text-xs shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button></div>`;
                        }
                    });
                });
            }
        };

        const Game = {
            join: async (rid, bet) => {
                if(userData.balance < bet) return Swal.fire('Error', '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
                db.ref('rooms/'+rid).transaction(r => {
                    if(r) {
                        if(!r.p1) { r.p1 = { uid: user.uid, name: userData.name, ready: false, score: 0, move: '' }; r.status = 'waiting'; return r; }
                        else if(!r.p2 && r.p1.uid !== user.uid) { r.p2 = { uid: user.uid, name: userData.name, ready: false, score: 0, move: '' }; r.status = 'waiting'; return r; }
                    }
                    return;
                }, (err, com) => {
                    if(com) {
                        db.ref('users/'+user.uid).update({ balance: userData.balance - bet });
                        Game.enter(rid);
                    } else Swal.fire('‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß', '', 'warning');
                });
            },
            enter: (rid) => {
                curRoomId = rid; UI.page('game');
                db.ref('rooms/'+rid).on('value', s => {
                    const r = s.val();
                    if(!r) { Game.quit(true); return; }
                    
                    document.getElementById('g-room-name').innerText = r.name;
                    document.getElementById('g-bet').innerText = `‡∏ø${r.bet * 2}`;
                    document.getElementById('g-round-curr').innerText = r.round;
                    
                    const me = r.p1 && r.p1.uid === user.uid ? 'p1' : 'p2';
                    const opp = me === 'p1' ? 'p2' : 'p1';
                    
                    document.getElementById('p1-score').innerText = r.p1?.score || 0;
                    document.getElementById('p2-score').innerText = r.p2?.score || 0;
                    if(r[opp]) document.getElementById('p2-name').innerText = r[opp].name;

                    const setBadge = (id, rd) => { 
                        const el = document.getElementById(id);
                        el.innerText = rd ? '‡∏û‡∏£‡πâ‡∏≠‡∏°' : '‡∏£‡∏≠...';
                        el.className = `ready-badge ${rd ? 'is-ready' : 'not-ready'} mx-auto w-max mb-2`;
                    };
                    setBadge('p1-ready-badge', r[me]?.ready);
                    setBadge('p2-ready-badge', r[opp]?.ready);

                    const st = document.getElementById('g-status');
                    const btnRdy = document.getElementById('btn-ready');
                    const ctrl = document.getElementById('g-controls');
                    const res = document.getElementById('g-result-moves');

                    if(r.status === 'waiting') {
                        res.classList.add('hidden');
                        if(!r[me].ready) { st.innerText = "‡∏£‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°"; btnRdy.classList.remove('hidden'); }
                        else { st.innerText = "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°..."; btnRdy.classList.add('hidden'); }
                        ctrl.classList.add('hidden');
                    } else if(r.status === 'playing') {
                        btnRdy.classList.add('hidden'); res.classList.add('hidden');
                        ctrl.classList.remove('hidden');
                        if(!r[me].move) { st.innerText = "‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò!"; ctrl.style.opacity = 1; ctrl.style.pointerEvents = 'auto'; }
                        else { st.innerText = "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..."; ctrl.style.opacity = 0.3; ctrl.style.pointerEvents = 'none'; }
                    } else if(r.status === 'calculating') {
                        st.innerText = "‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏∞‡∏ó‡∏∂‡∏Å!";
                        const map = {rock:'‚úä', paper:'‚úã', scissors:'‚úåÔ∏è'};
                        document.getElementById('m-p1').innerText = map[r[me].move];
                        document.getElementById('m-p2').innerText = map[r[opp].move];
                        res.classList.remove('hidden');
                    } else if(r.status === 'finished') {
                        const win = r.winner === user.uid ? '‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞! ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : (r.winner === 'draw' ? '‡πÄ‡∏™‡∏°‡∏≠! ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                        Swal.fire({ title: '‡∏à‡∏ö‡πÄ‡∏Å‡∏°', text: win, icon: r.winner === user.uid ? 'success' : 'info' }).then(() => Game.quit());
                    }
                });
            },
            setReady: () => {
                db.ref(`rooms/${curRoomId}`).transaction(r => {
                    if(r) {
                        const me = r.p1.uid === user.uid ? 'p1' : 'p2';
                        r[me].ready = true;
                        if(r.p1.ready && r.p2?.ready) r.status = 'playing';
                    }
                    return r;
                });
            },
            play: (m) => {
                document.querySelectorAll('.rps-item').forEach(e => e.classList.remove('selected'));
                document.getElementById('btn-'+m).classList.add('selected');
                db.ref(`rooms/${curRoomId}/${user.uid === userData.uid ? 'p1' : 'p2'}/move`).set(m);
                // Note: Logic in Admin Site handles the result calculation.
                db.ref(`rooms/${curRoomId}`).transaction(r => {
                    if(r) {
                        const me = r.p1.uid === user.uid ? 'p1' : 'p2';
                        r[me].move = m;
                    }
                    return r;
                });
            },
            quit: () => {
                if(curRoomId) db.ref('rooms/'+curRoomId).off();
                curRoomId = null; UI.page('lobby');
            }
        };

        const Wallet = {
            redeem: () => {
                const c = document.getElementById('gift-code').value.trim();
                if(!c) return;
                db.ref('codes/'+c).transaction(data => {
                    if(data && !data.used) { data.used = true; return data; }
                    return;
                }, (err, com, snap) => {
                    if(com) {
                        const amt = snap.val().amount;
                        db.ref('users/'+user.uid).update({ balance: userData.balance + amt });
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ ${amt} ‡∏ö‡∏≤‡∏ó`, 'success');
                    } else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'error');
                });
            },
            submit: (type) => {
                const amt = Number(document.getElementById(type==='deposit'?'dep-amt':'wit-amt').value);
                const time = document.getElementById('dep-time').value;
                if(amt < 1) return;
                db.ref('requests').push({ uid:user.uid, name:userData.name, type:type, amount:amt, time:time, status:'pending', timestamp:Date.now() });
                if(type==='withdraw') db.ref('users/'+user.uid).update({ balance: userData.balance - amt });
                Swal.fire('‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ', 'success'); UI.page('lobby');
            }
        };

        const User = {
            save: () => {
                db.ref('users/'+user.uid).update({
                    name: document.getElementById('pf-name').value,
                    fb_link: document.getElementById('pf-fb').value,
                    bank: document.getElementById('pf-bank').value,
                    acc: document.getElementById('pf-acc').value
                }).then(() => Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success'));
            }
        };

        const UI = {
            toggleAuth: (m) => { document.getElementById('login-form').classList.toggle('hidden', m==='reg'); document.getElementById('reg-form').classList.toggle('hidden', m==='log'); },
            page: (p) => {
                ['lobby','game','wallet','profile'].forEach(id => { 
                    document.getElementById('p-'+id).classList.add('hidden'); 
                    if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.remove('active');
                });
                document.getElementById('p-'+p).classList.remove('hidden');
                if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active');
            },
            tabFin: (m) => {
                document.getElementById('fin-dep').classList.toggle('hidden', m==='wit'); document.getElementById('fin-wit').classList.toggle('hidden', m==='dep');
                document.getElementById('t-dep').className = m==='dep' ? 'flex-1 py-3 rounded-xl font-bold bg-yellow-500 text-black' : 'flex-1 py-3 rounded-xl font-bold text-slate-500';
                document.getElementById('t-wit').className = m==='wit' ? 'flex-1 py-3 rounded-xl font-bold bg-yellow-500 text-black' : 'flex-1 py-3 rounded-xl font-bold text-slate-500';
            },
            copy: (t) => { navigator.clipboard.writeText(t); Swal.fire({toast:true, position:'top', title:'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton:false, timer:1000}); },
            contact: () => window.open(config.fbLink || '#')
        };
    </script>
</body>
</html>
