<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA - Centralized Escrow & Wallet</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Status Badges */
        .badge-pending { @apply bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold; }
        .badge-completed { @apply bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold; }
        .badge-rejected { @apply bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold; }

        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen flex flex-col relative">
        
        <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 animate-pulse">กำลังเชื่อมต่อระบบ FAFADA...</p>
        </div>

        <div id="toast" class="fixed top-5 right-5 z-[60] hidden transition-all duration-300 transform translate-x-full">
            <div class="bg-gray-800 text-white px-6 py-4 rounded shadow-lg flex items-center gap-3">
                <i id="toastIcon" class="fas fa-info-circle"></i>
                <span id="toastMessage">Notification</span>
            </div>
        </div>

        <section id="authScreen" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-800 p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
                <div class="flex border-b">
                    <button onclick="switchAuthTab('login')" id="tabLogin" class="flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50">เข้าสู่ระบบ</button>
                    <button onclick="switchAuthTab('register')" id="tabRegister" class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50">สมัครสมาชิก</button>
                </div>

                <div id="loginForm" class="p-8">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">ยินดีต้อนรับกลับ</h2>
                    <p class="text-gray-500 mb-6 text-sm">เข้าสู่ระบบเพื่อจัดการกระเป๋าเงินของคุณ</p>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                            <input type="email" id="loginEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="example@email.com" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                            <input type="password" id="loginPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">เข้าสู่ระบบ</button>
                    </form>
                </div>

                <div id="registerForm" class="p-8 hidden">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">สร้างบัญชีใหม่</h2>
                    <p class="text-gray-500 mb-6 text-sm">สมัครสมาชิก FAFADA Wallet</p>
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อที่แสดง</label>
                            <input type="text" id="regName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="เช่น สมชาย ใจดี" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                            <input type="email" id="regEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="example@email.com" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                            <input type="password" id="regPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="อย่างน้อย 6 ตัวอักษร" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">สมัครสมาชิก</button>
                        <p class="text-xs text-gray-400 mt-4 text-center">*หากใช้อีเมล farisxuma1@gmail.com จะเป็น Admin อัตโนมัติ</p>
                    </form>
                </div>
            </div>
        </section>

        <section id="userScreen" class="hidden min-h-screen bg-gray-50 fade-in">
            <nav class="bg-white shadow-md sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 flex items-center gap-2">
                                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">F</div>
                                <span class="font-bold text-xl text-blue-900">FAFADA</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right hidden sm:block">
                                <div id="userDisplayName" class="text-sm font-bold text-gray-900">User Name</div>
                                <div id="userEmailDisplay" class="text-xs text-gray-500">user@email.com</div>
                            </div>
                            <button onclick="handleLogout()" class="text-gray-500 hover:text-red-600 transition">
                                <i class="fas fa-sign-out-alt fa-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="announcementArea" class="mb-6 hidden">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 flex items-start gap-3 rounded-r-md">
                        <i class="fas fa-bullhorn text-yellow-500 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-yellow-800" id="annTitle">ประกาศ</h4>
                            <p class="text-sm text-yellow-700" id="annContent">เนื้อหาประกาศ...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl shadow-xl p-8 text-white mb-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
                        <i class="fas fa-wallet fa-10x"></i>
                    </div>
                    <p class="text-blue-100 font-medium">ยอดเงินคงเหลือสุทธิ</p>
                    <h1 class="text-5xl font-bold mt-2 mb-4">฿ <span id="userBalance">0.00</span></h1>
                    <div class="flex gap-2 text-sm text-blue-200">
                        <span class="bg-white/20 px-3 py-1 rounded-full"><i class="fas fa-user-shield mr-1"></i> Verified</span>
                        <span class="bg-white/20 px-3 py-1 rounded-full"><i class="fas fa-check-circle mr-1"></i> Active</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6 h-fit">
                        <h3 class="text-lg font-bold mb-4 border-b pb-2">ทำรายการ</h3>
                        
                        <div class="flex bg-gray-100 p-1 rounded-lg mb-6">
                            <button onclick="setTransactionType('deposit')" id="btnTypeDeposit" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm text-green-600 transition">ฝากเงิน</button>
                            <button onclick="setTransactionType('withdraw')" id="btnTypeWithdraw" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-red-600 transition">ถอนเงิน</button>
                        </div>

                        <form onsubmit="submitTransaction(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500">฿</span>
                                    </div>
                                    <input type="number" id="txnAmount" step="0.01" min="1" class="pl-8 w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00" required oninput="calculateFee()">
                                </div>
                            </div>

                            <div id="withdrawInfo" class="hidden mb-4 bg-red-50 p-3 rounded-lg border border-red-100 text-sm">
                                <div class="flex justify-between text-gray-600 mb-1">
                                    <span>จำนวนที่ขอถอน:</span>
                                    <span id="previewAmount">0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500 mb-1">
                                    <span>ค่าธรรมเนียม (5%):</span>
                                    <span id="previewFee">0.00</span>
                                </div>
                                <div class="flex justify-between font-bold text-gray-900 border-t pt-1 border-red-200">
                                    <span>ได้รับเงินจริง:</span>
                                    <span id="previewNet">0.00</span>
                                </div>
                            </div>

                            <button type="submit" id="btnSubmitTxn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i> ยืนยันรายการ
                            </button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 border-b pb-2 flex justify-between items-center">
                            <span>ประวัติการทำธุรกรรม</span>
                            <button onclick="loadUserHistory()" class="text-sm text-blue-500 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase">ประเภท</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase">วันที่</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase text-right">จำนวน</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase text-center">สถานะ</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase text-right">เหตุผล</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody" class="divide-y divide-gray-100">
                                    </tbody>
                            </table>
                            <div id="emptyHistory" class="text-center py-8 text-gray-400 hidden">ไม่มีข้อมูลประวัติ</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="adminScreen" class="hidden min-h-screen bg-slate-900 text-gray-100 flex fade-in">
            <aside class="w-64 bg-slate-800 flex-shrink-0 flex flex-col border-r border-slate-700">
                <div class="h-16 flex items-center justify-center border-b border-slate-700 bg-slate-900">
                    <span class="text-yellow-500 font-bold text-xl tracking-wider">FAFADA ADMIN</span>
                </div>
                <div class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <button onclick="switchAdminTab('dashboard')" id="menuDashboard" class="w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white shadow-lg transition">
                        <i class="fas fa-tachometer-alt w-6"></i> แดชบอร์ด (อนุมัติ)
                    </button>
                    <button onclick="switchAdminTab('users')" id="menuUsers" class="w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">
                        <i class="fas fa-users w-6"></i> จัดการสมาชิก / ปรับเงิน
                    </button>
                    <button onclick="switchAdminTab('news')" id="menuNews" class="w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition">
                        <i class="fas fa-newspaper w-6"></i> ประกาศข่าวสาร
                    </button>
                </div>
                <div class="p-4 border-t border-slate-700 bg-slate-900">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-slate-900 font-bold">A</div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium truncate" id="adminNameDisplay">Admin</p>
                            <p class="text-xs text-slate-500">Super Admin</p>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="w-full py-2 border border-red-500/50 text-red-500 rounded hover:bg-red-500 hover:text-white transition text-sm">ออกจากระบบ</button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto p-8 relative">
                
                <div id="adminTabDashboard">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-yellow-500"></i> รายการรออนุมัติ (Pending Requests)
                    </h2>
                    <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-900 text-slate-400 border-b border-slate-700">
                                    <tr>
                                        <th class="p-4">User</th>
                                        <th class="p-4">ประเภท</th>
                                        <th class="p-4 text-right">ยอดเงิน</th>
                                        <th class="p-4 text-right">ค่าธรรมเนียม</th>
                                        <th class="p-4 text-right">สุทธิ</th>
                                        <th class="p-4 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="adminRequestTable" class="divide-y divide-slate-700">
                                    </tbody>
                            </table>
                            <div id="adminEmptyRequests" class="p-8 text-center text-slate-500 hidden">ไม่มีรายการค้างอนุมัติ</div>
                        </div>
                    </div>
                </div>

                <div id="adminTabUsers" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-users-cog text-blue-500"></i> จัดการสมาชิก
                    </h2>
                    
                    <div class="mb-6 flex gap-4">
                        <input type="text" id="userSearchInput" placeholder="ค้นหา Email..." class="flex-1 bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded focus:outline-none focus:border-blue-500">
                        <button onclick="fetchUserList()" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">ค้นหา</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="adminUserListGrid">
                        </div>
                </div>

                 <div id="adminTabNews" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-bullhorn text-green-500"></i> จัดการข่าวสาร
                    </h2>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-6">
                        <h3 class="font-bold mb-4">ลงประกาศใหม่</h3>
                        <input type="text" id="newsTitle" placeholder="หัวข้อประกาศ" class="w-full mb-3 bg-slate-900 border border-slate-600 rounded p-2 text-white">
                        <textarea id="newsContent" rows="3" placeholder="รายละเอียดเนื้อหา..." class="w-full mb-3 bg-slate-900 border border-slate-600 rounded p-2 text-white"></textarea>
                        <button onclick="postAnnouncement()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded">โพสต์ประกาศ</button>
                    </div>
                 </div>

            </main>

            <div id="adjustModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
                <div class="bg-slate-800 border border-slate-600 rounded-xl p-6 w-full max-w-md shadow-2xl">
                    <h3 class="text-xl font-bold mb-4 text-white">ปรับยอดเงิน (Manual Adjustment)</h3>
                    <p class="text-sm text-slate-400 mb-4">ปรับยอดเงินให้กับ: <span id="adjUserEmail" class="text-blue-400 font-mono"></span></p>
                    
                    <div class="mb-4">
                        <label class="block text-slate-400 text-sm mb-1">ประเภท</label>
                        <select id="adjType" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white">
                            <option value="add">เพิ่มเงิน (Credit)</option>
                            <option value="deduct">ลดเงิน (Debit)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-slate-400 text-sm mb-1">จำนวนเงิน</label>
                        <input type="number" id="adjAmount" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" placeholder="0.00">
                    </div>

                    <div class="mb-6">
                        <label class="block text-slate-400 text-sm mb-1">เหตุผล (บังคับ)</label>
                        <input type="text" id="adjReason" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" placeholder="เช่น โบนัสกิจกรรม, ปรับปรุงยอด...">
                    </div>

                    <div class="flex gap-3 justify-end">
                        <button onclick="closeAdjustModal()" class="px-4 py-2 text-slate-400 hover:text-white">ยกเลิก</button>
                        <button onclick="submitAdjustment()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">ยืนยัน</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        // ------------------------------------------------
        // 1. Firebase Initialization (SDK v10 via CDN)
        // ------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, query, where, orderBy, runTransaction, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.firebasestorage.app",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419",
            measurementId: "G-Q73X8Q841W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userData = null;
        let currentTxnType = 'deposit'; // 'deposit' | 'withdraw'
        let unsubscribeUserDoc = null;
        let unsubscribeHistory = null;
        let unsubscribeAdminRequests = null;

        // ------------------------------------------------
        // 2. Authentication Logic
        // ------------------------------------------------
        
        // Listen to Auth State Changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Fetch User Data
                try {
                    const userRef = doc(db, "users", user.uid);
                    unsubscribeUserDoc = onSnapshot(userRef, (docSnap) => {
                        if (docSnap.exists()) {
                            userData = docSnap.data();
                            routeUserByRole(userData.role);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    showToast("ไม่สามารถดึงข้อมูลผู้ใช้ได้", "error");
                }
            } else {
                // No User
                currentUser = null;
                userData = null;
                showScreen('authScreen');
                toggleLoading(false);
            }
        });

        // Router Logic based on Role
        function routeUserByRole(role) {
            toggleLoading(false);
            if (role === 'admin') {
                showScreen('adminScreen');
                setupAdminDashboard();
            } else {
                showScreen('userScreen');
                setupUserDashboard();
            }
        }

        // Register Function
        window.handleRegister = async (e) => {
            e.preventDefault();
            toggleLoading(true);
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Auto-Admin Logic
                const role = email === "farisxuma1@gmail.com" ? "admin" : "user";

                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    displayName: name,
                    email: email,
                    role: role,
                    balance: 0,
                    createdAt: new Date(),
                    status: 'active'
                });

                showToast(`สมัครสมาชิกสำเร็จ! ยินดีต้อนรับ ${name}`, "success");
            } catch (error) {
                showToast("เกิดข้อผิดพลาด: " + error.message, "error");
                toggleLoading(false);
            }
        };

        // Login Function
        window.handleLogin = async (e) => {
            e.preventDefault();
            toggleLoading(true);
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Listener will handle redirection
            } catch (error) {
                showToast("อีเมลหรือรหัสผ่านไม่ถูกต้อง", "error");
                toggleLoading(false);
            }
        };

        // Logout Function
        window.handleLogout = () => {
            if (unsubscribeUserDoc) unsubscribeUserDoc();
            if (unsubscribeHistory) unsubscribeHistory();
            if (unsubscribeAdminRequests) unsubscribeAdminRequests();
            signOut(auth);
            showToast("ออกจากระบบแล้ว", "info");
        };

        // ------------------------------------------------
        // 3. User Dashboard Logic
        // ------------------------------------------------
        
        function setupUserDashboard() {
            // Update UI with User Data
            document.getElementById('userDisplayName').textContent = userData.displayName;
            document.getElementById('userEmailDisplay').textContent = userData.email;
            document.getElementById('userBalance').textContent = formatCurrency(userData.balance);

            // Listen to Balance changes (Already in onAuthStateChanged but needed for DOM update)
            // Realtime balance update logic is inside the onSnapshot above in Auth State

            // Fetch Announcements
            fetchAnnouncements();

            // Load History
            loadUserHistory();
        }

        // Realtime Balance UI Updater (Called from onSnapshot)
        // Note: In a framework like React this is automatic, here we manually update DOM in the snapshot callback inside Auth State. 
        // Let's modify the onSnapshot in Auth Section to call a render function.
        // *Correction*: I added the render inside the onSnapshot in Auth section implicitly. Let's make it explicit.
        
        // Setup Transaction Type Switcher
        window.setTransactionType = (type) => {
            currentTxnType = type;
            const btnDeposit = document.getElementById('btnTypeDeposit');
            const btnWithdraw = document.getElementById('btnTypeWithdraw');
            const withdrawInfo = document.getElementById('withdrawInfo');
            const btnSubmit = document.getElementById('btnSubmitTxn');

            if (type === 'deposit') {
                btnDeposit.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm text-green-600 transition";
                btnWithdraw.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-red-600 transition";
                withdrawInfo.classList.add('hidden');
                btnSubmit.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2";
                btnSubmit.innerHTML = '<i class="fas fa-arrow-circle-up"></i> แจ้งฝากเงิน';
            } else {
                btnWithdraw.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm text-red-600 transition";
                btnDeposit.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-green-600 transition";
                withdrawInfo.classList.remove('hidden');
                btnSubmit.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2";
                btnSubmit.innerHTML = '<i class="fas fa-arrow-circle-down"></i> แจ้งถอนเงิน';
            }
            calculateFee();
        };

        // Calculate Fee Logic
        window.calculateFee = () => {
            const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
            if (currentTxnType === 'withdraw') {
                const fee = amount * 0.05;
                const net = amount - fee;
                document.getElementById('previewAmount').textContent = formatCurrency(amount);
                document.getElementById('previewFee').textContent = formatCurrency(fee);
                document.getElementById('previewNet').textContent = formatCurrency(net);
            }
        };

        // Submit Transaction
        window.submitTransaction = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('txnAmount').value);
            
            if (amount <= 0) return showToast("จำนวนเงินต้องมากกว่า 0", "error");
            if (currentTxnType === 'withdraw' && amount > userData.balance) {
                return showToast("ยอดเงินคงเหลือไม่เพียงพอ", "error");
            }

            toggleLoading(true);
            try {
                let fee = 0;
                let netAmount = amount;
                
                if (currentTxnType === 'withdraw') {
                    fee = amount * 0.05;
                    netAmount = amount - fee;
                }

                await addDoc(collection(db, "transactions"), {
                    uid: currentUser.uid,
                    email: userData.email, // For Admin search convenience
                    userDisplayName: userData.displayName,
                    type: currentTxnType,
                    amount: amount,
                    fee: fee,
                    netAmount: netAmount,
                    status: 'pending',
                    timestamp: new Date(),
                    reason: '' // To be filled by admin if rejected
                });

                showToast("ส่งคำขอเรียบร้อยแล้ว รอแอดมินตรวจสอบ", "success");
                document.getElementById('txnAmount').value = "";
                calculateFee();
            } catch (error) {
                showToast("เกิดข้อผิดพลาด: " + error.message, "error");
            } finally {
                toggleLoading(false);
            }
        };

        // Load History (Realtime)
        window.loadUserHistory = () => {
            if (unsubscribeHistory) unsubscribeHistory();
            
            const q = query(
                collection(db, "transactions"),
                where("uid", "==", currentUser.uid),
                orderBy("timestamp", "desc")
            );

            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('historyTableBody');
                const emptyMsg = document.getElementById('emptyHistory');
                tbody.innerHTML = "";

                if (snapshot.empty) {
                    emptyMsg.classList.remove('hidden');
                } else {
                    emptyMsg.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const txn = doc.data();
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 transition";
                        
                        let typeColor = txn.type === 'deposit' ? 'text-green-600' : (txn.type === 'withdraw' ? 'text-red-600' : 'text-blue-600');
                        let sign = txn.type === 'deposit' ? '+' : (txn.type === 'withdraw' ? '-' : '');
                        let statusClass = txn.status === 'pending' ? 'badge-pending' : (txn.status === 'completed' ? 'badge-completed' : 'badge-rejected');

                        tr.innerHTML = `
                            <td class="px-4 py-3">
                                <span class="uppercase text-xs font-bold ${typeColor} bg-opacity-10 bg-gray-200 px-2 py-1 rounded">${txn.type}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500">${formatDate(txn.timestamp)}</td>
                            <td class="px-4 py-3 text-right font-bold ${typeColor}">${sign}${formatCurrency(txn.amount)}</td>
                            <td class="px-4 py-3 text-center"><span class="${statusClass}">${txn.status}</span></td>
                            <td class="px-4 py-3 text-right text-sm text-gray-400">${txn.reason || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        };

        async function fetchAnnouncements() {
            try {
                // Get latest announcement
                const q = query(collection(db, "announcements"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const ann = querySnapshot.docs[0].data();
                    document.getElementById('announcementArea').classList.remove('hidden');
                    document.getElementById('annTitle').textContent = ann.title;
                    document.getElementById('annContent').textContent = ann.content;
                }
            } catch (e) { console.log(e); }
        }

        // ------------------------------------------------
        // 4. Admin Panel Logic
        // ------------------------------------------------

        function setupAdminDashboard() {
            document.getElementById('adminNameDisplay').textContent = userData.displayName;
            switchAdminTab('dashboard');
        }

        window.switchAdminTab = (tab) => {
            // Hide all tabs
            document.getElementById('adminTabDashboard').classList.add('hidden');
            document.getElementById('adminTabUsers').classList.add('hidden');
            document.getElementById('adminTabNews').classList.add('hidden');
            
            // Reset Sidebar Styles
            document.getElementById('menuDashboard').className = "w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition";
            document.getElementById('menuUsers').className = "w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition";
            document.getElementById('menuNews').className = "w-full text-left px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition";

            // Show selected
            if (tab === 'dashboard') {
                document.getElementById('adminTabDashboard').classList.remove('hidden');
                document.getElementById('menuDashboard').className = "w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white shadow-lg transition";
                fetchPendingRequests();
            } else if (tab === 'users') {
                document.getElementById('adminTabUsers').classList.remove('hidden');
                document.getElementById('menuUsers').className = "w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white shadow-lg transition";
                fetchUserList();
            } else if (tab === 'news') {
                document.getElementById('adminTabNews').classList.remove('hidden');
                document.getElementById('menuNews').className = "w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white shadow-lg transition";
            }
        };

        // Fetch Pending Requests (Realtime)
        function fetchPendingRequests() {
            if (unsubscribeAdminRequests) unsubscribeAdminRequests();

            const q = query(collection(db, "transactions"), where("status", "==", "pending"), orderBy("timestamp", "asc"));
            
            unsubscribeAdminRequests = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('adminRequestTable');
                const emptyMsg = document.getElementById('adminEmptyRequests');
                tbody.innerHTML = "";

                if (snapshot.empty) {
                    emptyMsg.classList.remove('hidden');
                } else {
                    emptyMsg.classList.add('hidden');
                    snapshot.forEach(docSnap => {
                        const req = docSnap.data();
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-800 transition";
                        
                        tr.innerHTML = `
                            <td class="p-4">
                                <div class="font-bold text-white">${req.userDisplayName}</div>
                                <div class="text-xs text-slate-400">${req.email}</div>
                                <div class="text-xs text-slate-500">${formatDate(req.timestamp)}</div>
                            </td>
                            <td class="p-4">
                                <span class="${req.type === 'deposit' ? 'text-green-400' : 'text-red-400'} font-bold uppercase">${req.type}</span>
                            </td>
                            <td class="p-4 text-right font-mono text-white">${formatCurrency(req.amount)}</td>
                            <td class="p-4 text-right font-mono text-red-300">-${formatCurrency(req.fee)}</td>
                            <td class="p-4 text-right font-mono font-bold text-green-300">${formatCurrency(req.netAmount)}</td>
                            <td class="p-4 text-center space-x-2">
                                <button onclick="processTransaction('${docSnap.id}', 'approve')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs shadow">อนุมัติ</button>
                                <button onclick="processTransaction('${docSnap.id}', 'reject')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs shadow">ปฏิเสธ</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        }

        // Process Transaction (Approve/Reject)
        window.processTransaction = async (txnId, action) => {
            if (!confirm(`ยืนยันการ ${action === 'approve' ? 'อนุมัติ' : 'ปฏิเสธ'} รายการนี้?`)) return;

            toggleLoading(true);
            try {
                await runTransaction(db, async (transaction) => {
                    const txnRef = doc(db, "transactions", txnId);
                    const txnDoc = await transaction.get(txnRef);
                    if (!txnDoc.exists()) throw "Transaction not found";

                    const txnData = txnDoc.data();
                    const userRef = doc(db, "users", txnData.uid);
                    const userDoc = await transaction.get(userRef);
                    
                    if (action === 'approve') {
                        if (!userDoc.exists()) throw "User not found";
                        const currentBal = userDoc.data().balance;
                        
                        let newBal = currentBal;
                        if (txnData.type === 'deposit') {
                            newBal += txnData.amount;
                        } else if (txnData.type === 'withdraw') {
                            // Check balance again
                            if (currentBal < txnData.amount) throw "ยอดเงิน User ไม่พอในขณะนี้";
                            newBal -= txnData.amount; // Deduct full amount
                        }

                        transaction.update(userRef, { balance: newBal });
                        transaction.update(txnRef, { status: 'completed', approvedBy: currentUser.email });
                    } else {
                        // Reject
                        transaction.update(txnRef, { status: 'rejected', rejectedBy: currentUser.email, reason: 'ปฏิเสธโดยแอดมิน' });
                    }
                });
                showToast("ดำเนินการสำเร็จ", "success");
            } catch (error) {
                alert("Error: " + error);
            } finally {
                toggleLoading(false);
            }
        };

        // User Management Logic
        window.fetchUserList = async () => {
            const grid = document.getElementById('adminUserListGrid');
            grid.innerHTML = '<div class="col-span-3 text-center text-slate-500"><div class="loader mx-auto mb-2"></div>Loading...</div>';

            const searchEmail = document.getElementById('userSearchInput').value.trim();
            let q;
            if (searchEmail) {
                q = query(collection(db, "users"), where("email", "==", searchEmail));
            } else {
                q = query(collection(db, "users"), orderBy("createdAt", "desc"));
            }

            const querySnapshot = await getDocs(q);
            grid.innerHTML = "";

            if (querySnapshot.empty) {
                grid.innerHTML = '<div class="col-span-3 text-center text-slate-500">ไม่พบข้อมูล</div>';
                return;
            }

            querySnapshot.forEach(docSnap => {
                const u = docSnap.data();
                const card = document.createElement('div');
                card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm hover:border-blue-500 transition";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-white">${u.displayName}</h4>
                            <p class="text-xs text-slate-400">${u.email}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300">${u.role}</span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-slate-400">Balance</p>
                        <p class="text-2xl font-bold text-green-400">฿${formatCurrency(u.balance)}</p>
                    </div>
                    <button onclick="openAdjustModal('${u.uid}', '${u.email}')" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm transition">
                        <i class="fas fa-coins mr-1"></i> ปรับยอดเงิน
                    </button>
                `;
                grid.appendChild(card);
            });
        };

        // Manual Adjustment Modal
        let selectedAdjUser = null;
        window.openAdjustModal = (uid, email) => {
            selectedAdjUser = uid;
            document.getElementById('adjUserEmail').textContent = email;
            document.getElementById('adjustModal').classList.remove('hidden');
        };

        window.closeAdjustModal = () => {
            selectedAdjUser = null;
            document.getElementById('adjustModal').classList.add('hidden');
            document.getElementById('adjAmount').value = "";
            document.getElementById('adjReason').value = "";
        };

        window.submitAdjustment = async () => {
            const amount = parseFloat(document.getElementById('adjAmount').value);
            const reason = document.getElementById('adjReason').value.trim();
            const type = document.getElementById('adjType').value;

            if (!amount || amount <= 0) return alert("กรุณากรอกจำนวนเงิน");
            if (!reason) return alert("ต้องระบุเหตุผลในการปรับยอด");

            toggleLoading(true);
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", selectedAdjUser);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "User not found";

                    let newBal = userDoc.data().balance;
                    if (type === 'add') newBal += amount;
                    else newBal -= amount;

                    transaction.update(userRef, { balance: newBal });
                    
                    // Record in transactions as 'adjustment'
                    const txnRef = doc(collection(db, "transactions"));
                    transaction.set(txnRef, {
                        uid: selectedAdjUser,
                        email: userDoc.data().email,
                        userDisplayName: userDoc.data().displayName,
                        type: 'adjustment',
                        amount: amount,
                        fee: 0,
                        netAmount: amount,
                        status: 'completed',
                        reason: `[Admin Adjusted ${type}] ${reason}`,
                        timestamp: new Date(),
                        approvedBy: currentUser.email
                    });
                });
                alert("ปรับยอดเงินเรียบร้อย");
                closeAdjustModal();
                fetchUserList(); // Refresh list
            } catch (err) {
                alert("Error: " + err);
            } finally {
                toggleLoading(false);
            }
        };

        // Post Announcement
        window.postAnnouncement = async () => {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            if(!title || !content) return alert("กรุณากรอกข้อมูลให้ครบ");

            try {
                await addDoc(collection(db, "announcements"), {
                    title, content, createdAt: new Date()
                });
                alert("ประกาศข่าวสารแล้ว");
                document.getElementById('newsTitle').value = "";
                document.getElementById('newsContent').value = "";
            } catch(e) { alert(e.message); }
        };

        // ------------------------------------------------
        // 5. Utilities
        // ------------------------------------------------
        
        // Helpers
        function showScreen(screenId) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function toggleLoading(isLoading) {
            const overlay = document.getElementById('loadingOverlay');
            if (isLoading) overlay.classList.remove('hidden');
            else overlay.classList.add('hidden');
        }

        window.switchAuthTab = (tab) => {
            const btnLogin = document.getElementById('tabLogin');
            const btnReg = document.getElementById('tabRegister');
            const formLogin = document.getElementById('loginForm');
            const formReg = document.getElementById('registerForm');

            if (tab === 'login') {
                btnLogin.className = "flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50";
                btnReg.className = "flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50";
                formLogin.classList.remove('hidden');
                formReg.classList.add('hidden');
            } else {
                btnReg.className = "flex-1 py-4 font-bold text-green-600 border-b-2 border-green-600 bg-green-50";
                btnLogin.className = "flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50";
                formReg.classList.remove('hidden');
                formLogin.classList.add('hidden');
            }
        };

        function showToast(message, type = "info") {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            msg.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);

            if (type === 'success') {
                toast.firstElementChild.className = "bg-green-600 text-white px-6 py-4 rounded shadow-lg flex items-center gap-3";
                icon.className = "fas fa-check-circle";
            } else if (type === 'error') {
                toast.firstElementChild.className = "bg-red-600 text-white px-6 py-4 rounded shadow-lg flex items-center gap-3";
                icon.className = "fas fa-exclamation-circle";
            } else {
                toast.firstElementChild.className = "bg-gray-800 text-white px-6 py-4 rounded shadow-lg flex items-center gap-3";
                icon.className = "fas fa-info-circle";
            }

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function formatCurrency(num) {
            return num ? num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp.seconds * 1000).toLocaleString('th-TH');
        }

        // On document load (check Balance update)
        if (userData) {
           document.getElementById('userBalance').textContent = formatCurrency(userData.balance); 
        }

    </script>
</body>
</html>
