<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAFADA | Premium Client Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b' }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(14, 165, 233, 0.5)',
                        'card': '0 10px 30px -10px rgba(0, 0, 0, 0.15)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset */
        body { background-color: #f1f5f9; color: #334155; -webkit-font-smoothing: antialiased; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* 3D Card Animation */
        .perspective-1000 { perspective: 1000px; }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .flip-card:hover .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.5rem; overflow: hidden;
        }
        .card-front {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .card-back {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            transform: rotateY(180deg);
        }

        /* Loading Skeleton Animation */
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Floating Animation */
        .float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="globalLoader" class="fixed inset-0 z-[9999] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-brand-500 rounded-full border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-bolt text-brand-500 text-3xl animate-pulse"></i>
            </div>
        </div>
        <h2 class="mt-6 text-2xl font-bold text-slate-800 tracking-widest">FAFADA</h2>
        <p class="text-sm text-slate-400 font-medium">Initializing Secure Environment...</p>
    </div>

    <div id="authModule" class="hidden fixed inset-0 z-50 bg-slate-100 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-5xl rounded-[2rem] shadow-2xl overflow-hidden flex flex-col lg:flex-row min-h-[600px] animate__animated animate__fadeInUp">
                
                <div class="lg:w-1/2 bg-slate-900 p-12 text-white relative flex flex-col justify-between overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                    <div class="absolute -right-20 -top-20 w-96 h-96 bg-brand-500 rounded-full blur-[100px] opacity-20"></div>
                    
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-brand-500 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-glow mb-6">F</div>
                        <h1 class="text-5xl font-bold mb-4 leading-tight">Banking <br>Reimagined.</h1>
                        <p class="text-slate-400 text-lg">ระบบกระเป๋าเงินออนไลน์ที่ปลอดภัย รวดเร็ว และตรวจสอบได้ 100%</p>
                    </div>

                    <div class="relative z-10 flex gap-4 mt-8">
                        <div class="flex -space-x-4">
                            <div class="w-10 h-10 rounded-full border-2 border-slate-900 bg-slate-700"></div>
                            <div class="w-10 h-10 rounded-full border-2 border-slate-900 bg-slate-600"></div>
                            <div class="w-10 h-10 rounded-full border-2 border-slate-900 bg-slate-500"></div>
                        </div>
                        <p class="text-sm text-slate-400 self-center">Trusted by 10k+ users</p>
                    </div>
                </div>

                <div class="lg:w-1/2 p-12 bg-white flex flex-col justify-center relative">
                    <div class="absolute top-8 right-8 flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="auth.switch('login')" id="btnToLogin" class="px-6 py-2.5 rounded-lg text-sm font-bold bg-white text-brand-600 shadow-sm transition-all">Login</button>
                        <button onclick="auth.switch('register')" id="btnToReg" class="px-6 py-2.5 rounded-lg text-sm font-bold text-slate-500 hover:text-brand-600 transition-all">Register</button>
                    </div>

                    <div id="viewLogin" class="w-full max-w-sm mx-auto">
                        <h2 class="text-3xl font-bold text-slate-800 mb-2">Welcome Back!</h2>
                        <p class="text-slate-500 mb-8">กรุณาเข้าสู่ระบบเพื่อดำเนินการต่อ</p>
                        
                        <form onsubmit="auth.handleLogin(event)" class="space-y-5">
                            <div class="group">
                                <label class="block text-xs font-bold text-slate-500 mb-1 ml-1 group-focus-within:text-brand-600">อีเมล</label>
                                <div class="relative">
                                    <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400 group-focus-within:text-brand-500 transition"></i>
                                    <input type="email" id="lEmail" class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:bg-white outline-none transition" placeholder="name@example.com" required>
                                </div>
                            </div>
                            <div class="group">
                                <label class="block text-xs font-bold text-slate-500 mb-1 ml-1 group-focus-within:text-brand-600">รหัสผ่าน</label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400 group-focus-within:text-brand-500 transition"></i>
                                    <input type="password" id="lPass" class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:bg-white outline-none transition" placeholder="••••••••" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-500/30 transition transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2">
                                <span>เข้าสู่ระบบ</span> <i class="fas fa-arrow-right"></i>
                            </button>
                        </form>
                    </div>

                    <div id="viewRegister" class="w-full max-w-sm mx-auto hidden">
                        <h2 class="text-3xl font-bold text-slate-800 mb-2">Create Account</h2>
                        <p class="text-slate-500 mb-8">สมัครสมาชิกใหม่ ง่ายๆ ใน 1 นาที</p>
                        
                        <form onsubmit="auth.handleRegister(event)" class="space-y-4">
                            <div>
                                <input type="text" id="rName" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="ชื่อที่แสดง (Display Name)" required>
                            </div>
                            <div>
                                <input type="email" id="rEmail" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="อีเมล" required>
                            </div>
                            <div>
                                <input type="password" id="rPass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)" required>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 transition transform hover:-translate-y-1 active:scale-95">
                                สมัครสมาชิกทันที
                            </button>
                            <p class="text-xs text-center text-slate-400 mt-4">*ใช้อีเมล farisxuma1@gmail.com เพื่อเป็น Admin</p>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="appModule" class="hidden flex-col h-screen overflow-hidden bg-slate-50">
        
        <nav class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-brand-500 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg">F</div>
                    <span class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block">FAFADA</span>
                </div>
                
                <div class="flex items-center gap-3">
                    <div onclick="profile.open()" class="flex items-center gap-3 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-full pl-1 pr-4 py-1 cursor-pointer transition group">
                        <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold border border-brand-200 group-hover:bg-brand-600 group-hover:text-white transition">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="text-right hidden sm:block">
                            <p class="text-xs font-bold text-slate-700" id="navName">Loading...</p>
                            <p class="text-[10px] text-slate-400" id="navId">ID: ...</p>
                        </div>
                    </div>
                    
                    <button onclick="auth.logout()" class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white border border-red-100 transition flex items-center justify-center" title="ออกจากระบบ">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto custom-scroll">
            <div class="max-w-7xl mx-auto px-4 py-8 w-full space-y-8">
                
                <div id="newsSection" class="hidden animate__animated animate__fadeInDown">
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-400 p-4 rounded-r-xl shadow-sm flex gap-4">
                        <div class="bg-white p-2.5 rounded-full text-amber-500 shadow-sm h-fit"><i class="fas fa-bullhorn animate-pulse"></i></div>
                        <div>
                            <h3 class="font-bold text-amber-900 text-sm" id="newsTitle">ประกาศ</h3>
                            <p class="text-xs text-amber-800 mt-1 leading-relaxed" id="newsContent">...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <div class="lg:col-span-5 space-y-6">
                        
                        <div class="perspective-1000 w-full h-56 cursor-pointer flip-card group">
                            <div class="card-inner relative w-full h-full shadow-2xl rounded-3xl">
                                <div class="card-front p-6 text-white flex flex-col justify-between">
                                    <div class="flex justify-between items-center">
                                        <img src="https://raw.githubusercontent.com/muhmi/payment-icons/main/assets/chip.png" class="h-10 opacity-90">
                                        <i class="fas fa-wifi rotate-90 text-2xl opacity-60"></i>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-slate-300 text-xs font-medium uppercase tracking-widest mb-1">Total Balance</p>
                                        <h1 class="text-4xl font-bold tracking-tight">฿ <span id="cardBal">0.00</span></h1>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <div class="text-left">
                                            <p class="text-[10px] text-slate-300 uppercase">Card Holder</p>
                                            <p class="text-sm font-medium tracking-widest uppercase" id="cardHolder">...</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                                            <span class="text-[10px] font-bold">ACTIVE</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-back p-6 text-white flex flex-col justify-center items-center relative">
                                    <div class="w-full h-10 bg-black absolute top-6"></div>
                                    <div class="w-3/4 h-8 bg-white/20 rounded mt-4 flex items-center justify-end px-3">
                                        <span class="text-black font-mono text-sm font-bold" id="cardCvc">***</span>
                                    </div>
                                    <p class="mt-8 text-xs text-slate-400 px-4">บัตรนี้เป็นทรัพย์สินของ FAFADA ใช้สำหรับธุรกรรมภายในระบบเท่านั้น</p>
                                    <p class="absolute bottom-4 left-6 font-mono text-sm tracking-widest" id="cardUid">.... .... .... ....</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-card border border-slate-100 p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-5"><i class="fas fa-coins text-6xl"></i></div>
                            
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-800"><i class="fas fa-wallet text-brand-500 mr-2"></i> ทำรายการ</h3>
                                <a id="contactAdminBtn" href="#" target="_blank" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded hover:bg-slate-200 transition hidden">
                                    <i class="fab fa-facebook-messenger"></i> ติดต่อ จนท.
                                </a>
                            </div>

                            <div class="flex bg-slate-100 p-1.5 rounded-xl mb-6">
                                <button onclick="txn.setType('deposit')" id="btnDep" class="flex-1 py-3 text-sm font-bold bg-white text-green-600 shadow rounded-lg transition-all duration-300">ฝากเงิน</button>
                                <button onclick="txn.setType('withdraw')" id="btnWdr" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-red-500 transition-all duration-300">ถอนเงิน</button>
                            </div>

                            <div id="boxAdminBank" class="hidden mb-4 bg-blue-50 border border-blue-100 rounded-xl p-4 animate-fade-in">
                                <p class="text-[10px] font-bold text-blue-800 uppercase mb-2"><i class="fas fa-university mr-1"></i> บัญชีรับโอน (Official)</p>
                                <div class="flex items-start gap-3">
                                    <div class="bg-white p-2 rounded text-blue-600"><i class="fas fa-money-bill-wave"></i></div>
                                    <div>
                                        <p class="text-sm font-bold text-blue-700 whitespace-pre-line" id="txtAdminBank">Loading...</p>
                                    </div>
                                </div>
                            </div>

                            <form onsubmit="txn.submit(event)">
                                <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block">ระบุจำนวนเงิน</label>
                                <div class="relative mb-2">
                                    <span class="absolute left-4 top-3.5 text-slate-400 font-bold">฿</span>
                                    <input type="number" id="txnAmt" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-bold text-slate-700 focus:ring-2 focus:ring-brand-500 focus:bg-white outline-none transition" placeholder="0.00" step="0.01" min="1" required oninput="txn.calc()">
                                </div>

                                <div id="boxFee" class="hidden px-2 mb-4 animate-fade-in">
                                    <div class="flex justify-between text-xs text-red-500 mb-1">
                                        <span>ค่าธรรมเนียม (<span id="txtFeePc">0</span>%)</span>
                                        <span id="txtFeeVal">-0.00</span>
                                    </div>
                                    <div class="flex justify-between text-sm font-bold text-slate-700 border-t border-dashed border-slate-300 pt-1">
                                        <span>ยอดได้รับสุทธิ</span>
                                        <span id="txtNetVal">0.00</span>
                                    </div>
                                </div>

                                <button id="btnSubmitTxn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 transition transform active:scale-95 flex items-center justify-center gap-2 mt-4">
                                    <i class="fas fa-check-circle"></i> ยืนยันรายการ
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="lg:col-span-7 bg-white rounded-2xl shadow-card border border-slate-100 flex flex-col h-[600px] lg:h-auto">
                        <div class="p-6 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-history text-brand-500"></i> ประวัติรายการ</h3>
                            
                            <div class="flex gap-2">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                    <input type="text" id="histSearch" onkeyup="hist.filter()" class="pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-full text-xs focus:ring-2 focus:ring-brand-500 outline-none w-32 focus:w-48 transition-all" placeholder="ค้นหา...">
                                </div>
                                <select id="histFilter" onchange="hist.filter()" class="py-2 px-3 bg-white border border-slate-200 rounded-full text-xs outline-none focus:ring-2 focus:ring-brand-500 cursor-pointer">
                                    <option value="all">ทั้งหมด</option>
                                    <option value="deposit">ฝากเงิน</option>
                                    <option value="withdraw">ถอนเงิน</option>
                                    <option value="pending">รออนุมัติ</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex-1 overflow-auto custom-scroll p-2 relative">
                            <div id="skelTable" class="space-y-3 p-4">
                                <div class="h-12 bg-slate-100 rounded-lg w-full skeleton"></div>
                                <div class="h-12 bg-slate-100 rounded-lg w-full skeleton"></div>
                                <div class="h-12 bg-slate-100 rounded-lg w-full skeleton"></div>
                            </div>

                            <table class="w-full text-left text-sm border-collapse hidden" id="realTable">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="p-4 rounded-l-lg">ประเภท</th>
                                        <th class="p-4 text-right">จำนวนเงิน</th>
                                        <th class="p-4 text-center">สถานะ</th>
                                        <th class="p-4 text-right rounded-r-lg text-[10px]">หมายเหตุ</th>
                                    </tr>
                                </thead>
                                <tbody id="tbHist" class="divide-y divide-slate-100"></tbody>
                            </table>
                            
                            <div id="noData" class="hidden flex flex-col items-center justify-center h-full text-slate-400 py-10">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><i class="far fa-folder-open text-2xl opacity-50"></i></div>
                                <p class="text-sm">ไม่พบประวัติรายการ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalProfile" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/70 backdrop-blur-sm p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="modalContent">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">ข้อมูลผู้ใช้งาน</h3>
                <button onclick="profile.close()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-brand-100 text-brand-600 rounded-full mx-auto flex items-center justify-center text-3xl font-bold mb-3 border-4 border-white shadow-lg">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-800" id="pfDisplayName">...</h2>
                    <p class="text-xs text-slate-500" id="pfEmail">...</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 shadow-sm">
                        <p class="text-[10px] font-bold text-yellow-700 uppercase mb-3 flex items-center gap-1">
                            <i class="fas fa-shield-alt"></i> ข้อมูลสำหรับรับเงิน (จำเป็น)
                        </p>
                        <form onsubmit="profile.save(event)" class="space-y-3">
                            <div class="group">
                                <label class="text-[10px] text-yellow-600 font-bold ml-1">ธนาคาร</label>
                                <input id="inpBank" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="เช่น กสิกรไทย" required>
                            </div>
                            <div class="group">
                                <label class="text-[10px] text-yellow-600 font-bold ml-1">เลขที่บัญชี</label>
                                <input id="inpAcc" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="xxx-x-xxxxx-x" required>
                            </div>
                            <div class="group">
                                <label class="text-[10px] text-yellow-600 font-bold ml-1">ช่องทางติดต่อ (Facebook/Line)</label>
                                <input id="inpContact" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="ลิงก์ หรือ ID" required>
                            </div>
                            <button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm mt-2 transition">บันทึกข้อมูล</button>
                        </form>
                    </div>
                    
                    <div class="flex justify-between items-center text-xs text-slate-500 pt-3 border-t border-slate-100">
                        <span>วันที่สมัคร: <span id="pfDate" class="text-slate-700 font-medium">-</span></span>
                        <span>สถานะ: <span class="text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full">ปกติ</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419", measurementId: "G-Q73X8Q841W" };
        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        // --- STATE ---
        const store = { user: null, data: null, config: { feePercent: 0, adminBank: '-', contactLink: '' }, history: [], type: 'deposit' };

        // --- MODULES ---
        window.auth = {
            switch: (m) => {
                if(m==='login'){ document.getElementById('formLogin').classList.remove('hidden'); document.getElementById('formRegister').classList.add('hidden'); document.getElementById('tabLogin').className="flex-1 py-2 rounded-lg font-bold bg-white text-blue-600 shadow transition"; document.getElementById('tabRegister').className="flex-1 py-2 rounded-lg font-bold text-gray-400 transition"; }
                else { document.getElementById('formLogin').classList.add('hidden'); document.getElementById('formRegister').classList.remove('hidden'); document.getElementById('tabRegister').className="flex-1 py-2 rounded-lg font-bold bg-green-500 text-white shadow transition"; document.getElementById('tabLogin').className="flex-1 py-2 rounded-lg font-bold text-gray-400 transition"; }
            },
            login: async(e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); } catch(err){ Swal.fire('Error','ข้อมูลไม่ถูกต้อง','error'); } },
            register: async(e)=>{ e.preventDefault(); const n=document.getElementById('rName').value, em=document.getElementById('rEmail').value, pw=document.getElementById('rPass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,pw); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:em,displayName:n,role:em==='farisxuma1@gmail.com'?'admin':'user',balance:0,createdAt:new Date(),bankName:'',bankAcc:'',contactLink:''}); Swal.fire('Success','สมัครเรียบร้อย','success'); } catch(err){ Swal.fire('Error',err.message,'error'); } },
            logout: ()=>Swal.fire({title:'ออกจากระบบ?',icon:'warning',showCancelButton:true,confirmButtonText:'ยืนยัน',confirmButtonColor:'#ef4444'}).then(r=>{if(r.isConfirmed)signOut(auth).then(()=>location.reload())})
        };

        window.profile = {
            open: ()=>{ 
                const m = document.getElementById('modalProfile');
                document.getElementById('pfDisplayName').innerText = store.data.displayName;
                document.getElementById('pfEmail').innerText = store.data.email;
                document.getElementById('pfDate').innerText = store.data.createdAt ? new Date(store.data.createdAt.seconds*1000).toLocaleDateString('th-TH') : '-';
                document.getElementById('inpBank').value = store.data.bankName || '';
                document.getElementById('inpAcc').value = store.data.bankAcc || '';
                document.getElementById('inpContact').value = store.data.contactLink || '';
                m.classList.remove('hidden'); setTimeout(()=> { m.classList.remove('opacity-0'); document.getElementById('modalContent').classList.remove('scale-95'); }, 10);
            },
            close: ()=>{ 
                const m = document.getElementById('modalProfile');
                m.classList.add('opacity-0'); document.getElementById('modalContent').classList.add('scale-95');
                setTimeout(()=>m.classList.add('hidden'), 300);
            },
            save: async(e)=>{
                e.preventDefault();
                try{
                    await updateDoc(doc(db,"users",store.user.uid), { bankName:document.getElementById('inpBank').value, bankAcc:document.getElementById('inpAcc').value, contactLink:document.getElementById('inpContact').value });
                    Swal.fire('Success','บันทึกข้อมูลเรียบร้อย','success'); profile.close();
                }catch(err){ Swal.fire('Error','บันทึกไม่สำเร็จ','error'); }
            }
        };

        window.txn = {
            setType: (t)=>{
                store.type=t;
                const bd=document.getElementById('btnDep'), bw=document.getElementById('btnWdr'), sub=document.getElementById('btnSubmitTxn');
                if(t==='deposit'){
                    bd.className="flex-1 py-3 text-sm font-bold bg-white text-green-600 shadow rounded-lg transition-all transform scale-105";
                    bw.className="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-red-500 transition-all opacity-70";
                    sub.className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2 mt-4";
                    sub.innerHTML='<i class="fas fa-arrow-circle-down"></i> แจ้งฝากเงิน';
                    document.getElementById('adminBankBox').classList.remove('hidden'); document.getElementById('boxFee').classList.add('hidden');
                } else {
                    bw.className="flex-1 py-3 text-sm font-bold bg-white text-red-600 shadow rounded-lg transition-all transform scale-105";
                    bd.className="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-green-600 transition-all opacity-70";
                    sub.className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2 mt-4";
                    sub.innerHTML='<i class="fas fa-paper-plane"></i> แจ้งถอนเงิน';
                    document.getElementById('adminBankBox').classList.add('hidden'); document.getElementById('boxFee').classList.remove('hidden');
                }
                txn.calc();
            },
            calc: ()=>{
                const v=parseFloat(document.getElementById('txnAmt').value)||0;
                if(store.type==='withdraw'){
                    const feePc=store.config.feePercent||0;
                    const f=v*(feePc/100);
                    document.getElementById('txtFeeVal').innerText='-'+f.toLocaleString();
                    document.getElementById('txtNetVal').innerText=(v-f).toLocaleString();
                }
            },
            submit: async(e)=>{
                e.preventDefault(); const v=parseFloat(document.getElementById('txnAmt').value);
                if(v<=0) return Swal.fire('เตือน','ระบุยอดเงินให้ถูกต้อง','warning');
                
                // Validation for Withdraw
                if(store.type==='withdraw'){
                    if(v > store.data.balance) return Swal.fire('ยอดเงินไม่พอ','','error');
                    if(!store.data.bankAcc || !store.data.contactLink) return Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลธนาคารและช่องทางติดต่อในหน้าโปรไฟล์ก่อน','warning').then(()=>profile.open());
                }

                try{
                    Swal.showLoading();
                    const fee = store.type==='withdraw' ? v*(store.config.feePercent/100) : 0;
                    await addDoc(collection(db,"transactions"), {
                        uid:store.user.uid, email:store.data.email, userDisplayName:store.data.displayName,
                        userBank:(store.data.bankName||'')+' '+(store.data.bankAcc||''), userFb:store.data.contactLink||'',
                        type:store.type, amount:v, fee:fee, netAmount:v-fee, status:'pending', timestamp:new Date()
                    });
                    Swal.fire('สำเร็จ','ส่งรายการเรียบร้อย','success');
                    document.getElementById('txnAmt').value=''; txn.calc();
                }catch(err){ Swal.fire('Error',err.message,'error'); }
            }
        };

        window.hist = {
            render: (list)=>{
                const t=document.getElementById('tbHist'); t.innerHTML='';
                if(list.length===0){ document.getElementById('noData').classList.remove('hidden'); document.getElementById('realTable').classList.add('hidden'); return; }
                document.getElementById('noData').classList.add('hidden'); document.getElementById('realTable').classList.remove('hidden');
                
                list.forEach(x=>{
                    const isD=x.type==='deposit', c=isD?'text-green-600':'text-red-600';
                    let s=x.status==='pending'?'<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200">รอ</span>':(x.status==='completed'?'<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200">เสร็จ</span>':'<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200">ยกเลิก</span>');
                    
                    t.innerHTML+=`
                    <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50 transition group">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${isD?'bg-green-100 text-green-600':'bg-red-100 text-red-600'} flex items-center justify-center text-xs"><i class="fas ${isD?'fa-arrow-down':'fa-arrow-up'}"></i></div>
                                <div>
                                    <p class="font-bold text-slate-700 text-xs uppercase">${x.type}</p>
                                    <p class="text-[10px] text-slate-400">${new Date(x.timestamp.seconds*1000).toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono font-bold ${c}">${isD?'+':'-'}${x.amount.toLocaleString()}</td>
                        <td class="p-4 text-center">${s}</td>
                        <td class="p-4 text-right text-[10px] text-slate-400 max-w-[80px] truncate">${x.reason||'-'}</td>
                    </tr>`;
                });
            },
            filter: ()=>{
                const k=document.getElementById('histSearch').value.toLowerCase();
                const f=document.getElementById('histFilter').value;
                const res=store.history.filter(x=>{
                    const matchesK = x.type.includes(k) || x.amount.toString().includes(k) || x.status.includes(k);
                    const matchesF = f==='all' ? true : (f==='pending'?x.status==='pending':x.type===f);
                    return matchesK && matchesF;
                });
                hist.render(res);
            }
        };

        // --- INIT ---
        onAuthStateChanged(auth, u=>{
            document.getElementById('loader').classList.add('hidden');
            if(u){
                store.user=u;
                onSnapshot(doc(db,"users",u.uid), s=>{ if(s.exists()){ store.data=s.data(); renderMainUI(); } });
                onSnapshot(doc(db,"system","config"), s=>{ if(s.exists()){ store.config=s.data(); renderConfigUI(); } });
                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid)), s=>{
                    let l=[]; s.forEach(d=>l.push(d.data())); l.sort((a,b)=>b.timestamp-a.timestamp);
                    store.history=l; 
                    document.getElementById('skelTable').classList.add('hidden');
                    hist.render(l);
                });
                onSnapshot(query(collection(db,"announcements"), orderBy("createdAt","desc"), limit(1)), s=>{
                    if(!s.empty){ const n=s.docs[0].data(); document.getElementById('newsAlert').classList.remove('hidden'); document.getElementById('newsTitle').innerText=n.title; document.getElementById('newsContent').innerText=n.content; }
                });
                
                document.getElementById('authScreen').classList.add('hidden'); document.getElementById('mainScreen').classList.remove('hidden');
            } else {
                document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('mainScreen').classList.add('hidden');
            }
        });

        function renderMainUI() {
            document.getElementById('navName').innerText=store.data.displayName;
            document.getElementById('navId').innerText='ID: '+store.user.uid.slice(0,6);
            document.getElementById('cardBal').innerText=store.data.balance.toLocaleString('th-TH',{minimumFractionDigits:2});
            document.getElementById('cardHolder').innerText=store.data.displayName;
            document.getElementById('cardId').innerText=store.user.uid.slice(0,4)+"  **** **** "+store.user.uid.slice(-4);
        }

        function renderConfigUI() {
            document.getElementById('txtAdminBank').innerText=store.config.adminBank||'-';
            document.getElementById('txtFeePc').innerText=store.config.feePercent||0;
            const btn=document.getElementById('contactAdminBtn');
            if(store.config.contactLink && store.config.contactLink.length>5){ btn.classList.remove('hidden'); btn.href=store.config.contactLink; }
        }
    </script>
</body>
</html>
