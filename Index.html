<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-SQUARE | E-Sports Escrow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --neon-blue: #00f3ff; --neon-pink: #ff00ff; --bg: #050b14; --panel: #0f1923; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); color: #fff; }
        .font-game { font-family: 'Rajdhani', sans-serif; }
        .glass { background: rgba(15, 25, 35, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .neon-text { text-shadow: 0 0 10px var(--neon-blue); }
        .btn-neon {
            background: linear-gradient(90deg, var(--neon-blue), #0066ff); color: #000; font-weight: 800;
            text-transform: uppercase; border: none; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
            transition: 0.3s;
        }
        .btn-neon:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--neon-blue); }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="auth-screen" class="fixed inset-0 z-50 bg-[#050b14] flex items-center justify-center bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="glass p-8 rounded-none w-full max-w-sm border-l-4 border-[var(--neon-blue)] relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-[var(--neon-blue)] blur-[50px] opacity-20"></div>
            <h1 class="text-5xl font-game font-bold text-white mb-2 tracking-widest">G-SQUARE</h1>
            <p class="text-[var(--neon-blue)] text-xs mb-8 uppercase tracking-[0.3em]">Secure Escrow System</p>
            
            <div class="space-y-4">
                <input id="l-email" class="w-full bg-[#0a1018] border border-gray-700 p-3 text-white outline-none focus:border-[var(--neon-blue)] transition" placeholder="Email Address">
                <input id="l-pass" type="password" class="w-full bg-[#0a1018] border border-gray-700 p-3 text-white outline-none focus:border-[var(--neon-blue)] transition" placeholder="Password">
                <button onclick="App.login()" class="btn-neon w-full py-4 mt-4 tracking-wider">LOGIN SYSTEM</button>
                <div class="flex justify-between text-xs text-gray-500 mt-4">
                    <span onclick="App.register()" class="cursor-pointer hover:text-white">Create Account</span>
                    <span>Forgot Password?</span>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden flex-1 flex flex-col h-full">
        <header class="h-16 glass flex justify-between items-center px-6 z-40">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-[var(--neon-blue)] to-purple-600 rounded flex items-center justify-center font-bold text-black text-xl">G</div>
                <div>
                    <h2 class="font-game text-xl font-bold leading-none tracking-wide">G-SQUARE</h2>
                    <span class="text-[10px] text-gray-400 bg-gray-800 px-1 rounded">USER</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">Credits</p>
                    <p id="u-bal" class="font-game text-2xl font-bold text-[var(--neon-blue)] neon-text">0.00</p>
                </div>
                <div class="w-10 h-10 rounded bg-gray-800 border border-gray-600 overflow-hidden">
                    <img id="u-avatar" src="" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <nav class="w-20 bg-[#0a1018] border-r border-gray-800 flex flex-col items-center py-6 gap-6 z-30">
                <button onclick="UI.nav('lobby')" id="nav-lobby" class="nav-btn active text-[var(--neon-blue)]"><i class="fa-solid fa-gamepad text-2xl"></i></button>
                <button onclick="UI.nav('wallet')" id="nav-wallet" class="nav-btn text-gray-500 hover:text-white"><i class="fa-solid fa-wallet text-2xl"></i></button>
                <button onclick="UI.nav('history')" id="nav-history" class="nav-btn text-gray-500 hover:text-white"><i class="fa-solid fa-clock-rotate-left text-2xl"></i></button>
                <button onclick="App.logout()" class="mt-auto text-red-500 hover:bg-red-500/10 p-2 rounded"><i class="fa-solid fa-power-off text-xl"></i></button>
            </nav>

            <main class="flex-1 overflow-y-auto p-6 relative">
                
                <section id="p-lobby" class="max-w-5xl mx-auto animate__animated animate__fadeIn">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h1 class="text-3xl font-game font-bold uppercase">Match Lobby</h1>
                            <p class="text-gray-400 text-sm">สร้างรายการหรือเข้าร่วมการแข่งขัน (เงินจะถูกล็อกในระบบกลาง)</p>
                        </div>
                        <button onclick="Game.createModal()" class="btn-neon px-6 py-2 text-sm">+ CREATE MATCH</button>
                    </div>

                    <div id="match-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </section>

                <section id="p-wallet" class="hidden max-w-3xl mx-auto animate__animated animate__fadeIn">
                    <h1 class="text-3xl font-game font-bold uppercase mb-6">My Wallet</h1>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="glass p-6 rounded relative overflow-hidden group cursor-pointer hover:border-green-500 transition" onclick="Wallet.depositModal()">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-circle-arrow-down text-8xl"></i></div>
                            <h3 class="text-xl font-bold text-green-400">DEPOSIT</h3>
                            <p class="text-gray-400 text-sm">เติมเครดิตเข้าระบบ</p>
                        </div>
                        <div class="glass p-6 rounded relative overflow-hidden group cursor-pointer hover:border-red-500 transition" onclick="Wallet.withdrawModal()">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-circle-arrow-up text-8xl"></i></div>
                            <h3 class="text-xl font-bold text-red-400">WITHDRAW</h3>
                            <p class="text-gray-400 text-sm">ถอนเครดิตออก</p>
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-500 mb-4 border-b border-gray-800 pb-2">PENDING TRANSACTIONS</h3>
                    <div id="pending-list" class="space-y-3"></div>
                </section>

                <section id="p-history" class="hidden max-w-4xl mx-auto animate__animated animate__fadeIn">
                    <h1 class="text-3xl font-game font-bold uppercase mb-6">Transaction History</h1>
                    <div class="glass rounded overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-[#0a1018] text-white font-bold uppercase text-xs">
                                <tr><th class="p-4">Date</th><th>Type</th><th>Ref ID</th><th>Amount</th><th>Status</th></tr>
                            </thead>
                            <tbody id="hist-list" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyAochx_FIKbXLrbhhcLdVrpaurjjk4aQYc", authDomain: "paoshuv-c260d.firebaseapp.com", databaseURL: "https://paoshuv-c260d-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "paoshuv-c260d" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user = null;

        // --- 2. AUTH ---
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').style.display='none';
                document.getElementById('main-app').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('auth-screen').style.display='flex';
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        const App = {
            login: () => {
                const e = document.getElementById('l-email').value;
                const p = document.getElementById('l-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
            },
            register: async () => {
                const { value: form } = await Swal.fire({
                    title: 'Create Account',
                    html: '<input id="r-email" class="swal2-input" placeholder="Email"><input id="r-pass" type="password" class="swal2-input" placeholder="Password"><input id="r-name" class="swal2-input" placeholder="Display Name">',
                    focusConfirm: false, background: '#0f1923', color: '#fff',
                    preConfirm: () => [document.getElementById('r-email').value, document.getElementById('r-pass').value, document.getElementById('r-name').value]
                });
                if(form) {
                    try {
                        const cred = await auth.createUserWithEmailAndPassword(form[0], form[1]);
                        await db.collection('users').doc(cred.user.uid).set({
                            email: form[0], displayName: form[2], balance: 0, role: 'user', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        Swal.fire('Success', 'Account Created', 'success');
                    } catch(e) { Swal.fire('Error', e.message, 'error'); }
                }
            },
            logout: () => auth.signOut(),
            init: () => {
                // Listen to User Data
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        document.getElementById('u-bal').innerText = d.balance.toLocaleString(undefined, {minimumFractionDigits: 2});
                        document.getElementById('u-avatar').src = `https://ui-avatars.com/api/?name=${d.displayName}&background=00f3ff&color=000`;
                    }
                });
                Game.loadMatches();
                Wallet.loadPending();
                Wallet.loadHistory();
            }
        };

        // --- 3. GAME & ESCROW LOGIC ---
        const Game = {
            loadMatches: () => {
                db.collection('matches').where('status', 'in', ['open', 'active', 'dispute']).onSnapshot(snap => {
                    const l = document.getElementById('match-list'); l.innerHTML = '';
                    snap.forEach(doc => {
                        const m = doc.data();
                        const isMe = m.creatorId === user.uid || m.joinerId === user.uid;
                        let actionBtn = '';
                        
                        if(m.status === 'open' && m.creatorId !== user.uid) {
                            actionBtn = `<button onclick="Game.join('${doc.id}', ${m.amount})" class="btn-neon w-full py-2 text-sm mt-3">JOIN (${m.amount})</button>`;
                        } else if (m.status === 'active' && isMe) {
                            actionBtn = `<button onclick="Game.confirmResult('${doc.id}')" class="bg-green-600 text-white w-full py-2 mt-3 rounded font-bold hover:bg-green-500">CONFIRM WIN</button>`;
                        } else if (m.status === 'open' && m.creatorId === user.uid) {
                            actionBtn = `<button class="bg-gray-700 text-gray-400 w-full py-2 mt-3 rounded font-bold cursor-not-allowed">WAITING...</button>`;
                        } else {
                            actionBtn = `<div class="text-center mt-3 text-[var(--neon-blue)] font-bold animate-pulse">${m.status.toUpperCase()}</div>`;
                        }

                        l.innerHTML += `
                            <div class="glass p-5 border-l-4 ${m.status=='active'?'border-green-500':'border-[var(--neon-blue)]'} relative">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg text-white">${m.title}</h3>
                                        <p class="text-xs text-gray-400">Created by: ${m.creatorName}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-game text-2xl font-bold text-[var(--neon-blue)]">${m.amount}</p>
                                        <p class="text-[10px] text-gray-500 uppercase">Prize Pool: ${m.amount*2}</p>
                                    </div>
                                </div>
                                ${actionBtn}
                            </div>
                        `;
                    });
                });
            },
            createModal: async () => {
                const { value: form } = await Swal.fire({
                    title: 'Create Match',
                    html: '<input id="m-title" class="swal2-input" placeholder="Match Title (e.g. ROV 1v1)"><input id="m-amt" type="number" class="swal2-input" placeholder="Bet Amount">',
                    focusConfirm: false, background: '#0f1923', color: '#fff',
                    preConfirm: () => [document.getElementById('m-title').value, document.getElementById('m-amt').value]
                });
                if(form && form[0] && form[1]) {
                    // Check balance first
                    const uDoc = await db.collection('users').doc(user.uid).get();
                    if(uDoc.data().balance < Number(form[1])) return Swal.fire('Error', 'Insufficient Balance', 'error');

                    // Create Match (Escrow Logic handled by Backend/Admin in this version)
                    // In real production: Cloud Function triggers here to deduct balance immediately.
                    // Here: We create match, Admin/System approves deduction.
                    // For MVP: We assume user has balance, and we deduct via Transaction.
                    
                    // Client cannot deduct balance directly due to Rules. 
                    // We create a "match_request".
                    
                    try {
                        // 1. Create Transaction Record (Pending)
                        const txRef = await db.collection('transactions').add({
                            uid: user.uid, type: 'bet_lock', amount: -Number(form[1]), status: 'pending', 
                            refId: 'new_match', timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // 2. Create Match (Open)
                        await db.collection('matches').add({
                            title: form[0], amount: Number(form[1]), creatorId: user.uid, creatorName: user.email.split('@')[0],
                            status: 'open', txId: txRef.id, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        Swal.fire('Success', 'Match Created & Credit Locked', 'success');
                    } catch(e) { Swal.fire('Error', e.message, 'error'); }
                }
            },
            join: async (matchId, amount) => {
                const uDoc = await db.collection('users').doc(user.uid).get();
                if(uDoc.data().balance < amount) return Swal.fire('Error', 'Insufficient Balance', 'error');

                try {
                    // 1. Create Transaction (Lock Credit)
                    const txRef = await db.collection('transactions').add({
                        uid: user.uid, type: 'bet_lock', amount: -amount, status: 'pending',
                        refId: matchId, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 2. Update Match
                    await db.collection('matches').doc(matchId).update({
                        joinerId: user.uid, joinerName: user.email.split('@')[0], status: 'active',
                        joinerTxId: txRef.id
                    });
                    
                    Swal.fire('Success', 'Joined Match!', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },
            confirmResult: async (matchId) => {
                // In real app, both users confirm or upload proof.
                Swal.fire({
                    title: 'Claim Victory?', text: 'Admin will verify.', icon: 'question',
                    showCancelButton: true, background: '#0f1923', color: '#fff', confirmButtonText: 'Yes, I Won'
                }).then(async (res) => {
                    if(res.isConfirmed) {
                        await db.collection('matches').doc(matchId).update({ status: 'dispute', winnerClaim: user.uid });
                        Swal.fire('Submitted', 'Waiting for admin approval', 'success');
                    }
                });
            }
        };

        // --- 4. WALLET LOGIC ---
        const Wallet = {
            depositModal: async () => {
                const { value: amt } = await Swal.fire({ 
                    title: 'Deposit', input: 'number', inputPlaceholder: 'Amount', background: '#0f1923', color: '#fff' 
                });
                if(amt) {
                    await db.collection('transactions').add({
                        uid: user.uid, type: 'deposit', amount: Number(amt), status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    Swal.fire('Request Sent', 'Waiting for admin approval', 'success');
                }
            },
            withdrawModal: async () => {
                const { value: amt } = await Swal.fire({ 
                    title: 'Withdraw', input: 'number', inputPlaceholder: 'Amount', background: '#0f1923', color: '#fff' 
                });
                if(amt) {
                    await db.collection('transactions').add({
                        uid: user.uid, type: 'withdraw', amount: -Number(amt), status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    Swal.fire('Request Sent', 'Waiting for admin approval', 'success');
                }
            },
            loadPending: () => {
                db.collection('transactions').where('uid', '==', user.uid).where('status', '==', 'pending').onSnapshot(snap => {
                    const l = document.getElementById('pending-list'); l.innerHTML = '';
                    snap.forEach(doc => {
                        const t = doc.data();
                        l.innerHTML += `<div class="bg-[#0f1923] p-3 rounded flex justify-between border-l-2 border-yellow-500"><span>${t.type.toUpperCase()}</span><span class="text-yellow-500">${t.amount} (Pending)</span></div>`;
                    });
                });
            },
            loadHistory: () => {
                db.collection('transactions').where('uid', '==', user.uid).orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
                    const l = document.getElementById('hist-list'); l.innerHTML = '';
                    snap.forEach(doc => {
                        const t = doc.data();
                        const color = t.status=='success'?'text-green-500':(t.status=='pending'?'text-yellow-500':'text-red-500');
                        l.innerHTML += `<tr class="border-b border-gray-800"><td class="p-3 text-xs text-gray-500">${t.timestamp?.toDate().toLocaleDateString()}</td><td>${t.type}</td><td class="text-xs text-gray-600">${doc.id.slice(0,5)}</td><td class="font-bold ${t.amount>0?'text-green-400':'text-red-400'}">${t.amount}</td><td class="${color} uppercase text-xs">${t.status}</td></tr>`;
                    });
                });
            }
        };

        // --- 5. UI NAVIGATION ---
        const UI = {
            nav: (page) => {
                ['lobby', 'wallet', 'history'].forEach(p => {
                    document.getElementById('p-'+p).classList.add('hidden');
                    document.getElementById('nav-'+p).classList.remove('active', 'text-[var(--neon-blue)]');
                    document.getElementById('nav-'+p).classList.add('text-gray-500');
                });
                document.getElementById('p-'+page).classList.remove('hidden');
                document.getElementById('nav-'+page).classList.add('active', 'text-[var(--neon-blue)]');
                document.getElementById('nav-'+page).classList.remove('text-gray-500');
            }
        };
    </script>
</body>
</html>
