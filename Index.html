<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPS BATTLE - ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Bangers&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --p: #FFD700; --bg: #0a0a0a; --panel: #1a1a1a; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); color: #fff; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Custom UI */
        .glass-panel { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 215, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.7); border-radius: 16px; }
        .gold-text { background: linear-gradient(to bottom, #fff, #FFD700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Bangers', cursive; letter-spacing: 2px; }
        
        .btn-gold { background: linear-gradient(180deg, #FFD700 0%, #B8860B 100%); color: #000; font-weight: 800; border-radius: 12px; transition: 0.1s; box-shadow: 0 4px 0 #8B6914; transform: translateY(0); }
        .btn-gold:active { transform: translateY(4px); box-shadow: 0 0 0 #8B6914; }
        
        .btn-menu { background: #222; border: 1px solid #333; color: #888; border-radius: 12px; transition: 0.2s; }
        .btn-menu.active { border-color: #FFD700; color: #FFD700; background: rgba(255, 215, 0, 0.1); }

        /* Game UI */
        .hand-card { width: 90px; height: 90px; border-radius: 50%; background: #222; border: 4px solid #444; display: flex; justify-content: center; align-items: center; font-size: 3rem; cursor: pointer; transition: 0.2s; }
        .hand-card:hover { transform: scale(1.1); border-color: #FFD700; }
        .hand-card.selected { background: #FFD700; border-color: #fff; transform: scale(1.15); box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
        
        .vs-badge { font-family: 'Bangers'; font-size: 3rem; color: #ff4d4d; text-shadow: 0 0 10px red; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .loader-wrap { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #FFD700; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <div id="loader" class="loader-wrap"><div class="spinner"></div><p class="absolute mt-20 text-[#FFD700] text-xs font-bold animate-pulse">CONNECTING...</p></div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-6 hidden">
        <div class="glass-panel w-full max-w-sm p-8 text-center animate__animated animate__zoomIn">
            <h1 class="text-6xl gold-text mb-2">RPS BATTLE</h1>
            <p class="text-gray-500 text-xs tracking-widest mb-8">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
            
            <div id="form-login">
                <input id="l-email" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl text-center text-white mb-3 focus:border-[#FFD700] outline-none" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                <input id="l-pass" type="password" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl text-center text-white mb-6 focus:border-[#FFD700] outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button onclick="Auth.login()" class="btn-gold w-full py-3 text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p class="mt-4 text-xs text-gray-500 cursor-pointer hover:text-white" onclick="UI.toggleAuth('reg')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</p>
            </div>

            <div id="form-reg" class="hidden">
                <input id="r-name" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl mb-2 text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                <input id="r-email" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl mb-2 text-white" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                <input id="r-pass" type="password" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl mb-4 text-white" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button onclick="Auth.reg()" class="btn-gold w-full py-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                <p class="mt-4 text-xs text-gray-500 cursor-pointer hover:text-white" onclick="UI.toggleAuth('log')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-md mx-auto min-h-screen relative shadow-2xl border-x border-[#222]">
        
        <header class="p-4 flex justify-between items-center bg-[#111]/90 backdrop-blur sticky top-0 z-40 border-b border-[#222]">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full border-2 border-[#FFD700] p-0.5"><img id="u-img" class="w-full h-full rounded-full bg-black object-cover"></div>
                <div>
                    <div class="text-[10px] text-[#FFD700] font-bold">CREDITS</div>
                    <div id="u-bal" class="text-2xl font-bold font-['Bangers'] tracking-wider leading-none">0</div>
                </div>
            </div>
            <button onclick="Auth.logout()" class="w-10 h-10 bg-[#222] rounded-lg text-gray-500 hover:text-red-500"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <main id="p-lobby" class="p-4 space-y-6 animate__animated animate__fadeIn">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="UI.modal('deposit')" class="glass-panel p-4 flex flex-col items-center gap-2 hover:border-green-500 transition group">
                    <div class="w-12 h-12 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-plus"></i></div>
                    <span class="text-sm font-bold text-gray-300">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                </button>
                <button onclick="UI.modal('withdraw')" class="glass-panel p-4 flex flex-col items-center gap-2 hover:border-red-500 transition group">
                    <div class="w-12 h-12 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-minus"></i></div>
                    <span class="text-sm font-bold text-gray-300">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                </button>
            </div>

            <div class="glass-panel p-5">
                <h3 class="text-[#FFD700] font-bold text-lg mb-3 flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô</h3>
                <div class="flex gap-2">
                    <input id="new-room-bet" type="number" class="w-full bg-[#111] border border-[#333] p-3 rounded-xl text-center text-[#FFD700] font-bold text-xl outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô">
                    <button onclick="Game.create()" class="btn-gold px-6 whitespace-nowrap">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 text-center">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô)</p>
            </div>

            <div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-white font-bold"><i class="fa-solid fa-gamepad text-[#FFD700] mr-2"></i>‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (Lobby)</h3>
                    <span class="text-xs text-gray-500 bg-[#222] px-2 py-1 rounded">Online: <span id="online-count">0</span></span>
                </div>
                <div id="room-list" class="space-y-3 pb-20">
                    <p class="text-center text-gray-600 py-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</p>
                </div>
            </div>
        </main>

        <main id="p-game" class="hidden p-4 h-[calc(100vh-80px)] flex flex-col relative bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
            
            <div class="flex justify-between items-start mb-6">
                <div class="text-xs text-gray-400 bg-black/50 px-3 py-1 rounded-full border border-white/10">ROOM: <span id="g-room-id" class="text-[#FFD700] font-bold">...</span></div>
                <div class="text-center">
                    <div class="text-[10px] text-gray-500 font-bold mb-1">POT SIZE</div>
                    <div id="g-pot" class="text-2xl font-['Bangers'] text-[#FFD700] tracking-widest leading-none">0</div>
                </div>
                <button onclick="Game.leave()" class="text-xs bg-red-900/50 text-red-400 px-3 py-1 rounded hover:bg-red-500 hover:text-white transition">‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            </div>

            <div class="flex-1 flex flex-col justify-center items-center relative">
                
                <div class="absolute top-0 text-center transition-all duration-500" id="area-p2">
                    <div class="w-16 h-16 rounded-full border-2 border-red-500 mx-auto mb-2 p-0.5"><img id="g-p2-img" class="w-full h-full rounded-full bg-black"></div>
                    <div id="g-p2-name" class="text-xs font-bold text-gray-400">Waiting...</div>
                    <div id="g-p2-choice" class="mt-2 text-4xl hidden animate__animated">‚úä</div>
                </div>

                <div class="z-10 text-center">
                    <div id="vs-badge" class="vs-badge hidden">VS</div>
                    <div id="timer" class="text-6xl font-['Bangers'] text-white drop-shadow-lg hidden">3</div>
                    <div id="status-text" class="text-xl font-bold text-[#FFD700] animate-pulse">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô...</div>
                    <button id="btn-ready" onclick="Game.ready()" class="btn-gold px-8 py-3 text-xl mt-4 shadow-lg hidden">‡∏û‡∏£‡πâ‡∏≠‡∏°!</button>
                </div>

                <div class="absolute bottom-0 text-center transition-all duration-500" id="area-p1">
                    <div id="g-p1-choice" class="mb-4 text-4xl hidden animate__animated">‚úä</div>
                    <div class="w-16 h-16 rounded-full border-2 border-green-500 mx-auto mb-2 p-0.5"><img id="g-p1-img" class="w-full h-full rounded-full bg-black"></div>
                    <div id="g-p1-name" class="text-xs font-bold text-gray-400">You</div>
                </div>
            </div>

            <div id="controls" class="mt-auto grid grid-cols-3 gap-4 mb-4 opacity-50 pointer-events-none transition duration-300">
                <div onclick="Game.move('rock')" class="hand-card mx-auto" id="btn-rock">‚úä</div>
                <div onclick="Game.move('paper')" class="hand-card mx-auto" id="btn-paper">‚úã</div>
                <div onclick="Game.move('scissors')" class="hand-card mx-auto" id="btn-scissors">‚úåÔ∏è</div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 w-full h-[70px] bg-[#0a0a0a] border-t border-[#222] flex justify-around items-center px-4 z-50 max-w-md mx-auto right-0">
            <button class="btn-menu active w-full h-12 mx-1 flex flex-col items-center justify-center text-[10px]" onclick="location.reload()"><i class="fa-solid fa-home text-lg mb-1"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <button class="btn-menu w-full h-12 mx-1 flex flex-col items-center justify-center text-[10px]" onclick="UI.history()"><i class="fa-solid fa-list text-lg mb-1"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </nav>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); const auth = firebase.auth();
        let user=null, userData={}, curRoom=null, roomUnsub=null;

        auth.onAuthStateChanged(u => {
            document.getElementById('loader').style.display='none';
            if(u) { user=u; document.getElementById('auth-screen').style.display='none'; document.getElementById('app-screen').classList.remove('hidden'); App.init(); }
            else { document.getElementById('auth-screen').style.display='flex'; }
        });

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e=>Swal.fire('Error',e.message,'error')),
            reg: () => {
                const d={n:document.getElementById('r-name').value, e:document.getElementById('r-email').value, p:document.getElementById('r-pass').value};
                auth.createUserWithEmailAndPassword(d.e,d.p).then(c=>{
                    db.ref('users/'+c.user.uid).set({name:d.n, email:d.e, balance:0});
                }).catch(e=>Swal.fire('Error',e.message,'error'));
            },
            logout: () => auth.signOut()
        };

        const App = {
            init: () => {
                // User Listener
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    document.getElementById('u-bal').innerText = `‡∏ø${(userData.balance||0).toLocaleString()}`;
                    document.getElementById('u-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=FFD700&color=000`;
                });
                
                // Rooms Listener (Lobby)
                db.ref('rooms').on('value', s => {
                    const l = document.getElementById('room-list'); l.innerHTML='';
                    let count = 0;
                    s.forEach(d => {
                        const r = d.val();
                        if(r.status === 'waiting') {
                            count++;
                            l.innerHTML += `
                                <div class="glass-panel p-4 flex justify-between items-center animate__animated animate__fadeInUp">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-[#222] border border-[#333] flex items-center justify-center text-2xl">üëë</div>
                                        <div>
                                            <p class="text-xs text-gray-400">‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${r.p1.name}</p>
                                            <p class="text-[#FFD700] font-bold text-lg">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: ‡∏ø${r.bet}</p>
                                        </div>
                                    </div>
                                    ${r.p1.uid===user.uid 
                                        ? `<button onclick="Game.cancel('${d.key}')" class="bg-red-900/50 text-red-400 px-4 py-2 rounded-lg text-xs hover:bg-red-500 hover:text-white transition">‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á</button>`
                                        : `<button onclick="Game.join('${d.key}')" class="btn-gold px-6 py-2 text-sm shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>`
                                    }
                                </div>`;
                        }
                    });
                    if(count===0) l.innerHTML = '<div class="text-center text-gray-600 py-10 border border-dashed border-[#222] rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢!</div>';
                    document.getElementById('online-count').innerText = count; // Fake online count using room count for now
                });
            }
        };

        const Game = {
            create: () => {
                const bet = Number(document.getElementById('new-room-bet').value);
                if(!bet || bet <= 0) return Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô','','warning');
                if(bet > userData.balance) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô','error');

                // Transaction: Create Room & Deduct Balance
                const roomId = db.ref('rooms').push().key;
                const roomData = {
                    bet: bet,
                    status: 'waiting',
                    p1: { uid: user.uid, name: userData.name, move: '', ready: false },
                    created: Date.now()
                };

                const updates = {};
                updates['rooms/'+roomId] = roomData;
                updates['users/'+user.uid+'/balance'] = userData.balance - bet;
                
                db.ref().update(updates).then(() => {
                    Game.enter(roomId);
                });
            },
            join: (roomId) => {
                db.ref('rooms/'+roomId).transaction(r => {
                    if (r && r.status === 'waiting' && !r.p2) {
                        if(userData.balance < r.bet) return; // Client check (Security rule handles server side)
                        r.p2 = { uid: user.uid, name: userData.name, move: '', ready: false };
                        r.status = 'ready_check';
                        return r;
                    }
                    return; // Abort
                }, (err, committed, s) => {
                    if (committed) {
                        const r = s.val();
                        // Deduct balance P2
                        db.ref('users/'+user.uid).update({balance: userData.balance - r.bet});
                        Game.enter(roomId);
                    } else {
                        Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','error');
                    }
                });
            },
            enter: (roomId) => {
                curRoom = roomId;
                document.getElementById('p-lobby').classList.add('hidden');
                document.getElementById('p-game').classList.remove('hidden');
                document.getElementById('g-room-id').innerText = roomId.substring(0,6);
                
                // Listener
                roomUnsub = db.ref('rooms/'+roomId).on('value', s => {
                    const r = s.val();
                    if(!r) { Game.leave(true); return; } // Room deleted

                    // Update UI
                    document.getElementById('g-pot').innerText = `‡∏ø${r.bet * 2}`;
                    
                    const me = r.p1.uid === user.uid ? 'p1' : 'p2';
                    const opp = me === 'p1' ? 'p2' : 'p1';

                    // Update Opponent UI
                    if(r[opp]) {
                        document.getElementById('g-p2-name').innerText = r[opp].name;
                        document.getElementById('g-p2-img').src = `https://ui-avatars.com/api/?name=${r[opp].name}`;
                    } else {
                        document.getElementById('g-p2-name').innerText = '‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á...';
                        document.getElementById('g-p2-img').src = '';
                    }
                    document.getElementById('g-p1-img').src = `https://ui-avatars.com/api/?name=${userData.name}`;

                    const statusTxt = document.getElementById('status-text');
                    const btnReady = document.getElementById('btn-ready');
                    const controls = document.getElementById('controls');
                    const vsBadge = document.getElementById('vs-badge');

                    // Game States
                    if(r.status === 'waiting') {
                        statusTxt.innerText = "‡∏£‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á...";
                        btnReady.classList.add('hidden');
                    }
                    else if(r.status === 'ready_check') {
                        if(!r[me].ready) {
                            statusTxt.innerText = "‡∏Å‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°!";
                            btnReady.classList.remove('hidden');
                        } else {
                            statusTxt.innerText = "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏Å‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°...";
                            btnReady.classList.add('hidden');
                        }
                    }
                    else if(r.status === 'playing') {
                        btnReady.classList.add('hidden');
                        vsBadge.classList.remove('hidden');
                        
                        // Countdown Logic handled by server/admin script simulation below
                        if(!r[me].move) {
                            statusTxt.innerText = "‡∏≠‡∏≠‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡πÄ‡∏•‡∏¢!";
                            controls.style.opacity = 1; 
                            controls.style.pointerEvents = 'auto';
                        } else {
                            statusTxt.innerText = "‡∏£‡∏≠‡∏ú‡∏•‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô...";
                            controls.style.opacity = 0.5; 
                            controls.style.pointerEvents = 'none';
                        }
                    }
                    else if(r.status === 'finished') {
                        Game.showResult(r, me, opp);
                    }
                });
            },
            ready: () => {
                db.ref(`rooms/${curRoom}`).transaction(r => {
                    if(r) {
                        const me = r.p1.uid === user.uid ? 'p1' : 'p2';
                        r[me].ready = true;
                        if(r.p1.ready && r.p2.ready) r.status = 'playing';
                    }
                    return r;
                });
            },
            move: (m) => {
                document.querySelectorAll('.hand-card').forEach(e=>e.classList.remove('selected'));
                document.getElementById('btn-'+m).classList.add('selected');
                
                db.ref(`rooms/${curRoom}`).transaction(r => {
                    if(r && r.status === 'playing') {
                        const me = r.p1.uid === user.uid ? 'p1' : 'p2';
                        r[me].move = m;
                        // Client-side Win Logic Trigger (Safe enough for demo)
                        const opp = me === 'p1' ? 'p2' : 'p1';
                        if(r[opp].move) {
                            // Calculate Winner
                            const m1 = r[me].move, m2 = r[opp].move;
                            let res = 'draw';
                            if((m1=='rock'&&m2=='scissors') || (m1=='paper'&&m2=='rock') || (m1=='scissors'&&m2=='paper')) res = me;
                            else if(m1 !== m2) res = opp;
                            
                            r.winner = res;
                            r.status = 'finished';
                        }
                    }
                    return r;
                });
            },
            showResult: (r, me, opp) => {
                const map = {rock:'‚úä', paper:'‚úã', scissors:'‚úåÔ∏è'};
                document.getElementById('g-p1-choice').innerText = map[r[me].move];
                document.getElementById('g-p2-choice').innerText = map[r[opp].move];
                
                document.getElementById('g-p1-choice').classList.remove('hidden', 'animate__zoomIn');
                document.getElementById('g-p2-choice').classList.remove('hidden', 'animate__zoomIn');
                document.getElementById('g-p1-choice').classList.add('animate__zoomIn');
                document.getElementById('g-p2-choice').classList.add('animate__zoomIn');

                let title = '', msg = '';
                if(r.winner === 'draw') {
                    title = '‡πÄ‡∏™‡∏°‡∏≠!'; msg = '‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô';
                    if(r.p1.uid === user.uid) { // Prevent double refund
                        const refund = {};
                        refund['users/'+r.p1.uid+'/balance'] = (userData.balance + r.bet); // Just add locally for UX, DB updates via logic
                        // In real production, use Cloud Functions. Here we rely on Admin script or Client trust (Demo).
                        // Let's create a payout transaction if I am the winner or draw
                        db.ref('users/'+user.uid).update({balance: userData.balance + r.bet});
                    }
                } else if(r.winner === me) {
                    title = '‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞!'; msg = `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏ø${r.bet*2}`;
                    db.ref('users/'+user.uid).update({balance: userData.balance + (r.bet*2)});
                } else {
                    title = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ!'; msg = '‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞';
                }

                Swal.fire({
                    title: title,
                    text: msg,
                    icon: r.winner===me?'success':(r.winner==='draw'?'info':'error'),
                    background: '#111', color:'#fff', confirmButtonColor: '#FFD700'
                }).then(() => {
                    if(r.p1.uid === user.uid) db.ref('rooms/'+curRoom).remove(); // Host cleans up
                    Game.leave();
                });
            },
            cancel: (rid) => {
                // Refund before delete
                db.ref('rooms/'+rid).once('value', s => {
                    const r = s.val();
                    db.ref('users/'+user.uid).update({balance: userData.balance + r.bet});
                    db.ref('rooms/'+rid).remove();
                });
            },
            leave: (force=false) => {
                if(curRoom) {
                    db.ref('rooms/'+curRoom).off();
                    curRoom = null;
                }
                document.getElementById('p-game').classList.add('hidden');
                document.getElementById('p-lobby').classList.remove('hidden');
                if(force) Swal.fire('‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î','','info');
            }
        };

        const UI = {
            toggleAuth: (m) => { document.getElementById('form-login').style.display=m=='log'?'block':'none'; document.getElementById('form-reg').style.display=m=='reg'?'block':'none'; },
            modal: async (type) => {
                const {value: amt} = await Swal.fire({
                    title: type=='deposit'?'‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï',
                    input: 'number',
                    inputPlaceholder: '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                    background: '#222', color: '#fff', confirmButtonColor: '#FFD700',
                    showCancelButton: true
                });
                if(amt && amt > 0) {
                    if(type=='withdraw' && amt > userData.balance) return Swal.fire('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
                    db.ref('transactions').push({uid:user.uid, name:userData.name, type:type, amount:Number(amt), status:'pending', timestamp:Date.now()});
                    if(type=='withdraw') db.ref('users/'+user.uid).update({balance: userData.balance - Number(amt)});
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','success');
                }
            },
            history: () => {
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).once('value', s => {
                    let html = '<div class="text-left">';
                    s.forEach(d => {
                        const t = d.val();
                        html += `<div class="p-2 border-b border-gray-700 flex justify-between text-sm"><span>${t.type}</span><span class="${t.status=='approved'?'text-green-400':'text-yellow-400'}">${t.amount} (${t.status})</span></div>`;
                    });
                    html += '</div>';
                    Swal.fire({title:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', html:html, background:'#222', color:'#fff'});
                });
            }
        };
    </script>
</body>
</html>
