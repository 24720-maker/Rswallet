<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA - ลูกค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style> 
        body { font-family: 'Prompt', sans-serif; background-color: #f1f5f9; } 
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <p class="text-blue-600 font-bold animate-pulse">กำลังโหลดข้อมูล...</p>
    </div>

    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 hidden bg-gradient-to-br from-blue-100 to-indigo-200">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform hover:scale-[1.01] transition duration-300">
            <div class="bg-blue-600 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-blue-700 opacity-20 transform rotate-12 scale-150"></div>
                <h1 class="text-3xl font-bold text-white relative z-10 tracking-widest">FAFADA</h1>
                <p class="text-blue-100 text-sm relative z-10">ระบบกระเป๋าเงินออนไลน์</p>
            </div>
            
            <div class="flex border-b">
                <button onclick="toggleAuth('login')" id="tabLogin" class="flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition">เข้าสู่ระบบ</button>
                <button onclick="toggleAuth('register')" id="tabRegister" class="flex-1 py-4 font-bold text-gray-400 hover:bg-gray-50 transition">สมัครสมาชิก</button>
            </div>

            <div class="p-8">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 font-bold ml-1">อีเมล</label>
                        <input type="email" id="lEmail" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50" placeholder="your@email.com" required>
                    </div>
                    <div class="mb-6">
                        <label class="text-xs text-gray-500 font-bold ml-1">รหัสผ่าน</label>
                        <input type="password" id="lPass" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">เข้าสู่ระบบ</button>
                </form>

                <form id="registerForm" onsubmit="handleRegister(event)" class="hidden">
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 font-bold ml-1">ชื่อที่แสดง</label>
                        <input type="text" id="rName" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-gray-50" required>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 font-bold ml-1">อีเมล</label>
                        <input type="email" id="rEmail" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-gray-50" required>
                    </div>
                    <div class="mb-6">
                        <label class="text-xs text-gray-500 font-bold ml-1">รหัสผ่าน</label>
                        <input type="password" id="rPass" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-gray-50" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition">สมัครสมาชิก</button>
                    <p class="text-xs text-center mt-4 text-gray-400">ใช้อีเมล farisxuma1@gmail.com ระบบจะตั้งเป็น Admin</p>
                </form>
            </div>
        </div>
    </div>

    <div id="dashScreen" class="min-h-screen hidden pb-12">
        <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200">
            <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">F</div>
                    <span class="text-xl font-bold text-blue-900 tracking-wide">FAFADA</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="uName" class="font-bold text-sm text-gray-800">...</div>
                        <div id="uEmail" class="text-xs text-gray-500">...</div>
                    </div>
                    <button onclick="doLogout()" class="w-10 h-10 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-4 py-8">
            <div id="newsBox" class="hidden mb-8 bg-gradient-to-r from-orange-50 to-amber-50 border-l-4 border-orange-400 p-4 rounded-r-lg shadow-sm flex items-start gap-3 animate-pulse">
                <i class="fas fa-bullhorn text-orange-500 mt-1"></i>
                <div>
                    <h3 id="newsTitle" class="font-bold text-orange-900">ประกาศ</h3>
                    <p id="newsContent" class="text-sm text-orange-800 mt-1">...</p>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-3xl p-8 text-white shadow-2xl mb-8 relative overflow-hidden transform hover:scale-[1.01] transition duration-500">
                <div class="absolute -right-10 -top-10 bg-white opacity-10 rounded-full w-60 h-60 blur-2xl"></div>
                <div class="absolute -left-10 -bottom-10 bg-black opacity-10 rounded-full w-40 h-40 blur-xl"></div>
                
                <div class="relative z-10">
                    <p class="text-blue-200 text-sm mb-1 font-medium tracking-wide">ยอดเงินคงเหลือสุทธิ</p>
                    <h1 class="text-5xl font-bold mb-4 tracking-tight">฿ <span id="uBal">0.00</span></h1>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-fit px-3 py-1 rounded-full backdrop-blur-sm border border-white/10">
                        <i class="fas fa-id-card"></i> Wallet ID: <span id="uID">...</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-xl h-fit border border-gray-100">
                    <h3 class="font-bold text-lg mb-6 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-exchange-alt text-blue-600"></i> ทำรายการ
                    </h3>
                    
                    <div class="flex bg-gray-100 p-1.5 rounded-xl mb-6">
                        <button onclick="setType('deposit')" id="bD" class="flex-1 py-3 text-sm font-bold bg-white text-green-600 shadow rounded-lg transition-all">ฝากเงิน</button>
                        <button onclick="setType('withdraw')" id="bW" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-red-500 transition-all">ถอนเงิน</button>
                    </div>
                    
                    <form onsubmit="subTxn(event)">
                        <label class="text-xs text-gray-500 font-bold ml-1 mb-1 block">จำนวนเงิน (บาท)</label>
                        <div class="relative mb-4">
                            <span class="absolute left-4 top-3.5 text-gray-400">฿</span>
                            <input type="number" id="amt" class="w-full pl-10 pr-4 py-3 border rounded-xl text-lg outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition" placeholder="0.00" step="0.01" min="1" required oninput="calc()">
                        </div>
                        
                        <div id="fee" class="hidden mb-6 bg-red-50 p-4 rounded-xl border border-red-100 text-sm">
                            <div class="flex justify-between text-red-500 mb-1"><span>ค่าธรรมเนียม 5%</span><span id="txtF">0.00</span></div>
                            <div class="border-t border-red-200 my-1"></div>
                            <div class="flex justify-between font-bold text-gray-800"><span>ได้รับจริง</span><span id="txtN">0.00</span></div>
                        </div>
                        
                        <button id="bS" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold shadow-lg transition flex justify-center items-center gap-2">
                            <i class="fas fa-check-circle"></i> ยืนยันฝากเงิน
                        </button>
                    </form>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-history text-blue-600"></i> ประวัติล่าสุด</h3>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">Real-time</span>
                    </div>
                    
                    <div class="overflow-auto max-h-[500px] pr-2 custom-scrollbar">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 rounded-l-lg">รายการ</th>
                                    <th class="p-4">เวลา</th>
                                    <th class="p-4 text-right">ยอดเงิน</th>
                                    <th class="p-4 text-center rounded-r-lg">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="hist" class="divide-y divide-gray-100"></tbody>
                        </table>
                        <div id="noHist" class="flex flex-col items-center justify-center py-12 text-gray-400 hidden">
                            <i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i>
                            <p>ยังไม่มีรายการ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.firebasestorage.app",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419",
            measurementId: "G-Q73X8Q841W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let user, userData, type='deposit';

        // 1. Auth Listener
        onAuthStateChanged(auth, (u) => {
            document.getElementById('loader').classList.add('hidden');
            if(u) {
                user = u;
                // ดึงข้อมูล Realtime User
                onSnapshot(doc(db, "users", u.uid), (s) => {
                    if(s.exists()) {
                        userData = s.data();
                        initUI();
                    }
                });
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('dashScreen').classList.add('hidden');
            }
        });

        function initUI() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashScreen').classList.remove('hidden');
            document.getElementById('uName').innerText = userData.displayName;
            document.getElementById('uEmail').innerText = userData.email;
            document.getElementById('uID').innerText = userData.uid.slice(0,6);
            document.getElementById('uBal').innerText = userData.balance.toLocaleString('th-TH', {minimumFractionDigits:2});
            
            // เรียกฟังก์ชัน Realtime Listener
            loadHist(); 
            loadNews();
        }

        // Toggle UI
        window.toggleAuth = (m) => {
            if(m==='login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition";
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-gray-400 hover:bg-gray-50 transition";
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-green-600 border-b-2 border-green-600 bg-green-50 transition";
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-gray-400 hover:bg-gray-50 transition";
            }
        };

        window.handleLogin = async(e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); }
            catch(e) { Swal.fire('เข้าสู่ระบบไม่สำเร็จ', 'อีเมลหรือรหัสผ่านผิด', 'error'); }
        };

        window.handleRegister = async(e) => {
            e.preventDefault();
            const em = document.getElementById('rEmail').value, pw = document.getElementById('rPass').value, nm = document.getElementById('rName').value;
            try {
                const r = await createUserWithEmailAndPassword(auth, em, pw);
                await setDoc(doc(db, "users", r.user.uid), {
                    uid: r.user.uid, email: em, displayName: nm, role: em==='farisxuma1@gmail.com'?'admin':'user', balance: 0, createdAt: new Date()
                });
                Swal.fire('สำเร็จ', 'สมัครสมาชิกเรียบร้อย', 'success');
            } catch(e) { Swal.fire('เกิดข้อผิดพลาด', e.message, 'error'); }
        };

        window.doLogout = () => signOut(auth);

        window.setType = (t) => {
            type=t;
            const bD=document.getElementById('bD'), bW=document.getElementById('bW'), bS=document.getElementById('bS');
            if(t==='deposit') {
                bD.className="flex-1 py-3 text-sm font-bold bg-white text-green-600 shadow rounded-lg transition-all";
                bW.className="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-red-500 transition-all";
                bS.className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold shadow-lg transition flex justify-center items-center gap-2";
                bS.innerHTML='<i class="fas fa-check-circle"></i> ยืนยันฝากเงิน';
                document.getElementById('fee').classList.add('hidden');
            } else {
                bW.className="flex-1 py-3 text-sm font-bold bg-white text-red-600 shadow rounded-lg transition-all";
                bD.className="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-green-600 transition-all";
                bS.className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold shadow-lg transition flex justify-center items-center gap-2";
                bS.innerHTML='<i class="fas fa-paper-plane"></i> ยืนยันถอนเงิน';
                document.getElementById('fee').classList.remove('hidden');
            }
            calc();
        };

        window.calc = () => {
            const v = parseFloat(document.getElementById('amt').value)||0;
            if(type==='withdraw') {
                const f = v*0.05;
                document.getElementById('txtF').innerText = f.toLocaleString();
                document.getElementById('txtN').innerText = (v-f).toLocaleString();
            }
        };

        window.subTxn = async(e) => {
            e.preventDefault();
            const v = parseFloat(document.getElementById('amt').value);
            if(v<=0) return Swal.fire('แจ้งเตือน','ยอดเงินต้องมากกว่า 0','warning');
            if(type==='withdraw' && v > userData.balance) return Swal.fire('แจ้งเตือน','เงินไม่พอ','error');
            
            const f = type==='withdraw'?v*0.05:0;
            try {
                Swal.showLoading();
                await addDoc(collection(db, "transactions"), {
                    uid: user.uid, email: userData.email, userDisplayName: userData.displayName, type, amount: v, fee: f, netAmount: v-f, status: 'pending', timestamp: new Date()
                });
                Swal.close();
                Swal.fire('สำเร็จ','ส่งรายการเรียบร้อย รอตรวจสอบ','success');
                document.getElementById('amt').value=''; calc();
            } catch(e) { Swal.fire('Error',e.message,'error'); }
        };

        // Real-time History
        function loadHist() {
            onSnapshot(query(collection(db, "transactions"), where("uid","==",user.uid), orderBy("timestamp","desc"), limit(20)), (s) => {
                const t = document.getElementById('hist'); t.innerHTML='';
                if(s.empty) { document.getElementById('noHist').classList.remove('hidden'); return; }
                document.getElementById('noHist').classList.add('hidden');
                
                s.forEach(d=>{
                    const x=d.data(), c=x.type==='deposit'?'text-green-600':'text-red-600';
                    const icon = x.type==='deposit'?'fa-arrow-down':'fa-arrow-up';
                    let st = '';
                    if(x.status==='pending') st = '<span class="px-2 py-1 rounded bg-yellow-100 text-yellow-800 text-xs font-bold border border-yellow-200">รออนุมัติ</span>';
                    else if(x.status==='completed') st = '<span class="px-2 py-1 rounded bg-green-100 text-green-800 text-xs font-bold border border-green-200">สำเร็จ</span>';
                    else st = '<span class="px-2 py-1 rounded bg-red-100 text-red-800 text-xs font-bold border border-red-200">ปฏิเสธ</span>';

                    t.innerHTML += `
                        <tr class="hover:bg-blue-50/50 transition border-b last:border-0 border-gray-100">
                            <td class="p-4">
                                <span class="font-bold ${c} flex items-center gap-2">
                                    <i class="fas ${icon}"></i> ${x.type}
                                </span>
                            </td>
                            <td class="p-4 text-xs text-gray-500">${new Date(x.timestamp.seconds*1000).toLocaleString('th-TH')}</td>
                            <td class="p-4 text-right font-bold ${c}">${x.type==='deposit'?'+':'-'}${x.amount.toLocaleString()}</td>
                            <td class="p-4 text-center">${st}</td>
                        </tr>`;
                });
            });
        }

        // Real-time News
        function loadNews() {
            onSnapshot(query(collection(db, "announcements"), orderBy("createdAt","desc"), limit(1)), (s) => {
                if(!s.empty) {
                    const n = s.docs[0].data();
                    document.getElementById('newsBox').classList.remove('hidden');
                    document.getElementById('newsTitle').innerHTML = `<i class="fas fa-bullhorn"></i> ${n.title}`;
                    document.getElementById('newsContent').innerText = n.content;
                }
            });
        }
    </script>
</body>
</html>
