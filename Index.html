<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITANIUM - ADMIN CONTROL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>body{background:#0a0a0a;color:#ccc;font-family:'Kanit'} .card{background:#121212;border:1px solid #333;padding:20px;border-radius:10px} input{background:#000;border:1px solid #333;color:white;padding:8px;border-radius:6px;width:100%}</style>
</head>
<body class="p-6">

    <div id="auth" class="text-center mt-20">
        <h1 class="text-3xl text-[#D4AF37] font-bold mb-4">ADMIN</h1>
        <input id="pass" type="password" class="w-64 text-center" placeholder="Password">
        <button onclick="Admin.login()" class="bg-[#D4AF37] text-black px-6 py-2 rounded mt-2 font-bold">LOGIN</button>
    </div>

    <div id="panel" class="hidden max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="card lg:col-span-2">
            <h3 class="font-bold text-white mb-4">รายการฝาก-ถอน (Pending)</h3>
            <div id="tx-list" class="space-y-2 max-h-[500px] overflow-y-auto"></div>
        </div>

        <div class="card">
            <h3 class="font-bold text-white mb-4">ควบคุมระบบ</h3>
            <div class="flex gap-4 mb-4">
                <button id="btn-dep" onclick="Admin.toggle('dep')" class="w-full py-2 rounded bg-green-900 text-green-400 border border-green-500/30">ฝาก: ON</button>
                <button id="btn-wit" onclick="Admin.toggle('wit')" class="w-full py-2 rounded bg-green-900 text-green-400 border border-green-500/30">ถอน: ON</button>
            </div>
            
            <label class="text-xs text-gray-500">เปอร์เซ็นต์คืนยอดเสีย (%)</label>
            <div class="flex gap-2 mb-4">
                <input id="s-cb" type="number" placeholder="5">
                <button onclick="Admin.saveCB()" class="bg-blue-600 px-4 rounded text-white text-xs">SAVE</button>
            </div>

            <label class="text-xs text-gray-500">เพิ่มธนาคาร</label>
            <div class="flex gap-2">
                <input id="b-name" placeholder="ชื่อแบงค์">
                <input id="b-acc" placeholder="เลข">
                <button onclick="Admin.addBank()" class="bg-green-600 px-4 rounded text-white text-xs">+</button>
            </div>
            <div id="bank-list" class="mt-2 space-y-1 text-xs text-gray-500"></div>
        </div>

        <div class="card lg:col-span-3">
            <div class="flex justify-between mb-4">
                <h3 class="font-bold text-white">จัดการสมาชิก (หักเงิน/เพิ่มเงิน)</h3>
                <input onkeyup="Admin.filter(this.value)" class="w-64 bg-[#222]" placeholder="ค้นหา...">
            </div>
            <div id="user-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto"></div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); const auth = firebase.auth();

        let settings = {};

        const Admin = {
            login: () => { if(document.getElementById('pass').value=='admin'){ document.getElementById('auth').style.display='none'; document.getElementById('panel').style.display='grid'; Admin.init(); } },
            init: () => {
                db.ref('transactions').orderByChild('status').equalTo('pending').on('value', s => {
                    const l=document.getElementById('tx-list'); l.innerHTML='';
                    if(!s.exists()) l.innerHTML='<div class="text-center text-gray-600">ไม่มีรายการ</div>';
                    s.forEach(d => {
                        const t=d.val();
                        l.innerHTML += `
                            <div class="bg-[#222] p-3 rounded flex justify-between items-center border-l-4 ${t.type=='deposit'?'border-green-500':'border-red-500'}">
                                <div><b class="text-white">${t.type.toUpperCase()} ฿${t.amount}</b><br><span class="text-xs text-gray-400">${t.name} • ${t.time||t.bank_info}</span></div>
                                <div class="flex gap-2">
                                    <button onclick="Admin.tx('${d.key}','approved','${t.uid}',${t.amount},'${t.type}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">อนุมัติ</button>
                                    <button onclick="Admin.tx('${d.key}','rejected','${t.uid}',${t.amount},'${t.type}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs">ปฏิเสธ</button>
                                </div>
                            </div>`;
                    });
                });

                db.ref('users').on('value', s => {
                    const l=document.getElementById('user-list'); l.innerHTML='';
                    s.forEach(d => {
                        const u=d.val();
                        l.innerHTML += `
                            <div class="bg-[#1a1a1a] p-3 rounded border border-gray-800 user-item relative">
                                <div class="font-bold text-[#D4AF37]">${u.name}</div>
                                <div class="text-xs text-white">Credit: ${u.balance.toLocaleString()}</div>
                                <div class="text-[10px] text-gray-500">${u.bank} - ${u.acc}</div>
                                <div class="mt-2 flex gap-2">
                                    <button onclick="Admin.penalty('${d.key}','${u.name}')" class="flex-1 bg-red-900/50 text-red-400 text-xs py-1 rounded border border-red-500/20 hover:bg-red-600 hover:text-white">หักเงิน (Penalty)</button>
                                    <button onclick="Admin.give('${d.key}','${u.name}')" class="flex-1 bg-green-900/50 text-green-400 text-xs py-1 rounded border border-green-500/20 hover:bg-green-600 hover:text-white">เพิ่มเงิน</button>
                                </div>
                            </div>`;
                    });
                });

                db.ref('settings').on('value', s => {
                    settings = s.val() || {};
                    document.getElementById('s-cb').value = settings.cashbackPercent || 5;
                    const bd = document.getElementById('btn-dep'), bw = document.getElementById('btn-wit');
                    bd.innerText = `ฝาก: ${settings.isDepositActive===false?'OFF':'ON'}`;
                    bd.className = `w-full py-2 rounded border ${settings.isDepositActive===false?'bg-red-900 text-red-400 border-red-500/30':'bg-green-900 text-green-400 border-green-500/30'}`;
                    bw.innerText = `ถอน: ${settings.isWithdrawActive===false?'OFF':'ON'}`;
                    bw.className = `w-full py-2 rounded border ${settings.isWithdrawActive===false?'bg-red-900 text-red-400 border-red-500/30':'bg-green-900 text-green-400 border-green-500/30'}`;
                    
                    const bl = document.getElementById('bank-list'); bl.innerHTML='';
                    if(settings.banks) Object.entries(settings.banks).forEach(([k,v]) => bl.innerHTML+=`<div class="flex justify-between bg-[#222] p-1 px-2 rounded mb-1"><span>${v.name} ${v.acc}</span><span onclick="db.ref('settings/banks/${k}').remove()" class="text-red-500 cursor-pointer">x</span></div>`);
                });
            },
            tx: (k,s,u,a,t) => {
                db.ref('transactions/'+k).update({status:s});
                if(s=='approved') {
                    if(t=='deposit') {
                        db.ref('users/'+u).transaction(usr => { if(usr){ usr.balance+=a; usr.total_deposit=(usr.total_deposit||0)+a; } return usr; });
                    }
                    if(t=='withdraw') {
                        db.ref('users/'+u).transaction(usr => { if(usr){ usr.total_withdraw=(usr.total_withdraw||0)+a; } return usr; });
                    }
                }
                if(s=='rejected' && t=='withdraw') db.ref('users/'+u+'/balance').transaction(b => (b||0)+a); // Refund
            },
            toggle: (t) => {
                const k = t=='dep'?'isDepositActive':'isWithdrawActive';
                db.ref('settings').update({ [k]: settings[k]===false ? true : false });
            },
            penalty: async (uid, name) => {
                const {value:form} = await Swal.fire({
                    title: `ลงโทษหักเงิน: ${name}`,
                    html: `<input id="p-amt" type="number" class="swal2-input" placeholder="จำนวน"><input id="p-reason" class="swal2-input" placeholder="สาเหตุ (ลูกค้าจะเห็น)">`,
                    focusConfirm: false, background:'#111', color:'#fff',
                    preConfirm: () => [document.getElementById('p-amt').value, document.getElementById('p-reason').value]
                });
                if(form && form[0] && form[1]) {
                    const amt = Number(form[0]);
                    db.ref('users/'+uid+'/balance').transaction(b => (b||0) - amt);
                    db.ref('transactions').push({uid:uid, type:'penalty', amount:amt, reason:form[1], status:'completed', timestamp:Date.now()});
                    Swal.fire('เรียบร้อย','หักเงินแล้ว','success');
                }
            },
            give: async (uid, name) => {
                const {value:amt} = await Swal.fire({title:`เติมเงินพิเศษ: ${name}`, input:'number', background:'#111', color:'#fff'});
                if(amt) {
                    db.ref('users/'+uid+'/balance').transaction(b => (b||0) + Number(amt));
                    db.ref('transactions').push({uid:uid, type:'bonus', amount:Number(amt), status:'completed', timestamp:Date.now()});
                }
            },
            saveCB: () => db.ref('settings/cashbackPercent').set(Number(document.getElementById('s-cb').value)).then(()=>Swal.fire('Saved')),
            addBank: () => db.ref('settings/banks').push({name:document.getElementById('b-name').value, acc:document.getElementById('b-acc').value}),
            filter: (v) => { document.querySelectorAll('.user-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(v.toLowerCase()) ? 'flex' : 'none'); }
        };
    </script>
</body>
</html>
