<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS INFINITY - AI TRADING</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        /* --- VISUAL IDENTITY: Premium Dark Tech --- */
        :root {
            --gold-primary: #FFD700;
            --gold-dark: #B8860B;
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 215, 0, 0.2);
            --neon-green: #00ff88;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)),
                repeating-linear-gradient(45deg, #111 0, #111 1px, transparent 0, transparent 50%);
            background-size: 20px 20px;
            color: #ffffff;
            overflow-x: hidden;
            height: 100vh;
        }

        /* Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Typography */
        .font-tech { font-family: 'Rajdhani', sans-serif; }
        .text-gold { 
            background: linear-gradient(to bottom, #FFD700, #FDB931);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 0px 10px rgba(255, 215, 0, 0.3);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .btn-scan {
            background: linear-gradient(135deg, #FFD700, #B8860B);
            animation: pulse-gold 2s infinite;
        }
        .btn-click:active { transform: scale(0.95); transition: transform 0.1s; }

        /* Loader */
        .loader-ring {
            border: 4px solid #333;
            border-top: 4px solid var(--gold-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Bottom Nav */
        .bottom-nav {
            background: rgba(10, 10, 10, 0.95);
            border-top: 1px solid var(--glass-border);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .nav-item.active { color: var(--gold-primary); }
        
        /* Grayscale for Locked */
        .grayscale-mode { filter: grayscale(100%); pointer-events: none; opacity: 0.5; }
        
        /* Utility */
        .hidden-page { display: none; }

        /* Admin Button Special */
        .admin-btn-glow {
            position: relative;
            overflow: hidden;
            z-index: 1;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        .admin-btn-glow::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.2), transparent);
            transition: 0.5s;
            z-index: -1;
        }
        .admin-btn-glow:hover::before {
            left: 100%;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <div class="text-center">
            <div class="loader-ring mx-auto mb-4"></div>
            <h1 class="text-2xl font-bold tracking-widest text-gold italic">RS INFINITY</h1>
        </div>
    </div>

    <div id="auth-screen" class="hidden-page fixed inset-0 z-40 flex items-center justify-center p-6">
        <div class="glass-panel w-full max-w-sm p-8 rounded-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
            
            <h2 class="text-3xl font-bold text-center mb-6 italic text-gold" id="auth-title">เข้าสู่ระบบ</h2>
            
            <form id="login-form" class="space-y-4">
                <div id="name-field" class="hidden">
                    <label class="text-xs text-gray-400">ชื่อเล่น / ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-yellow-500 outline-none" placeholder="กรอกชื่อของคุณ">
                </div>
                <div>
                    <label class="text-xs text-gray-400">อีเมล</label>
                    <input type="email" id="email" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-yellow-500 outline-none" placeholder="example@email.com" required>
                </div>
                <div>
                    <label class="text-xs text-gray-400">รหัสผ่าน</label>
                    <input type="password" id="password" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-yellow-500 outline-none" placeholder="••••••••" required>
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-bold py-3 rounded-lg btn-click mt-4">เข้าสู่ระบบ</button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-400">
                <span id="auth-toggle-text">ยังไม่มีบัญชี?</span> <span onclick="toggleAuthMode()" class="text-yellow-400 cursor-pointer underline hover:text-yellow-300" id="auth-toggle-link">สมัครสมาชิก</span>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden-page flex-1 flex flex-col relative">
        
        <header class="flex justify-between items-center p-5 pt-8">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-bolt text-yellow-500"></i>
                <h1 class="text-xl font-bold italic tracking-wide">RS <span class="text-gold">INFINITY</span></h1>
            </div>
            <div class="flex items-center gap-3">
                 <div class="text-right">
                    <div id="header-username" class="text-xs text-yellow-500 font-bold">User</div>
                    <div class="text-[10px] text-gray-400" id="status-indicator">● Online</div>
                </div>
                <div class="w-10 h-10 rounded-full bg-gray-800 border border-yellow-500/50 flex items-center justify-center overflow-hidden">
                    <i class="fa-solid fa-user text-gray-400"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-24 px-4 relative">
            
            <div id="home-page" class="space-y-6">
                <div class="glass-panel p-4 rounded-xl flex justify-between items-center shadow-lg">
                    <div>
                        <div class="text-xs text-gray-400 flex items-center gap-1"><img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=025" class="w-3 h-3"> BTC/USDT</div>
                        <div id="btc-price" class="text-2xl font-tech font-bold text-white">$0.00</div>
                    </div>
                    <div class="h-8 w-[1px] bg-gray-700"></div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 flex items-center gap-1 justify-end"><img src="https://cryptologos.cc/logos/ethereum-eth-logo.png?v=025" class="w-3 h-3"> ETH/USDT</div>
                        <div id="eth-price" class="text-lg font-tech font-bold text-white">$0.00</div>
                    </div>
                </div>

                <div class="relative py-8 flex justify-center">
                    <button id="scan-btn" onclick="openScannerModal()" class="btn-scan w-52 h-52 rounded-full flex flex-col items-center justify-center relative z-10 animate-float btn-click shadow-[0_0_40px_rgba(255,215,0,0.3)] border-4 border-black group transition-all duration-300">
                        <i class="fa-solid fa-fingerprint text-5xl text-black mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-black font-bold text-xl tracking-tighter">สแกนตลาด</span>
                        <span class="text-black/70 text-xs mt-1">AI SMART SIGNAL</span>
                    </button>
                    <div class="absolute inset-0 bg-yellow-500/10 blur-3xl rounded-full z-0 transform scale-75"></div>
                </div>

                <div id="expired-alert" class="hidden glass-panel p-6 rounded-xl border border-red-500/50 bg-gradient-to-b from-red-900/40 to-black text-center animate-pulse">
                    <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fa-solid fa-lock text-red-500 text-2xl"></i>
                    </div>
                    <h3 class="text-red-400 font-bold text-lg">วันใช้งานหมดอายุ</h3>
                    <p class="text-sm text-gray-300 mt-1">กรุณาติดต่อแอดมินเพื่อต่ออายุการใช้งาน</p>
                    <button onclick="contactAdmin()" class="mt-4 px-6 py-2 bg-red-600 rounded-lg text-white text-sm font-bold shadow-lg">ต่ออายุทันที</button>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="glass-panel p-3 rounded-lg flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="fa-solid fa-chart-line"></i></div>
                        <div>
                            <div class="text-[10px] text-gray-400">ความแม่นยำ</div>
                            <div class="font-bold text-sm">92.4%</div>
                        </div>
                    </div>
                    <div class="glass-panel p-3 rounded-lg flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-purple-500/20 flex items-center justify-center text-purple-400"><i class="fa-solid fa-robot"></i></div>
                        <div>
                            <div class="text-[10px] text-gray-400">AI Model</div>
                            <div class="font-bold text-sm">V.3.5 Turbo</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chart-page" class="hidden-page h-full flex flex-col">
                <div class="glass-panel p-2 mb-2 rounded-lg flex gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="changeChart('BTCUSDT')" class="px-4 py-1.5 rounded bg-yellow-500/20 text-yellow-500 text-xs border border-yellow-500/50 font-bold">BTC</button>
                    <button onclick="changeChart('ETHUSDT')" class="px-4 py-1.5 rounded bg-gray-800 text-gray-400 text-xs hover:bg-gray-700">ETH</button>
                    <button onclick="changeChart('XAUUSD')" class="px-4 py-1.5 rounded bg-gray-800 text-gray-400 text-xs hover:bg-gray-700">ทองคำ</button>
                </div>
                <div id="tv_chart_container" class="flex-1 rounded-xl overflow-hidden glass-panel border-0"></div>
            </div>

            <div id="profile-page" class="hidden-page space-y-6">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden bg-gradient-to-br from-gray-900 via-black to-gray-900 border border-gray-800 shadow-xl">
                    <div class="flex justify-between items-start mb-8 z-10 relative">
                        <div>
                            <div class="italic text-gold font-bold text-xl tracking-widest">VIP MEMBER</div>
                            <div class="text-[10px] text-gray-500">RS INFINITY ACCESS</div>
                        </div>
                        <i class="fa-solid fa-crown text-yellow-600/50 text-5xl absolute right-0 -top-2"></i>
                    </div>
                    
                    <div class="mb-4 relative z-10">
                        <div class="text-xs text-gray-500">ชื่อบัญชีผู้ใช้</div>
                        <div id="profile-name-display" class="text-lg font-bold text-white tracking-wide">Loading...</div>
                        <div id="profile-email-display" class="text-xs text-gray-500 font-tech">...</div>
                    </div>

                    <div class="relative z-10 pt-4 border-t border-gray-800">
                        <div class="text-xs text-gray-500 mb-1 flex justify-between">
                            <span>เวลาคงเหลือ</span>
                            <span id="status-text" class="text-green-500 font-bold">Active</span>
                        </div>
                        <div id="countdown" class="text-2xl font-tech font-bold text-white tracking-widest">00 : 00 : 00 : 00</div>
                    </div>
                    
                    <div class="absolute top-0 -left-[100%] w-full h-full bg-gradient-to-r from-transparent via-white/5 to-transparent skew-x-12 animate-[shine_4s_infinite]"></div>
                </div>

                <div class="space-y-4">
                    <button id="contact-admin-btn" class="w-full glass-panel p-1 rounded-xl btn-click admin-btn-glow group">
                        <div class="bg-gray-900/90 rounded-lg p-4 flex items-center justify-between h-full">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-green-900 flex items-center justify-center text-white shadow-[0_0_10px_rgba(0,255,136,0.5)]">
                                    <i class="fa-brands fa-line text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-white font-bold group-hover:text-green-400 transition">ติดต่อแอดมิน</div>
                                    <div class="text-xs text-gray-400">เติมวันใช้งาน / แจ้งปัญหา</div>
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-600 group-hover:text-green-400 group-hover:translate-x-1 transition"></i>
                        </div>
                    </button>
                    
                    <button onclick="logout()" class="w-full glass-panel p-4 rounded-xl flex items-center justify-between btn-click text-red-400 border-red-900/30 hover:bg-red-900/10 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-red-900/20 flex items-center justify-center"><i class="fa-solid fa-power-off"></i></div>
                            <span>ออกจากระบบ</span>
                        </div>
                    </button>
                </div>
            </div>

        </main>

        <nav class="bottom-nav fixed bottom-0 w-full h-20 flex justify-around items-center px-2 z-30">
            <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center gap-1 p-2 w-20 btn-click" id="nav-home">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-light">หน้าหลัก</span>
            </button>
            <button onclick="switchTab('chart')" class="nav-item text-gray-500 flex flex-col items-center gap-1 p-2 w-20 btn-click" id="nav-chart">
                <i class="fa-solid fa-chart-simple text-xl mb-1"></i>
                <span class="text-[10px] font-light">กราฟ</span>
            </button>
            <button onclick="switchTab('profile')" class="nav-item text-gray-500 flex flex-col items-center gap-1 p-2 w-20 btn-click" id="nav-profile">
                <i class="fa-solid fa-user-astronaut text-xl mb-1"></i>
                <span class="text-[10px] font-light">โปรไฟล์</span>
            </button>
        </nav>
    </div>

    <div id="scanner-modal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="glass-panel w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 animate-float" style="animation: none; transition: transform 0.3s;">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-robot text-gold"></i>
                    <h3 class="text-xl font-bold text-white">ตั้งค่า AI</h3>
                </div>
                <button onclick="closeModal('scanner-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs text-gray-400 mb-2 block tracking-wider">เลือกสินทรัพย์ (ASSET)</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="selectAsset(this, 'BTC')" class="asset-btn bg-yellow-500 text-black font-bold py-3 rounded-lg border border-yellow-500 shadow-lg">BTC</button>
                        <button onclick="selectAsset(this, 'ETH')" class="asset-btn bg-gray-800 text-gray-400 py-3 rounded-lg border border-gray-700">ETH</button>
                        <button onclick="selectAsset(this, 'ทองคำ')" class="asset-btn bg-gray-800 text-gray-400 py-3 rounded-lg border border-gray-700">ทองคำ</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-400 mb-2 block tracking-wider">ช่วงเวลา (TIMEFRAME)</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="selectTF(this, '1m')" class="tf-btn bg-gray-800 text-gray-400 py-2 rounded-lg border border-gray-700 text-xs">1m</button>
                        <button onclick="selectTF(this, '5m')" class="tf-btn bg-yellow-500 text-black font-bold py-2 rounded-lg border border-yellow-500 text-xs shadow-lg">5m</button>
                        <button onclick="selectTF(this, '15m')" class="tf-btn bg-gray-800 text-gray-400 py-2 rounded-lg border border-gray-700 text-xs">15m</button>
                        <button onclick="selectTF(this, '30m')" class="tf-btn bg-gray-800 text-gray-400 py-2 rounded-lg border border-gray-700 text-xs">30m</button>
                    </div>
                </div>
                <button onclick="startScanning()" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-bold py-4 rounded-xl mt-2 shadow-[0_0_20px_rgba(255,215,0,0.3)] btn-click flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bolt"></i> เริ่มวิเคราะห์ตลาด
                </button>
            </div>
        </div>
    </div>

    <div id="processing-modal" class="hidden fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center">
        <div class="relative w-64 h-64">
            <div class="absolute inset-0 border-4 border-gray-800 rounded-full"></div>
            <div class="absolute inset-0 border-t-4 border-yellow-500 rounded-full animate-spin"></div>
            <div class="absolute inset-4 border-t-4 border-yellow-300 rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
            <div class="absolute inset-0 flex items-center justify-center flex-col">
                <i class="fa-solid fa-brain text-4xl text-gray-200 mb-2"></i>
                <div class="text-xs text-yellow-500 font-tech">AI WORKING</div>
            </div>
        </div>
        <h2 class="mt-8 text-2xl font-bold animate-pulse text-white">กำลังวิเคราะห์...</h2>
        <p class="text-gray-500 text-sm mt-2 font-tech">Checking EMA / RSI / MACD / Volume</p>
    </div>

    <div id="result-modal" class="hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="w-full max-w-sm border border-gray-800 bg-gray-900 rounded-2xl p-8 text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
            <button onclick="closeModal('result-modal')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            
            <div class="mb-2 text-xs text-gray-400">ผลการวิเคราะห์ AI</div>
            
            <div id="signal-badge" class="inline-flex items-center gap-2 px-8 py-3 rounded-full bg-green-500/10 text-green-400 font-bold border border-green-500/50 mb-8 text-2xl shadow-[0_0_30px_rgba(34,197,94,0.2)]">
                <i class="fa-solid fa-circle-arrow-up"></i> BUY
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center border-b border-gray-800 pb-3">
                    <span class="text-gray-400 text-sm">คู่เหรียญ</span>
                    <span id="res-pair" class="font-bold text-xl text-white">BTC/USDT</span>
                </div>
                <div class="flex justify-between items-center border-b border-gray-800 pb-3">
                    <span class="text-gray-400 text-sm">จุดเข้า</span>
                    <span id="res-entry" class="font-tech text-gold text-lg">ราคาปัจจุบัน (Market)</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Timeframe</span>
                    <span id="res-tf" class="text-white bg-gray-800 px-2 py-1 rounded text-xs">5m</span>
                </div>
            </div>

            <button onclick="closeModal('result-modal')" class="w-full py-3 rounded-lg bg-gray-800 text-white mt-8 hover:bg-gray-700 transition font-bold border border-gray-700">ปิดหน้าต่าง</button>
        </div>
    </div>

    <script type="module">
        // --- 1. FIREBASE CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.appspot.com",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let isExpired = true;
        let expiryTimer = null;
        let adminLink = "https://line.me/ti/p/~YOUR_LINE_ID"; // Default Fallback
        let selectedAsset = "BTC";
        let selectedTF = "5m";

        // --- 2. AUTHENTICATION LOGIC ---
        const loginForm = document.getElementById('login-form');
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const loadingScreen = document.getElementById('loading-screen');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initUserData(user.uid);
            } else {
                showAuth();
            }
        });

        function showAuth() {
            loadingScreen.style.display = 'none';
            appContainer.classList.add('hidden-page');
            authScreen.classList.remove('hidden-page');
            if(expiryTimer) clearInterval(expiryTimer);
        }

        function showApp(userData) {
            loadingScreen.style.display = 'none';
            authScreen.classList.add('hidden-page');
            appContainer.classList.remove('hidden-page');
            
            // Set User Info
            const displayName = userData.username || userData.email.split('@')[0];
            document.getElementById('header-username').innerText = displayName;
            document.getElementById('profile-name-display').innerText = displayName;
            document.getElementById('profile-email-display').innerText = userData.email;
            
            // Init Chart
            loadTradingView('BTCUSDT');
        }

        // Login / Register Toggle
        let isLoginMode = true;
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleLink = document.getElementById('auth-toggle-link');
            const nameField = document.getElementById('name-field');

            if (isLoginMode) {
                title.innerText = "เข้าสู่ระบบ";
                submitBtn.innerText = "เข้าสู่ระบบ";
                toggleText.innerText = "ยังไม่มีบัญชี?";
                toggleLink.innerText = "สมัครสมาชิก";
                nameField.classList.add('hidden');
                document.getElementById('username').required = false;
            } else {
                title.innerText = "สมัครสมาชิก";
                submitBtn.innerText = "ยืนยันการสมัคร";
                toggleText.innerText = "มีบัญชีแล้ว?";
                toggleLink.innerText = "เข้าสู่ระบบ";
                nameField.classList.remove('hidden');
                document.getElementById('username').required = true;
            }
        };

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value; // Get username
            
            try {
                loadingScreen.style.display = 'flex';
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    // Create User Doc with Username
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1); // Free 1 day
                    
                    await setDoc(doc(db, "users", cred.user.uid), {
                        email: email,
                        username: username, // Save username
                        createdAt: serverTimestamp(),
                        expiryDate: tomorrow
                    });
                }
            } catch (error) {
                loadingScreen.style.display = 'none';
                let msg = "เกิดข้อผิดพลาด: " + error.message;
                if(error.code === 'auth/wrong-password') msg = "รหัสผ่านไม่ถูกต้อง";
                if(error.code === 'auth/user-not-found') msg = "ไม่พบผู้ใช้งานนี้";
                if(error.code === 'auth/email-already-in-use') msg = "อีเมลนี้ถูกใช้งานแล้ว";
                alert(msg);
            }
        });

        window.logout = () => {
            if(confirm("ต้องการออกจากระบบใช่ไหม?")) {
                signOut(auth);
            }
        };

        // --- 3. DATA & EXPIRY LOGIC (Real-time) ---
        function initUserData(uid) {
            // Listener for User Profile
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    handleExpiry(data.expiryDate);
                    showApp(data);
                } else {
                    // Fallback for old users without docs
                    setDoc(doc(db, "users", uid), { email: currentUser.email, expiryDate: new Date() });
                }
            });

            // Listener for System Config (Admin Link)
            // สร้าง Collection: system, Document: config, Field: contactLink ใน Firestore
            onSnapshot(doc(db, "system", "config"), (docSnap) => {
                if (docSnap.exists()) {
                    adminLink = docSnap.data().contactLink || "#";
                }
            });
        }

        function handleExpiry(expiryTimestamp) {
            if (!expiryTimestamp) return;
            
            // Check if it's Firestore timestamp or Date
            const expiryDate = expiryTimestamp.toDate ? expiryTimestamp.toDate() : new Date(expiryTimestamp);
            
            if (expiryTimer) clearInterval(expiryTimer);

            // Update immediately
            updateTimerDisplay(expiryDate);

            // Update every second
            expiryTimer = setInterval(() => {
                updateTimerDisplay(expiryDate);
            }, 1000);
        }

        function updateTimerDisplay(expiryDate) {
            const now = new Date();
            const diff = expiryDate - now;

            if (diff <= 0) {
                // EXPIRED STATE
                document.getElementById('countdown').innerText = "00 : 00 : 00 : 00";
                document.getElementById('countdown').classList.add('text-red-500');
                document.getElementById('status-text').innerText = "หมดอายุ (Expired)";
                document.getElementById('status-text').className = "text-red-500 font-bold";
                
                // Lock Scanner
                document.getElementById('scan-btn').classList.add('grayscale-mode');
                document.getElementById('expired-alert').classList.remove('hidden');
                
                isExpired = true;
                // No need to clear interval, keep showing 00
            } else {
                // ACTIVE STATE
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                const str = `${pad(days)} : ${pad(hours)} : ${pad(minutes)} : ${pad(seconds)}`;
                document.getElementById('countdown').innerText = str;
                document.getElementById('countdown').classList.remove('text-red-500');
                document.getElementById('status-text').innerText = "ใช้งานได้ (Active)";
                document.getElementById('status-text').className = "text-green-500 font-bold";
                
                // Unlock
                document.getElementById('scan-btn').classList.remove('grayscale-mode');
                document.getElementById('expired-alert').classList.add('hidden');
                isExpired = false;
            }
        }

        function pad(n) { return n < 10 ? '0' + n : n; }

        // --- 4. SCANNER & UI LOGIC ---
        
        window.openScannerModal = () => {
            if (isExpired) {
                alert("แพ็กเกจของคุณหมดอายุ กรุณาเติมวันใช้งาน");
                return;
            }
            document.getElementById('scanner-modal').classList.remove('hidden');
        };
        
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // Asset Select
        window.selectAsset = (el, asset) => {
            document.querySelectorAll('.asset-btn').forEach(b => {
                b.className = 'asset-btn bg-gray-800 text-gray-400 py-3 rounded-lg border border-gray-700 transition';
            });
            el.className = 'asset-btn bg-yellow-500 text-black font-bold py-3 rounded-lg border border-yellow-500 shadow-lg scale-105 transition';
            selectedAsset = asset;
        };

        // TF Select
        window.selectTF = (el, tf) => {
            document.querySelectorAll('.tf-btn').forEach(b => {
                b.className = 'tf-btn bg-gray-800 text-gray-400 py-2 rounded-lg border border-gray-700 text-xs transition';
            });
            el.className = 'tf-btn bg-yellow-500 text-black font-bold py-2 rounded-lg border border-yellow-500 text-xs shadow-lg scale-105 transition';
            selectedTF = tf;
        };

        // AI Process Simulation
        window.startScanning = () => {
            closeModal('scanner-modal');
            document.getElementById('processing-modal').classList.remove('hidden');

            setTimeout(() => {
                document.getElementById('processing-modal').classList.add('hidden');
                showResult();
            }, 3500); // 3.5 sec for effect
        };

        function showResult() {
            const isBuy = Math.random() > 0.5; 
            const type = isBuy ? "BUY (ซื้อขึ้น)" : "SELL (ซื้อลง)";
            const colorClass = isBuy ? "text-green-400" : "text-red-400";
            const bgClass = isBuy ? "bg-green-500/10" : "bg-red-500/10";
            const borderClass = isBuy ? "border-green-500/50" : "border-red-500/50";
            const icon = isBuy ? '<i class="fa-solid fa-circle-arrow-up"></i>' : '<i class="fa-solid fa-circle-arrow-down"></i>';
            const shadow = isBuy ? "shadow-[0_0_30px_rgba(34,197,94,0.2)]" : "shadow-[0_0_30px_rgba(239,68,68,0.2)]";

            const badge = document.getElementById('signal-badge');
            badge.className = `inline-flex items-center gap-2 px-8 py-3 rounded-full font-bold border mb-8 text-2xl ${colorClass} ${bgClass} ${borderClass} ${shadow}`;
            badge.innerHTML = `${icon} ${type}`;

            document.getElementById('res-pair').innerText = selectedAsset + (selectedAsset === 'ทองคำ' ? '' : '/USDT');
            document.getElementById('res-tf').innerText = selectedTF;
            
            document.getElementById('result-modal').classList.remove('hidden');
        }

        // Contact Admin
        window.contactAdmin = () => {
             window.open(adminLink, '_blank');
        };

        document.getElementById('contact-admin-btn').addEventListener('click', () => {
            window.contactAdmin();
        });

        // --- 5. PRICE & CHART LOGIC ---
        
        // Binance Price Ticker
        async function fetchPrices() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                const data = await res.json();
                document.getElementById('btc-price').innerText = "$" + parseFloat(data.price).toFixed(2);
                
                const res2 = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT');
                const data2 = await res2.json();
                document.getElementById('eth-price').innerText = "$" + parseFloat(data2.price).toFixed(2);
            } catch (e) { console.log("Price fetch error"); }
        }
        
        setInterval(fetchPrices, 3000);
        fetchPrices(); // First run

        // Navigation
        window.switchTab = (tab) => {
            document.querySelectorAll('.hidden-page').forEach(p => {
                 if(p.id !== 'auth-screen' && p.id !== 'loading-screen') p.classList.add('hidden-page');
            });
            document.getElementById('home-page').classList.add('hidden-page'); 
            
            // Remove active nav
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active', 'text-gold');
                n.classList.add('text-gray-500');
            });

            // Show target
            if (tab === 'home') {
                document.getElementById('home-page').classList.remove('hidden-page');
                const nav = document.getElementById('nav-home');
                nav.classList.add('active', 'text-gold');
                nav.classList.remove('text-gray-500');
            } else if (tab === 'chart') {
                document.getElementById('chart-page').classList.remove('hidden-page');
                const nav = document.getElementById('nav-chart');
                nav.classList.add('active', 'text-gold');
                nav.classList.remove('text-gray-500');
            } else if (tab === 'profile') {
                document.getElementById('profile-page').classList.remove('hidden-page');
                const nav = document.getElementById('nav-profile');
                nav.classList.add('active', 'text-gold');
                nav.classList.remove('text-gray-500');
            }
        };

        // TradingView Widget
        window.changeChart = (symbol) => {
            loadTradingView(symbol);
        };

        function loadTradingView(symbol) {
            document.getElementById('tv_chart_container').innerHTML = "";
            let tvSymbol = "BINANCE:" + symbol;
            if(symbol === 'XAUUSD') tvSymbol = "OANDA:XAUUSD";

            new TradingView.widget({
                "width": "100%",
                "height": "100%",
                "symbol": tvSymbol,
                "interval": "15",
                "timezone": "Asia/Bangkok",
                "theme": "dark",
                "style": "1",
                "locale": "th_TH",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "save_image": false,
                "container_id": "tv_chart_container",
                "backgroundColor": "rgba(0, 0, 0, 0)",
                "gridLineColor": "rgba(42, 46, 57, 0)"
            });
        }
    </script>
</body>
</html>
