<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MY WALLET - Minimal Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Glass & Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; transition: 0.3s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .main-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; border-radius: 24px; padding: 30px;
            position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
        }
        .main-card::after {
            content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px;
            background: rgba(255,255,255,0.05); border-radius: 50%;
        }

        /* Buttons */
        .btn-primary {
            background: #0f172a; color: white; border-radius: 12px; padding: 12px;
            font-weight: 500; width: 100%; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-outline {
            border: 1px solid #cbd5e1; color: #64748b; border-radius: 12px; padding: 12px;
            width: 100%; font-weight: 500; background: white;
        }

        /* Inputs */
        .input-box {
            background: #f1f5f9; border: 1px solid #e2e8f0; padding: 14px;
            border-radius: 12px; width: 100%; outline: none; transition: 0.3s;
        }
        .input-box:focus { background: white; border-color: #0f172a; box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1); }

        /* Animation */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation */
        .nav-item { color: #94a3b8; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: #0f172a; font-weight: 600; }
        .nav-item.active i { transform: translateY(-3px); }
    </style>
</head>
<body class="pb-24">

    <div id="auth-modal" class="fixed inset-0 z-50 bg-white flex flex-col justify-center px-8 hidden">
        <div class="mb-10 text-center">
            <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto flex items-center justify-center text-white text-2xl mb-4"><i class="fa-solid fa-wallet"></i></div>
            <h1 class="text-3xl font-bold text-slate-800">MY WALLET</h1>
            <p class="text-slate-400 text-sm">จัดการการเงินของคุณอย่างมีสไตล์</p>
        </div>

        <div id="form-login">
            <div class="space-y-4">
                <input id="l-email" class="input-box" placeholder="อีเมล">
                <input id="l-pass" type="password" class="input-box" placeholder="รหัสผ่าน">
                <button onclick="Auth.login()" class="btn-primary">เข้าสู่ระบบ</button>
            </div>
            <p class="text-center mt-6 text-sm text-slate-500">ยังไม่มีบัญชี? <span onclick="UI.toggleAuth('reg')" class="text-slate-900 font-bold cursor-pointer underline">สร้างบัญชีใหม่</span></p>
        </div>

        <div id="form-reg" class="hidden">
            <div class="space-y-3">
                <input id="r-name" class="input-box" placeholder="ชื่อ-นามสกุล">
                <input id="r-email" class="input-box" placeholder="อีเมล">
                <input id="r-pass" type="password" class="input-box" placeholder="รหัสผ่าน">
                <input id="r-fb" class="input-box" placeholder="ลิ้งก์ Facebook (สำหรับติดต่อ)">
                <button onclick="Auth.register()" class="btn-primary mt-2">สมัครสมาชิก</button>
            </div>
            <p class="text-center mt-6 text-sm text-slate-500">มีบัญชีแล้ว? <span onclick="UI.toggleAuth('log')" class="text-slate-900 font-bold cursor-pointer underline">เข้าสู่ระบบ</span></p>
        </div>
    </div>

    <div id="app-view" class="hidden max-w-md mx-auto min-h-screen relative">
        
        <header class="p-6 flex justify-between items-center bg-white sticky top-0 z-40 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <img id="u-avatar" class="w-10 h-10 rounded-full object-cover bg-slate-100">
                <div>
                    <p class="text-xs text-slate-400">ยินดีต้อนรับ</p>
                    <p id="u-name" class="font-bold text-slate-800 leading-none">Loading...</p>
                </div>
            </div>
            <button onclick="Auth.logout()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <main class="p-6 space-y-6">
            <section id="p-home" class="fade-in">
                <div class="main-card mb-6">
                    <p class="text-slate-400 text-sm mb-1">ยอดเงินคงเหลือ</p>
                    <h2 id="u-bal" class="text-4xl font-bold">฿0.00</h2>
                    <div class="mt-4 flex items-center justify-between text-xs text-slate-400 bg-white/10 p-3 rounded-xl border border-white/5">
                        <span><i class="fa-solid fa-building-columns mr-1"></i> <span id="u-bank">...</span></span>
                        <span class="font-mono" id="u-acc">...</span>
                    </div>
                    <div id="turnover-alert" class="hidden mt-3 bg-yellow-500/20 text-yellow-200 p-2 rounded-lg text-xs border border-yellow-500/30 flex items-center gap-2">
                        <i class="fa-solid fa-lock"></i>
                        <span>ต้องทำยอดให้ถึง <b id="target-bal">0</b> ถึงจะถอนได้</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="Wallet.deposit()" class="card p-4 flex flex-col items-center gap-2 hover:bg-slate-50">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-down"></i></div>
                        <span class="font-bold text-sm">ฝากเงิน</span>
                    </button>
                    <button onclick="Wallet.withdraw()" class="card p-4 flex flex-col items-center gap-2 hover:bg-slate-50">
                        <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-up"></i></div>
                        <span class="font-bold text-sm">ถอนเงิน</span>
                    </button>
                </div>

                <div>
                    <h3 class="font-bold text-slate-700 mb-3 text-lg">รายการล่าสุด</h3>
                    <div id="tx-list" class="space-y-3 pb-20"></div>
                </div>
            </section>

            <section id="p-profile" class="hidden fade-in space-y-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">ตั้งค่าบัญชี</h2>
                
                <div class="card p-6">
                    <h3 class="font-bold mb-4 text-slate-700 border-b border-slate-100 pb-2">ข้อมูลส่วนตัว</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">ชื่อ-นามสกุล</label>
                            <input id="pf-name" class="input-box mt-1">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Facebook Link (สำหรับแอดมินติดต่อ)</label>
                            <input id="pf-fb" class="input-box mt-1" placeholder="https://facebook.com/...">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="font-bold mb-4 text-slate-700 border-b border-slate-100 pb-2">บัญชีธนาคาร</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-400">ธนาคาร</label>
                            <select id="pf-bank" class="input-box mt-1">
                                <option value="KBANK">กสิกรไทย</option>
                                <option value="SCB">ไทยพาณิชย์</option>
                                <option value="BBL">กรุงเทพ</option>
                                <option value="WALLET">TrueMoney</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">เลขบัญชี</label>
                            <input id="pf-acc" class="input-box mt-1">
                        </div>
                    </div>
                </div>

                <button onclick="User.save()" class="btn-primary py-3 text-lg shadow-lg">บันทึกข้อมูล</button>
                <div class="h-20"></div>
            </section>

            <section id="p-contact" class="hidden fade-in text-center pt-10">
                <div class="w-24 h-24 bg-slate-100 rounded-full mx-auto flex items-center justify-center text-4xl text-slate-800 mb-6">
                    <i class="fa-solid fa-headset"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">ศูนย์ช่วยเหลือ</h2>
                <p class="text-slate-500 mb-8">มีปัญหาการใช้งาน ติดต่อแอดมินได้ตลอด 24 ชม.</p>
                
                <div class="space-y-4 px-6">
                    <button onclick="User.contactAdmin('line')" class="card w-full p-4 flex items-center gap-4 hover:bg-green-50 border-green-100">
                        <i class="fa-brands fa-line text-3xl text-green-500"></i>
                        <div class="text-left">
                            <p class="font-bold text-slate-800">Line Official</p>
                            <p class="text-xs text-slate-400">@admin_support</p>
                        </div>
                    </button>
                    <button onclick="User.contactAdmin('fb')" class="card w-full p-4 flex items-center gap-4 hover:bg-blue-50 border-blue-100">
                        <i class="fa-brands fa-facebook text-3xl text-blue-600"></i>
                        <div class="text-left">
                            <p class="font-bold text-slate-800">Facebook Page</p>
                            <p class="text-xs text-slate-400">Admin Service</p>
                        </div>
                    </button>
                </div>
            </section>
        </main>

        <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 h-[70px] flex justify-around items-center px-6 z-50 max-w-md mx-auto right-0">
            <div onclick="UI.nav('home')" class="nav-item active" id="nav-home">
                <div class="flex flex-col items-center gap-1"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-medium">หน้าหลัก</span></div>
            </div>
            <div onclick="UI.nav('profile')" class="nav-item" id="nav-profile">
                <div class="flex flex-col items-center gap-1"><i class="fa-solid fa-user-gear text-xl"></i><span class="text-[10px] font-medium">โปรไฟล์</span></div>
            </div>
            <div onclick="UI.nav('contact')" class="nav-item" id="nav-contact">
                <div class="flex flex-col items-center gap-1"><i class="fa-solid fa-comment-dots text-xl"></i><span class="text-[10px] font-medium">ติดต่อ</span></div>
            </div>
        </nav>

    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAochx_FIKbXLrbhhcLdVrpaurjjk4aQYc", authDomain: "paoshuv-c260d.firebaseapp.com", databaseURL: "https://paoshuv-c260d-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "paoshuv-c260d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let user = null, userData = {}, config = {};

        // AUTH
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e=>Swal.fire('Error',e.message,'error')),
            register: () => {
                const e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value, n=document.getElementById('r-name').value, fb=document.getElementById('r-fb').value;
                if(!e||!p||!n) return Swal.fire('แจ้งเตือน','กรอกข้อมูลให้ครบ','warning');
                auth.createUserWithEmailAndPassword(e,p).then(c => {
                    db.ref('users/'+c.user.uid).set({
                        name:n, email:e, fb_link:fb, balance:0, bank:'-', acc:'-', role:'user',
                        is_free_credit: false, turnover_target: 0
                    });
                }).catch(e=>Swal.fire('Error',e.message,'error'));
            },
            logout: () => auth.signOut()
        };

        const App = {
            init: () => {
                // User Data
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    document.getElementById('u-bal').innerText = `฿${(userData.balance||0).toLocaleString()}`;
                    document.getElementById('u-name').innerText = userData.name;
                    document.getElementById('u-bank').innerText = userData.bank || '-';
                    document.getElementById('u-acc').innerText = userData.acc || '-';
                    document.getElementById('u-avatar').src = `https://ui-avatars.com/api/?name=${userData.name}&background=0f172a&color=fff`;
                    
                    // Profile Form
                    document.getElementById('pf-name').value = userData.name;
                    document.getElementById('pf-fb').value = userData.fb_link || '';
                    document.getElementById('pf-bank').value = userData.bank || 'KBANK';
                    document.getElementById('pf-acc').value = userData.acc || '';

                    // Turnover Logic
                    if(userData.is_free_credit && userData.turnover_target > 0) {
                        document.getElementById('turnover-alert').classList.remove('hidden');
                        document.getElementById('target-bal').innerText = userData.turnover_target.toLocaleString();
                    } else {
                        document.getElementById('turnover-alert').classList.add('hidden');
                    }
                });

                // Transactions
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).limitToLast(10).on('value', s => {
                    const l = document.getElementById('tx-list'); l.innerHTML = '';
                    const arr = []; s.forEach(d => arr.unshift(d.val()));
                    if(arr.length===0) l.innerHTML='<p class="text-center text-slate-400 py-4 text-sm">ยังไม่มีรายการ</p>';
                    arr.forEach(t => {
                        let icon = t.type==='deposit' ? 'fa-arrow-down text-green-500 bg-green-50' : 'fa-arrow-up text-red-500 bg-red-50';
                        let stColor = t.status==='approved'?'text-green-600':(t.status==='rejected'?'text-red-500':'text-yellow-600');
                        l.innerHTML += `
                            <div class="card p-3 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${icon}"><i class="fa-solid ${t.type==='deposit'?'fa-plus':'fa-minus'}"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-slate-700 capitalize">${t.type}</p>
                                        <p class="text-[10px] text-slate-400">${new Date(t.timestamp).toLocaleString()}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-slate-800">฿${t.amount}</p>
                                    <p class="text-[10px] font-bold uppercase ${stColor}">${t.status}</p>
                                </div>
                            </div>`;
                    });
                });

                // Settings
                db.ref('settings').on('value', s => config = s.val() || {});
            }
        };

        const Wallet = {
            deposit: () => {
                Swal.fire({
                    title: 'ฝากเงิน',
                    html: `
                        <div class="bg-slate-50 p-3 rounded text-left text-sm mb-3">
                            <p class="text-slate-500">กรุณาติดต่อแอดมินเพื่อขอเลขบัญชีและแจ้งสลิป</p>
                        </div>
                        <input id="d-amt" type="number" class="swal2-input" placeholder="จำนวนเงิน">
                    `,
                    confirmButtonText: 'แจ้งฝาก',
                    showCancelButton: true
                }).then(r => {
                    if(r.isConfirmed) {
                        const amt = document.getElementById('d-amt').value;
                        if(amt) {
                            db.ref('transactions').push({uid:user.uid, name:userData.name, type:'deposit', amount:Number(amt), status:'pending', timestamp:Date.now()});
                            Swal.fire('สำเร็จ','แจ้งฝากแล้ว กรุณาแจ้งสลิปในไลน์','success');
                            if(config.admin_contact) window.open(config.admin_contact);
                        }
                    }
                });
            },
            withdraw: () => {
                // Turnover Check
                if(userData.is_free_credit && userData.balance < userData.turnover_target) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'ถอนไม่ได้!',
                        text: `คุณติดเงื่อนไขเครดิตฟรี ต้องมียอดเงิน ${userData.turnover_target} บาท ถึงจะถอนได้`,
                        confirmButtonText: 'เข้าใจแล้ว'
                    });
                }

                Swal.fire({
                    title: 'ถอนเงิน',
                    text: `เข้าบัญชี: ${userData.bank} - ${userData.acc}`,
                    input: 'number',
                    inputPlaceholder: 'จำนวนเงิน',
                    confirmButtonText: 'ยืนยัน',
                    confirmButtonColor: '#0f172a',
                    showCancelButton: true
                }).then(r => {
                    if(r.isConfirmed && r.value) {
                        const amt = Number(r.value);
                        if(amt > userData.balance) return Swal.fire('ยอดเงินไม่พอ','','error');
                        if(amt < 100) return Swal.fire('ขั้นต่ำ 100 บาท','','warning');
                        
                        db.ref('transactions').push({uid:user.uid, name:userData.name, type:'withdraw', amount:amt, status:'pending', timestamp:Date.now()});
                        db.ref('users/'+user.uid).update({balance: userData.balance - amt});
                        Swal.fire('สำเร็จ','แจ้งถอนเรียบร้อย','success');
                    }
                });
            }
        };

        const User = {
            save: () => {
                db.ref('users/'+user.uid).update({
                    name: document.getElementById('pf-name').value,
                    fb_link: document.getElementById('pf-fb').value,
                    bank: document.getElementById('pf-bank').value,
                    acc: document.getElementById('pf-acc').value
                }).then(() => Swal.fire('บันทึกสำเร็จ','','success'));
            },
            contactAdmin: (type) => {
                const link = config.admin_contact || '#';
                window.open(link, '_blank');
            }
        };

        const UI = {
            toggleAuth: (m) => { document.getElementById('form-login').style.display=m=='log'?'block':'none'; document.getElementById('form-reg').style.display=m=='reg'?'block':'none'; },
            nav: (p) => {
                ['home','profile','contact'].forEach(id => {
                    document.getElementById('p-'+id).classList.add('hidden');
                    document.getElementById('nav-'+id).classList.remove('active');
                });
                document.getElementById('p-'+p).classList.remove('hidden');
                document.getElementById('p-'+p).classList.add('fade-in');
                document.getElementById('nav-'+p).classList.add('active');
            }
        };
    </script>
</body>
</html>
