<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÄ‡∏õ‡πà‡∏≤‡∏â‡∏∏‡∏ö</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #d4af37; --gold-dim: #8a6d1c; --bg: #050505; --card: #121212; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); color: #fff; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* UI Kit */
        .font-head { font-family: 'Russo One', sans-serif; letter-spacing: 1px; }
        .glass { background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: 0 4px 30px rgba(0,0,0,0.5); }
        
        .btn-gold { 
            background: linear-gradient(135deg, #d4af37 0%, #a07e18 100%); 
            color: #000; font-weight: 700; border-radius: 12px; 
            transition: all 0.2s; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            position: relative; overflow: hidden;
        }
        .btn-gold::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: rgba(255,255,255,0.2); transform: rotate(45deg) translateY(-100%); transition: 0.5s; }
        .btn-gold:hover::after { transform: rotate(45deg) translateY(100%); }
        .btn-gold:active { transform: scale(0.96); box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }

        .input-dark { background: #0a0a0a; border: 1px solid #333; color: white; padding: 14px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; }
        .input-dark:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }

        /* Game Specific */
        .rps-btn { width: 85px; height: 85px; border-radius: 50%; background: #1a1a1a; border: 3px solid #333; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; transition: 0.2s; cursor: pointer; }
        .rps-btn.selected { background: var(--gold); border-color: #fff; transform: scale(1.15) translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .rps-btn:active { transform: scale(0.9); }

        .player-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); padding: 2px; background: #000; }
        .player-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .st-waiting { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }
        .st-playing { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }

        /* Loading */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">

    <div id="loader"><div class="loader-ring"></div><p class="mt-4 text-[#d4af37] text-xs font-bold tracking-widest animate-pulse">CONNECTING...</p></div>

    <div id="view-auth" class="fixed inset-0 z-50 bg-[#050505] flex flex-col justify-center px-8 hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="glass p-8 animate__animated animate__zoomIn">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-head text-[#d4af37] mb-2 drop-shadow-[0_0_10px_rgba(212,175,55,0.5)]">ARENA</h1>
                <p class="text-xs text-gray-500 tracking-[0.4em]">BATTLE ROYALE</p>
            </div>

            <div id="form-login">
                <div class="space-y-4">
                    <input id="l-email" class="input-dark text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / ‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input id="l-pass" type="password" class="input-dark text-center" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="Auth.login()" class="btn-gold w-full py-3.5 text-lg shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ô‡∏≤‡∏°</button>
                </div>
                <p class="text-center text-xs text-gray-500 mt-6 cursor-pointer hover:text-white transition" onclick="UI.toggleAuth('reg')">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span class="text-[#d4af37] underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></p>
            </div>

            <div id="form-reg" class="hidden">
                <div class="space-y-3">
                    <input id="r-name" class="input-dark" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏° (Display Name)">
                    <input id="r-email" class="input-dark" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    <input id="r-pass" type="password" class="input-dark" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button onclick="Auth.reg()" class="btn-gold w-full py-3.5 mt-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                </div>
                <p class="text-center text-xs text-gray-500 mt-6 cursor-pointer hover:text-white transition" onclick="UI.toggleAuth('login')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden max-w-md mx-auto min-h-screen relative shadow-2xl border-x border-[#222]">
        
        <header class="p-5 sticky top-0 z-40 bg-[#050505]/95 backdrop-blur-md border-b border-[#222] flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full border-2 border-[#d4af37] p-0.5 shadow-[0_0_15px_rgba(212,175,55,0.3)]">
                    <img id="u-avatar" class="w-full h-full rounded-full bg-black object-cover">
                </div>
                <div>
                    <p class="text-[10px] text-[#d4af37] font-bold tracking-wider">BALANCE</p>
                    <p id="u-balance" class="text-2xl font-head leading-none text-white">0.00</p>
                </div>
            </div>
            <button onclick="Auth.logout()" class="w-10 h-10 rounded-xl bg-[#1a1a1a] text-gray-500 hover:text-red-500 transition flex items-center justify-center border border-[#333]"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <div class="bg-[#d4af37]/10 border-b border-[#d4af37]/20 py-2">
            <marquee id="sys-msg" class="text-xs text-gray-300 font-light">Welcome to The Arena...</marquee>
        </div>

        <main class="p-5 space-y-6">
            
            <section id="p-lobby" class="animate__animated animate__fadeIn">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="UI.modal('deposit')" class="glass p-4 flex flex-col items-center gap-2 hover:border-green-500 transition group">
                        <div class="w-12 h-12 rounded-full bg-green-500/20 text-green-500 flex items-center justify-center text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-circle-arrow-down"></i></div>
                        <span class="text-xs font-bold text-gray-300">‡∏ù‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
                    </button>
                    <button onclick="UI.modal('withdraw')" class="glass p-4 flex flex-col items-center gap-2 hover:border-red-500 transition group">
                        <div class="w-12 h-12 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-circle-arrow-up"></i></div>
                        <span class="text-xs font-bold text-gray-300">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
                    </button>
                </div>

                <div class="glass p-1 pl-4 flex items-center justify-between mb-6 border-dashed border-[#444]">
                    <input id="gift-code" class="bg-transparent w-full text-sm outline-none text-[#d4af37] placeholder-gray-600 uppercase font-bold" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ü‡∏£‡∏µ...">
                    <button onclick="Wallet.redeem()" class="bg-[#222] text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-[#d4af37] hover:text-black transition">‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö</button>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span class="w-1 h-6 bg-[#d4af37] rounded-full"></span> ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (Live)</h3>
                    <div id="lobby-list" class="space-y-3 pb-24">
                        <p class="text-center text-gray-600 py-10 border border-dashed border-[#222] rounded-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</p>
                    </div>
                </div>
            </section>

            <section id="p-game" class="hidden h-[calc(100vh-140px)] flex flex-col relative">
                <div class="flex justify-between items-center mb-4 bg-[#111] p-3 rounded-xl border border-[#222]">
                    <div class="text-xs text-gray-400">‡∏´‡πâ‡∏≠‡∏á: <span id="g-name" class="text-white font-bold">...</span></div>
                    <div class="text-center">
                        <div class="text-[9px] text-[#d4af37] font-bold">POT SIZE</div>
                        <div id="g-pot" class="text-xl font-head text-white">0</div>
                    </div>
                    <div class="text-xs text-gray-400">‡∏£‡∏≠‡∏ö: <span id="g-round" class="text-white font-bold">1/3</span></div>
                </div>

                <div class="flex-1 relative flex flex-col justify-center">
                    <div class="absolute top-4 left-0 right-0 text-center transition-all duration-500">
                        <div class="w-16 h-16 rounded-full border-2 border-red-500 mx-auto p-1 mb-2 relative">
                            <img id="p2-img" class="w-full h-full rounded-full bg-[#111] object-cover">
                            <div id="p2-status" class="absolute bottom-0 right-0 w-4 h-4 bg-gray-500 border-2 border-black rounded-full"></div>
                        </div>
                        <p id="p2-name" class="text-xs font-bold text-gray-400">‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á...</p>
                        <div id="p2-move" class="text-5xl mt-2 hidden animate__animated">‚úä</div>
                    </div>

                    <div class="z-10 text-center">
                        <div id="g-status-text" class="text-2xl font-bold text-[#d4af37] animate-pulse drop-shadow-lg">WAITING...</div>
                        <div id="g-score" class="text-5xl font-head text-white mt-2 drop-shadow-xl tracking-widest">0 - 0</div>
                        <div id="timer" class="text-red-500 font-head text-6xl mt-4 hidden">15</div>
                    </div>

                    <div class="absolute bottom-4 left-0 right-0 text-center transition-all duration-500">
                        <div id="p1-move" class="text-5xl mb-2 hidden animate__animated">‚úä</div>
                        <div class="w-16 h-16 rounded-full border-2 border-green-500 mx-auto p-1 mb-2">
                            <img id="p1-img" class="w-full h-full rounded-full bg-[#111] object-cover">
                        </div>
                        <p id="p1-name" class="text-xs font-bold text-gray-400">You</p>
                    </div>
                </div>

                <div id="g-controls" class="grid grid-cols-3 gap-6 mt-auto mb-4 opacity-50 pointer-events-none transition duration-300">
                    <div onclick="Game.move('rock')" class="rps-btn mx-auto" id="btn-rock">‚úä</div>
                    <div onclick="Game.move('paper')" class="rps-btn mx-auto" id="btn-paper">‚úã</div>
                    <div onclick="Game.move('scissors')" class="rps-btn mx-auto" id="btn-scissors">‚úåÔ∏è</div>
                </div>

                <button onclick="Game.confirmLeave()" class="absolute top-0 right-0 bg-red-900/80 text-red-400 px-3 py-1 rounded-full text-[10px] font-bold hover:bg-red-600 hover:text-white transition backdrop-blur">‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
            </section>

        </main>

        <nav class="fixed bottom-0 left-0 w-full h-[80px] bg-[#050505]/95 border-t border-[#222] flex justify-around items-center px-4 z-50 max-w-md mx-auto right-0 backdrop-blur-lg">
            <button onclick="UI.page('lobby')" class="flex flex-col items-center gap-1 text-[#d4af37] transition"><i class="fa-solid fa-gamepad text-xl"></i><span class="text-[10px] font-bold">LOBBY</span></button>
            <button onclick="UI.history()" class="flex flex-col items-center gap-1 text-gray-600 hover:text-white transition"><i class="fa-solid fa-clock-rotate-left text-xl"></i><span class="text-[10px] font-bold">HISTORY</span></button>
            <button onclick="window.open(config.contactLink)" class="flex flex-col items-center gap-1 text-gray-600 hover:text-green-400 transition"><i class="fa-brands fa-line text-xl"></i><span class="text-[10px] font-bold">SUPPORT</span></button>
        </nav>

    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- GLOBAL VARIABLES ---
        let user = null, userData = {}, config = {}, currentRoomId = null;

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(u => {
            document.getElementById('loader').style.display='none';
            if(u) {
                user = u;
                document.getElementById('view-auth').style.display='none';
                document.getElementById('view-app').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('view-auth').style.display='flex';
            }
        });

        // --- MAIN APP LOGIC ---
        const App = {
            init: () => {
                // 1. Listen User Data
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    document.getElementById('u-balance').innerText = (userData.balance || 0).toLocaleString();
                    document.getElementById('u-avatar').src = `https://ui-avatars.com/api/?name=${userData.name}&background=d4af37&color=000&bold=true`;
                    document.getElementById('p1-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=d4af37&color=000&bold=true`;
                    document.getElementById('p1-name').innerText = userData.name;
                });

                // 2. Listen Settings
                db.ref('settings').on('value', s => {
                    config = s.val() || {};
                    document.getElementById('sys-msg').innerText = config.announcement || '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà The Arena';
                });

                // 3. Listen Rooms (Lobby)
                db.ref('rooms').on('value', s => {
                    const list = document.getElementById('lobby-list');
                    list.innerHTML = '';
                    let hasRoom = false;

                    s.forEach(doc => {
                        const r = doc.val();
                        const rid = doc.key;
                        
                        // Show only rooms that are OPEN or WAITING_P2
                        if(r.status === 'open' || r.status === 'waiting_p2') {
                            hasRoom = true;
                            // Determine button state
                            let btnHtml = '';
                            let statusBadge = '';
                            let playerCount = 0;
                            
                            if (r.p1) playerCount++;
                            if (r.p2) playerCount++;

                            if (playerCount === 0) {
                                statusBadge = '<span class="status-badge st-waiting">‡∏ß‡πà‡∏≤‡∏á (0/2)</span>';
                                btnHtml = `<button onclick="Game.join('${rid}', 1)" class="btn-gold px-5 py-2 text-xs shadow-lg w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô P1</button>`;
                            } else if (playerCount === 1) {
                                statusBadge = '<span class="status-badge st-waiting">‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (1/2)</span>';
                                // If I am P1, show waiting text, else show Join P2
                                if (r.p1 && r.p1.uid === user.uid) {
                                    btnHtml = `<button class="bg-gray-800 text-gray-500 px-5 py-2 rounded-lg text-xs w-full cursor-not-allowed">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...</button>`;
                                } else {
                                    btnHtml = `<button onclick="Game.join('${rid}', 2)" class="btn-gold px-5 py-2 text-xs shadow-lg w-full">‡∏ó‡πâ‡∏≤‡∏î‡∏ß‡∏• (P2)</button>`;
                                }
                            }

                            list.innerHTML += `
                                <div class="glass p-4 animate__animated animate__fadeInUp">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 bg-[#1a1a1a] rounded-xl flex items-center justify-center text-2xl border border-[#333]">ü•ä</div>
                                            <div>
                                                <h4 class="font-bold text-white text-sm">${r.name}</h4>
                                                <p class="text-[10px] text-gray-400">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: <span class="text-[#d4af37] font-bold text-sm">‡∏ø${r.bet.toLocaleString()}</span></p>
                                            </div>
                                        </div>
                                        ${statusBadge}
                                    </div>
                                    ${btnHtml}
                                </div>`;
                        }
                    });

                    if(!hasRoom) list.innerHTML = '<div class="text-center text-gray-600 py-10 border border-dashed border-[#222] rounded-xl"><i class="fa-solid fa-ghost text-2xl mb-2"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á<br>‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>';
                });
            }
        };

        const Game = {
            join: async (rid, slot) => {
                // 1. Check Balance
                const roomSnap = await db.ref('rooms/'+rid).once('value');
                const r = roomSnap.val();
                
                if(userData.balance < r.bet) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô', 'error');
                
                // 2. Transaction to Join
                db.ref('rooms/'+rid).transaction(currentData => {
                    if (currentData) {
                        if (slot === 1 && !currentData.p1) {
                            currentData.p1 = { uid: user.uid, name: userData.name, score: 0, move: '' };
                            currentData.status = 'waiting_p2';
                            return currentData;
                        } else if (slot === 2 && !currentData.p2) {
                            currentData.p2 = { uid: user.uid, name: userData.name, score: 0, move: '' };
                            currentData.status = 'playing'; // Start Game!
                            return currentData;
                        }
                    }
                    return; // Abort if slot taken
                }, (error, committed, snapshot) => {
                    if (committed) {
                        // Deduct Balance
                        db.ref('users/'+user.uid).update({ balance: userData.balance - r.bet });
                        Game.enter(rid);
                    } else {
                        Swal.fire('‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß', '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì', 'warning');
                    }
                });
            },

            enter: (rid) => {
                currentRoomId = rid;
                document.getElementById('p-lobby').classList.add('hidden');
                document.getElementById('p-game').classList.remove('hidden');

                // Listener for Game State
                db.ref('rooms/'+rid).on('value', s => {
                    const r = s.val();
                    if(!r) { Game.quit(true); return; } // Room deleted by admin

                    // Update Info
                    document.getElementById('g-name').innerText = r.name;
                    document.getElementById('g-pot').innerText = (r.bet * 2).toLocaleString();
                    document.getElementById('g-round').innerText = `${r.round}/${r.maxRound}`;
                    
                    // Identify Players
                    const amIP1 = r.p1 && r.p1.uid === user.uid;
                    const me = amIP1 ? r.p1 : r.p2;
                    const opp = amIP1 ? r.p2 : r.p1;

                    // Update Opponent UI
                    if(opp) {
                        document.getElementById('p2-name').innerText = opp.name;
                        document.getElementById('p2-img').src = `https://ui-avatars.com/api/?name=${opp.name}&background=1a1a1a&color=fff`;
                        document.getElementById('p2-status').className = 'absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-black rounded-full animate-pulse';
                    } else {
                        document.getElementById('p2-name').innerText = '‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á...';
                        document.getElementById('p2-img').src = ''; 
                        document.getElementById('p2-status').className = 'absolute bottom-0 right-0 w-4 h-4 bg-gray-500 border-2 border-black rounded-full';
                    }

                    // Update Score
                    const s1 = r.p1 ? r.p1.score : 0;
                    const s2 = r.p2 ? r.p2.score : 0;
                    document.getElementById('g-score').innerText = amIP1 ? `${s1} - ${s2}` : `${s2} - ${s1}`;

                    // --- GAME STATES ---
                    const controls = document.getElementById('g-controls');
                    const statusTxt = document.getElementById('g-status-text');
                    const p1Move = document.getElementById('p1-move');
                    const p2Move = document.getElementById('p2-move');

                    if (r.status === 'waiting_p2') {
                        statusTxt.innerText = "‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô...";
                        statusTxt.className = "text-xl font-bold text-gray-500 animate-pulse";
                        controls.style.opacity = 0.5; controls.style.pointerEvents = 'none';
                    } 
                    else if (r.status === 'playing') {
                        // Reset Moves UI
                        p1Move.classList.add('hidden');
                        p2Move.classList.add('hidden');
                        p1Move.classList.remove('animate__bounceIn');
                        p2Move.classList.remove('animate__bounceIn');

                        if (!me.move) {
                            statusTxt.innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!";
                            statusTxt.className = "text-2xl font-bold text-[#d4af37] animate-bounce";
                            controls.style.opacity = 1; controls.style.pointerEvents = 'auto';
                        } else {
                            statusTxt.innerText = "‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...";
                            statusTxt.className = "text-xl font-bold text-blue-400";
                            controls.style.opacity = 0.5; controls.style.pointerEvents = 'none';
                        }
                    }
                    else if (r.status === 'calculating') {
                        statusTxt.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
                        // Show Moves
                        const map = {rock:'‚úä', paper:'‚úã', scissors:'‚úåÔ∏è'};
                        p1Move.innerText = map[me.move];
                        p2Move.innerText = map[opp.move];
                        
                        p1Move.classList.remove('hidden'); 
                        p2Move.classList.remove('hidden');
                        p1Move.classList.add('animate__bounceIn');
                        p2Move.classList.add('animate__bounceIn');
                    }
                    else if (r.status === 'finished') {
                        let msg = '', icon = '';
                        if (r.winner === 'draw') { msg = '‡πÄ‡∏™‡∏°‡∏≠! ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô'; icon = 'info'; }
                        else if (r.winner === user.uid) { msg = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞‡∏£‡∏±‡∏ö ‡∏ø${r.bet*2}`; icon = 'success'; }
                        else { msg = '‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ!'; icon = 'error'; }

                        Swal.fire({
                            title: '‡∏à‡∏ö‡πÄ‡∏Å‡∏°!',
                            text: msg,
                            icon: icon,
                            background: '#111', color:'#fff', confirmButtonColor:'#d4af37',
                            allowOutsideClick: false
                        }).then(() => Game.quit());
                    }
                });
            },

            move: (m) => {
                // UI Feedback
                document.querySelectorAll('.rps-btn').forEach(el => el.classList.remove('selected'));
                document.getElementById('btn-'+m).classList.add('selected');

                // Send Move
                db.ref(`rooms/${currentRoomId}`).transaction(r => {
                    if (r && r.status === 'playing') {
                        const amIP1 = r.p1.uid === user.uid;
                        if (amIP1) r.p1.move = m; else r.p2.move = m;
                    }
                    return r;
                });
            },

            confirmLeave: () => {
                Swal.fire({
                    title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?',
                    text: '‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏û‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                    icon: 'warning',
                    showCancelButton: true,
                    background: '#111', color:'#fff', confirmButtonColor:'#ef4444'
                }).then(res => {
                    if(res.isConfirmed) {
                        // Logic for leaving (Simplified: just remove user from room logic handled by Admin/Server in real app)
                        // Here we just quit UI for demo stability
                        Game.quit();
                    }
                });
            },

            quit: (forced = false) => {
                if(currentRoomId) db.ref('rooms/'+currentRoomId).off();
                currentRoomId = null;
                document.getElementById('p-game').classList.add('hidden');
                document.getElementById('p-lobby').classList.remove('hidden');
                if(forced) Swal.fire('‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î','‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô','info');
            }
        };

        const Wallet = {
            redeem: () => {
                const code = document.getElementById('gift-code').value.trim();
                if(!code) return;
                
                db.ref('codes/'+code).transaction(c => {
                    if(c && !c.used) { c.used = true; c.usedBy = user.uid; return c; }
                    return; // Abort
                }, (e, committed, s) => {
                    if(committed) {
                        const val = s.val().amount;
                        db.ref('users/'+user.uid).update({balance: userData.balance + val});
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ ${val} ‡∏ö‡∏≤‡∏ó`, 'success');
                    } else {
                        Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    }
                });
            }
        };

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e=>Swal.fire('Login Error',e.message,'error')),
            reg: () => {
                const d = {n:document.getElementById('r-name').value, e:document.getElementById('r-email').value, p:document.getElementById('r-pass').value};
                auth.createUserWithEmailAndPassword(d.e,d.p).then(c => db.ref('users/'+c.user.uid).set({name:d.n, email:d.e, balance:0})).catch(e=>Swal.fire('Register Error',e.message,'error'));
            },
            logout: () => auth.signOut()
        };

        const UI = {
            toggleAuth: (mode) => {
                document.getElementById('form-login').style.display = mode==='login'?'block':'none';
                document.getElementById('form-reg').style.display = mode==='reg'?'block':'none';
            },
            page: (page) => {
                // Simple navigation logic
                if(page === 'lobby') {
                    document.getElementById('p-game').classList.add('hidden');
                    document.getElementById('p-lobby').classList.remove('hidden');
                }
            },
            modal: async (type) => {
                const {value: amt} = await Swal.fire({
                    title: type==='deposit'?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                    input: 'number',
                    background: '#111', color: '#fff', confirmButtonColor: '#d4af37',
                    inputPlaceholder: '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'
                });
                if(amt) {
                    if(type==='withdraw' && amt > userData.balance) return Swal.fire('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
                    
                    db.ref('transactions').push({
                        uid: user.uid, name: userData.name, type: type, amount: Number(amt),
                        status: 'pending', timestamp: Date.now()
                    });
                    
                    if(type==='withdraw') db.ref('users/'+user.uid).update({balance: userData.balance - Number(amt)});
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö','success');
                }
            },
            history: () => {
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).limitToLast(10).once('value', s => {
                    let html = '<div class="text-left space-y-2">';
                    s.forEach(d => {
                        const t = d.val();
                        let color = t.status==='approved'?'text-green-400':(t.status==='rejected'?'text-red-400':'text-yellow-400');
                        html += `<div class="bg-[#222] p-2 rounded flex justify-between text-xs"><span>${t.type.toUpperCase()}</span> <span class="${color}">${t.amount} (${t.status})</span></div>`;
                    });
                    html += '</div>';
                    Swal.fire({title:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', html:html, background:'#111', color:'#fff'});
                });
            }
        };
    </script>
</body>
</html>
