<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE ARENA VIP - MEMBER</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #D4AF37;
            --primary-light: #F3E5AB;
            --bg-dark: #050505;
            --card-bg: rgba(20, 20, 20, 0.95);
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-dark);
            color: #fff;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* Typography */
        .font-eng { font-family: 'Oswald', sans-serif; }

        /* Components */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .gold-text {
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gold-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #aa8a2e 100%);
            color: #000;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        .gold-btn:active { transform: scale(0.97); }

        .input-vip {
            background: #0a0a0a;
            border: 1px solid #333;
            color: var(--primary);
            padding: 14px;
            border-radius: 12px;
            width: 100%;
            transition: 0.3s;
            outline: none;
        }
        .input-vip:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(212, 175, 55, 0.1); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Animations */
        .fade-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-24">

    <div id="loader">
        <div class="spinner"></div>
        <p class="absolute mt-20 text-[#D4AF37] text-xs tracking-[0.3em] animate-pulse">CONNECTING</p>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-6 hidden bg-[url('https://www.transparenttextures.com/patterns/dark-leather.png')]">
        <div class="glass-panel w-full max-w-sm p-8 rounded-2xl animate__animated animate__zoomIn">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-eng font-bold text-[#D4AF37] mb-2">ARENA</h1>
                <p class="text-gray-500 text-xs tracking-[0.4em]">VIP MEMBER CLUB</p>
            </div>

            <div id="form-login">
                <div class="space-y-4">
                    <input id="l-email" class="input-vip text-center" placeholder="อีเมล / เบอร์โทรศัพท์">
                    <input id="l-pass" type="password" class="input-vip text-center" placeholder="รหัสผ่าน">
                </div>
                <button onclick="Auth.login()" class="gold-btn w-full py-4 rounded-xl mt-6">เข้าสู่ระบบ</button>
                <div class="mt-6 text-center">
                    <p class="text-gray-500 text-xs">ยังไม่มีบัญชี?</p>
                    <button onclick="UI.toggleAuth('reg')" class="text-[#D4AF37] text-sm underline mt-1 hover:text-white transition">สมัครสมาชิกใหม่</button>
                </div>
            </div>

            <div id="form-reg" class="hidden space-y-3">
                <input id="r-name" class="input-vip" placeholder="ชื่อ-นามสกุล">
                <input id="r-email" class="input-vip" placeholder="อีเมล">
                <input id="r-pass" type="password" class="input-vip" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)">
                <input id="r-fb" class="input-vip" placeholder="ID Line (สำหรับติดต่อ)">
                <div class="grid grid-cols-2 gap-3">
                    <select id="r-bank" class="input-vip text-xs px-2 cursor-pointer">
                        <option value="KBANK">กสิกรไทย</option>
                        <option value="SCB">ไทยพาณิชย์</option>
                        <option value="BBL">กรุงเทพ</option>
                        <option value="KTB">กรุงไทย</option>
                        <option value="WALLET">TrueMoney</option>
                    </select>
                    <input id="r-acc" class="input-vip" placeholder="เลขบัญชี">
                </div>
                <button onclick="Auth.register()" class="gold-btn w-full py-3 rounded-xl mt-4">ยืนยันการสมัคร</button>
                <p class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white" onclick="UI.toggleAuth('log')">กลับไปหน้าล็อกอิน</p>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden max-w-md mx-auto min-h-screen relative shadow-2xl border-x border-[#222]">
        
        <header class="p-5 sticky top-0 z-40 bg-[#050505]/90 backdrop-blur-md border-b border-[#222]">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full p-[2px] bg-gradient-to-tr from-[#D4AF37] to-[#000]">
                        <img id="u-img" class="w-full h-full rounded-full object-cover bg-[#111]">
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total Balance</p>
                        <p id="u-bal" class="text-2xl font-bold text-[#D4AF37] font-eng tracking-wide">฿0.00</p>
                    </div>
                </div>
                <button onclick="Auth.logout()" class="w-10 h-10 rounded-xl bg-[#1a1a1a] text-gray-400 border border-[#333] flex items-center justify-center hover:border-red-500 hover:text-red-500 transition">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
            <div class="mt-4 bg-[#D4AF37]/10 border-l-2 border-[#D4AF37] py-2 px-3 rounded text-xs text-gray-300 flex items-center gap-2">
                <i class="fa-solid fa-volume-high text-[#D4AF37]"></i>
                <marquee id="site-ann">ยินดีต้อนรับสมาชิกทุกท่าน...</marquee>
            </div>
        </header>

        <main class="p-5 space-y-8">
            
            <section id="p-home" class="fade-up">
                <div id="turnover-box" class="hidden bg-[#111] p-4 rounded-xl border border-[#333] mb-6">
                    <div class="flex justify-between text-xs mb-2 font-bold text-[#D4AF37]">
                        <span><i class="fa-solid fa-lock mr-1"></i> ติดเงื่อนไขถอน</span>
                        <span id="turnover-val">0 / 0</span>
                    </div>
                    <div class="w-full bg-[#222] rounded-full h-2 overflow-hidden">
                        <div id="turnover-fill" class="bg-gradient-to-r from-[#D4AF37] to-[#F3E5AB] h-2 rounded-full transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="UI.page('deposit')" class="glass-panel p-5 flex flex-col items-center gap-3 rounded-2xl hover:border-[#D4AF37] transition group">
                        <div class="w-14 h-14 rounded-full bg-green-500/10 text-green-500 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-[0_0_15px_rgba(34,197,94,0.2)]">
                            <i class="fa-solid fa-circle-arrow-down"></i>
                        </div>
                        <span class="text-sm font-bold text-gray-300">ฝากเงิน</span>
                    </button>
                    <button onclick="UI.page('withdraw')" class="glass-panel p-5 flex flex-col items-center gap-3 rounded-2xl hover:border-[#D4AF37] transition group">
                        <div class="w-14 h-14 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center text-2xl group-hover:scale-110 transition shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                            <i class="fa-solid fa-circle-arrow-up"></i>
                        </div>
                        <span class="text-sm font-bold text-gray-300">ถอนเงิน</span>
                    </button>
                </div>

                <div class="mt-8">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-[#D4AF37] font-bold text-lg uppercase tracking-wide">โปรโมชั่น</h3>
                        <button onclick="UI.page('promos')" class="text-xs text-gray-500 hover:text-white">ดูทั้งหมด <i class="fa-solid fa-chevron-right ml-1"></i></button>
                    </div>
                    <div id="promo-teaser" class="space-y-3"></div>
                </div>

                <div class="mt-8">
                    <h3 class="text-gray-500 font-bold text-sm uppercase tracking-wide mb-4">ประวัติล่าสุด</h3>
                    <div id="tx-list" class="space-y-3 pb-20 min-h-[100px]">
                        <p class="text-center text-gray-600 text-xs py-4">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
            </section>

            <section id="p-deposit" class="hidden fade-up">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="UI.page('home')" class="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold text-white">แจ้งฝากเงิน</h2>
                </div>

                <div id="deposit-content">
                    <p class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider">1. เลือกบัญชีธนาคารเพื่อโอน</p>
                    <div id="bank-list-display" class="space-y-3 mb-8">
                        <div class="text-center py-4 border border-dashed border-[#333] rounded-xl text-xs text-gray-500">กำลังโหลดธนาคาร...</div>
                    </div>

                    <div class="border-t border-[#222] pt-6 space-y-5">
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider">2. กรอกรายละเอียดการโอน</p>
                        
                        <div>
                            <label class="text-xs text-[#D4AF37] ml-1 mb-1 block">โปรโมชั่น (รับได้ครั้งเดียว)</label>
                            <select id="dep-promo" class="input-vip text-sm cursor-pointer" onchange="Wallet.checkPromo()">
                                <option value="">ไม่รับโปรโมชั่น (ยอดเข้าปกติ)</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 ml-1 mb-1 block">จำนวนเงิน</label>
                            <input id="dep-amt" type="number" class="input-vip text-center text-3xl font-bold text-[#D4AF37]" placeholder="0.00" onkeyup="Wallet.calcBonus()">
                            <p id="promo-lock-msg" class="text-[10px] text-red-500 mt-1 hidden text-center">* ยอดฝากถูกล็อคตามเงื่อนไขโปร</p>
                        </div>

                        <div id="bonus-info" class="hidden bg-[#D4AF37]/10 p-3 rounded-lg border border-[#D4AF37]/30 text-center">
                            <p class="text-xs text-[#D4AF37]">โบนัสที่จะได้รับ: <span class="font-bold" id="bonus-val">0</span> บาท</p>
                            <p class="text-sm font-bold text-white mt-1">รวมเข้ากระเป๋า: <span id="total-get">0</span> บาท</p>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 ml-1 mb-1 block">เวลาโอน (ตามสลิป)</label>
                            <input id="dep-time" type="text" class="input-vip" placeholder="เช่น 14.30">
                        </div>

                        <button onclick="Wallet.deposit()" class="gold-btn w-full py-4 rounded-xl shadow-lg shadow-[#D4AF37]/20 mt-4">ยืนยันการโอนเงิน</button>
                    </div>
                </div>
                
                <div id="deposit-closed" class="hidden text-center py-20 animate__animated animate__fadeIn">
                    <i class="fa-solid fa-ban text-5xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-white">ระบบฝากปิดปรับปรุง</h3>
                    <p class="text-gray-500 text-sm mt-2">ขออภัยในความไม่สะดวก</p>
                </div>
            </section>

            <section id="p-withdraw" class="hidden fade-up">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="UI.page('home')" class="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold text-white">แจ้งถอนเงิน</h2>
                </div>

                <div id="withdraw-content">
                    <div class="bg-gradient-to-br from-[#D4AF37] to-[#8a6d1c] p-6 rounded-2xl text-black shadow-lg shadow-[#D4AF37]/20 mb-8 relative overflow-hidden">
                        <div class="absolute -right-5 -top-5 w-24 h-24 bg-white/30 rounded-full blur-xl"></div>
                        <p class="text-xs font-bold opacity-70 mb-1">ยอดเงินที่ถอนได้</p>
                        <h2 class="text-5xl font-eng font-bold mb-4 tracking-tighter" id="w-avail-bal">0.00</h2>
                        <div class="flex items-center gap-2 text-xs font-bold border-t border-black/10 pt-3">
                            <i class="fa-solid fa-building-columns opacity-50"></i>
                            <span id="w-bank-info">Loading...</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-xs text-gray-500 ml-1 block">ระบุจำนวนเงินที่ต้องการถอน</label>
                        <div class="relative">
                            <span class="absolute left-4 top-4 text-gray-500 text-xl">฿</span>
                            <input id="w-amt" type="number" class="input-vip pl-10 text-xl font-bold" placeholder="0">
                        </div>
                        <div class="flex justify-end">
                            <p class="text-[10px] text-gray-500" id="min-w-txt">* ถอนขั้นต่ำ 100 บาท</p>
                        </div>
                        <button onclick="Wallet.withdraw()" class="gold-btn w-full py-4 rounded-xl shadow-lg mt-4">ยืนยันแจ้งถอน</button>
                    </div>
                </div>

                <div id="withdraw-closed" class="hidden text-center py-20 animate__animated animate__fadeIn">
                    <i class="fa-solid fa-ban text-5xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-white">ระบบถอนปิดปรับปรุง</h3>
                    <p class="text-gray-500 text-sm mt-2">กรุณาติดต่อแอดมิน</p>
                </div>
            </section>

            <section id="p-promos" class="hidden fade-up">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="UI.page('home')" class="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold text-white">โปรโมชั่นทั้งหมด</h2>
                </div>
                <div id="promo-list" class="space-y-4 pb-24"></div>
            </section>

            <section id="p-profile" class="hidden fade-up">
                <h2 class="text-2xl font-bold text-white mb-6">ข้อมูลส่วนตัว</h2>
                <div class="space-y-6">
                    <div class="glass-panel p-6 rounded-2xl space-y-4">
                        <p class="text-xs font-bold text-[#D4AF37] uppercase tracking-wider mb-2">ข้อมูลทั่วไป</p>
                        <div><label class="text-xs text-gray-500">ชื่อ-นามสกุล</label><input id="pf-name" class="input-vip mt-1"></div>
                        <div><label class="text-xs text-gray-500">ID Line / Facebook</label><input id="pf-fb" class="input-vip mt-1"></div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl space-y-4">
                        <p class="text-xs font-bold text-[#D4AF37] uppercase tracking-wider mb-2">บัญชีรับเงิน</p>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-1">
                                <label class="text-xs text-gray-500">ธนาคาร</label>
                                <select id="pf-bank" class="input-vip text-sm px-1 mt-1">
                                    <option value="KBANK">KBANK</option>
                                    <option value="SCB">SCB</option>
                                    <option value="BBL">BBL</option>
                                    <option value="KTB">KTB</option>
                                    <option value="WALLET">WALLET</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs text-gray-500">เลขบัญชี</label>
                                <input id="pf-acc" class="input-vip mt-1">
                            </div>
                        </div>
                    </div>

                    <button onclick="User.save()" class="gold-btn w-full py-4 rounded-xl">บันทึกข้อมูล</button>
                    
                    <button onclick="UI.contact()" class="w-full bg-[#1a1a1a] text-white py-4 rounded-xl border border-[#333] flex items-center justify-center gap-2 hover:border-[#D4AF37] transition mt-2">
                        <i class="fa-brands fa-line text-green-500 text-xl"></i> ติดต่อแอดมิน
                    </button>
                </div>
            </section>

        </main>

        <nav class="fixed bottom-0 left-0 w-full h-[80px] bg-[#050505] border-t border-[#222] flex justify-around items-center px-6 z-50 max-w-md mx-auto right-0 backdrop-blur-md bg-opacity-95">
            <button onclick="UI.page('home')" class="nav-item active text-center" id="nav-home">
                <i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[9px] font-bold block">หน้าหลัก</span>
            </button>
            <button onclick="UI.page('promos')" class="nav-item text-center text-gray-500" id="nav-promos">
                <i class="fa-solid fa-gift text-xl mb-1"></i><span class="text-[9px] font-bold block">โปรโมชั่น</span>
            </button>
            <button onclick="UI.page('profile')" class="nav-item text-center text-gray-500" id="nav-profile">
                <i class="fa-solid fa-user-gear text-xl mb-1"></i><span class="text-[9px] font-bold block">บัญชี</span>
            </button>
        </nav>

    </div>

    <script>
        // --- 1. FIREBASE CONFIG (ต้องตรงกับ ADMIN 100%) ---
        const firebaseConfig = { apiKey: "AIzaSyAochx_FIKbXLrbhhcLdVrpaurjjk4aQYc", authDomain: "paoshuv-c260d.firebaseapp.com", databaseURL: "https://paoshuv-c260d-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "paoshuv-c260d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let user = null, userData = {}, promos = [], usedPromos = [], config = {};

        // --- 2. AUTHENTICATION ---
        auth.onAuthStateChanged(u => {
            document.getElementById('loader').style.display = 'none';
            if(u) {
                user = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-view').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        const Auth = {
            login: () => {
                const e = document.getElementById('l-email').value, p = document.getElementById('l-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire({icon:'error', title:'เข้าสู่ระบบไม่สำเร็จ', text:err.message, background:'#222', color:'#fff'}));
            },
            register: () => {
                const d = { n: document.getElementById('r-name').value, e: document.getElementById('r-email').value, p: document.getElementById('r-pass').value, fb: document.getElementById('r-fb').value, b: document.getElementById('r-bank').value, a: document.getElementById('r-acc').value };
                if(!d.n || !d.e || !d.p) return Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลให้ครบถ้วน','warning');
                auth.createUserWithEmailAndPassword(d.e, d.p).then(cred => {
                    db.ref('users/' + cred.user.uid).set({ name: d.n, email: d.e, fb_link: d.fb, balance: 0, bank: d.b, acc: d.a, created_at: Date.now() });
                }).catch(err => Swal.fire('Error', err.message, 'error'));
            },
            logout: () => auth.signOut()
        };

        // --- 3. APP LOGIC ---
        const App = {
            init: () => {
                // Monitor Settings
                db.ref('settings').on('value', s => {
                    config = s.val() || {};
                    document.getElementById('site-ann').innerText = config.announcement || 'ยินดีต้อนรับสมาชิก VIP';
                    document.getElementById('min-w-txt').innerText = `* ขั้นต่ำ ${config.minWithdraw || 100} บาท`;
                    
                    // Toggle Deposit/Withdraw
                    if(config.isDepositActive === false) {
                        document.getElementById('deposit-content').classList.add('hidden');
                        document.getElementById('deposit-closed').classList.remove('hidden');
                    } else {
                        document.getElementById('deposit-content').classList.remove('hidden');
                        document.getElementById('deposit-closed').classList.add('hidden');
                    }

                    if(config.isWithdrawActive === false) {
                        document.getElementById('withdraw-content').classList.add('hidden');
                        document.getElementById('withdraw-closed').classList.remove('hidden');
                    } else {
                        document.getElementById('withdraw-content').classList.remove('hidden');
                        document.getElementById('withdraw-closed').classList.add('hidden');
                    }
                });

                // Monitor Banks (Multi-Bank System)
                db.ref('admin_banks').on('value', s => {
                    const l = document.getElementById('bank-list-display'); l.innerHTML = '';
                    if(!s.exists()) { l.innerHTML = '<div class="text-center text-xs text-gray-500 py-4 border border-[#333] rounded-xl">กรุณาติดต่อแอดมินเพื่อขอเลขบัญชี</div>'; return; }
                    
                    s.forEach(d => {
                        const b = d.val();
                        let color = 'bg-gray-700', icon = 'B';
                        if(b.bankName.includes('KBANK')) { color='bg-green-600'; icon='K'; }
                        else if(b.bankName.includes('SCB')) { color='bg-purple-600'; icon='S'; }
                        else if(b.bankName.includes('WALLET')) { color='bg-orange-500'; icon='W'; }
                        else if(b.bankName.includes('BBL')) { color='bg-blue-600'; icon='B'; }

                        l.innerHTML += `
                            <div class="bg-[#111] p-4 rounded-xl border border-[#333] flex items-center gap-4 relative overflow-hidden transition hover:border-[#D4AF37] group">
                                <div class="w-12 h-12 ${color} rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-black/50">${icon}</div>
                                <div class="flex-1 z-10">
                                    <p class="font-bold text-white text-sm">${b.bankName}</p>
                                    <p class="font-eng text-xl text-[#D4AF37] font-bold tracking-wider my-1">${b.accNo}</p>
                                    <p class="text-xs text-gray-500">${b.accName}</p>
                                </div>
                                <button onclick="UI.copy('${b.accNo}')" class="bg-[#222] text-gray-400 p-2 rounded-lg border border-[#333] hover:bg-[#D4AF37] hover:text-black transition z-10 group-hover:scale-110">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                            </div>`;
                    });
                });

                // Monitor User
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    const bal = userData.balance || 0;
                    document.getElementById('u-bal').innerText = `฿${bal.toLocaleString()}`;
                    document.getElementById('w-avail-bal').innerText = bal.toLocaleString();
                    document.getElementById('u-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=D4AF37&color=000`;
                    document.getElementById('w-bank-info').innerText = `${userData.bank} • ${userData.acc}`;
                    
                    document.getElementById('pf-name').value = userData.name;
                    document.getElementById('pf-fb').value = userData.fb_link || '';
                    document.getElementById('pf-bank').value = userData.bank || 'KBANK';
                    document.getElementById('pf-acc').value = userData.acc || '';

                    // Turnover Check
                    const tb = document.getElementById('turnover-box');
                    if(userData.is_free_credit && userData.turnover_target > 0) {
                        tb.classList.remove('hidden');
                        document.getElementById('turnover-val').innerText = `${bal.toLocaleString()} / ${userData.turnover_target.toLocaleString()}`;
                        document.getElementById('turnover-fill').style.width = Math.min((bal/userData.turnover_target)*100, 100) + '%';
                    } else {
                        tb.classList.add('hidden');
                    }
                });

                // Transactions & Promos (Used check)
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).on('value', s => {
                    const l = document.getElementById('tx-list'); l.innerHTML = '';
                    const arr = []; usedPromos = [];
                    s.forEach(d => {
                        const t = d.val();
                        arr.unshift(t);
                        if(t.promo_id) usedPromos.push(t.promo_id);
                    });

                    if(arr.length === 0) l.innerHTML = '<p class="text-center text-gray-600 text-xs py-10 border border-[#222] rounded-xl border-dashed">ยังไม่มีรายการ</p>';
                    else arr.slice(0, 10).forEach(t => {
                        let c = t.status=='approved'?'text-green-500':(t.status=='rejected'?'text-red-500':'text-yellow-500');
                        let icon = t.type=='deposit' ? 'fa-arrow-down text-green-500 bg-green-500/10' : (t.type=='withdraw'?'fa-arrow-up text-red-500 bg-red-500/10':'fa-sliders text-blue-500 bg-blue-500/10');
                        let title = t.type=='deposit' ? 'ฝากเงิน' : (t.type=='withdraw'?'ถอนเงิน':'ปรับยอด');
                        
                        l.innerHTML += `
                            <div class="glass-panel p-3 flex justify-between items-center rounded-xl border-l-2 ${t.type=='deposit'?'border-green-500':(t.type=='withdraw'?'border-red-500':'border-blue-500')}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${icon}"><i class="fa-solid ${t.type=='deposit'?'fa-arrow-down':(t.type=='withdraw'?'fa-arrow-up':'fa-sliders')}"></i></div>
                                    <div>
                                        <p class="font-bold text-sm text-gray-300">${title}</p>
                                        <p class="text-[10px] text-gray-500">${moment(t.timestamp).format('DD/MM HH:mm')} ${t.promo?'• '+t.promo:''}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-white font-eng tracking-wide">฿${Math.abs(t.amount).toLocaleString()}</p>
                                    <p class="text-[9px] uppercase font-bold ${c}">${t.status}</p>
                                </div>
                            </div>`;
                    });
                    renderPromos();
                });

                // Promos Data
                db.ref('promotions').on('value', s => {
                    promos = [];
                    if(s.exists()) s.forEach(d => promos.push({id:d.key, ...d.val()}));
                    renderPromos();
                });
            }
        };

        function renderPromos() {
            const l = document.getElementById('promo-list'); const teaser = document.getElementById('promo-teaser');
            const sel = document.getElementById('dep-promo');
            l.innerHTML = ''; teaser.innerHTML = '';
            
            // Reset Select
            const firstOpt = sel.options[0];
            sel.innerHTML = ''; sel.appendChild(firstOpt);

            let count = 0;
            promos.forEach(p => {
                if(usedPromos.includes(p.id)) return; // One-time use check
                count++;

                // Add to Select
                const opt = document.createElement('option');
                opt.value = p.id; opt.text = p.title;
                sel.appendChild(opt);

                // Add to Display
                const html = `
                    <div class="glass-panel p-4 flex gap-4 items-center rounded-xl border border-white/5 hover:border-[#D4AF37] transition cursor-pointer group" onclick="UI.page('deposit'); document.getElementById('dep-promo').value='${p.id}'; Wallet.checkPromo();">
                        <img src="${p.img}" class="w-16 h-16 rounded-xl object-cover bg-[#222] shadow-lg">
                        <div class="flex-1">
                            <h4 class="font-bold text-[#D4AF37] text-sm group-hover:text-white transition">${p.title}</h4>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400">ฝาก ${p.minDep}</span>
                                <span class="text-[10px] bg-green-900/30 text-green-400 px-2 py-0.5 rounded border border-green-900/50">โบนัส ${p.bonus}%</span>
                            </div>
                        </div>
                        <button class="w-8 h-8 rounded-full bg-[#D4AF37] text-black flex items-center justify-center shadow-lg hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                    </div>`;
                l.innerHTML += html;
                if(count <= 2) teaser.innerHTML += html;
            });

            if(count === 0) {
                const empty = '<p class="text-center text-gray-600 text-xs py-6 border border-dashed border-[#222] rounded-xl">ไม่มีโปรโมชั่นที่รับได้ในขณะนี้</p>';
                l.innerHTML = empty; teaser.innerHTML = empty;
            }
        }

        const Wallet = {
            checkPromo: () => {
                const pid = document.getElementById('dep-promo').value;
                const amtInput = document.getElementById('dep-amt');
                const lockMsg = document.getElementById('promo-lock-msg');
                if(pid) {
                    const p = promos.find(x => x.id === pid);
                    amtInput.value = p.minDep;
                    amtInput.readOnly = true;
                    amtInput.classList.add('text-gray-500', 'bg-[#111]');
                    lockMsg.classList.remove('hidden');
                    Wallet.calcBonus();
                } else {
                    amtInput.readOnly = false;
                    amtInput.value = '';
                    amtInput.classList.remove('text-gray-500', 'bg-[#111]');
                    lockMsg.classList.add('hidden');
                    Wallet.calcBonus();
                }
            },
            calcBonus: () => {
                const amt = Number(document.getElementById('dep-amt').value);
                const pid = document.getElementById('dep-promo').value;
                const info = document.getElementById('bonus-info');
                if(pid && amt > 0) {
                    const p = promos.find(x => x.id === pid);
                    if(amt < p.minDep) { info.classList.add('hidden'); return; }
                    const bonus = Math.floor(amt * (p.bonus/100));
                    document.getElementById('bonus-val').innerText = bonus;
                    document.getElementById('total-get').innerText = amt + bonus;
                    info.classList.remove('hidden');
                } else info.classList.add('hidden');
            },
            deposit: () => {
                if(config.isDepositActive === false) return Swal.fire('ระบบปิด','ระบบฝากเงินปิดปรับปรุงชั่วคราว','warning');
                const amt = document.getElementById('dep-amt').value, time = document.getElementById('dep-time').value, pid = document.getElementById('dep-promo').value;
                if(!amt || !time) return Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกจำนวนเงินและเวลาโอน','warning');
                
                let bonus=0, pName='', pId=null;
                if(pid) {
                    const p = promos.find(x=>x.id===pid);
                    if(Number(amt) < p.minDep) return Swal.fire('ยอดไม่ถึง',`โปรนี้ต้องฝากขั้นต่ำ ${p.minDep}`,'error');
                    bonus = Math.floor(Number(amt)*(p.bonus/100)); pName=p.title; pId=p.id;
                }

                db.ref('transactions').push({
                    uid: user.uid, name: userData.name, type: 'deposit', 
                    amount: Number(amt), bonus: bonus, promo: pName, promo_id: pId,
                    total: Number(amt)+bonus, time: time, status: 'pending', timestamp: Date.now()
                });
                Swal.fire({icon:'success', title:'แจ้งฝากสำเร็จ', text:'กรุณารอแอดมินตรวจสอบ', confirmButtonColor:'#D4AF37', background:'#222', color:'#fff'});
                UI.page('home');
                document.getElementById('dep-amt').value = '';
                document.getElementById('dep-time').value = '';
                document.getElementById('dep-promo').value = '';
                Wallet.checkPromo();
            },
            withdraw: () => {
                if(config.isWithdrawActive === false) return Swal.fire('ระบบปิด','ระบบถอนเงินปิดปรับปรุงชั่วคราว','warning');
                if(userData.is_free_credit && userData.balance < userData.turnover_target) return Swal.fire('ติดเทิร์น',`ต้องมียอดเงิน ${userData.turnover_target} บาท ถึงจะถอนได้`,'error');
                
                const amt = Number(document.getElementById('w-amt').value);
                const minW = config.minWithdraw || 100;
                
                if(amt > userData.balance) return Swal.fire('ยอดเงินไม่พอ','','error');
                if(amt < minW) return Swal.fire('ขั้นต่ำไม่ถึง',`ถอนขั้นต่ำ ${minW} บาท`,'warning');
                
                // Create Transaction
                db.ref('transactions').push({
                    uid: user.uid, name: userData.name, type: 'withdraw', 
                    amount: amt, status: 'pending', timestamp: Date.now(), 
                    bank_info: `${userData.bank} ${userData.acc}`
                });
                
                // Deduct Balance Immediately (Pending state)
                db.ref('users/'+user.uid).update({balance: userData.balance - amt});
                
                Swal.fire({icon:'success', title:'แจ้งถอนสำเร็จ', text:'เงินจะเข้าบัญชีภายใน 5 นาที', confirmButtonColor:'#D4AF37', background:'#222', color:'#fff'});
                UI.page('home');
                document.getElementById('w-amt').value = '';
            },
            copyBank: () => {
                // Copy logic needs specific element, but here we have multiple. 
                // Handled in HTML onclick directly.
            }
        };

        const User = {
            save: () => {
                db.ref('users/'+user.uid).update({
                    name: document.getElementById('pf-name').value, 
                    fb_link: document.getElementById('pf-fb').value,
                    bank: document.getElementById('pf-bank').value, 
                    acc: document.getElementById('pf-acc').value
                }).then(() => Swal.fire({icon:'success', title:'บันทึกแล้ว', showConfirmButton:false, timer:1500, background:'#222', color:'#fff'}));
            }
        };

        const UI = {
            toggleAuth: (m) => { document.getElementById('form-login').style.display=m=='log'?'block':'none'; document.getElementById('form-reg').style.display=m=='reg'?'block':'none'; },
            page: (p) => {
                ['home','promos','deposit','withdraw','profile'].forEach(id => {
                    document.getElementById('p-'+id).classList.add('hidden');
                    if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.remove('active', 'text-[#D4AF37]');
                });
                document.getElementById('p-'+p).classList.remove('hidden');
                document.getElementById('p-'+p).classList.add('fade-up');
                if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active', 'text-[#D4AF37]');
            },
            contact: () => window.open(config.contactLink || '#'),
            copy: (t) => {
                navigator.clipboard.writeText(t);
                Swal.fire({toast:true, position:'top', icon:'success', title:'คัดลอกเลขบัญชีแล้ว', showConfirmButton:false, timer:1500, background:'#D4AF37', color:'#000'});
            }
        };
    </script>
</body>
</html>
