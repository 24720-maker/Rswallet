<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAFADA Banking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        bank: { main: '#003366', dark: '#002244', gold: '#c5a059', bg: '#f2f4f7' }
                    },
                    boxShadow: { 'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f2f4f7; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #003366; transition: all 0.2s; }
        .pin-dot.active { background-color: #003366; }
        .gradient-card { background: linear-gradient(135deg, #003366 0%, #00509E 100%); }
        .bottom-nav-item.active { color: #003366; }
        .bottom-nav-item { color: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="sysLoader" class="fixed inset-0 z-[9999] bg-white flex flex-col items-center justify-center">
        <img src="https://img.icons8.com/color/96/safe-out-of-control.png" class="animate-bounce mb-4">
        <p class="text-bank-main font-bold tracking-widest animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...</p>
    </div>

    <div id="maintenanceScreen" class="hidden fixed inset-0 z-[9998] bg-bank-main flex flex-col items-center justify-center text-white p-8 text-center">
        <i class="fas fa-tools text-6xl mb-6 text-bank-gold animate-pulse"></i>
        <h1 class="text-2xl font-bold mb-2">‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</h1>
        <p class="text-slate-300">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
        <button onclick="location.reload()" class="mt-8 border border-white/30 px-6 py-2 rounded-full hover:bg-white/10">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    </div>

    <div id="authScreen" class="hidden fixed inset-0 z-50 bg-white overflow-y-auto">
        <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
            <div class="w-full max-w-sm">
                <div class="text-center mb-10">
                    <div class="w-20 h-20 bg-bank-main rounded-2xl mx-auto flex items-center justify-center shadow-xl mb-4">
                        <span class="text-4xl text-white font-bold">F</span>
                    </div>
                    <h1 class="text-3xl font-bold text-bank-main">FAFADA BANKING</h1>
                    <p class="text-slate-500 text-sm">‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>

                <div class="bg-white p-1 rounded-2xl shadow-sm border border-slate-100 flex mb-6">
                    <button onclick="auth.tab('login')" id="tabL" class="flex-1 py-3 rounded-xl font-bold text-sm bg-bank-main text-white shadow transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button onclick="auth.tab('reg')" id="tabR" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-bank-main transition">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <form id="fLogin" onsubmit="auth.login(event)" class="space-y-4 fade-in">
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-4 text-slate-400"></i>
                        <input id="lEmail" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-bank-main outline-none transition" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" required>
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-4 text-slate-400"></i>
                        <input type="password" id="lPass" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-bank-main outline-none transition" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                    </div>
                    <button class="w-full bg-bank-main text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/20 active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>

                <form id="fReg" onsubmit="auth.reg(event)" class="space-y-4 fade-in hidden">
                    <input id="rName" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)" required>
                    <input id="rEmail" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                    <input type="password" id="rPass" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" required>
                    <button class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                </form>
            </div>
        </div>
    </div>

    <div id="pinScreen" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-slate-100 rounded-full mx-auto flex items-center justify-center mb-4 overflow-hidden border-2 border-white shadow">
                <i class="fas fa-user text-2xl text-slate-400"></i>
            </div>
            <h2 class="text-xl font-bold text-bank-main" id="pinGreeting">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</h2>
            <p class="text-sm text-slate-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>
        
        <div class="flex gap-4 mb-10" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>

        <div class="grid grid-cols-3 gap-6 text-2xl font-bold text-bank-main w-full max-w-[280px]">
            <button onclick="auth.typePin(1)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">1</button>
            <button onclick="auth.typePin(2)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">2</button>
            <button onclick="auth.typePin(3)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">3</button>
            <button onclick="auth.typePin(4)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">4</button>
            <button onclick="auth.typePin(5)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">5</button>
            <button onclick="auth.typePin(6)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">6</button>
            <button onclick="auth.typePin(7)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">7</button>
            <button onclick="auth.typePin(8)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">8</button>
            <button onclick="auth.typePin(9)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">9</button>
            <div class="w-16 h-16"></div>
            <button onclick="auth.typePin(0)" class="w-16 h-16 rounded-full border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:bg-bank-main active:text-white transition">0</button>
            <button onclick="auth.delPin()" class="w-16 h-16 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><i class="fas fa-backspace"></i></button>
        </div>
        <button onclick="auth.logout()" class="mt-8 text-sm text-slate-400 underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö / ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™</button>
    </div>

    <div id="mainApp" class="hidden flex-1 flex flex-col bg-white overflow-hidden pb-20">
        
        <header class="bg-white px-5 pt-12 pb-4 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 overflow-hidden"><i class="fas fa-user text-slate-400 text-lg"></i></div>
                <div>
                    <p class="text-xs text-slate-400">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô<span id="timeGreeting">‡πÄ‡∏ä‡πâ‡∏≤</span></p>
                    <p class="font-bold text-bank-main text-lg leading-none truncate max-w-[150px]" id="uName">...</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 relative">
                    <i class="far fa-bell"></i>
                    <div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></div>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-5 space-y-6 hide-scroll pb-10">
            
            <div class="gradient-card rounded-3xl p-6 text-white shadow-xl shadow-blue-900/20 relative overflow-hidden transform transition active:scale-95">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/4"></div>
                
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-blue-200 text-xs font-light mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>
                        <div class="flex items-center gap-3">
                            <h1 class="text-3xl font-bold tracking-tight" id="uBal">‡∏ø ****</h1>
                            <button onclick="app.toggleBal()" class="text-blue-200 hover:text-white transition"><i class="fas fa-eye-slash" id="eyeIcon"></i></button>
                        </div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-md px-2 py-1 rounded text-[10px] font-mono border border-white/20">SAVINGS</div>
                </div>
                
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-blue-200 uppercase tracking-widest mb-0.5">Account No.</p>
                        <p class="font-mono text-sm tracking-widest opacity-90" id="uAccNo">xxx-x-xxxxx-x</p>
                    </div>
                    <img src="https://raw.githubusercontent.com/muhmi/payment-icons/main/assets/visa.png" class="h-4 opacity-80">
                </div>
            </div>

            <div class="grid grid-cols-4 gap-4 text-center">
                <button onclick="app.modal('deposit')" class="flex flex-col items-center gap-2 group">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 text-xl group-active:scale-90 transition shadow-sm border border-blue-100"><i class="fas fa-arrow-down"></i></div>
                    <span class="text-xs font-medium text-slate-600">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</span>
                </button>
                <button onclick="app.modal('withdraw')" class="flex flex-col items-center gap-2 group">
                    <div class="w-12 h-12 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-500 text-xl group-active:scale-90 transition shadow-sm border border-orange-100"><i class="fas fa-arrow-up"></i></div>
                    <span class="text-xs font-medium text-slate-600">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                </button>
                <button onclick="app.openProfile()" class="flex flex-col items-center gap-2 group">
                    <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center text-purple-500 text-xl group-active:scale-90 transition shadow-sm border border-purple-100"><i class="fas fa-user-edit"></i></div>
                    <span class="text-xs font-medium text-slate-600">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                </button>
                <a href="#" id="lineLink" target="_blank" class="flex flex-col items-center gap-2 group">
                    <div class="w-12 h-12 bg-green-50 rounded-2xl flex items-center justify-center text-green-500 text-xl group-active:scale-90 transition shadow-sm border border-green-100"><i class="fab fa-line"></i></div>
                    <span class="text-xs font-medium text-slate-600">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
                </a>
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-bank-main text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <button class="text-xs text-slate-400">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <i class="fas fa-chevron-right ml-1"></i></button>
                </div>
                
                <div id="txList" class="space-y-4">
                    <div class="text-center py-10 text-slate-400 text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 pb-safe pt-2 px-6 flex justify-between items-center shadow-up z-30">
            <button class="flex flex-col items-center gap-1 bottom-nav-item active">
                <i class="fas fa-home text-xl"></i><span class="text-[10px] font-medium">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </button>
            <button class="flex flex-col items-center gap-1 bottom-nav-item">
                <i class="fas fa-chart-pie text-xl"></i><span class="text-[10px] font-medium">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</span>
            </button>
            <div class="w-12"></div> <button class="flex flex-col items-center gap-1 bottom-nav-item">
                <i class="fas fa-gift text-xl"></i><span class="text-[10px] font-medium">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
            </button>
            <button onclick="app.openProfile()" class="flex flex-col items-center gap-1 bottom-nav-item">
                <i class="fas fa-cog text-xl"></i><span class="text-[10px] font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </button>

            <div class="absolute left-1/2 -top-6 -translate-x-1/2">
                <button class="w-14 h-14 bg-bank-main rounded-full flex items-center justify-center text-white text-2xl shadow-lg border-4 border-white transform active:scale-95 transition">
                    <i class="fas fa-qrcode"></i>
                </button>
            </div>
        </nav>
    </div>

    <div id="modalOverlay" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center transition-opacity duration-300">
        <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up relative">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <div id="modalContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419", measurementId: "G-Q73X8Q841W" };
        const fb = initializeApp(firebaseConfig);
        const auth = getAuth(fb);
        const db = getFirestore(fb);

        // STATE
        let user = null, userData = null, sysConfig = {}, pinBuffer = "", isBalanceHidden = true;

        // AUTH MODULE
        window.auth = {
            tab: (t) => {
                if(t==='login'){ document.getElementById('fLogin').classList.remove('hidden'); document.getElementById('fReg').classList.add('hidden'); document.getElementById('tabL').className="flex-1 py-3 rounded-xl font-bold text-sm bg-bank-main text-white shadow transition"; document.getElementById('tabR').className="flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-bank-main transition"; }
                else { document.getElementById('fLogin').classList.add('hidden'); document.getElementById('fReg').classList.remove('hidden'); document.getElementById('tabR').className="flex-1 py-3 rounded-xl font-bold text-sm bg-green-600 text-white shadow transition"; document.getElementById('tabL').className="flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-green-600 transition"; }
            },
            login: async(e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); }catch(err){ Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î','error'); } },
            reg: async(e)=>{ e.preventDefault(); const n=document.getElementById('rName').value, em=document.getElementById('rEmail').value, pw=document.getElementById('rPass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,pw); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:em,displayName:n,role:em==='farisxuma1@gmail.com'?'admin':'user',balance:0,createdAt:new Date(),bankName:'',bankAcc:'',contactLink:''}); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); }catch(err){ Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',err.message,'error'); } },
            typePin: (n)=>{
                if(pinBuffer.length < 6) {
                    pinBuffer += n;
                    updatePinUI();
                    if(pinBuffer.length === 6) verifyPin();
                }
            },
            delPin: ()=>{ pinBuffer = pinBuffer.slice(0, -1); updatePinUI(); },
            logout: ()=>{ Swal.fire({title:'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',showCancelButton:true,confirmButtonColor:'#ef4444'}).then(r=>{if(r.isConfirmed)signOut(auth).then(()=>location.reload())}); }
        };

        function updatePinUI() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((d, i) => {
                if(i < pinBuffer.length) d.classList.add('active'); else d.classList.remove('active');
            });
        }

        function verifyPin() {
            // In real app, check PIN with DB. Here just hardcode '111111' or allow any for demo if unset
            setTimeout(() => {
                document.getElementById('pinScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('mainApp').classList.add('flex');
            }, 300);
        }

        // APP MODULE
        window.app = {
            toggleBal: ()=>{
                isBalanceHidden = !isBalanceHidden;
                const balEl = document.getElementById('uBal');
                const eyeEl = document.getElementById('eyeIcon');
                if(isBalanceHidden){ balEl.innerText = "‡∏ø ****"; eyeEl.className="fas fa-eye-slash"; }
                else { balEl.innerText = "‡∏ø " + userData.balance.toLocaleString('th-TH',{minimumFractionDigits:2}); eyeEl.className="fas fa-eye"; }
            },
            
            modal: (type) => {
                const m = document.getElementById('modalOverlay');
                const c = document.getElementById('modalContent');
                m.classList.remove('hidden');
                
                if(type === 'deposit') {
                    c.innerHTML = `
                        <h3 class="text-lg font-bold text-bank-main mb-4">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                            <p class="text-xs text-blue-800 font-bold mb-1">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</p>
                            <p class="text-sm text-blue-600 whitespace-pre-line">${sysConfig.adminBank || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'}</p>
                        </div>
                        <input type="number" id="txAmt" class="w-full p-3 border rounded-xl mb-3 text-lg font-bold text-center" placeholder="0.00">
                        <button onclick="app.submitTxn('deposit')" class="w-full bg-bank-main text-white py-3 rounded-xl font-bold shadow-lg">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                        <button onclick="app.closeModal()" class="w-full mt-2 py-2 text-slate-400 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    `;
                } else if(type === 'withdraw') {
                    c.innerHTML = `
                        <h3 class="text-lg font-bold text-red-600 mb-4">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
                        <div class="flex justify-between text-sm text-slate-500 mb-2"><span>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</span><span>${userData.balance.toLocaleString()} ‡∏ö.</span></div>
                        <input type="number" id="txAmt" class="w-full p-3 border rounded-xl mb-2 text-lg font-bold text-center text-red-600" placeholder="0.00">
                        <p class="text-xs text-red-400 mb-4 text-center">*‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ${sysConfig.feePercent}%</p>
                        <button onclick="app.submitTxn('withdraw')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô</button>
                        <button onclick="app.closeModal()" class="w-full mt-2 py-2 text-slate-400 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    `;
                }
            },
            
            closeModal: () => document.getElementById('modalOverlay').classList.add('hidden'),

            openProfile: () => {
                const m = document.getElementById('modalOverlay');
                const c = document.getElementById('modalContent');
                m.classList.remove('hidden');
                c.innerHTML = `
                    <h3 class="text-lg font-bold text-slate-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß / ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="space-y-3">
                        <input id="pfBank" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" value="${userData.bankName||''}">
                        <input id="pfAcc" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" value="${userData.bankAcc||''}">
                        <input id="pfFb" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (FB/Line)" value="${userData.contactLink||''}">
                        <button onclick="app.saveProfile()" class="w-full bg-bank-main text-white py-3 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="app.closeModal()" class="w-full py-2 text-slate-400 text-sm">‡∏õ‡∏¥‡∏î</button>
                    </div>
                `;
            },

            saveProfile: async () => {
                try {
                    await updateDoc(doc(db,"users",user.uid), {
                        bankName: document.getElementById('pfBank').value,
                        bankAcc: document.getElementById('pfAcc').value,
                        contactLink: document.getElementById('pfFb').value
                    });
                    Swal.fire({icon:'success',title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß',timer:1500,showConfirmButton:false});
                    app.closeModal();
                } catch(e){ Swal.fire('Error',e.message,'error'); }
            },

            submitTxn: async (type) => {
                const amt = parseFloat(document.getElementById('txAmt').value);
                if(!amt || amt <= 0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warning');
                
                if(type==='withdraw') {
                    if(amt > userData.balance) return Swal.fire('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
                    if(!userData.bankAcc) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô','warning').then(()=>app.openProfile());
                }

                try {
                    Swal.showLoading();
                    const fee = type==='withdraw' ? amt*(sysConfig.feePercent/100) : 0;
                    await addDoc(collection(db,"transactions"), {
                        uid: user.uid, email: userData.email, userDisplayName: userData.displayName,
                        userBank: (userData.bankName||'')+' '+(userData.bankAcc||''), userFb: userData.contactLink||'',
                        type, amount: amt, fee, netAmount: amt-fee, status: 'pending', timestamp: new Date()
                    });
                    Swal.fire({icon:'success',title:'‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', timer:2000, showConfirmButton:false});
                    app.closeModal();
                } catch(e){ Swal.fire('Error',e.message,'error'); }
            }
        };

        // INIT SYSTEM
        onAuthStateChanged(auth, u => {
            document.getElementById('sysLoader').classList.add('hidden');
            if(u) {
                user = u;
                // Get User Data
                onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        userData = s.data();
                        document.getElementById('uName').innerText = userData.displayName;
                        document.getElementById('pinGreeting').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userData.displayName}`;
                        document.getElementById('uAccNo').innerText = userData.uid.slice(0,4)+"-x-xxxxx-x";
                        if(!isBalanceHidden) document.getElementById('uBal').innerText = "‡∏ø " + userData.balance.toLocaleString('th-TH',{minimumFractionDigits:2});
                    }
                });
                
                // Get Config
                onSnapshot(doc(db,"system","config"), s => {
                    if(s.exists()) {
                        sysConfig = s.data();
                        if(sysConfig.isMaintenance) document.getElementById('maintenanceScreen').classList.remove('hidden');
                        if(sysConfig.contactLink) document.getElementById('lineLink').href = sysConfig.contactLink;
                    }
                });

                // Get History
                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid), orderBy("timestamp","desc"), limit(20)), s => {
                    const list = document.getElementById('txList');
                    list.innerHTML = "";
                    if(s.empty) { list.innerHTML = `<div class="text-center py-8 text-slate-300 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`; return; }
                    
                    s.forEach(d => {
                        const x = d.data();
                        const isDep = x.type==='deposit';
                        const time = moment(x.timestamp.seconds*1000).format('HH:mm');
                        const date = moment(x.timestamp.seconds*1000).format('DD/MM');
                        
                        let stIcon = '';
                        if(x.status==='pending') stIcon = '<span class="text-yellow-500 text-[10px] bg-yellow-50 px-2 py-0.5 rounded-full">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                        else if(x.status==='completed') stIcon = '<span class="text-green-500 text-[10px] bg-green-50 px-2 py-0.5 rounded-full">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                        else stIcon = '<span class="text-red-500 text-[10px] bg-red-50 px-2 py-0.5 rounded-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';

                        list.innerHTML += `
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg ${isDep?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}">
                                        <i class="fas ${isDep?'fa-arrow-down':'fa-arrow-up'}"></i>
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-700 text-sm">${isDep?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'}</p>
                                        <p class="text-[10px] text-slate-400">${date} ‚Ä¢ ${time} ‡∏ô.</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${isDep?'text-green-600':'text-slate-800'}">${isDep?'+':'-'}${x.amount.toLocaleString()}</p>
                                    ${stIcon}
                                </div>
                            </div>
                        `;
                    });
                });

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('pinScreen').classList.remove('hidden'); // Show PIN First
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('pinScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Time Greeting
        const hour = new Date().getHours();
        document.getElementById('timeGreeting').innerText = hour < 12 ? "‡πÄ‡∏ä‡πâ‡∏≤" : (hour < 18 ? "‡∏ö‡πà‡∏≤‡∏¢" : "‡πÄ‡∏¢‡πá‡∏ô");
    </script>
</body>
</html>
