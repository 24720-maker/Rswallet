<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS ULTIMATE AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        /* --- THEME SETUP --- */
        :root {
            --gold: #FFD700;
            --gold-dim: #C5A000;
            --bg-dark: #050505;
            --glass: rgba(20, 20, 20, 0.7);
            --border: rgba(255, 215, 0, 0.15);
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 215, 0, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 215, 0, 0.05) 0px, transparent 50%);
            color: #fff;
            height: 100dvh;
            overflow: hidden;
        }

        .font-num { font-family: 'Rajdhani', sans-serif; }

        /* Custom Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes scan-laser {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; box-shadow: 0 0 20px var(--gold); }
            100% { top: 100%; opacity: 0; }
        }

        /* Elements */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .gold-glow {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: #000;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.96); }
        
        /* Locked Overlay */
        .locked-filter {
            filter: grayscale(100%) brightness(0.5);
            pointer-events: none;
        }

        /* Inputs */
        .custom-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        .custom-input:focus { border-color: var(--gold); }
    </style>
</head>
<body class="flex flex-col">

    <div id="auth-screen" class="fixed inset-0 z-50 bg-black flex flex-col justify-center items-center p-6 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        
        <div class="mb-8 text-center animate-[float_3s_infinite_ease-in-out]">
            <div class="w-20 h-20 mx-auto bg-gradient-to-b from-yellow-400 to-yellow-700 rounded-full p-[2px] shadow-[0_0_30px_rgba(255,215,0,0.3)]">
                <div class="w-full h-full bg-black rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-robot text-4xl text-yellow-500"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold mt-4 tracking-wider italic">RS <span class="text-[#FFD700]">INFINITY</span></h1>
            <p class="text-gray-500 text-xs font-num tracking-[0.3em]">AI TRADING SYSTEM V6.0</p>
        </div>

        <div class="glass-card w-full max-w-sm p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
            
            <h2 id="auth-title" class="text-xl text-center mb-6 font-bold text-white">เข้าสู่ระบบ</h2>

            <form id="auth-form" class="space-y-4">
                <div id="field-username" class="hidden">
                    <label class="text-xs text-gray-400 ml-1">ชื่อเรียกขาน (Username)</label>
                    <input type="text" id="inp-username" class="custom-input font-light" placeholder="ระบุชื่อของคุณ">
                </div>

                <div>
                    <label class="text-xs text-gray-400 ml-1">อีเมล (Email)</label>
                    <input type="email" id="inp-email" required class="custom-input font-light" placeholder="example@gmail.com">
                </div>

                <div>
                    <label class="text-xs text-gray-400 ml-1">รหัสผ่าน (Password)</label>
                    <input type="password" id="inp-password" required class="custom-input font-light" placeholder="••••••••">
                </div>

                <button type="submit" id="btn-submit" class="btn-primary w-full py-3 rounded-xl mt-2">
                    เข้าสู่ระบบ
                </button>
            </form>

            <div class="mt-6 text-center">
                <p id="auth-msg" class="text-xs text-gray-500">ยังไม่มีบัญชี?</p>
                <button onclick="toggleAuth()" id="auth-toggle" class="text-yellow-500 text-sm font-bold underline mt-1">สมัครสมาชิกใหม่</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex flex-col h-full relative">
        
        <header class="flex justify-between items-center p-5 pt-8 bg-gradient-to-b from-black to-transparent sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full border border-yellow-500/50 bg-yellow-500/10 flex items-center justify-center">
                    <i class="fa-solid fa-user-astronaut text-yellow-500"></i>
                </div>
                <div>
                    <div id="disp-username" class="font-bold text-white leading-tight">Guest</div>
                    <div class="text-[10px] text-gray-400 font-num">ID: <span id="disp-uid">...</span></div>
                </div>
            </div>
            <div id="status-pill" class="px-3 py-1 rounded-full bg-red-900/30 border border-red-500/50 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-red-400 uppercase">EXPIRED</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scroll pb-24 px-4">
            
            <div id="tab-home" class="space-y-6 animate-[fadeIn_0.5s]">
                
                <div class="glass-card p-4 flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">MARKET SENTIMENT</div>
                        <div class="text-xl font-bold text-white flex items-center gap-2">
                            BULLISH <i class="fa-solid fa-arrow-trend-up text-green-500"></i>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 mb-1">VOLATILITY</div>
                        <div class="text-xl font-bold font-num text-yellow-500">HIGH</div>
                    </div>
                </div>

                <div class="relative py-6 flex justify-center">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border border-white/5 rounded-full"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-56 h-56 border border-dashed border-yellow-500/20 rounded-full animate-[spin_10s_linear_infinite]"></div>
                    
                    <button id="btn-main-scan" onclick="openSetupModal()" class="relative z-10 w-48 h-48 rounded-full bg-gradient-to-b from-[#1a1a1a] to-[#000] border-2 border-[#222] shadow-[0_0_30px_rgba(0,0,0,0.8)] flex flex-col items-center justify-center group active:scale-95 transition-transform duration-200">
                        <i class="fa-solid fa-fingerprint text-5xl text-gray-600 group-hover:text-yellow-500 transition-colors duration-300"></i>
                        <div class="mt-3 text-lg font-bold text-white tracking-widest group-hover:text-yellow-500 transition-colors">START AI</div>
                        <div class="text-[10px] text-gray-500 font-num">SCAN MARKET</div>
                        
                        <div id="lock-icon" class="absolute inset-0 bg-black/80 rounded-full flex flex-col items-center justify-center backdrop-blur-[2px]">
                            <i class="fa-solid fa-lock text-3xl text-red-500 mb-2"></i>
                            <span class="text-xs font-bold text-red-500">LOCKED</span>
                        </div>
                    </button>
                </div>

                <div id="alert-box" class="glass-card p-4 border-l-4 border-red-500 bg-red-900/10 flex justify-between items-center">
                    <div>
                        <h3 class="text-sm font-bold text-red-400">ระบบถูกระงับ (Expired)</h3>
                        <p class="text-[10px] text-gray-400">กรุณาติดต่อแอดมินเพื่อเติมเวลาใช้งาน</p>
                    </div>
                    <button onclick="contactAdmin()" class="bg-red-600 hover:bg-red-500 text-white text-xs px-3 py-2 rounded-lg font-bold">
                        ติดต่อ Admin
                    </button>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-gray-400 mb-3 ml-1">สัญญาณล่าสุด (Recent Signals)</h3>
                    <div class="space-y-3">
                        <div class="glass-card p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" class="w-8 h-8 rounded-full">
                                <div>
                                    <div class="text-sm font-bold text-white">BTC/USDT</div>
                                    <div class="text-[10px] text-gray-400">09:45 AM</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-green-500">WIN</div>
                                <div class="text-[10px] text-green-500/70">+185% Profit</div>
                            </div>
                        </div>
                        <div class="glass-card p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-yellow-500/20 rounded-full flex items-center justify-center text-yellow-500 text-[10px] font-bold border border-yellow-500/50">GLD</div>
                                <div>
                                    <div class="text-sm font-bold text-white">XAU/USD</div>
                                    <div class="text-[10px] text-gray-400">08:20 AM</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-green-500">WIN</div>
                                <div class="text-[10px] text-green-500/70">+92% Profit</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-chart" class="hidden h-full flex flex-col">
                <div class="mb-3 overflow-x-auto whitespace-nowrap pb-1">
                    <button onclick="loadChart('BTCUSDT')" class="bg-yellow-500 text-black px-4 py-1.5 rounded-lg text-xs font-bold mr-2">BTC</button>
                    <button onclick="loadChart('ETHUSDT')" class="bg-gray-800 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold mr-2">ETH</button>
                    <button onclick="loadChart('XAUUSD')" class="bg-gray-800 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold mr-2">GOLD</button>
                    <button onclick="loadChart('EURUSD')" class="bg-gray-800 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold">EURUSD</button>
                </div>
                <div class="flex-1 glass-card overflow-hidden p-1">
                    <div id="tv-main-chart" class="w-full h-full rounded-lg bg-black"></div>
                </div>
            </div>

            <div id="tab-profile" class="hidden space-y-5 animate-[fadeIn_0.5s]">
                <div class="w-full bg-gradient-to-br from-[#1a1a1a] via-[#111] to-[#000] border border-gray-800 rounded-2xl p-6 relative overflow-hidden shadow-2xl">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-500/5 rounded-full blur-2xl"></div>
                    
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-20 h-20 rounded-full border-2 border-yellow-500 p-1 mb-3">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full rounded-full bg-gray-800">
                        </div>
                        <h2 id="profile-name" class="text-xl font-bold text-white">User Name</h2>
                        <p class="text-xs text-yellow-500 font-bold tracking-widest uppercase mt-1">Premium Member</p>
                    </div>

                    <div class="bg-black/50 rounded-xl p-4 border border-white/5 text-center">
                        <div class="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">เวลาคงเหลือ (Time Remaining)</div>
                        <div id="countdown-timer" class="text-3xl font-num font-bold text-white tracking-wider">00 : 00 : 00 : 00</div>
                        <div id="countdown-label" class="flex justify-center gap-5 text-[8px] text-gray-500 mt-1">
                            <span>DAYS</span><span>HOURS</span><span>MINS</span><span>SECS</span>
                        </div>
                    </div>
                </div>

                <button id="btn-contact" class="w-full glass-card p-4 flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-900/20 text-green-500 flex items-center justify-center">
                            <i class="fa-brands fa-line text-xl"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-bold text-white">ติดต่อแอดมิน (Support)</div>
                            <div class="text-[10px] text-gray-400">เติมวันใช้งาน / แจ้งปัญหา</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-600"></i>
                </button>

                <button onclick="logout()" class="w-full glass-card p-4 flex items-center justify-between group border-red-900/30">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-red-900/20 text-red-500 flex items-center justify-center">
                            <i class="fa-solid fa-power-off text-xl"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-bold text-red-400">ออกจากระบบ</div>
                            <div class="text-[10px] text-gray-500">Log out</div>
                        </div>
                    </div>
                </button>
            </div>

        </main>

        <nav class="h-[80px] bg-[#080808] border-t border-white/5 grid grid-cols-3 items-center pb-2 px-2 relative z-30">
            <button onclick="switchTab('home')" id="nav-home" class="nav-item active flex flex-col items-center gap-1 opacity-100 text-yellow-500 transition-all">
                <i class="fa-solid fa-house text-xl"></i>
                <span class="text-[10px]">หน้าหลัก</span>
            </button>
            <button onclick="switchTab('chart')" id="nav-chart" class="nav-item flex flex-col items-center gap-1 opacity-50 text-gray-400 transition-all">
                <i class="fa-solid fa-chart-line text-xl"></i>
                <span class="text-[10px]">กราฟ</span>
            </button>
            <button onclick="switchTab('profile')" id="nav-profile" class="nav-item flex flex-col items-center gap-1 opacity-50 text-gray-400 transition-all">
                <i class="fa-solid fa-user text-xl"></i>
                <span class="text-[10px]">โปรไฟล์</span>
            </button>
        </nav>

    </div>

    <div id="modal-setup" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="w-full sm:w-[400px] bg-[#151515] rounded-t-3xl border-t border-yellow-500/50 p-6 animate-[float_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-sliders text-yellow-500 mr-2"></i>ตั้งค่า AI</h3>
                <button onclick="closeModal('modal-setup')" class="text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-400 mb-1 block">เลือกคู่เงิน (Currency Pair)</label>
                <select id="setup-pair" class="custom-input bg-[#222]">
                    <optgroup label="Crypto">
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="XRPUSDT">XRP/USDT</option>
                    </optgroup>
                    <optgroup label="Forex/Metals">
                        <option value="XAUUSD">XAU/USD (Gold)</option>
                        <option value="EURUSD">EUR/USD</option>
                        <option value="GBPUSD">GBP/USD</option>
                        <option value="USDJPY">USD/JPY</option>
                    </optgroup>
                </select>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-400 mb-1 block">เงินทุนเริ่มต้น (Capital)</label>
                <div class="relative">
                    <input type="number" id="setup-capital" class="custom-input bg-[#222] pl-8" placeholder="1000">
                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-xs text-gray-400 mb-1 block">กรอบเวลา (Timeframe)</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="selectTF(this, '1m')" class="tf-btn bg-[#222] text-gray-400 py-2 rounded border border-gray-700 text-xs">1m</button>
                    <button onclick="selectTF(this, '5m')" class="tf-btn active bg-yellow-500 text-black py-2 rounded border border-yellow-500 text-xs font-bold">5m</button>
                    <button onclick="selectTF(this, '15m')" class="tf-btn bg-[#222] text-gray-400 py-2 rounded border border-gray-700 text-xs">15m</button>
                    <button onclick="selectTF(this, '1h')" class="tf-btn bg-[#222] text-gray-400 py-2 rounded border border-gray-700 text-xs">1h</button>
                </div>
            </div>

            <button onclick="startProcessing()" class="btn-primary w-full py-3.5 rounded-xl text-lg flex justify-center items-center gap-2">
                <i class="fa-solid fa-bolt"></i> เริ่มประมวลผล
            </button>
        </div>
    </div>

    <div id="screen-process" class="hidden fixed inset-0 z-[60] bg-black flex flex-col font-num">
        
        <div class="h-16 border-b border-gray-800 flex justify-between items-center px-4 bg-[#0a0a0a]">
            <div>
                <div class="text-[10px] text-gray-500">TARGET ASSET</div>
                <div id="proc-pair" class="text-xl font-bold text-yellow-500">BTC/USDT</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-500">TIMEFRAME</div>
                <div id="proc-tf" class="text-lg font-bold text-white">5m</div>
            </div>
        </div>

        <div class="h-[40%] bg-[#000] relative border-b border-gray-800">
            <div id="tv-process-chart" class="w-full h-full opacity-60"></div>
            <div class="absolute inset-0 w-[2px] h-full bg-yellow-500 blur-[2px] shadow-[0_0_10px_#FFD700] animate-[scan-laser_2s_infinite_linear] left-1/2"></div>
        </div>

        <div class="flex-1 bg-black p-4 overflow-hidden relative">
            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-10"></div>
            
            <div class="space-y-2 text-xs font-mono relative z-10">
                <div class="text-green-500 flex justify-between">
                    <span>> CONNECTING TO SERVER...</span>
                    <span>[OK]</span>
                </div>
                <div id="log-1" class="text-gray-400 opacity-0 transition duration-300">> ANALYZING CANDLESTICK PATTERN...</div>
                <div id="log-2" class="text-gray-400 opacity-0 transition duration-300">> RSI (14): <span class="text-yellow-500">34.2 (OVERSOLD)</span></div>
                <div id="log-3" class="text-gray-400 opacity-0 transition duration-300">> MACD: <span class="text-green-500">CROSSOVER SIGNAL DETECTED</span></div>
                <div id="log-4" class="text-gray-400 opacity-0 transition duration-300">> BOLLINGER BANDS: <span class="text-blue-400">TOUCHING LOWER BAND</span></div>
                <div id="log-5" class="text-white font-bold opacity-0 transition duration-300 mt-4 border-t border-gray-700 pt-2">> CALCULATING PROBABILITY... <span class="animate-pulse">94%</span></div>
            </div>
        </div>

        <div class="h-2 bg-gray-900 w-full">
            <div id="proc-bar" class="h-full bg-yellow-500 w-0 transition-all duration-[4000ms] ease-out"></div>
        </div>
    </div>

    <div id="modal-result" class="hidden fixed inset-0 z-[70] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="w-full max-w-sm glass-card p-6 border-t-4 border-green-500 animate-[float_0.5s_ease-out]">
            <div class="text-center">
                <div class="text-xs text-gray-400 tracking-widest mb-4">AI SIGNAL GENERATED</div>
                
                <div id="res-badge" class="w-20 h-20 rounded-full bg-green-900/20 border border-green-500 mx-auto flex items-center justify-center mb-4 shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                    <i id="res-icon" class="fa-solid fa-arrow-up text-3xl text-green-500"></i>
                </div>

                <h2 id="res-action" class="text-4xl font-black text-green-500 italic mb-2">BUY</h2>
                <div class="flex justify-between items-center bg-gray-900 rounded-lg p-3 mb-2">
                    <span class="text-gray-400 text-xs">PAIR</span>
                    <span id="res-pair-text" class="text-white font-bold">BTC/USDT</span>
                </div>
                <div class="flex justify-between items-center bg-gray-900 rounded-lg p-3 mb-2">
                    <span class="text-gray-400 text-xs">ENTRY PRICE</span>
                    <span class="text-yellow-500 font-bold">Market Price</span>
                </div>
                <div class="flex justify-between items-center bg-gray-900 rounded-lg p-3 mb-4">
                    <span class="text-gray-400 text-xs">CONFIDENCE</span>
                    <span class="text-green-400 font-bold">94.5%</span>
                </div>
                
                <button onclick="closeResult()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-gray-700">เสร็จสิ้น</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.appspot.com",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let isExpired = true;
        let adminLink = "#";
        let selectedTF = '5m';

        // --- AUTH ---
        let isRegister = false;
        window.toggleAuth = () => {
            isRegister = !isRegister;
            document.getElementById('auth-title').innerText = isRegister ? "สมัครสมาชิก" : "เข้าสู่ระบบ";
            document.getElementById('btn-submit').innerText = isRegister ? "ยืนยันการสมัคร" : "เข้าสู่ระบบ";
            document.getElementById('field-username').classList.toggle('hidden');
            document.getElementById('auth-msg').innerText = isRegister ? "มีบัญชีอยู่แล้ว?" : "ยังไม่มีบัญชี?";
            document.getElementById('auth-toggle').innerText = isRegister ? "เข้าสู่ระบบ" : "สมัครสมาชิกใหม่";
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('inp-email').value;
            const pass = document.getElementById('inp-password').value;
            const btn = document.getElementById('btn-submit');
            
            try {
                btn.innerText = "กำลังโหลด...";
                if(isRegister) {
                    const name = document.getElementById('inp-username').value;
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    
                    // Create user but EXPIRED (past date)
                    const pastDate = new Date();
                    pastDate.setDate(pastDate.getDate() - 1); // Yesterday

                    await setDoc(doc(db, "users", cred.user.uid), {
                        username: name,
                        email: email,
                        expiryDate: pastDate, // Expired by default
                        createdAt: serverTimestamp()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(err) {
                alert("Error: " + err.message);
                btn.innerText = "ลองใหม่";
            }
        });

        window.logout = () => signOut(auth);

        // --- MAIN LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadUserData(user.uid);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        function loadUserData(uid) {
            // User Data
            onSnapshot(doc(db, "users", uid), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    document.getElementById('disp-username').innerText = data.username || "User";
                    document.getElementById('profile-name').innerText = data.username || "User";
                    document.getElementById('disp-uid').innerText = uid.substring(0, 6);

                    // Check Expiry
                    const exp = data.expiryDate.toDate();
                    startCountdown(exp);
                }
            });

            // Admin Link
            onSnapshot(doc(db, "system", "config"), (snap) => {
                if(snap.exists()) adminLink = snap.data().contactLink || "#";
            });

            // Load Default Chart
            loadChart('BTCUSDT', 'tv-main-chart');
        }

        // --- COUNTDOWN SYSTEM ---
        let timerInterval;
        function startCountdown(expiryDate) {
            if(timerInterval) clearInterval(timerInterval);

            function update() {
                const now = new Date();
                const diff = expiryDate - now;

                if(diff <= 0) {
                    // Expired
                    isExpired = true;
                    document.getElementById('countdown-timer').innerText = "00 : 00 : 00 : 00";
                    document.getElementById('countdown-timer').classList.add('text-red-500');
                    document.getElementById('status-pill').innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-[10px] font-bold text-red-400">EXPIRED</span>';
                    document.getElementById('status-pill').className = "px-3 py-1 rounded-full bg-red-900/30 border border-red-500/50 flex items-center gap-2";
                    
                    // Lock UI
                    document.getElementById('lock-icon').classList.remove('hidden');
                    document.getElementById('alert-box').classList.remove('hidden');
                } else {
                    // Active
                    isExpired = false;
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);

                    document.getElementById('countdown-timer').innerText = 
                        `${pad(d)} : ${pad(h)} : ${pad(m)} : ${pad(s)}`;
                    document.getElementById('countdown-timer').classList.remove('text-red-500');
                    
                    document.getElementById('status-pill').innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-[10px] font-bold text-green-400">ONLINE</span>';
                    document.getElementById('status-pill').className = "px-3 py-1 rounded-full bg-green-900/30 border border-green-500/50 flex items-center gap-2";

                    // Unlock UI
                    document.getElementById('lock-icon').classList.add('hidden');
                    document.getElementById('alert-box').classList.add('hidden');
                }
            }

            update();
            timerInterval = setInterval(update, 1000);
        }

        function pad(n) { return n < 10 ? '0'+n : n; }

        // --- SCANNER LOGIC ---
        window.openSetupModal = () => {
            if(isExpired) {
                alert("ระบบสมาชิกหมดอายุ กรุณาเติมวันใช้งาน");
                return;
            }
            document.getElementById('modal-setup').classList.remove('hidden');
        }

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.selectTF = (el, tf) => {
            document.querySelectorAll('.tf-btn').forEach(b => {
                b.className = "tf-btn bg-[#222] text-gray-400 py-2 rounded border border-gray-700 text-xs";
            });
            el.className = "tf-btn active bg-yellow-500 text-black py-2 rounded border border-yellow-500 text-xs font-bold";
            selectedTF = tf;
        }

        window.startProcessing = () => {
            const pair = document.getElementById('setup-pair').value;
            const capital = document.getElementById('setup-capital').value;
            
            if(!capital) return alert("กรุณาระบุเงินทุน");

            closeModal('modal-setup');
            
            // Show Processing Screen
            const procScreen = document.getElementById('screen-process');
            procScreen.classList.remove('hidden');
            
            document.getElementById('proc-pair').innerText = pair;
            document.getElementById('proc-tf').innerText = selectedTF;
            
            // Load Chart in Processing Screen
            loadChart(pair, 'tv-process-chart', true);

            // Animation Sequence
            document.getElementById('proc-bar').style.width = "0%";
            setTimeout(() => document.getElementById('proc-bar').style.width = "100%", 100);

            // Fake Logs
            setTimeout(() => document.getElementById('log-1').style.opacity = 1, 800);
            setTimeout(() => document.getElementById('log-2').style.opacity = 1, 1600);
            setTimeout(() => document.getElementById('log-3').style.opacity = 1, 2400);
            setTimeout(() => document.getElementById('log-4').style.opacity = 1, 3200);
            setTimeout(() => document.getElementById('log-5').style.opacity = 1, 3800);

            // Finish
            setTimeout(() => {
                procScreen.classList.add('hidden');
                showResult(pair);
            }, 4500);
        }

        function showResult(pair) {
            const isBuy = Math.random() > 0.5;
            const action = document.getElementById('res-action');
            const icon = document.getElementById('res-icon');
            const badge = document.getElementById('res-badge');

            document.getElementById('res-pair-text').innerText = pair;

            if(isBuy) {
                action.innerText = "BUY";
                action.className = "text-4xl font-black text-green-500 italic mb-2";
                icon.className = "fa-solid fa-arrow-up text-3xl text-green-500";
                badge.className = "w-20 h-20 rounded-full bg-green-900/20 border border-green-500 mx-auto flex items-center justify-center mb-4 shadow-[0_0_20px_rgba(34,197,94,0.3)]";
            } else {
                action.innerText = "SELL";
                action.className = "text-4xl font-black text-red-500 italic mb-2";
                icon.className = "fa-solid fa-arrow-down text-3xl text-red-500";
                badge.className = "w-20 h-20 rounded-full bg-red-900/20 border border-red-500 mx-auto flex items-center justify-center mb-4 shadow-[0_0_20px_rgba(239,68,68,0.3)]";
            }

            document.getElementById('modal-result').classList.remove('hidden');
        }

        window.closeResult = () => document.getElementById('modal-result').classList.add('hidden');

        // --- TRADING VIEW ---
        window.loadChart = (symbol, containerId = 'tv-main-chart', hideToolbar = false) => {
            let tvSymbol = "BINANCE:" + symbol;
            if(symbol === "XAUUSD") tvSymbol = "OANDA:XAUUSD";
            if(symbol === "EURUSD" || symbol === "GBPUSD" || symbol === "USDJPY") tvSymbol = "FX:" + symbol;

            new TradingView.widget({
                "container_id": containerId,
                "width": "100%",
                "height": "100%",
                "symbol": tvSymbol,
                "interval": "15",
                "timezone": "Asia/Bangkok",
                "theme": "dark",
                "style": "1",
                "locale": "th_TH",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": hideToolbar,
                "hide_legend": hideToolbar,
                "save_image": false,
                "backgroundColor": "#000000"
            });
        }

        // --- NAVIGATION & CONTACT ---
        window.switchTab = (tab) => {
            ['home', 'chart', 'profile'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-yellow-500', 'opacity-100');
                el.classList.add('opacity-50', 'text-gray-400');
            });

            document.getElementById('tab-'+tab).classList.remove('hidden');
            const active = document.getElementById('nav-'+tab);
            active.classList.remove('opacity-50', 'text-gray-400');
            active.classList.add('active', 'text-yellow-500', 'opacity-100');

            if(tab === 'chart') loadChart('BTCUSDT'); // Refresh chart
        }

        window.contactAdmin = () => window.open(adminLink, '_blank');
        document.getElementById('btn-contact').addEventListener('click', contactAdmin);

    </script>
</body>
</html>
