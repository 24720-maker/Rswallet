<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA - Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-bg { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="loader" class="fixed inset-0 z-[999] bg-white flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <p class="text-blue-600 font-bold animate-pulse">CONNECTING...</p>
    </div>

    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden transform hover:-translate-y-1 transition duration-500">
            <div class="bg-blue-600 p-8 text-center">
                <h1 class="text-4xl font-bold text-white tracking-widest">FAFADA</h1>
                <p class="text-blue-100 text-sm mt-1">Wallet System</p>
            </div>
            <div class="p-8">
                <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                    <button onclick="authTab('login')" id="tabLogin" class="flex-1 py-2 rounded-lg font-bold bg-white text-blue-600 shadow">เข้าสู่ระบบ</button>
                    <button onclick="authTab('register')" id="tabRegister" class="flex-1 py-2 rounded-lg font-bold text-gray-400">สมัครสมาชิก</button>
                </div>

                <form id="formLogin" onsubmit="app.login(event)">
                    <input id="lEmail" class="w-full px-4 py-3 bg-slate-50 border rounded-xl mb-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="อีเมล" required>
                    <input type="password" id="lPass" class="w-full px-4 py-3 bg-slate-50 border rounded-xl mb-6 outline-none focus:ring-2 focus:ring-blue-500" placeholder="รหัสผ่าน" required>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition">เข้าสู่ระบบ</button>
                </form>

                <form id="formRegister" onsubmit="app.register(event)" class="hidden">
                    <input id="rName" class="w-full px-4 py-3 bg-slate-50 border rounded-xl mb-3 outline-none focus:ring-2 focus:ring-green-500" placeholder="ชื่อที่แสดง" required>
                    <input id="rEmail" class="w-full px-4 py-3 bg-slate-50 border rounded-xl mb-3 outline-none focus:ring-2 focus:ring-green-500" placeholder="อีเมล" required>
                    <input type="password" id="rPass" class="w-full px-4 py-3 bg-slate-50 border rounded-xl mb-6 outline-none focus:ring-2 focus:ring-green-500" placeholder="รหัสผ่าน" required>
                    <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition">สมัครสมาชิก</button>
                </form>
            </div>
        </div>
    </div>

    <div id="mainScreen" class="min-h-screen hidden pb-20">
        <nav class="bg-white sticky top-0 z-40 shadow-sm border-b border-gray-200">
            <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
                <span class="text-xl font-bold text-blue-900 tracking-tight">FAFADA</span>
                <div class="flex items-center gap-3">
                    <button onclick="app.openProfile()" class="flex items-center gap-2 bg-slate-50 hover:bg-slate-100 px-3 py-1.5 rounded-full transition border border-slate-200">
                        <div class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs"><i class="fas fa-user"></i></div>
                        <span class="text-xs font-bold text-slate-700 max-w-[100px] truncate" id="navName">...</span>
                    </button>
                    <button onclick="app.logout()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-4 py-6">
            
            <div id="newsAlert" class="hidden mb-6 bg-white border-l-4 border-amber-400 p-4 rounded-r-xl shadow-sm flex items-start gap-4">
                <i class="fas fa-bullhorn text-amber-500 mt-1"></i>
                <div>
                    <h3 id="newsTitle" class="font-bold text-slate-800 text-sm"></h3>
                    <p id="newsContent" class="text-xs text-slate-500 mt-1"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-5 space-y-6">
                    <div class="card-bg rounded-3xl p-8 text-white shadow-xl relative overflow-hidden transform hover:scale-[1.01] transition duration-500">
                        <div class="absolute right-0 top-0 w-48 h-48 bg-white opacity-10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/4"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-8">
                                <img src="https://raw.githubusercontent.com/muhmi/payment-icons/main/assets/chip.png" class="h-8 opacity-80">
                                <i class="fas fa-wifi rotate-90 opacity-50"></i>
                            </div>
                            <p class="text-blue-200 text-xs font-medium tracking-wider mb-1">Current Balance</p>
                            <h1 class="text-4xl font-bold tracking-tight mb-6">฿ <span id="cardBal">0.00</span></h1>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-[10px] text-blue-200 uppercase tracking-widest">Account ID</p>
                                    <p class="font-mono text-sm tracking-widest opacity-90" id="cardId">.... ....</p>
                                </div>
                                <div class="bg-white/20 backdrop-blur px-2 py-1 rounded text-[10px]">ACTIVE</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800">ทำรายการ</h3>
                            <a id="contactBtn" href="#" target="_blank" class="hidden text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"><i class="fab fa-facebook-messenger mr-1"></i> ติดต่อแอดมิน</a>
                        </div>

                        <div class="flex bg-slate-50 p-1 rounded-xl mb-4">
                            <button onclick="app.setTxn('deposit')" id="btnDep" class="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white text-green-600 shadow transition">ฝากเงิน</button>
                            <button onclick="app.setTxn('withdraw')" id="btnWdr" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-400 hover:text-red-500 transition">ถอนเงิน</button>
                        </div>

                        <div id="adminBankBox" class="hidden mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm">
                            <p class="text-xs font-bold text-blue-800 mb-1"><i class="fas fa-bank"></i> โอนเงินเข้าบัญชี:</p>
                            <p id="txtAdminBank" class="text-blue-600 whitespace-pre-line">Loading...</p>
                        </div>

                        <form onsubmit="app.submitTxn(event)">
                            <div class="relative mb-2">
                                <span class="absolute left-4 top-3.5 text-gray-400 font-bold">฿</span>
                                <input type="number" id="amt" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-gray-700" placeholder="0.00" step="0.01" min="1" required oninput="app.calc()">
                            </div>
                            
                            <div id="feeBox" class="hidden px-2 mb-4">
                                <div class="flex justify-between text-xs text-red-500 mb-1"><span>ค่าธรรมเนียม (<span id="feePc">0</span>%)</span><span id="feeVal">0</span></div>
                                <div class="flex justify-between text-sm font-bold text-slate-700 border-t border-dashed border-slate-300 pt-1"><span>รับสุทธิ</span><span id="netVal">0</span></div>
                            </div>

                            <button id="btnSubmit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-check-circle"></i> ยืนยัน
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-7 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-history text-blue-500"></i> ประวัติล่าสุด</h3>
                        <input type="text" id="search" onkeyup="app.filter()" placeholder="ค้นหา..." class="text-xs bg-slate-50 border-none rounded-full py-1.5 px-4 w-32 focus:w-48 transition-all focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="overflow-auto flex-1 max-h-[500px]">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10">
                                <tr><th class="p-3 rounded-l">รายการ</th><th class="p-3 text-right">ยอด</th><th class="p-3 text-center rounded-r">สถานะ</th></tr>
                            </thead>
                            <tbody id="tbHist" class="divide-y divide-slate-100"></tbody>
                        </table>
                        <div id="noHist" class="hidden py-10 text-center text-slate-400 text-sm">ยังไม่มีรายการ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalProfile" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative animate-fade-in">
            <button onclick="document.getElementById('modalProfile').classList.add('hidden')" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                <p class="text-[10px] font-bold text-yellow-700 uppercase mb-2"><i class="fas fa-exclamation-triangle"></i> ข้อมูลสำหรับรับเงิน (จำเป็น)</p>
                <form onsubmit="app.saveProfile(event)" class="space-y-3">
                    <input id="pfBank" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="ชื่อธนาคาร (เช่น กสิกร)" required>
                    <input id="pfAcc" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="เลขที่บัญชี" required>
                    <input id="pfFb" class="w-full text-xs p-3 border border-yellow-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-yellow-500" placeholder="ลิงก์ Facebook/Line (สำหรับติดต่อ)" required>
                    <button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">บันทึกข้อมูล</button>
                </form>
            </div>
            
            <div class="text-xs text-slate-400 text-center">
                User ID: <span id="pfUid" class="font-mono">...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419", measurementId: "G-Q73X8Q841W" };
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        const state = { user: null, data: null, config: { feePercent: 5, adminBank: '-', contactLink: '' }, type: 'deposit', history: [] };

        window.authTab = (t) => {
            const l=document.getElementById('formLogin'), r=document.getElementById('formRegister'), bl=document.getElementById('tabLogin'), br=document.getElementById('tabRegister');
            if(t==='login'){ l.classList.remove('hidden'); r.classList.add('hidden'); bl.className="flex-1 py-2 rounded-lg font-bold bg-white text-blue-600 shadow"; br.className="flex-1 py-2 rounded-lg font-bold text-gray-400"; }
            else { l.classList.add('hidden'); r.classList.remove('hidden'); br.className="flex-1 py-2 rounded-lg font-bold bg-green-500 text-white shadow"; bl.className="flex-1 py-2 rounded-lg font-bold text-gray-400"; }
        };

        window.app = {
            login: async(e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); }catch(err){ Swal.fire('Error','ข้อมูลไม่ถูกต้อง','error'); } },
            register: async(e)=>{ e.preventDefault(); const n=document.getElementById('rName').value, em=document.getElementById('rEmail').value, pw=document.getElementById('rPass').value; try{ const c=await createUserWithEmailAndPassword(auth, em, pw); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid, email:em, displayName:n, role:em==='farisxuma1@gmail.com'?'admin':'user', balance:0, createdAt:new Date()}); Swal.fire('Success','สมัครสำเร็จ','success'); }catch(err){ Swal.fire('Error',err.message,'error'); } },
            logout: ()=>Swal.fire({title:'Logout?',showCancelButton:true}).then(r=>{if(r.isConfirmed)signOut(auth).then(()=>location.reload())}),
            
            render: ()=>{
                document.getElementById('navName').innerText = state.data.displayName;
                document.getElementById('cardBal').innerText = state.data.balance.toLocaleString('th-TH',{minimumFractionDigits:2});
                document.getElementById('cardId').innerText = state.user.uid.slice(0,4)+"  "+state.user.uid.slice(-4);
                document.getElementById('txtAdminBank').innerText = state.config.adminBank || 'กรุณาติดต่อแอดมิน';
                document.getElementById('feePc').innerText = state.config.feePercent;
                
                // Modal Data
                document.getElementById('pfUid').innerText = state.user.uid;
                document.getElementById('pfBank').value = state.data.bankName || '';
                document.getElementById('pfAcc').value = state.data.bankAcc || '';
                document.getElementById('pfFb').value = state.data.facebookLink || '';

                if(state.config.contactLink){ const b=document.getElementById('contactBtn'); b.classList.remove('hidden'); b.href=state.config.contactLink; }
            },

            setTxn: (t)=>{
                state.type=t;
                const bD=document.getElementById('btnDep'), bW=document.getElementById('btnWdr'), sub=document.getElementById('btnSubmit');
                if(t==='deposit'){
                    bD.className="flex-1 py-3 text-sm font-bold bg-white text-green-600 shadow rounded-lg transition-all transform scale-105";
                    bW.className="flex-1 py-3 text-sm font-bold text-gray-400 hover:text-red-500 transition-all opacity-70";
                    sub.className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2";
                    sub.innerHTML='<i class="fas fa-arrow-circle-down"></i> ยืนยันฝากเงิน';
                    document.getElementById('feeBox').classList.add('hidden'); document.getElementById('adminBankBox').classList.remove('hidden');
                } else {
                    bW.className="flex-1 py-3 text-sm font-bold bg-white text-red-600 shadow rounded-lg transition-all transform scale-105";
                    bD.className="flex-1 py-3 text-sm font-bold text-gray-400 hover:text-green-600 transition-all opacity-70";
                    sub.className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2";
                    sub.innerHTML='<i class="fas fa-paper-plane"></i> ยืนยันถอนเงิน';
                    document.getElementById('feeBox').classList.remove('hidden'); document.getElementById('adminBankBox').classList.add('hidden');
                }
                app.calc();
            },

            calc: ()=>{
                const v = parseFloat(document.getElementById('amt').value)||0;
                if(state.type==='withdraw'){
                    const f = v*(state.config.feePercent/100);
                    document.getElementById('feeVal').innerText = '-'+f.toLocaleString();
                    document.getElementById('netVal').innerText = (v-f).toLocaleString();
                }
            },

            submitTxn: async(e)=>{
                e.preventDefault(); const v=parseFloat(document.getElementById('amt').value);
                if(v<=0) return Swal.fire('เตือน','ระบุจำนวนเงินให้ถูกต้อง','warning');
                
                if(state.type==='withdraw') {
                    if(v>state.data.balance) return Swal.fire('Error','ยอดเงินไม่พอ','error');
                    if(!state.data.bankAcc || !state.data.facebookLink) return Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกบัญชีและลิงก์ติดต่อในโปรไฟล์ก่อนถอนเงิน','warning').then(()=>app.openProfile());
                }

                try {
                    Swal.showLoading();
                    const fee = state.type==='withdraw' ? v*(state.config.feePercent/100) : 0;
                    await addDoc(collection(db,"transactions"), {
                        uid:state.user.uid, email:state.data.email, userDisplayName:state.data.displayName,
                        userBank:(state.data.bankName||'')+' '+(state.data.bankAcc||''), userFb:state.data.facebookLink||'',
                        type:state.type, amount:v, fee:fee, netAmount:v-fee, status:'pending', timestamp:new Date()
                    });
                    Swal.fire('Success','ส่งรายการแล้ว รอตรวจสอบ','success');
                    document.getElementById('amt').value=''; app.calc();
                } catch(err){ Swal.fire('Error',err.message,'error'); }
            },

            openProfile: ()=>{ document.getElementById('modalProfile').classList.remove('hidden'); },
            
            saveProfile: async(e)=>{
                e.preventDefault();
                try {
                    await updateDoc(doc(db,"users",state.user.uid), {
                        bankName: document.getElementById('pfBank').value,
                        bankAcc: document.getElementById('pfAcc').value,
                        facebookLink: document.getElementById('pfFb').value
                    });
                    Swal.fire('Success','บันทึกเรียบร้อย','success'); document.getElementById('modalProfile').classList.add('hidden');
                } catch(err){ Swal.fire('Error','บันทึกไม่สำเร็จ','error'); }
            },

            renderHist: (list)=>{
                const t=document.getElementById('tbHist'); t.innerHTML='';
                if(list.length===0){ document.getElementById('noHist').classList.remove('hidden'); return; }
                document.getElementById('noHist').classList.add('hidden');
                list.forEach(x=>{
                    const isD=x.type==='deposit', c=isD?'text-green-600':'text-red-600';
                    let s=x.status==='pending'?'<span class="text-yellow-600 bg-yellow-100 px-2 rounded text-xs">รอ</span>':(x.status==='completed'?'<span class="text-green-600 bg-green-100 px-2 rounded text-xs">เสร็จ</span>':'<span class="text-red-600 bg-red-100 px-2 rounded text-xs">ไม่ผ่าน</span>');
                    t.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-3"><div class="font-bold ${c}">${x.type}</div><div class="text-[10px] text-gray-400">${new Date(x.timestamp.seconds*1000).toLocaleString('th-TH')}</div></td><td class="p-3 text-right font-bold ${c}">${isD?'+':'-'}${x.amount.toLocaleString()}</td><td class="p-3 text-center">${s}</td></tr>`;
                });
            },

            filter: ()=>{
                const k=document.getElementById('search').value.toLowerCase();
                app.renderHist(state.history.filter(x=>x.type.includes(k)||x.amount.toString().includes(k)||x.status.includes(k)));
            }
        };

        // GLOBAL STARTUP
        onAuthStateChanged(auth, u=>{
            document.getElementById('loader').classList.add('hidden');
            if(u){
                state.user=u;
                onSnapshot(doc(db,"users",u.uid), s=>{ if(s.exists()){ state.data=s.data(); app.render(); } });
                onSnapshot(doc(db,"system","config"), s=>{ if(s.exists()){ state.config=s.data(); app.render(); } });
                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid)), s=>{
                    let l=[]; s.forEach(d=>l.push(d.data())); l.sort((a,b)=>b.timestamp-a.timestamp);
                    state.history=l; app.renderHist(l);
                });
                onSnapshot(query(collection(db,"announcements"), orderBy("createdAt","desc"), limit(1)), s=>{
                    if(!s.empty){
                        const n=s.docs[0].data(); document.getElementById('newsAlert').classList.remove('hidden');
                        document.getElementById('newsTitle').innerText=n.title; document.getElementById('newsContent').innerText=n.content;
                    }
                });
                document.getElementById('authScreen').classList.add('hidden'); document.getElementById('mainScreen').classList.remove('hidden');
            } else {
                document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('mainScreen').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
