<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POKDENG ARENA - VIP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Prata&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #F7C873; --wood: #1a0f0a; --green: #064e3b; }
        body { font-family: 'Kanit', sans-serif; background: #05070a; color: #fff; overflow: hidden; user-select: none; }
        
        /* CARD STYLES */
        .card-area { perspective: 1000px; width: 80px; height: 110px; position: relative; transition: 0.5s; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .card-area.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; background-size: cover; background-position: center; border: 1px solid #ccc; }
        .card-front { background-color: white; transform: rotateY(180deg); display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; font-size: 1.5rem; background-repeat: no-repeat; }
        .card-back { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); background-color: #b91c1c; border: 2px solid white; }
        
        /* Floating Animation */
        .deal-anim { animation: deal 0.5s ease-out forwards; }
        @keyframes deal { from { transform: translateY(-500px) scale(0.5); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* UI */
        .glass { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(247, 200, 115, 0.2); border-radius: 16px; }
        .btn-gold { background: linear-gradient(to bottom, #F7C873, #AA8038); color: black; border-radius: 50px; font-weight: 800; border: 2px solid #fff; box-shadow: 0 5px 15px rgba(247, 200, 115, 0.4); transition: 0.2s; }
        .btn-gold:active { transform: scale(0.95); }
        
        .pok-badge { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #ffeb3b; color: #b91c1c; padding: 2px 15px; border-radius: 20px; font-weight: 900; font-size: 1.2rem; border: 3px solid #b91c1c; box-shadow: 0 0 20px #ffeb3b; z-index: 50; animation: bounceIn 0.5s; white-space: nowrap; }
        
        #table-felt { background: radial-gradient(circle, #065f46 0%, #022c22 100%); border-radius: 200px; border: 10px solid #3f2e18; box-shadow: inset 0 0 50px #000; position: relative; width: 120%; height: 80vh; left: -10%; top: 10%; }
    </style>
</head>
<body class="bg-[#0f0f0f]">

    <div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center bg-black/95">
        <div class="glass p-8 w-80 text-center animate__animated animate__zoomIn">
            <h1 class="text-5xl font-['Prata'] text-[#F7C873] mb-2">POKDENG</h1>
            <p class="text-xs text-gray-400 mb-6 uppercase tracking-[0.3em]">Titanium Casino</p>
            <input id="l-email" class="w-full bg-[#222] border border-[#444] p-3 rounded-xl text-center text-white mb-3" placeholder="Email">
            <input id="l-pass" type="password" class="w-full bg-[#222] border border-[#444] p-3 rounded-xl text-center text-white mb-6" placeholder="Password">
            <button onclick="Auth.login()" class="btn-gold w-full py-3 text-lg">เข้าเล่นเกม</button>
            <div class="mt-4 text-xs text-gray-500 cursor-pointer" onclick="UI.regMode()">สมัครสมาชิก</div>
        </div>
    </div>

    <div id="app-view" class="hidden w-full h-screen flex flex-col relative overflow-hidden">
        
        <div class="absolute top-0 w-full z-40 p-4 flex justify-between items-start pointer-events-none">
            <div class="pointer-events-auto flex items-center gap-3 bg-black/60 p-2 rounded-full border border-[#F7C873]/30 pr-6">
                <img id="u-img" class="w-10 h-10 rounded-full border border-[#F7C873]">
                <div>
                    <div class="text-[9px] text-[#F7C873] font-bold">CREDIT</div>
                    <div class="text-lg font-bold leading-none text-white">฿<span id="u-credit">0</span></div>
                </div>
            </div>
            <div class="pointer-events-auto flex gap-2">
                <button onclick="UI.page('lobby')" class="w-10 h-10 rounded-full bg-black/60 text-white border border-white/20"><i class="fa-solid fa-home"></i></button>
                <button onclick="UI.page('wallet')" class="w-10 h-10 rounded-full bg-black/60 text-[#F7C873] border border-[#F7C873]/50"><i class="fa-solid fa-wallet"></i></button>
            </div>
        </div>

        <div id="p-lobby" class="relative z-30 p-4 pt-24 h-full overflow-y-auto">
            <div class="glass p-4 mb-4 flex gap-2 border-dashed border-[#F7C873]">
                <input id="code-in" class="bg-transparent w-full outline-none text-[#F7C873] font-bold placeholder-gray-600 text-center" placeholder="กรอกโค้ดลับที่นี่">
                <button onclick="Wallet.redeem()" class="bg-[#F7C873] text-black px-4 rounded font-bold text-xs">รับ</button>
            </div>
            <h2 class="text-xl font-bold text-white mb-4 border-l-4 border-[#F7C873] pl-3">ห้องป๊อกเด้ง (Live)</h2>
            <div id="room-list" class="grid gap-3 pb-20"></div>
        </div>

        <div id="p-wallet" class="hidden relative z-30 p-6 pt-24 h-full bg-black/90">
            <h2 class="text-2xl font-bold text-[#F7C873] mb-6">กระเป๋าเงิน</h2>
            <div class="glass p-6 text-center mb-6">
                <div class="text-sm text-gray-400">ยอดเงินคงเหลือ</div>
                <div class="text-4xl font-bold text-white my-2" id="w-bal">0.00</div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="UI.finModal('deposit')" class="btn-gold py-3 bg-green-500 border-none text-white shadow-none">ฝากเงิน</button>
                <button onclick="UI.finModal('withdraw')" class="btn-gold py-3 bg-red-500 border-none text-white shadow-none">ถอนเงิน</button>
            </div>
            <div class="mt-8">
                <h3 class="text-xs font-bold text-gray-500 mb-2">ประวัติล่าสุด</h3>
                <div id="tx-list" class="space-y-2 text-xs"></div>
            </div>
        </div>

        <div id="p-game" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center">
            <div id="table-felt">
                <div class="absolute top-10 left-1/2 transform -translate-x-1/2 text-center">
                    <div class="w-16 h-16 rounded-full border-4 border-[#1f2937] bg-gray-800 mx-auto mb-2 relative">
                        <img id="p2-img" class="w-full h-full rounded-full object-cover opacity-50">
                        <div id="p2-badge" class="hidden pok-badge">ป๊อก 9</div>
                    </div>
                    <div class="flex justify-center gap-2" id="p2-cards">
                        </div>
                </div>

                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full">
                    <div id="g-status" class="text-3xl font-black text-[#F7C873] drop-shadow-lg animate-pulse uppercase tracking-wider">WAITING...</div>
                    <div id="g-pot" class="text-white font-mono text-sm mt-1 bg-black/50 inline-block px-3 rounded-full">POT: 0</div>
                    <button id="btn-ready" onclick="Game.ready()" class="mt-4 btn-gold px-8 py-2 text-xl shadow-xl hidden animate__animated animate__bounceIn">เริ่มเกม!</button>
                </div>

                <div class="absolute bottom-20 left-1/2 transform -translate-x-1/2 text-center w-full">
                    <div id="p1-badge" class="hidden pok-badge">ป๊อก 8</div>
                    <div class="flex justify-center gap-2 mb-4 h-[120px] items-end" id="p1-cards">
                        </div>
                    <div id="game-controls" class="hidden flex justify-center gap-4 animate__animated animate__fadeInUp">
                        <button onclick="Game.action('hit')" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold border-b-4 border-green-800 active:border-b-0 active:translate-y-1">จั่วไพ่</button>
                        <button onclick="Game.action('stand')" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold border-b-4 border-red-800 active:border-b-0 active:translate-y-1">พอแล้ว</button>
                    </div>
                    <div class="text-xs text-gray-400 font-bold mt-2 bg-black/30 inline-block px-3 py-1 rounded-full">แต้มของคุณ: <span id="p1-score" class="text-white text-lg">0</span></div>
                </div>
            </div>
            
            <button onclick="Game.leave()" class="absolute top-20 right-4 bg-red-900/50 text-red-400 text-[10px] px-2 py-1 rounded">ออก</button>
        </div>

    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let user=null, userData={}, curRoom=null, bankConfig={};

        // AUTH
        auth.onAuthStateChanged(u => {
            if(u) { user=u; document.getElementById('auth-view').style.display='none'; document.getElementById('app-view').classList.remove('hidden'); App.init(); }
            else { document.getElementById('auth-view').style.display='flex'; }
        });

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e=>Swal.fire('Error',e.message,'error')),
            reg: () => auth.createUserWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).then(c=>db.ref('users/'+c.user.uid).set({email:c.user.email, balance:0, name:'Player'})),
        };

        // CORE
        const App = {
            init: () => {
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    document.getElementById('u-credit').innerText = (userData.balance||0).toLocaleString();
                    document.getElementById('w-bal').innerText = (userData.balance||0).toLocaleString();
                    document.getElementById('u-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=F7C873&color=000`;
                });
                db.ref('settings/banks').on('value', s => bankConfig = s.val() || {});
                db.ref('rooms').on('value', s => {
                    const l = document.getElementById('room-list'); l.innerHTML='';
                    s.forEach(d => {
                        const r = d.val();
                        if(r.status === 'open' || r.status === 'waiting') {
                            const pCount = (r.p1?1:0) + (r.p2?1:0);
                            const amIIn = r.p1?.uid === user.uid || r.p2?.uid === user.uid;
                            l.innerHTML += `<div class="glass p-4 flex justify-between items-center hover:border-[#F7C873] transition"><div class="flex items-center gap-4"><div class="text-3xl">♠️</div><div><div class="font-bold text-[#F7C873]">${r.name}</div><div class="text-xs text-gray-400">เดิมพัน ฿${r.bet} • ${pCount}/2 คน</div></div></div><button onclick="${amIIn?`Game.enter('${d.key}')`:`Game.join('${d.key}',${r.bet})`}" class="btn-gold px-6 py-2 text-xs">${amIIn?'กลับเข้าห้อง':'เข้าร่วม'}</button></div>`;
                        }
                    });
                });
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).limitToLast(5).on('value', s => {
                    const l = document.getElementById('tx-list'); l.innerHTML='';
                    const arr=[]; s.forEach(d=>arr.unshift(d.val()));
                    arr.forEach(t => l.innerHTML += `<div class="flex justify-between p-2 bg-white/5 rounded mb-1"><span>${t.type}</span><span class="${t.status=='approved'?'text-green-400':'text-yellow-400'}">${t.amount}</span></div>`);
                });
            }
        };

        const Game = {
            join: (rid, bet) => {
                if(userData.balance < bet) return Swal.fire('เงินไม่พอ','','error');
                db.ref('rooms/'+rid).transaction(r => {
                    if(r) {
                        if(!r.p1) { r.p1={uid:user.uid, name:userData.name, ready:false, hand:[], score:0, status:'thinking'}; r.status='waiting'; return r; }
                        else if(!r.p2 && r.p1.uid!==user.uid) { r.p2={uid:user.uid, name:userData.name, ready:false, hand:[], score:0, status:'thinking'}; r.status='waiting'; return r; }
                    }
                }, (e,c) => {
                    if(c) { db.ref('users/'+user.uid).update({balance:userData.balance-bet}); Game.enter(rid); }
                    else Swal.fire('เต็ม','','warning');
                });
            },
            enter: (rid) => {
                curRoom = rid;
                document.getElementById('p-lobby').classList.add('hidden');
                document.getElementById('p-game').classList.remove('hidden');
                
                db.ref('rooms/'+rid).on('value', s => {
                    const r = s.val();
                    if(!r) { Game.quit(); return; }
                    
                    document.getElementById('g-pot').innerText = `POT: ฿${r.bet*2}`;
                    const me = r.p1?.uid===user.uid ? 'p1' : 'p2';
                    const opp = me==='p1' ? 'p2' : 'p1';
                    
                    // Render Opponent
                    if(r[opp]) {
                        document.getElementById('p2-img').src = `https://ui-avatars.com/api/?name=${r[opp].name}`;
                        document.getElementById('p2-img').classList.remove('opacity-50');
                        UI.renderHand('p2', r[opp].hand, false); // Always hide opp cards until finish
                    }

                    // Render Me
                    UI.renderHand('p1', r[me].hand, true);
                    document.getElementById('p1-score').innerText = r[me].score % 10;

                    // Game Flow
                    const st = document.getElementById('g-status');
                    const btn = document.getElementById('btn-ready');
                    const ctrl = document.getElementById('game-controls');

                    if(r.status === 'waiting') {
                        st.innerText = r[me].ready ? "รอคู่แข่ง..." : "พร้อมไหม?";
                        btn.classList.toggle('hidden', r[me].ready);
                        ctrl.classList.add('hidden');
                    } else if(r.status === 'playing') {
                        btn.classList.add('hidden');
                        if(r.turn === me && r[me].status === 'thinking') {
                            st.innerText = "ตาของคุณ!";
                            ctrl.classList.remove('hidden');
                        } else {
                            st.innerText = "รออีกฝ่าย...";
                            ctrl.classList.add('hidden');
                        }
                    } else if(r.status === 'finished') {
                        ctrl.classList.add('hidden');
                        // Show all cards
                        UI.renderHand('p2', r[opp].hand, true); 
                        // Badges
                        if(r.winner === user.uid) Swal.fire({title:'ชนะ!', text:`รับ ฿${r.bet*2}`, icon:'success', background:'#000', color:'#fff'}).then(()=>Game.quit());
                        else if(r.winner === 'draw') Swal.fire({title:'เสมอ', text:'คืนทุน', icon:'info', background:'#000', color:'#fff'}).then(()=>Game.quit());
                        else Swal.fire({title:'แพ้!', text:'พยายามใหม่นะ', icon:'error', background:'#000', color:'#fff'}).then(()=>Game.quit());
                    }
                });
            },
            ready: () => db.ref(`rooms/${curRoom}/${curRoom&&db.ref(`rooms/${curRoom}/p1/uid`).toString().includes(user.uid)?'p1':'p2'}/ready`).set(true),
            action: (act) => {
                const meKey = document.getElementById('p1-score').getAttribute('data-key') || (curRoom&&db.ref(`rooms/${curRoom}/p1/uid`).toString().includes(user.uid)?'p1':'p2'); // Simplified check
                // In real app, secure logic needed. Sending intent to admin.
                // For this structure, we update status to 'hit' or 'stand' and let Admin logic handle card deal.
                // NOTE: Admin script MUST be running to deal cards.
                
                // Let's use a trigger field for admin
                db.ref(`rooms/${curRoom}/actions`).push({ uid:user.uid, action:act, timestamp:Date.now() });
                document.getElementById('game-controls').classList.add('hidden');
            },
            quit: () => {
                if(curRoom) db.ref('rooms/'+curRoom).off();
                curRoom = null;
                document.getElementById('p-game').classList.add('hidden');
                document.getElementById('p-lobby').classList.remove('hidden');
            }
        };

        const UI = {
            page: (p) => {
                ['lobby','wallet'].forEach(id => document.getElementById('p-'+id).classList.add('hidden'));
                document.getElementById('p-'+p).classList.remove('hidden');
            },
            regMode: () => Swal.fire('ติดต่อแอดมินเพื่อสมัคร','','info'),
            finModal: async (t) => {
                const {value:amt} = await Swal.fire({title:t, input:'number', background:'#111', color:'#fff'});
                if(amt) {
                    db.ref('requests').push({uid:user.uid, name:userData.name, type:t, amount:Number(amt), status:'pending', timestamp:Date.now()});
                    if(t=='withdraw') db.ref('users/'+user.uid).update({balance:userData.balance-amt});
                    Swal.fire('สำเร็จ','รออนุมัติ','success');
                }
            },
            renderHand: (pid, cards, show) => {
                const el = document.getElementById(`${pid}-cards`);
                el.innerHTML = '';
                if(!cards) return;
                cards.forEach((c, i) => {
                    const suit = c.suit=='H'?'♥':(c.suit=='D'?'♦':(c.suit=='S'?'♠':'♣'));
                    const color = (c.suit=='H'||c.suit=='D')?'text-red-500':'text-black';
                    const html = show 
                        ? `<div class="card-area deal-anim" style="animation-delay:${i*0.2}s"><div class="card-inner flipped"><div class="card-front ${color}">${c.rank}${suit}</div><div class="card-back"></div></div></div>`
                        : `<div class="card-area deal-anim" style="animation-delay:${i*0.2}s"><div class="card-inner"><div class="card-front"></div><div class="card-back"></div></div></div>`;
                    el.innerHTML += html;
                });
            }
        };

        const Wallet = {
            redeem: () => {
                const c = document.getElementById('code-in').value;
                if(!c) return;
                db.ref('codes/'+c).transaction(d => {
                    if(d && !d.used) { d.used=true; return d; }
                }, (e,s,snap) => {
                    if(s) {
                        db.ref('users/'+user.uid).update({balance:userData.balance+snap.val().amount});
                        Swal.fire('Success',`+${snap.val().amount}`,'success');
                    } else Swal.fire('Invalid Code');
                });
            }
        };
    </script>
</body>
</html>
