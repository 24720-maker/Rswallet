<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MY WALLET - The Next Gen</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg-body: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); color: var(--text-main); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-eng { font-family: 'Outfit', sans-serif; }

        /* Animations */
        .page-enter { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-bounce:active { transform: scale(0.95); }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        
        /* Custom Components */
        .wallet-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white; border-radius: 24px; padding: 30px; position: relative; overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3);
        }
        .wallet-card::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(99,102,241,0.2) 0%, transparent 70%);
            border-radius: 50%;
        }

        .input-anim {
            background: #f1f5f9; border: 2px solid transparent; transition: 0.3s;
            padding: 14px; border-radius: 14px; width: 100%; outline: none; font-weight: 600;
        }
        .input-anim:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99,102,241,0.1); }

        .progress-bar {
            width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin-top: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); width: 0%; transition: width 1s ease-out;
        }

        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); transition: 0.2s; border: 1px solid transparent;
        }
        .tx-item:hover { transform: translateX(5px); border-color: var(--primary); }

        /* Loader */
        .loader-wrap { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner-box { width: 60px; height: 60px; border-radius: 50%; border: 4px solid #f1f5f9; border-top-color: var(--primary); animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-28">

    <div id="loader" class="loader-wrap">
        <div class="spinner-box"></div>
        <p class="mt-4 font-eng font-bold text-slate-400 tracking-widest text-xs animate-pulse">INITIALIZING...</p>
    </div>

    <div id="auth-modal" class="fixed inset-0 z-50 bg-white flex flex-col justify-center px-8 hidden animate__animated animate__fadeIn">
        <div class="text-center mb-10">
            <h1 class="font-eng text-4xl font-black text-slate-900 tracking-tighter mb-2">MY<span class="text-indigo-600">WALLET</span></h1>
            <p class="text-slate-400 text-sm">เข้าสู่ระบบเพื่อจัดการกระเป๋าเงินของคุณ</p>
        </div>

        <div id="form-login" class="space-y-4 relative">
            <input id="l-email" class="input-anim" placeholder="อีเมล">
            <input id="l-pass" type="password" class="input-anim" placeholder="รหัสผ่าน">
            <button onclick="Auth.login()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold font-eng shadow-xl btn-bounce">LOGIN ACCOUNT</button>
            <p class="text-center mt-6 text-sm text-slate-500">ยังไม่มีบัญชี? <span onclick="UI.toggleAuth('reg')" class="text-indigo-600 font-bold cursor-pointer underline">สร้างบัญชีใหม่</span></p>
        </div>

        <div id="form-reg" class="hidden space-y-3 relative">
            <input id="r-name" class="input-anim" placeholder="ชื่อ-นามสกุลจริง">
            <input id="r-email" class="input-anim" placeholder="อีเมล">
            <input id="r-pass" type="password" class="input-anim" placeholder="รหัสผ่าน">
            <input id="r-fb" class="input-anim" placeholder="ลิ้งก์ Facebook (สำหรับยืนยันตัวตน)">
            <button onclick="Auth.register()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold font-eng shadow-xl btn-bounce mt-2">REGISTER NOW</button>
            <p class="text-center mt-6 text-sm text-slate-500">มีบัญชีแล้ว? <span onclick="UI.toggleAuth('log')" class="text-indigo-600 font-bold cursor-pointer underline">เข้าสู่ระบบ</span></p>
        </div>
    </div>

    <div id="app-view" class="hidden max-w-md mx-auto min-h-screen relative">
        
        <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md px-6 py-4 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-3" onclick="UI.page('profile')">
                <div class="w-10 h-10 rounded-full p-[2px] bg-gradient-to-tr from-indigo-500 to-purple-500">
                    <img id="u-avatar" class="w-full h-full rounded-full object-cover bg-white">
                </div>
                <div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Welcome Back</p>
                    <p id="u-name" class="font-bold text-slate-800 leading-none text-sm truncate w-24">Loading...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="UI.contact()" class="w-10 h-10 rounded-full bg-slate-50 text-slate-600 flex items-center justify-center btn-bounce hover:bg-slate-100"><i class="fa-brands fa-line text-xl"></i></button>
                <button onclick="Auth.logout()" class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center btn-bounce hover:bg-red-100"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <main class="p-6 space-y-8">
            
            <section id="p-home" class="page-enter">
                
                <div class="wallet-card mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Balance</p>
                            <h2 id="u-bal" class="text-4xl font-eng font-bold mt-1">฿0.00</h2>
                        </div>
                        <i class="fa-solid fa-wallet text-3xl text-indigo-400 opacity-50"></i>
                    </div>
                    
                    <div id="turnover-box" class="hidden bg-white/10 p-3 rounded-xl border border-white/10 backdrop-blur-sm">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-yellow-300 font-bold"><i class="fa-solid fa-lock mr-1"></i> ติดเงื่อนไขถอน</span>
                            <span id="turnover-text" class="text-white">0 / 0</span>
                        </div>
                        <div class="progress-bar"><div id="turnover-bar" class="progress-fill"></div></div>
                    </div>

                    <div class="mt-6 flex items-center gap-2 text-xs text-slate-400">
                        <span class="bg-white/10 px-2 py-1 rounded text-white" id="u-bank">BANK</span>
                        <span class="font-mono tracking-wider" id="u-acc">000-000-0000</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button onclick="Wallet.deposit()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-bounce hover:border-indigo-200 transition">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-down"></i></div>
                        <span class="font-bold text-sm text-slate-700">ฝากเงิน</span>
                    </button>
                    <button onclick="Wallet.withdraw()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2 btn-bounce hover:border-red-200 transition">
                        <div class="w-12 h-12 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-xl"><i class="fa-solid fa-arrow-up"></i></div>
                        <span class="font-bold text-sm text-slate-700">ถอนเงิน</span>
                    </button>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-lg text-slate-800">ประวัติธุรกรรม</h3>
                        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full" id="tx-count">0 รายการ</span>
                    </div>
                    <div id="tx-list" class="space-y-3 pb-10 min-h-[200px]">
                        <div class="text-center py-10 text-slate-300">
                            <i class="fa-solid fa-clipboard-list text-4xl mb-2"></i>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="p-profile" class="hidden page-enter">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">แก้ไขข้อมูลส่วนตัว</h2>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <h3 class="text-sm font-bold text-indigo-600 mb-4 uppercase tracking-widest">ข้อมูลบัญชี</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 ml-1">ชื่อ-นามสกุล</label>
                            <input id="pf-name" class="input-anim mt-1">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 ml-1">Facebook Profile (จำเป็น)</label>
                            <input id="pf-fb" class="input-anim mt-1 text-blue-600" placeholder="https://facebook.com/...">
                            <p class="text-[10px] text-slate-400 mt-1">*เพื่อให้แอดมินติดต่อกลับได้ง่ายขึ้น</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <h3 class="text-sm font-bold text-indigo-600 mb-4 uppercase tracking-widest">ข้อมูลธนาคาร</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 ml-1">ธนาคาร</label>
                            <select id="pf-bank" class="input-anim mt-1">
                                <option value="KBANK">กสิกรไทย (KBANK)</option>
                                <option value="SCB">ไทยพาณิชย์ (SCB)</option>
                                <option value="BBL">กรุงเทพ (BBL)</option>
                                <option value="KTB">กรุงไทย (KTB)</option>
                                <option value="WALLET">TrueMoney Wallet</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 ml-1">เลขบัญชี</label>
                            <input id="pf-acc" class="input-anim mt-1 font-mono tracking-wider">
                        </div>
                    </div>
                </div>

                <button onclick="User.save()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-xl btn-bounce">บันทึกข้อมูล</button>
            </section>

        </main>

        <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-100 h-[80px] flex justify-around items-center px-6 z-40 max-w-md mx-auto right-0 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="UI.page('home')" class="nav-item active flex flex-col items-center gap-1" id="nav-home">
                <i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">หน้าแรก</span>
            </div>
            <div onclick="UI.page('profile')" class="nav-item flex flex-col items-center gap-1" id="nav-profile">
                <i class="fa-solid fa-user-gear text-xl"></i><span class="text-[10px] font-bold">ตั้งค่า</span>
            </div>
        </nav>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAochx_FIKbXLrbhhcLdVrpaurjjk4aQYc", authDomain: "paoshuv-c260d.firebaseapp.com", databaseURL: "https://paoshuv-c260d-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "paoshuv-c260d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let user = null, userData = {}, config = {};
        const sfx = { 
            click: new Howl({src:['https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3']}),
            success: new Howl({src:['https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3']})
        };

        // --- AUTH ---
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                App.init();
            } else {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        const Auth = {
            login: () => {
                sfx.click.play();
                auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value)
                .catch(e=>Swal.fire({icon:'error',title:'เข้าสู่ระบบไม่สำเร็จ',text:e.message}));
            },
            register: () => {
                sfx.click.play();
                const d = {
                    e: document.getElementById('r-email').value,
                    p: document.getElementById('r-pass').value,
                    n: document.getElementById('r-name').value,
                    fb: document.getElementById('r-fb').value
                };
                if(!d.e||!d.p||!d.n) return Swal.fire('แจ้งเตือน','กรอกข้อมูลให้ครบ','warning');
                auth.createUserWithEmailAndPassword(d.e, d.p).then(c => {
                    db.ref('users/'+c.user.uid).set({
                        name:d.n, email:d.e, fb_link:d.fb, balance:0, bank:'-', acc:'-', 
                        is_free_credit:false, turnover_target:0, created_at: Date.now()
                    });
                }).catch(e=>Swal.fire('Error',e.message,'error'));
            },
            logout: () => { sfx.click.play(); auth.signOut(); }
        };

        const App = {
            init: () => {
                // Load User Data
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    document.getElementById('loader').style.display = 'none';
                    
                    // Basic Info
                    document.getElementById('u-bal').innerText = `฿${(userData.balance||0).toLocaleString()}`;
                    document.getElementById('u-name').innerText = userData.name;
                    document.getElementById('u-bank').innerText = userData.bank || 'NO BANK';
                    document.getElementById('u-acc').innerText = userData.acc || '000-000-000';
                    document.getElementById('u-avatar').src = `https://ui-avatars.com/api/?name=${userData.name}&background=6366f1&color=fff&bold=true`;

                    // Form Fill
                    document.getElementById('pf-name').value = userData.name;
                    document.getElementById('pf-fb').value = userData.fb_link || '';
                    document.getElementById('pf-bank').value = userData.bank || 'KBANK';
                    document.getElementById('pf-acc').value = userData.acc || '';

                    // Turnover Logic UI
                    const turnBox = document.getElementById('turnover-box');
                    if(userData.is_free_credit && userData.turnover_target > 0) {
                        turnBox.classList.remove('hidden');
                        const percent = Math.min((userData.balance / userData.turnover_target) * 100, 100);
                        document.getElementById('turnover-bar').style.width = `${percent}%`;
                        document.getElementById('turnover-text').innerText = `${userData.balance.toLocaleString()} / ${userData.turnover_target.toLocaleString()}`;
                        
                        // Check if complete
                        if(userData.balance >= userData.turnover_target) {
                            turnBox.classList.add('animate-pulse'); // Visual cue that condition met
                        } else {
                            turnBox.classList.remove('animate-pulse');
                        }
                    } else {
                        turnBox.classList.add('hidden');
                    }
                });

                // Load Config
                db.ref('settings').on('value', s => config = s.val() || {});

                // Load Full History
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).on('value', s => {
                    const l = document.getElementById('tx-list'); l.innerHTML = '';
                    const arr = [];
                    s.forEach(d => arr.unshift(d.val())); // Reverse order
                    document.getElementById('tx-count').innerText = `${arr.length} รายการ`;
                    
                    if(arr.length === 0) {
                        l.innerHTML = '<div class="text-center py-10 text-slate-300"><i class="fa-solid fa-receipt text-4xl mb-2"></i><p>ไม่มีประวัติธุรกรรม</p></div>';
                        return;
                    }

                    arr.forEach(t => {
                        const isDep = t.type === 'deposit';
                        const color = t.status === 'approved' ? 'text-green-500' : (t.status === 'rejected' ? 'text-red-500' : 'text-yellow-500');
                        const icon = isDep ? 'fa-arrow-down text-indigo-500 bg-indigo-50' : 'fa-arrow-up text-orange-500 bg-orange-50';
                        
                        l.innerHTML += `
                            <div class="tx-item">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${icon}">
                                        <i class="fa-solid ${isDep?'fa-plus':'fa-minus'}"></i>
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm text-slate-700 uppercase">${t.type}</p>
                                        <p class="text-[10px] text-slate-400 font-mono">${moment(t.timestamp).format('DD/MM/YY HH:mm')}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold font-eng text-slate-800">฿${t.amount.toLocaleString()}</p>
                                    <p class="text-[9px] font-bold uppercase ${color}">${t.status}</p>
                                </div>
                            </div>
                        `;
                    });
                });
            }
        };

        const Wallet = {
            deposit: () => {
                sfx.click.play();
                Swal.fire({
                    title: 'ฝากเงิน',
                    html: `
                        <div class="bg-indigo-50 p-4 rounded-xl text-left mb-4 border border-indigo-100">
                            <p class="text-indigo-800 font-bold text-sm mb-1"><i class="fa-solid fa-bank mr-1"></i> ช่องทางฝากเงิน</p>
                            <p class="text-xs text-indigo-600">กรุณาติดต่อแอดมินเพื่อขอเลขบัญชี และส่งสลิปเพื่อยืนยัน</p>
                            <a href="${config.admin_contact||'#'}" target="_blank" class="block w-full text-center bg-green-500 text-white py-2 rounded-lg mt-3 font-bold shadow hover:bg-green-600"><i class="fa-brands fa-line"></i> ติดต่อแอดมิน</a>
                        </div>
                        <input id="d-amt" type="number" class="swal2-input" placeholder="จำนวนเงิน">
                        <input id="d-time" type="text" class="swal2-input" placeholder="เวลาโอน (เช่น 12.00)">
                    `,
                    confirmButtonText: 'แจ้งฝากเงิน',
                    confirmButtonColor: '#0f172a',
                    showCancelButton: true
                }).then(r => {
                    if(r.isConfirmed) {
                        const amt = document.getElementById('d-amt').value;
                        const time = document.getElementById('d-time').value;
                        if(amt && time) {
                            db.ref('transactions').push({
                                uid: user.uid, name: userData.name, type: 'deposit', amount: Number(amt), time: time, status: 'pending', timestamp: Date.now()
                            });
                            sfx.success.play();
                            Swal.fire('สำเร็จ','แจ้งฝากเรียบร้อย รอตรวจสอบ','success');
                        }
                    }
                });
            },
            withdraw: () => {
                sfx.click.play();
                // Turnover Check
                if(userData.is_free_credit && userData.balance < userData.turnover_target) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'ถอนไม่ได้!',
                        html: `<div class="text-sm">คุณติดเงื่อนไขเครดิตฟรี<br>ต้องมียอดให้ถึง <b class="text-red-500">${userData.turnover_target}</b> บาท<br>(ยอดปัจจุบัน: ${userData.balance})</div>`,
                        confirmButtonColor: '#0f172a'
                    });
                }

                Swal.fire({
                    title: 'ถอนเงิน',
                    text: `เข้าบัญชี: ${userData.bank} - ${userData.acc}`,
                    input: 'number',
                    inputPlaceholder: 'จำนวนเงิน',
                    confirmButtonText: 'ยืนยันถอน',
                    confirmButtonColor: '#ef4444',
                    showCancelButton: true
                }).then(r => {
                    if(r.isConfirmed && r.value) {
                        const amt = Number(r.value);
                        if(amt > userData.balance) return Swal.fire('ยอดเงินไม่พอ','','error');
                        if(amt < 100) return Swal.fire('ขั้นต่ำ 100 บาท','','warning');
                        
                        db.ref('transactions').push({
                            uid: user.uid, name: userData.name, type: 'withdraw', amount: amt, status: 'pending', timestamp: Date.now()
                        });
                        db.ref('users/'+user.uid).update({balance: userData.balance - amt});
                        sfx.success.play();
                        Swal.fire('สำเร็จ','แจ้งถอนเรียบร้อย','success');
                    }
                });
            }
        };

        const User = {
            save: () => {
                sfx.click.play();
                db.ref('users/'+user.uid).update({
                    name: document.getElementById('pf-name').value,
                    fb_link: document.getElementById('pf-fb').value,
                    bank: document.getElementById('pf-bank').value,
                    acc: document.getElementById('pf-acc').value
                }).then(() => Swal.fire('บันทึกสำเร็จ','','success'));
            }
        };

        const UI = {
            toggleAuth: (m) => {
                document.getElementById('form-login').style.display=m=='log'?'block':'none';
                document.getElementById('form-reg').style.display=m=='reg'?'block':'none';
            },
            page: (p) => {
                sfx.click.play();
                ['home','profile'].forEach(id => {
                    document.getElementById('p-'+id).classList.add('hidden');
                    document.getElementById('nav-'+id).classList.remove('active', 'text-indigo-600');
                    document.getElementById('nav-'+id).classList.add('text-slate-400');
                });
                document.getElementById('p-'+p).classList.remove('hidden');
                document.getElementById('p-'+p).classList.add('page-enter');
                document.getElementById('nav-'+p).classList.add('active', 'text-indigo-600');
                document.getElementById('nav-'+p).classList.remove('text-slate-400');
            },
            contact: () => {
                sfx.click.play();
                const link = config.admin_contact || '#';
                window.open(link, '_blank');
            }
        };
    </script>
</body>
</html>
