<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAFADA | ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .thai-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #1e3a8a; transition: 0.2s; }
        .pin-dot.active { background: #1e3a8a; transform: scale(1.2); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased h-screen flex flex-col overflow-hidden">

    <div id="loader" class="fixed inset-0 z-[999] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-14 h-14 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-blue-900 font-bold tracking-widest animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...</p>
    </div>

    <div id="pinScreen" class="hidden fixed inset-0 z-[900] bg-white/95 backdrop-blur-md flex flex-col items-center justify-center p-6">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-blue-50 rounded-3xl mx-auto flex items-center justify-center mb-4 shadow-sm">
                <i class="fas fa-fingerprint text-4xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800" id="pinUserTitle">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</h2>
            <p class="text-slate-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>
        <div class="flex gap-4 mb-12" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 w-full max-w-[280px]">
            <button onclick="app.typePin(1)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">1</button>
            <button onclick="app.typePin(2)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">2</button>
            <button onclick="app.typePin(3)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">3</button>
            <button onclick="app.typePin(4)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">4</button>
            <button onclick="app.typePin(5)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">5</button>
            <button onclick="app.typePin(6)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">6</button>
            <button onclick="app.typePin(7)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">7</button>
            <button onclick="app.typePin(8)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">8</button>
            <button onclick="app.typePin(9)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">9</button>
            <div class="w-16 h-16"></div>
            <button onclick="app.typePin(0)" class="h-16 w-16 rounded-full border border-slate-100 text-2xl font-bold text-slate-600 hover:bg-slate-50 active:bg-blue-100 transition">0</button>
            <button onclick="app.delPin()" class="h-16 w-16 flex items-center justify-center text-slate-400 hover:text-red-500 transition"><i class="fas fa-backspace"></i></button>
        </div>
        <button onclick="app.logout()" class="mt-12 text-sm text-slate-400 underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="authPage" class="hidden fixed inset-0 z-50 bg-slate-50 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-fade-in">
                <div class="thai-gradient p-10 text-center text-white relative">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <h1 class="text-4xl font-bold tracking-widest relative">FAFADA</h1>
                    <p class="text-blue-100 text-xs mt-2 opacity-80 relative">Premium Wallet System</p>
                </div>
                <div class="p-8">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-8">
                        <button id="tL" onclick="ui.tab('login')" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white text-blue-800 shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button id="tR" onclick="ui.tab('reg')" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-blue-900 transition">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                    <form id="fLogin" onsubmit="app.handleLogin(event)" class="space-y-4">
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-4 top-4 text-slate-300"></i>
                            <input id="lEmail" type="email" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                        </div>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-4 top-4 text-slate-300"></i>
                            <input id="lPass" type="password" class="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/20 transform active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                    </form>
                    <form id="fReg" onsubmit="app.handleReg(event)" class="hidden space-y-4">
                        <input id="rName" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á" required>
                        <input id="rEmail" type="email" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                        <input id="rPass" type="password" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-green-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" required>
                        <button type="submit" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="mainPage" class="hidden flex-col h-screen overflow-hidden">
        <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-100 px-6 h-20 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900 rounded-2xl flex items-center justify-center text-white font-bold shadow-lg">F</div>
                <div class="hidden sm:block">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
                    <p class="font-bold text-blue-900 leading-none truncate max-w-[150px]" id="navName">...</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="app.openProfile()" class="w-10 h-10 rounded-full bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-blue-50 transition"><i class="fas fa-user-circle text-xl"></i></button>
                <button onclick="app.logout()" class="w-10 h-10 rounded-full bg-red-50 border border-red-100 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto p-6 sm:p-10 space-y-8 custom-scroll pb-24">
            
            <div id="newsBox" class="hidden animate-fade-in">
                <div class="bg-white border-l-4 border-amber-400 p-4 rounded-r-2xl shadow-sm flex gap-4 items-center">
                    <div class="bg-amber-100 w-10 h-10 rounded-full flex items-center justify-center text-amber-600"><i class="fas fa-bullhorn"></i></div>
                    <div>
                        <h4 id="newsTitle" class="font-bold text-sm text-slate-800"></h4>
                        <p id="newsBody" class="text-[10px] text-slate-500"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-5 space-y-6">
                    <div class="thai-gradient rounded-[2.5rem] p-8 text-white shadow-2xl shadow-blue-900/20 relative overflow-hidden transition transform hover:scale-[1.01]">
                        <div class="absolute right-[-10%] top-[-20%] w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
                        <div class="relative z-10">
                            <p class="text-blue-100 text-[10px] font-bold uppercase tracking-[0.2em] mb-1">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                            <div class="flex items-center gap-4 mb-8">
                                <h1 id="uBal" class="text-5xl font-bold tracking-tight">‡∏ø ****</h1>
                                <button onclick="app.toggleEye()" class="text-blue-200 hover:text-white transition mt-1"><i id="eye" class="fas fa-eye-slash text-xl"></i></button>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-[10px] text-blue-200 opacity-60 mb-1 font-mono">ACCOUNT NO.</p>
                                    <p id="uID" class="font-mono text-sm tracking-widest opacity-90">.... .... ....</p>
                                </div>
                                <div class="bg-white/20 backdrop-blur px-3 py-1 rounded-full text-[10px] border border-white/10 font-bold uppercase">Gold Member</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800 text-lg">‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
                            <a id="lineBtn" href="#" target="_blank" class="hidden text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold hover:bg-blue-100 transition"><i class="fab fa-line mr-1"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</a>
                        </div>
                        
                        <div class="flex bg-slate-50 p-1.5 rounded-2xl mb-6">
                            <button id="btnD" onclick="ui.setType('deposit')" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white text-green-600 shadow">‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å</button>
                            <button id="btnW" onclick="ui.setType('withdraw')" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-red-500 transition">‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô</button>
                        </div>

                        <div id="boxBank" class="hidden mb-6 bg-blue-50/50 p-5 rounded-2xl border border-blue-100 animate-fade-in">
                            <p class="text-[10px] font-bold text-blue-800 uppercase mb-2"><i class="fas fa-university mr-1"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</p>
                            <p id="txtBank" class="text-sm text-blue-700 font-bold whitespace-pre-line leading-relaxed">...</p>
                        </div>

                        <form onsubmit="app.subTx(event)">
                            <label class="text-[10px] font-bold text-slate-400 ml-1 mb-1 block">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <div class="relative mb-4">
                                <span class="absolute left-5 top-3.5 text-slate-300 font-bold text-xl">‡∏ø</span>
                                <input id="amt" type="number" step="0.01" min="1" class="w-full pl-12 pr-6 py-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-blue-900 focus:bg-white transition text-2xl font-bold text-slate-700" placeholder="0.00" required oninput="app.calc()">
                            </div>
                            
                            <div id="boxFee" class="hidden px-2 mb-6 space-y-2 fade-in">
                                <div class="flex justify-between text-xs text-red-500">
                                    <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (<span id="feePc">0</span>%)</span>
                                    <span id="feeVal">0</span>
                                </div>
                                <div class="flex justify-between text-sm font-bold text-slate-800 border-t border-dashed border-slate-200 pt-2">
                                    <span>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                    <span id="netVal" class="text-green-600 text-lg">0</span>
                                </div>
                            </div>

                            <button id="subBtn" class="w-full bg-blue-900 text-white py-4 rounded-2xl font-bold shadow-xl shadow-blue-900/20 active:scale-95 transition flex items-center justify-center gap-2">
                                <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-7 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i class="fas fa-history text-blue-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-slate-300 text-xs"></i>
                            <input onkeyup="ui.filterHist(this.value)" class="pl-8 pr-4 py-2 bg-slate-50 border-none rounded-full text-[10px] outline-none w-32 focus:w-48 transition-all" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 custom-scroll max-h-[500px]">
                        <table class="w-full text-left text-sm border-separate border-spacing-y-2">
                            <tbody id="tbHist">
                                </tbody>
                        </table>
                        <div id="noData" class="hidden py-20 text-center text-slate-300 flex flex-col items-center">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                            <p class="text-xs font-bold uppercase tracking-widest">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalPF" class="hidden fixed inset-0 z-[1000] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl relative animate-fade-in overflow-hidden">
            <div class="w-12 h-1 bg-slate-100 rounded-full mx-auto mb-6 sm:hidden"></div>
            <button onclick="document.getElementById('modalPF').classList.add('hidden')" class="absolute top-6 right-6 text-slate-300 hover:text-slate-600 transition"><i class="fas fa-times-circle text-2xl"></i></button>
            
            <h2 class="text-2xl font-bold mb-6 text-slate-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <p id="pfEm" class="font-bold text-blue-900">...</p>
                </div>

                <div class="bg-blue-50/50 border border-blue-100 p-6 rounded-2xl">
                    <p class="text-xs font-bold text-blue-800 mb-4 flex items-center gap-2"><i class="fas fa-shield-halved"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (KYC)</p>
                    <form onsubmit="app.savePF(event)" class="space-y-3">
                        <input id="iBank" class="w-full p-3.5 border rounded-xl text-sm" placeholder="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£)" required>
                        <input id="iAcc" class="w-full p-3.5 border rounded-xl text-sm font-mono" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å" required>
                        <input id="iFb" class="w-full p-3.5 border rounded-xl text-sm" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå Facebook ‡∏´‡∏£‡∏∑‡∏≠ ID Line" required>
                        <button class="w-full bg-blue-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg mt-2 transition active:scale-95">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config ‡πÄ‡∏î‡∏¥‡∏°
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419", measurementId: "G-Q73X8Q841W" };
        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        let user = null, userData = null, sysConfig = {}, pinBuffer = "", eyeOpen = false, lastKnownBalance = null;

        // UI SYSTEM
        window.ui = {
            tab: (t) => {
                const isL = t==='login';
                document.getElementById('fLogin').classList.toggle('hidden', !isL);
                document.getElementById('fReg').classList.toggle('hidden', isL);
                document.getElementById('tabL').className = isL ? "flex-1 py-3 rounded-xl font-bold text-sm bg-blue-900 text-white shadow" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-blue-900 transition";
                document.getElementById('tabR').className = !isL ? "flex-1 py-3 rounded-xl font-bold text-sm bg-green-600 text-white shadow" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-green-900 transition";
            },
            setType: (t) => {
                const isD = t==='deposit';
                document.getElementById('btnD').className = isD ? "flex-1 py-3 rounded-xl font-bold text-sm bg-white text-green-600 shadow" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-green-600 transition";
                document.getElementById('btnW').className = !isD ? "flex-1 py-3 rounded-xl font-bold text-sm bg-white text-red-600 shadow" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-400 hover:text-red-600 transition";
                document.getElementById('boxBank').classList.toggle('hidden', !isD);
                document.getElementById('boxFee').classList.toggle('hidden', isD);
                document.getElementById('subBtn').className = isD ? "w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg" : "w-full bg-red-600 text-white py-4 rounded-2xl font-bold shadow-lg";
                document.getElementById('subBtn').innerHTML = isD ? '<i class="fas fa-check-circle"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô' : '<i class="fas fa-paper-plane"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                app.calc();
            },
            showPage: (p) => {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('authPage').classList.toggle('hidden', p!=='auth');
                document.getElementById('pinScreen').classList.toggle('hidden', p!=='pin');
                document.getElementById('mainPage').classList.toggle('hidden', p!=='main');
                if(p==='main') document.getElementById('mainPage').classList.add('flex');
            },
            filterHist: (k) => {
                const rows = document.querySelectorAll('#tbHist tr');
                rows.forEach(r => {
                    r.style.display = r.innerText.toLowerCase().includes(k.toLowerCase()) ? '' : 'none';
                });
            }
        };

        // CORE APP
        window.app = {
            handleLogin: async(e)=>{ e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('lEmail').value, document.getElementById('lPass').value); } catch(err){ Swal.fire('Error','‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); } },
            handleReg: async(e)=>{ e.preventDefault(); const nm=document.getElementById('rName').value, em=document.getElementById('rEmail').value, pw=document.getElementById('rPass').value; try{ const c=await createUserWithEmailAndPassword(auth,em,pw); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:em,displayName:nm,role:em==='farisxuma1@gmail.com'?'admin':'user',balance:0,createdAt:new Date(),bankName:'',bankAcc:'',contactLink:'',pin:'111111'}); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (PIN ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ 111111)','success'); } catch(err){ Swal.fire('Error',err.message,'error'); } },
            logout: ()=>signOut(auth).then(()=>location.reload()),

            typePin: (n) => {
                if(pinBuffer.length < 6) {
                    pinBuffer += n;
                    const dots = document.querySelectorAll('.pin-dot');
                    dots.forEach((d,i)=> d.classList.toggle('active', i < pinBuffer.length));
                    if(pinBuffer.length === 6) {
                        if(pinBuffer === (userData.pin || '111111')){ ui.showPage('main'); }
                        else { Swal.fire('PIN ‡∏ú‡∏¥‡∏î','‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); pinBuffer=""; dots.forEach(d=>d.classList.remove('active')); }
                    }
                }
            },
            delPin: () => { pinBuffer = pinBuffer.slice(0, -1); const dots = document.querySelectorAll('.pin-dot'); dots.forEach((d,i)=> d.classList.toggle('active', i < pinBuffer.length)); },

            toggleEye: () => {
                eyeOpen = !eyeOpen;
                document.getElementById('eye').className = eyeOpen ? "fas fa-eye text-white" : "fas fa-eye-slash text-slate-400";
                document.getElementById('uBal').innerText = eyeOpen ? `‡∏ø ${userData.balance.toLocaleString('th-TH',{minimumFractionDigits:2})}` : "‡∏ø ****";
            },

            calc: () => {
                const val = parseFloat(document.getElementById('amt').value)||0;
                const pc = sysConfig.feePercent || 5;
                const fee = val * (pc/100);
                document.getElementById('feePc').innerText = pc;
                document.getElementById('feeVal').innerText = '-'+fee.toLocaleString();
                document.getElementById('netVal').innerText = (val-fee).toLocaleString();
            },

            openProfile: () => {
                document.getElementById('modalPF').classList.remove('hidden');
                document.getElementById('pfEm').innerText = userData.email;
                document.getElementById('iBank').value = userData.bankName || '';
                document.getElementById('iAcc').value = userData.bankAcc || '';
                document.getElementById('iFb').value = userData.contactLink || '';
            },

            savePF: async(e)=>{
                e.preventDefault();
                try {
                    await updateDoc(doc(db,"users",user.uid), { bankName: document.getElementById('iBank').value, bankAcc: document.getElementById('iAcc').value, contactLink: document.getElementById('iFb').value });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); document.getElementById('modalPF').classList.add('hidden');
                } catch(e){ Swal.fire('Error','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ','error'); }
            },

            subTx: async(e)=>{
                e.preventDefault();
                const amt = parseFloat(document.getElementById('amt').value);
                const isDep = document.getElementById('btnD').classList.contains('bg-white');
                
                if(amt <= 0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warning');
                if(!isDep && amt > userData.balance) return Swal.fire('Error','‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏≠','error');
                if(!isDep && !userData.bankAcc) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô','warning').then(()=>app.openProfile());

                try {
                    Swal.showLoading();
                    const fee = !isDep ? amt*((sysConfig.feePercent||5)/100) : 0;
                    await addDoc(collection(db,"transactions"), {
                        uid: user.uid, email: userData.email, userDisplayName: userData.displayName,
                        type: isDep?'deposit':'withdraw', amount: amt, fee, netAmount: amt-fee,
                        status: 'pending', timestamp: new Date(), 
                        userBank: `${userData.bankName} ${userData.bankAcc}`, userFb: userData.contactLink
                    });
                    Swal.fire('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà','success');
                    document.getElementById('amt').value=''; app.calc();
                } catch(e){ Swal.fire('Error',e.message,'error'); }
            }
        };

        // SYSTEM STARTUP
        onAuthStateChanged(auth, u => {
            if(u) {
                user = u;
                // Listen User Profile & Notice Manual Adjust
                onSnapshot(doc(db,"users",u.uid), s => {
                    if(s.exists()){
                        userData = s.data();
                        document.getElementById('navName').innerText = userData.displayName;
                        document.getElementById('pinUserTitle').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userData.displayName}`;
                        document.getElementById('uID').innerText = u.uid.slice(0,4)+" **** **** "+u.uid.slice(-4);
                        if(eyeOpen) document.getElementById('uBal').innerText = `‡∏ø ${userData.balance.toLocaleString('th-TH',{minimumFractionDigits:2})}`;
                        
                        // üî• ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                        if(lastKnownBalance !== null && lastKnownBalance !== userData.balance) {
                            const diff = userData.balance - lastKnownBalance;
                            if(diff < 0) {
                                // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô adjustment ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid), where("type","==","adjustment"), orderBy("timestamp","desc"), limit(1)), snap => {
                                    if(!snap.empty) {
                                        const txn = snap.docs[0].data();
                                        Swal.fire({ title: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', html: `<p class="text-sm">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å: <b class="text-red-600">${Math.abs(diff).toLocaleString()} ‡∏ö‡∏≤‡∏ó</b></p><p class="text-xs text-slate-500 mt-2">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${txn.reason || '‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°'}</p>`, icon: 'info' });
                                    }
                                });
                            }
                        }
                        lastKnownBalance = userData.balance;
                        if(document.getElementById('mainPage').classList.contains('hidden')) ui.showPage('pin');
                    }
                });

                // Listen System Config
                onSnapshot(doc(db,"system","config"), s => {
                    if(s.exists()){
                        sysConfig = s.data();
                        document.getElementById('txtBank').innerText = sysConfig.adminBank || '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
                        if(sysConfig.contactLink) { document.getElementById('lineBtn').classList.remove('hidden'); document.getElementById('lineBtn').href = sysConfig.contactLink; }
                        app.calc();
                    }
                });

                // Listen History
                onSnapshot(query(collection(db,"transactions"), where("uid","==",u.uid)), s => {
                    let list = []; s.forEach(d=>list.push(d.data())); list.sort((a,b)=>b.timestamp-a.timestamp);
                    const tb = document.getElementById('tbHist'); tb.innerHTML='';
                    if(list.length===0){ document.getElementById('noData').classList.remove('hidden'); return; }
                    document.getElementById('noData').classList.add('hidden');
                    
                    list.forEach(x => {
                        const isD = x.type==='deposit' || (x.type==='adjustment' && x.amount > 0);
                        const st = x.status==='pending' ? '<span class="text-amber-500 bg-amber-50 px-2 py-0.5 rounded text-[10px] font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>' : (x.status==='completed' ? '<span class="text-green-600 bg-green-50 px-2 py-0.5 rounded text-[10px] font-bold">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>' : '<span class="text-red-500 bg-red-50 px-2 py-0.5 rounded text-[10px] font-bold">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>');
                        tb.innerHTML += `
                            <tr class="fade-in">
                                <td class="py-3 pr-2">
                                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center ${isD?'bg-green-100 text-green-600':'bg-red-100 text-red-600'} text-xs shadow-sm"><i class="fas ${isD?'fa-arrow-down':'fa-arrow-up'}"></i></div>
                                </td>
                                <td class="py-3">
                                    <p class="font-bold text-slate-700 text-xs">${x.type==='adjustment'?'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©':(isD?'‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô':'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')}</p>
                                    <p class="text-[9px] text-slate-400 font-medium">${new Date(x.timestamp.seconds*1000).toLocaleString('th-TH')}</p>
                                </td>
                                <td class="py-3 text-right">
                                    <p class="font-bold font-mono text-sm ${isD?'text-green-600':'text-slate-700'}">${isD?'+':'-'}${x.amount.toLocaleString()}</p>
                                    ${st}
                                </td>
                            </tr>
                        `;
                    });
                });

                // Listen Announcements
                onSnapshot(query(collection(db,"announcements"), orderBy("createdAt","desc"), limit(1)), s => {
                    if(!s.empty){
                        const n = s.docs[0].data(); document.getElementById('newsBox').classList.remove('hidden');
                        document.getElementById('newsTitle').innerText = n.title; document.getElementById('newsBody').innerText = n.content;
                    }
                });

            } else { ui.showPage('auth'); }
        });

    </script>
</body>
</html>
