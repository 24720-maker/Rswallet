<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RS INFINITY V8 ULTIMATE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        /* --- CORE THEME --- */
        :root {
            --gold: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --bg-deep: #050505;
            --glass: rgba(20, 20, 20, 0.9);
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .font-tech { font-family: 'Rajdhani', sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }

        /* UI Components */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }

        .btn-effect {
            transition: transform 0.1s;
        }
        .btn-effect:active { transform: scale(0.95); }

        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #b8860b 100%);
            color: black;
            font-weight: bold;
            box-shadow: 0 0 15px var(--gold-glow);
        }

        /* Animations */
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-line { animation: scan 2s linear infinite; }

        /* Custom Input Range */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: var(--gold);
            margin-top: -8px;
            box-shadow: 0 0 10px var(--gold);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            background: #333;
            border-radius: 2px;
        }
    </style>
</head>
<body class="flex flex-col bg-black">

    <div id="auth-screen" class="fixed inset-0 z-50 bg-black flex flex-col justify-center items-center p-6 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">
        <div class="mb-8 text-center">
            <i class="fa-solid fa-infinity text-6xl text-yellow-500 mb-4 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)]"></i>
            <h1 class="text-4xl font-black italic tracking-tighter">RS <span class="text-yellow-500">INFINITY</span></h1>
            <p class="text-xs text-gray-400 font-tech tracking-[0.5em] mt-2">V8 ULTIMATE AI</p>
        </div>

        <div class="glass-panel w-full max-w-sm p-8">
            <h2 id="auth-title" class="text-xl font-bold text-center mb-6">เข้าระบบสมาชิก</h2>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="inp-email" required placeholder="อีเมล" class="w-full bg-black/50 border border-gray-700 p-3 rounded-xl text-white outline-none focus:border-yellow-500 transition">
                <input type="password" id="inp-password" required placeholder="รหัสผ่าน" class="w-full bg-black/50 border border-gray-700 p-3 rounded-xl text-white outline-none focus:border-yellow-500 transition">
                <button type="submit" id="btn-submit" class="btn-effect btn-gold w-full py-3 rounded-xl">เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden flex flex-col h-full relative">
        
        <header class="flex justify-between items-center p-4 bg-black/60 backdrop-blur-md border-b border-white/5 sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full border border-yellow-500/50 p-0.5">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=User" class="w-full h-full rounded-full bg-gray-900">
                </div>
                <div>
                    <div id="disp-username" class="font-bold text-sm text-yellow-500">Guest</div>
                    <div class="flex items-center gap-1">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span id="status-text" class="text-[10px] text-gray-400 uppercase">CHECKING...</span>
                    </div>
                </div>
            </div>
            <div class="glass-panel px-3 py-1 flex items-center gap-2">
                <span id="header-timer" class="font-tech text-yellow-500 font-bold text-lg">00:00:00</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scroll bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]">
            
            <div id="tab-home" class="p-5 pb-24 space-y-6">
                <div class="glass-panel p-3 flex items-center gap-3 overflow-hidden">
                    <div class="bg-yellow-500 text-black text-[10px] font-bold px-2 py-1 rounded">AI LIVE</div>
                    <marquee scrollamount="4" class="text-xs text-gray-300">
                        วิเคราะห์ตลาด: BTC มีแรงซื้อหนาแน่นที่ 42000, ทองคำระวังข่าว Non-Farm, EURUSD เกิด Divergence ใน Timeframe 1H...
                    </marquee>
                </div>

                <div class="flex flex-col items-center justify-center py-6">
                    <div class="relative group">
                        <div class="absolute inset-[-10px] border border-yellow-500/20 rounded-full animate-[spin_10s_linear_infinite]"></div>
                        <div class="absolute inset-0 bg-yellow-500/10 rounded-full blur-xl group-hover:bg-yellow-500/30 transition-all duration-500"></div>
                        
                        <button onclick="openAssetSelect()" class="btn-effect relative w-48 h-48 rounded-full bg-[#111] border-2 border-[#333] flex flex-col items-center justify-center z-10 shadow-2xl overflow-hidden">
                            <div class="absolute inset-0 bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,215,0,0.1)_360deg)] animate-[spin_2s_linear_infinite]"></div>
                            
                            <i class="fa-solid fa-fingerprint text-6xl text-gray-600 group-hover:text-yellow-500 transition-colors duration-300 relative z-10"></i>
                            <span class="mt-4 text-lg font-bold text-white tracking-widest relative z-10">AI SCAN</span>
                            <span class="text-[10px] text-gray-500 font-tech relative z-10">START ENGINE V8</span>

                            <div id="lock-overlay" class="absolute inset-0 bg-black/90 backdrop-blur-sm rounded-full flex flex-col items-center justify-center z-20 hidden">
                                <i class="fa-solid fa-lock text-3xl text-red-500 mb-2"></i>
                                <span class="text-xs text-red-500 font-bold uppercase">Membership Expired</span>
                            </div>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-gray-400 text-xs uppercase font-bold mb-3"><i class="fa-solid fa-chart-line text-yellow-500 mr-2"></i>Live Market</h3>
                    <div class="h-[250px] w-full bg-black rounded-xl overflow-hidden border border-gray-800">
                        <div id="tv-home-chart" class="w-full h-full"></div>
                    </div>
                </div>
            </div>

            <div id="tab-chart" class="hidden h-full flex flex-col">
                <div class="bg-black border-b border-gray-800 p-2 flex gap-2 overflow-x-auto">
                    <button onclick="changeChart('BTCUSDT')" class="px-3 py-1 bg-gray-800 rounded text-xs text-gray-300 hover:text-yellow-500">BTC</button>
                    <button onclick="changeChart('XAUUSD')" class="px-3 py-1 bg-gray-800 rounded text-xs text-gray-300 hover:text-yellow-500">GOLD</button>
                    <button onclick="changeChart('EURUSD')" class="px-3 py-1 bg-gray-800 rounded text-xs text-gray-300 hover:text-yellow-500">EU</button>
                </div>
                <div id="tv-full-chart" class="flex-1 w-full bg-black"></div>
            </div>

            <div id="tab-profile" class="hidden p-5 space-y-6 pb-24">
                <div class="glass-panel p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 opacity-20"><i class="fa-solid fa-crown text-6xl text-yellow-500"></i></div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-16 h-16 rounded-full border-2 border-yellow-500 p-1">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=User" class="w-full h-full rounded-full bg-gray-800">
                        </div>
                        <div>
                            <h2 id="pf-name" class="text-xl font-bold text-white">Loading...</h2>
                            <div class="text-xs text-yellow-500 bg-yellow-500/10 px-2 py-0.5 rounded inline-block mt-1">PREMIUM MEMBER</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="glass-panel p-3 text-center">
                        <div class="text-[10px] text-gray-500">WIN RATE</div>
                        <div class="text-lg font-bold text-green-400 font-tech">78%</div>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <div class="text-[10px] text-gray-500">TOTAL SCANS</div>
                        <div class="text-lg font-bold text-white font-tech">142</div>
                    </div>
                    <div class="glass-panel p-3 text-center">
                        <div class="text-[10px] text-gray-500">STATUS</div>
                        <div class="text-lg font-bold text-green-500 font-tech">ACTIVE</div>
                    </div>
                </div>

                <div class="glass-panel p-4 space-y-3">
                    <h3 class="text-sm font-bold text-gray-300 border-b border-gray-700 pb-2">ACCOUNT DETAILS</h3>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">User ID</span>
                        <span id="pf-uid" class="font-mono text-gray-300">...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Email</span>
                        <span id="pf-email" class="text-gray-300">...</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Expire Date</span>
                        <span id="pf-exp" class="text-yellow-500 font-bold">...</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <a id="link-line" href="#" target="_blank" class="glass-panel p-3 flex items-center justify-center gap-2 hover:bg-green-900/20 text-green-500 border-green-500/30">
                        <i class="fa-brands fa-line text-xl"></i> ติดต่อ LINE
                    </a>
                    <a id="link-fb" href="#" target="_blank" class="glass-panel p-3 flex items-center justify-center gap-2 hover:bg-blue-900/20 text-blue-500 border-blue-500/30">
                        <i class="fa-brands fa-facebook text-xl"></i> Facebook
                    </a>
                </div>
                
                <button onclick="logout()" class="w-full py-3 rounded-xl border border-red-500/30 text-red-500 hover:bg-red-900/20 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-power-off"></i> ออกจากระบบ
                </button>
            </div>
        </main>

        <nav class="h-[80px] bg-[#020202] border-t border-white/10 grid grid-cols-3 items-center pb-4 px-2 z-30">
            <button onclick="nav('home')" id="nav-home" class="btn-effect flex flex-col items-center gap-1 text-yellow-500">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Home</span>
            </button>
            <button onclick="nav('chart')" id="nav-chart" class="btn-effect flex flex-col items-center gap-1 text-gray-500">
                <i class="fa-solid fa-chart-simple text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Full Chart</span>
            </button>
            <button onclick="nav('profile')" id="nav-profile" class="btn-effect flex flex-col items-center gap-1 text-gray-500">
                <i class="fa-solid fa-id-card text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Profile</span>
            </button>
        </nav>
    </div>

    <div id="modal-assets" class="hidden fixed inset-0 z-40 bg-black/90 backdrop-blur-md flex items-end sm:items-center justify-center">
        <div class="w-full sm:w-[400px] bg-[#111] rounded-t-3xl border-t border-yellow-500/30 p-6 animate-[slideInUp_0.3s]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">เลือกสินทรัพย์</h3>
                <button onclick="closeModal('modal-assets')" class="text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="openAIInput('BTCUSDT', 'Bitcoin')" class="glass-panel p-3 flex flex-col items-center gap-2 hover:border-yellow-500">
                    <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" class="w-8 h-8">
                    <span class="text-xs font-bold">BTC</span>
                </button>
                <button onclick="openAIInput('ETHUSDT', 'Ethereum')" class="glass-panel p-3 flex flex-col items-center gap-2 hover:border-yellow-500">
                    <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="w-8 h-8">
                    <span class="text-xs font-bold">ETH</span>
                </button>
                <button onclick="openAIInput('XAUUSD', 'Gold')" class="glass-panel p-3 flex flex-col items-center gap-2 border-yellow-500/30 hover:border-yellow-500">
                    <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-black font-bold">GLD</div>
                    <span class="text-xs font-bold text-yellow-500">GOLD</span>
                </button>
                <button onclick="openAIInput('EURUSD', 'EUR/USD')" class="glass-panel p-3 flex flex-col items-center gap-2 hover:border-yellow-500">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">$</div>
                    <span class="text-xs font-bold">EU</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-ai-input" class="hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-[#111] border border-gray-800 rounded-2xl p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-yellow-500"></div>
            
            <h3 class="text-lg font-bold text-white mb-1"><i class="fa-solid fa-robot text-yellow-500 mr-2"></i>AI Configuration</h3>
            <p class="text-xs text-gray-500 mb-6">กรอกข้อมูลพอร์ตเพื่อให้ AI คำนวณความเสี่ยง</p>

            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg border border-gray-800">
                    <span class="text-sm text-gray-400">Asset</span>
                    <span id="input-asset-name" class="font-bold text-white">BTC/USDT</span>
                </div>

                <div>
                    <label class="text-xs text-gray-400">เงินทุนในพอร์ต ($)</label>
                    <input type="number" id="inp-balance" value="1000" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white font-mono focus:border-yellow-500 outline-none mt-1">
                </div>

                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Leverage</span>
                        <span id="disp-lev" class="text-yellow-500 font-bold">100x</span>
                    </div>
                    <input type="range" id="inp-lev" min="1" max="125" value="100" class="w-full" oninput="document.getElementById('disp-lev').innerText = this.value + 'x'">
                </div>

                <div>
                    <label class="text-xs text-gray-400">โหมดความเสี่ยง (Risk Style)</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <button onclick="setRisk('safe')" id="btn-risk-safe" class="risk-btn p-2 rounded border border-green-500/50 text-green-500 text-xs font-bold hover:bg-green-900/30">Safe (1%)</button>
                        <button onclick="setRisk('aggr')" id="btn-risk-aggr" class="risk-btn p-2 rounded border border-red-500/50 text-red-500 text-xs font-bold hover:bg-red-900/30 ring-2 ring-red-500">Aggressive (3%)</button>
                    </div>
                </div>

                <button onclick="startAnalysis()" class="btn-effect btn-gold w-full py-3 rounded-xl font-bold mt-4">
                    <i class="fa-solid fa-bolt mr-1"></i> เริ่มประมวลผล
                </button>
                <button onclick="closeModal('modal-ai-input')" class="w-full py-2 text-gray-500 text-sm mt-2">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div id="screen-process" class="hidden fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center font-tech">
        <div class="relative w-64 h-64 flex items-center justify-center">
            <div class="absolute inset-0 border-4 border-gray-800 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-yellow-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
            <div class="text-center z-10">
                <div class="text-4xl font-bold text-white mb-1" id="proc-percent">0%</div>
                <div class="text-xs text-yellow-500 animate-pulse">ANALYZING DATA...</div>
            </div>
        </div>
        <div class="mt-8 w-3/4 max-w-md space-y-2">
            <div class="text-xs text-gray-500 font-mono" id="log-text">Connecting to server...</div>
            <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="proc-bar" class="h-full bg-yellow-500 w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <div id="modal-result" class="hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-[#0a0a0a] border border-gray-800 rounded-2xl relative overflow-hidden shadow-2xl animate-[zoomIn_0.3s]">
            <div id="res-header-bg" class="p-6 bg-gradient-to-b from-green-900/20 to-transparent border-b border-green-500/20 text-center">
                <div class="text-gray-400 text-xs tracking-widest mb-1">AI SIGNAL V8</div>
                <div class="flex items-center justify-center gap-3">
                    <h2 id="res-pair" class="text-2xl font-bold text-white">BTC/USDT</h2>
                    <span id="res-side" class="px-3 py-1 bg-green-500 text-black font-black italic rounded text-lg">BUY</span>
                </div>
            </div>

            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                        <div class="text-[10px] text-gray-500 uppercase">Entry Price</div>
                        <div class="text-white font-bold text-lg">Market</div>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                        <div class="text-[10px] text-gray-500 uppercase">Confidence</div>
                        <div class="text-yellow-500 font-bold text-lg font-tech">98.5%</div>
                    </div>
                </div>

                <div class="border border-yellow-500/30 bg-yellow-500/5 rounded-xl p-4 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-yellow-500/10 text-6xl"><i class="fa-solid fa-coins"></i></div>
                    <h4 class="text-yellow-500 text-xs font-bold mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-calculator"></i> AI MONEY MANAGEMENT
                    </h4>
                    <div class="flex justify-between items-end border-b border-dashed border-gray-700 pb-2 mb-2">
                        <span class="text-xs text-gray-400">แนะนำออก Lot Size</span>
                        <span id="res-lot" class="text-xl font-bold text-white font-mono">0.05</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-xs text-gray-400">กำไรที่คาดหวัง (Est. Profit)</span>
                        <span id="res-profit" class="text-lg font-bold text-green-400 font-mono">+$45.00</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center bg-green-900/10 p-2 rounded border-l-4 border-green-500">
                        <span class="text-xs text-gray-400 ml-2">Take Profit (TP)</span>
                        <span id="res-tp" class="text-sm font-bold text-green-400">Target +1.5%</span>
                    </div>
                    <div class="flex justify-between items-center bg-red-900/10 p-2 rounded border-l-4 border-red-500">
                        <span class="text-xs text-gray-400 ml-2">Stop Loss (SL)</span>
                        <span id="res-sl" class="text-sm font-bold text-red-400">Low -0.5%</span>
                    </div>
                </div>

                <button onclick="closeResult()" class="btn-effect w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-xl text-white font-bold">รับทราบ / ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", // ใส่ของจริง
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.appspot.com",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentPair = 'BTCUSDT';
        let isExpired = true;
        let riskMode = 'aggr'; // safe, aggr

        // --- AUTH ---
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('inp-email').value, document.getElementById('inp-password').value);
            } catch(err) {
                alert("Login Failed: " + err.message);
                btn.innerHTML = 'เข้าสู่ระบบ';
            }
        });

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadUserData(user);
                loadChart('BTCUSDT', 'tv-home-chart', true);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        function loadUserData(user) {
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    const exp = d.expiryDate.toDate();
                    
                    // Header Update
                    document.getElementById('disp-username').innerText = d.username;
                    
                    // Profile Update
                    document.getElementById('pf-name').innerText = d.username;
                    document.getElementById('pf-email').innerText = d.email;
                    document.getElementById('pf-uid').innerText = user.uid.substring(0,8).toUpperCase();
                    document.getElementById('pf-exp').innerText = exp.toLocaleDateString('th-TH');

                    checkExpiry(exp);
                }
            });
            
            // Config for Links
            onSnapshot(doc(db, "system", "config"), (snap) => {
                if(snap.exists()) {
                    document.getElementById('link-line').href = snap.data().lineLink;
                    document.getElementById('link-fb').href = snap.data().fbLink;
                }
            });
        }

        function checkExpiry(date) {
            const now = new Date();
            if(date < now) {
                isExpired = true;
                document.getElementById('status-text').innerText = "EXPIRED";
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-red-500";
                document.getElementById('lock-overlay').classList.remove('hidden');
                document.getElementById('header-timer').innerText = "EXPIRED";
                document.getElementById('header-timer').classList.add('text-red-500');
            } else {
                isExpired = false;
                document.getElementById('status-text').innerText = "ONLINE";
                document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#0f0]";
                document.getElementById('lock-overlay').classList.add('hidden');
                
                // Timer
                setInterval(() => {
                    const diff = date - new Date();
                    if(diff > 0) {
                        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                        const m = Math.floor((diff / (1000 * 60)) % 60);
                        const s = Math.floor((diff / 1000) % 60);
                        document.getElementById('header-timer').innerText = `${h}:${m}:${s}`;
                    }
                }, 1000);
            }
        }

        // --- SCANNER SYSTEM ---
        window.openAssetSelect = () => {
            if(isExpired) return alert("กรุณาต่ออายุสมาชิก");
            document.getElementById('modal-assets').classList.remove('hidden');
        }

        window.openAIInput = (pair, name) => {
            currentPair = pair;
            document.getElementById('input-asset-name').innerText = name + ` (${pair})`;
            document.getElementById('modal-assets').classList.add('hidden');
            document.getElementById('modal-ai-input').classList.remove('hidden');
        }

        window.setRisk = (mode) => {
            riskMode = mode;
            document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('ring-2'));
            if(mode === 'safe') document.getElementById('btn-risk-safe').classList.add('ring-2');
            else document.getElementById('btn-risk-aggr').classList.add('ring-2');
        }

        window.startAnalysis = () => {
            document.getElementById('modal-ai-input').classList.add('hidden');
            const proc = document.getElementById('screen-process');
            proc.classList.remove('hidden');

            let pct = 0;
            const bar = document.getElementById('proc-bar');
            const txt = document.getElementById('proc-percent');
            const logs = ["Connecting API...", "Fetching Price...", "Checking EMA 200...", "Calculating RSI...", "Optimizing Lot Size...", "Done."];
            
            const interval = setInterval(() => {
                pct += Math.floor(Math.random() * 10) + 5;
                if(pct > 100) pct = 100;
                
                bar.style.width = pct + '%';
                txt.innerText = pct + '%';
                document.getElementById('log-text').innerText = logs[Math.floor((pct/100) * (logs.length-1))];

                if(pct === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        proc.classList.add('hidden');
                        calculateAndShowResult();
                    }, 500);
                }
            }, 200);
        }

        function calculateAndShowResult() {
            // Calculate Logic
            const balance = parseFloat(document.getElementById('inp-balance').value) || 1000;
            const lev = parseInt(document.getElementById('inp-lev').value);
            const riskPercent = riskMode === 'safe' ? 0.01 : 0.03; // 1% or 3%
            
            // AI Simulation Logic
            const isBuy = Math.random() > 0.5;
            const riskAmount = balance * riskPercent;
            // Simplified Lot calculation (Not accurate forex math, just estimation for display)
            const lotSize = (riskAmount * lev / 10000).toFixed(2); 
            const estProfit = (riskAmount * 1.5).toFixed(2); // RR 1:1.5

            // Update UI
            document.getElementById('res-pair').innerText = currentPair;
            document.getElementById('res-side').innerText = isBuy ? "BUY" : "SELL";
            document.getElementById('res-side').className = isBuy 
                ? "px-3 py-1 bg-green-500 text-black font-black italic rounded text-lg shadow-[0_0_15px_#0f0]" 
                : "px-3 py-1 bg-red-500 text-black font-black italic rounded text-lg shadow-[0_0_15px_#f00]";
            
            const header = document.getElementById('res-header-bg');
            header.className = isBuy 
                ? "p-6 bg-gradient-to-b from-green-900/30 to-transparent border-b border-green-500/20 text-center" 
                : "p-6 bg-gradient-to-b from-red-900/30 to-transparent border-b border-red-500/20 text-center";

            document.getElementById('res-lot').innerText = lotSize + " Lot";
            document.getElementById('res-profit').innerText = `+$${estProfit}`;
            document.getElementById('res-profit').className = "text-lg font-bold font-mono " + (isBuy ? "text-green-400" : "text-green-400"); // Profit always green

            document.getElementById('modal-result').classList.remove('hidden');
        }

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.closeResult = () => document.getElementById('modal-result').classList.add('hidden');

        // --- TRADING VIEW ---
        window.nav = (page) => {
            ['home', 'chart', 'profile'].forEach(p => document.getElementById('tab-'+p).classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-yellow-500', 'text-gray-500'));
            
            document.getElementById('tab-'+page).classList.remove('hidden');
            document.getElementById('nav-'+page).classList.replace('text-gray-500', 'text-yellow-500');

            if(page === 'chart') loadChart(currentPair, 'tv-full-chart');
        }

        window.changeChart = (pair) => {
            currentPair = pair;
            loadChart(pair, 'tv-full-chart');
        }

        window.loadChart = (symbol, containerId, isMini=false) => {
            let tvSym = "BINANCE:" + symbol;
            if(symbol === "XAUUSD") tvSym = "OANDA:XAUUSD";
            else if(symbol.includes("USD") && !symbol.includes("T")) tvSym = "FX:" + symbol;

            new TradingView.widget({
                "container_id": containerId,
                "autosize": true,
                "symbol": tvSym,
                "interval": "15",
                "timezone": "Asia/Bangkok",
                "theme": "dark",
                "style": "1",
                "locale": "th_TH",
                "toolbar_bg": "#000",
                "enable_publishing": false,
                "hide_top_toolbar": isMini,
                "hide_legend": isMini,
                "save_image": false,
                "backgroundColor": "#000000"
            });
        }
    </script>
</body>
</html>
