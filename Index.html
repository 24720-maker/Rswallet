<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITANIUM WALLET</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background: #020617; color: #fff; }
        .glass { background: #0f172a; border: 1px solid #1e293b; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-box { background: #020617; border: 1px solid #334155; color: #fff; padding: 14px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: #10b981; }
        .btn-main { background: #10b981; color: #000; font-weight: bold; padding: 14px; border-radius: 12px; width: 100%; transition: 0.2s; }
        .btn-main:hover { background: #059669; }
        .card-bal { background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 20px; padding: 25px; position: relative; overflow: hidden; }
        .card-bal::after { content: '฿'; position: absolute; right: -20px; bottom: -30px; font-size: 150px; opacity: 0.1; transform: rotate(-20deg); }
    </style>
</head>
<body class="pb-24">

    <div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center bg-black hidden">
        <div class="glass w-80 text-center animate__animated animate__fadeIn">
            <h1 class="text-3xl font-bold text-emerald-500 mb-2">WALLET PRO</h1>
            <p class="text-xs text-gray-500 mb-6">ระบบฝากถอนอัจฉริยะ</p>
            <div id="login-form">
                <input id="l-email" class="input-box mb-3 text-center" placeholder="อีเมล">
                <input id="l-pass" type="password" class="input-box mb-4 text-center" placeholder="รหัสผ่าน">
                <button onclick="Auth.login()" class="btn-main">เข้าสู่ระบบ</button>
                <p class="text-xs text-gray-500 mt-4 cursor-pointer" onclick="UI.toggleAuth('reg')">สมัครสมาชิกใหม่</p>
            </div>
            <div id="reg-form" class="hidden">
                <input id="r-name" class="input-box mb-2" placeholder="ชื่อเล่น">
                <input id="r-email" class="input-box mb-2" placeholder="อีเมล">
                <input id="r-pass" type="password" class="input-box mb-2" placeholder="รหัสผ่าน">
                <button onclick="Auth.reg()" class="btn-main mt-2">ยืนยันการสมัคร</button>
                <p class="text-xs text-gray-500 mt-4 cursor-pointer" onclick="UI.toggleAuth('login')">กลับไปหน้าล็อกอิน</p>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden max-w-md mx-auto min-h-screen relative shadow-2xl border-x border-slate-800">
        <header class="p-5 flex justify-between items-center bg-[#0f172a]/90 backdrop-blur sticky top-0 z-40 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center text-black font-bold text-xl">W</div>
                <div><p class="text-xs text-emerald-500 font-bold">สวัสดีคุณ</p><p id="u-name" class="text-sm font-bold">Loading...</p></div>
            </div>
            <button onclick="Auth.logout()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-power-off text-xl"></i></button>
        </header>

        <main class="p-5 space-y-6">
            <div class="card-bal shadow-lg shadow-emerald-500/20 animate__animated animate__fadeInDown">
                <p class="text-emerald-100 text-xs font-bold uppercase tracking-wider">ยอดเงินคงเหลือ</p>
                <h1 class="text-4xl font-bold text-white mt-1">฿<span id="u-balance">0.00</span></h1>
                <p class="text-[10px] text-emerald-200 mt-4 bg-black/20 inline-block px-2 py-1 rounded">บัญชี: <span id="u-acc-info">...</span></p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="UI.tab('dep')" id="btn-dep" class="glass p-4 text-center border-emerald-500/50">
                    <i class="fa-solid fa-circle-arrow-down text-2xl text-emerald-500 mb-2"></i>
                    <p class="text-sm font-bold">ฝากเงิน</p>
                </button>
                <button onclick="UI.tab('wit')" id="btn-wit" class="glass p-4 text-center border-red-500/50">
                    <i class="fa-solid fa-circle-arrow-up text-2xl text-red-500 mb-2"></i>
                    <p class="text-sm font-bold">ถอนเงิน</p>
                </button>
            </div>

            <section id="sec-dep" class="animate__animated animate__fadeIn">
                <div class="glass">
                    <h3 class="font-bold text-emerald-500 mb-4 border-b border-slate-700 pb-2">แจ้งฝากเงิน</h3>
                    <div id="admin-banks" class="mb-4 space-y-2"></div>
                    <div class="space-y-3">
                        <div><label class="text-xs text-gray-400">จำนวนเงิน</label><input id="d-amt" type="number" class="input-box text-emerald-400 font-bold text-lg" placeholder="0.00"></div>
                        <div><label class="text-xs text-gray-400">วันเวลาที่โอน</label><input id="d-time" class="input-box" placeholder="เช่น 14.30"></div>
                        <button onclick="Wallet.deposit()" class="btn-main mt-2">ยืนยันการฝาก</button>
                    </div>
                </div>
            </section>

            <section id="sec-wit" class="hidden animate__animated animate__fadeIn">
                <div class="glass border-red-900/30">
                    <h3 class="font-bold text-red-500 mb-4 border-b border-slate-700 pb-2">แจ้งถอนเงิน</h3>
                    <div class="bg-slate-900 p-3 rounded-lg text-center mb-4 border border-slate-700">
                        <p class="text-xs text-gray-400">ค่าธรรมเนียมถอน</p>
                        <p class="text-xl font-bold text-yellow-500" id="fee-percent">0%</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">จำนวนเงินที่ต้องการถอน</label>
                            <input id="w-amt" type="number" class="input-box text-red-400 font-bold text-lg" placeholder="0.00" onkeyup="Wallet.calcFee()">
                        </div>
                        
                        <div class="bg-black/40 p-3 rounded-lg text-xs space-y-1">
                            <div class="flex justify-between"><span>ยอดถอน:</span><span id="calc-amt">0</span></div>
                            <div class="flex justify-between text-red-400"><span>หักค่าธรรมเนียม:</span><span id="calc-fee">-0</span></div>
                            <div class="flex justify-between text-emerald-400 font-bold border-t border-slate-700 pt-1 mt-1"><span>รับเงินสุทธิ:</span><span id="calc-net">0</span></div>
                        </div>

                        <button onclick="Wallet.withdraw()" class="btn-main bg-red-600 hover:bg-red-700 text-white mt-2">ยืนยันการถอน</button>
                    </div>
                </div>
            </section>

            <div>
                <h3 class="text-sm font-bold text-gray-500 mb-3">ประวัติล่าสุด</h3>
                <div id="tx-list" class="space-y-2 pb-20"></div>
            </div>
        </main>

        <div id="modal-profile" class="fixed inset-0 z-50 bg-black/90 hidden items-center justify-center p-6">
            <div class="glass w-full max-w-sm relative">
                <button onclick="document.getElementById('modal-profile').style.display='none'" class="absolute top-4 right-4 text-gray-500"><i class="fa-solid fa-times"></i></button>
                <h3 class="font-bold text-xl mb-4 text-white">แก้ไขข้อมูลบัญชี</h3>
                <div class="space-y-3">
                    <input id="pf-name" class="input-box" placeholder="ชื่อเล่น">
                    <input id="pf-bank" class="input-box" placeholder="ชื่อธนาคาร (เช่น กสิกร)">
                    <input id="pf-acc" class="input-box" placeholder="เลขบัญชี">
                    <button onclick="User.save()" class="btn-main">บันทึกข้อมูล</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full bg-[#0f172a] border-t border-slate-800 h-16 flex justify-around items-center z-40 max-w-md">
            <button class="text-emerald-500 flex flex-col items-center text-xs" onclick="UI.tab('dep')"><i class="fa-solid fa-home text-xl mb-1"></i>หน้าหลัก</button>
            <button class="text-gray-500 flex flex-col items-center text-xs" onclick="document.getElementById('modal-profile').style.display='flex'"><i class="fa-solid fa-user-gear text-xl mb-1"></i>ข้อมูลส่วนตัว</button>
        </nav>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let user=null, userData={}, config={fee:0};

        auth.onAuthStateChanged(u => {
            if(u) { user=u; document.getElementById('auth-view').style.display='none'; document.getElementById('app-view').classList.remove('hidden'); App.init(); }
            else { document.getElementById('auth-view').style.display='flex'; }
        });

        const Auth = {
            login: () => auth.signInWithEmailAndPassword(document.getElementById('l-email').value, document.getElementById('l-pass').value).catch(e=>Swal.fire('Error',e.message,'error')),
            reg: () => auth.createUserWithEmailAndPassword(document.getElementById('r-email').value, document.getElementById('r-pass').value).then(c=>db.ref('users/'+c.user.uid).set({name:document.getElementById('r-name').value, balance:0})),
            logout: () => auth.signOut()
        };

        const App = {
            init: () => {
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val()||{};
                    document.getElementById('u-balance').innerText = (userData.balance||0).toLocaleString(undefined,{minimumFractionDigits:2});
                    document.getElementById('u-name').innerText = userData.name;
                    document.getElementById('u-acc-info').innerText = `${userData.bank||'-'} : ${userData.acc||'-'}`;
                    document.getElementById('pf-name').value = userData.name;
                    document.getElementById('pf-bank').value = userData.bank||'';
                    document.getElementById('pf-acc').value = userData.acc||'';
                });
                db.ref('settings').on('value', s => {
                    config = s.val()||{fee:0};
                    document.getElementById('fee-percent').innerText = `${config.fee}%`;
                    const bl = document.getElementById('admin-banks'); bl.innerHTML='';
                    if(config.banks) Object.values(config.banks).forEach(b => bl.innerHTML+=`<div class="bg-slate-800 p-2 rounded text-xs flex justify-between border border-slate-700"><span>${b.name}</span><span class="text-emerald-400 font-bold">${b.acc}</span></div>`);
                });
                db.ref('transactions').orderByChild('uid').equalTo(user.uid).limitToLast(10).on('value', s => {
                    const l=document.getElementById('tx-list'); l.innerHTML='';
                    const arr=[]; s.forEach(d=>arr.unshift(d.val()));
                    arr.forEach(t => {
                        let c = t.status=='approved'?'text-emerald-400':(t.status=='rejected'?'text-red-400':'text-yellow-400');
                        l.innerHTML += `<div class="glass p-3 flex justify-between items-center text-xs mb-2"><div><b class="uppercase">${t.type}</b><br><span class="text-gray-500">${moment(t.timestamp).format('DD/MM HH:mm')}</span></div><div class="text-right"><span class="font-bold text-white">฿${t.amount}</span><br><span class="${c} uppercase font-bold">${t.status}</span></div></div>`;
                    });
                });
            }
        };

        const Wallet = {
            calcFee: () => {
                const amt = Number(document.getElementById('w-amt').value);
                const fee = amt * (config.fee / 100);
                document.getElementById('calc-amt').innerText = amt.toLocaleString();
                document.getElementById('calc-fee').innerText = fee.toLocaleString();
                document.getElementById('calc-net').innerText = (amt - fee).toLocaleString();
            },
            deposit: () => {
                const amt=Number(document.getElementById('d-amt').value);
                if(amt<1) return Swal.fire('ระบุยอดเงิน','','warning');
                db.ref('transactions').push({uid:user.uid, name:userData.name, type:'deposit', amount:amt, time:document.getElementById('d-time').value, status:'pending', timestamp:Date.now()});
                Swal.fire('แจ้งฝากแล้ว','รอตรวจสอบ','success');
                document.getElementById('d-amt').value='';
            },
            withdraw: () => {
                const amt=Number(document.getElementById('w-amt').value);
                if(amt > userData.balance || amt < 100) return Swal.fire('ถอนไม่ได้','ยอดเงินไม่พอหรือต่ำกว่าขั้นต่ำ','error');
                
                const fee = amt * (config.fee / 100);
                const net = amt - fee;

                db.ref('transactions').push({
                    uid:user.uid, name:userData.name, type:'withdraw', 
                    amount:amt, fee:fee, net_amount:net, 
                    bank_info:`${userData.bank} ${userData.acc}`, 
                    status:'pending', timestamp:Date.now()
                });
                
                // Cut balance immediately
                db.ref('users/'+user.uid).update({balance: userData.balance - amt});
                Swal.fire('แจ้งถอนแล้ว',`ยอดเข้าบัญชี ${net} บาท`,'success');
                document.getElementById('w-amt').value=''; Wallet.calcFee();
            }
        };

        const User = {
            save: () => db.ref('users/'+user.uid).update({name:document.getElementById('pf-name').value, bank:document.getElementById('pf-bank').value, acc:document.getElementById('pf-acc').value}).then(()=>Swal.fire('Saved!','','success'))
        };

        const UI = {
            toggleAuth: (m) => { document.getElementById('login-form').classList.toggle('hidden', m=='reg'); document.getElementById('reg-form').classList.toggle('hidden', m=='login'); },
            tab: (m) => { 
                document.getElementById('sec-dep').classList.toggle('hidden', m=='wit');
                document.getElementById('sec-wit').classList.toggle('hidden', m=='dep');
                document.getElementById('btn-dep').className = m=='dep' ? 'glass p-4 text-center border-emerald-500 border-2 bg-emerald-900/20' : 'glass p-4 text-center border-emerald-500/50 opacity-50';
                document.getElementById('btn-wit').className = m=='wit' ? 'glass p-4 text-center border-red-500 border-2 bg-red-900/20' : 'glass p-4 text-center border-red-500/50 opacity-50';
            }
        };
    </script>
</body>
</html>
