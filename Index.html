<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA Wallet - กระเป๋าเงินออนไลน์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f0f2f5; }
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="loader" class="fixed inset-0 bg-white z-[99] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
        <p class="text-indigo-600 font-bold animate-pulse">กำลังเชื่อมต่อ FAFADA...</p>
    </div>

    <div id="authSection" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-100 to-purple-100 hidden">
        <div class="glass w-full max-w-md rounded-3xl shadow-2xl overflow-hidden transform transition-all hover:scale-[1.01]">
            <div class="h-32 gradient-bg flex items-center justify-center">
                <h1 class="text-4xl font-bold text-white tracking-widest drop-shadow-md">FAFADA</h1>
            </div>
            
            <div class="flex border-b border-gray-200">
                <button onclick="toggleAuth('login')" id="tabLogin" class="flex-1 py-4 font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50 transition-all">เข้าสู่ระบบ</button>
                <button onclick="toggleAuth('register')" id="tabRegister" class="flex-1 py-4 font-bold text-gray-400 hover:text-indigo-500 hover:bg-gray-50 transition-all">สมัครสมาชิก</button>
            </div>
            
            <div class="p-8">
                <form id="loginForm" onsubmit="handleLogin(event)" class="animate-fade-in-up">
                    <p class="text-gray-500 mb-6 text-center text-sm">เข้าสู่ระบบเพื่อจัดการธุรกรรมของคุณ</p>
                    <div class="mb-4 relative">
                        <i class="fas fa-envelope absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="email" id="loginEmail" placeholder="อีเมล" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" required>
                    </div>
                    <div class="mb-6 relative">
                        <i class="fas fa-lock absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="password" id="loginPass" placeholder="รหัสผ่าน" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                    </div>
                    <button type="submit" class="w-full gradient-bg text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">เข้าสู่ระบบทันที</button>
                </form>

                <form id="registerForm" onsubmit="handleRegister(event)" class="hidden animate-fade-in-up">
                    <p class="text-gray-500 mb-6 text-center text-sm">สร้างบัญชีใหม่ภายใน 1 นาที</p>
                    <div class="mb-4 relative">
                        <i class="fas fa-user absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="regName" placeholder="ชื่อเล่น / ชื่อที่แสดง" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all" required>
                    </div>
                    <div class="mb-4 relative">
                        <i class="fas fa-envelope absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="email" id="regEmail" placeholder="อีเมล" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all" required>
                    </div>
                    <div class="mb-6 relative">
                        <i class="fas fa-key absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="password" id="regPass" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all" required>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">สมัครสมาชิก</button>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboardSection" class="min-h-screen bg-slate-50 hidden pb-10">
        <nav class="glass sticky top-0 z-40 shadow-sm">
            <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center text-white font-bold text-lg">F</div>
                    <span class="text-xl font-bold text-indigo-900 tracking-wide">FAFADA</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="navName" class="font-bold text-indigo-900 text-sm">User</div>
                        <div id="navEmail" class="text-xs text-gray-500">...</div>
                    </div>
                    <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center shadow-sm">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-4 py-8">
            <div id="newsBox" class="bg-gradient-to-r from-amber-100 to-orange-50 border-l-4 border-orange-400 p-4 mb-8 rounded-r-xl shadow-sm hidden transform hover:scale-[1.005] transition-all">
                <div class="flex items-start gap-4">
                    <div class="bg-orange-100 p-2 rounded-full text-orange-500"><i class="fas fa-bullhorn fa-lg"></i></div>
                    <div>
                        <h4 id="newsTitle" class="font-bold text-orange-900 text-lg">ประกาศสำคัญ</h4>
                        <p id="newsContent" class="text-orange-800 mt-1"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-5 space-y-6">
                    <div class="gradient-bg rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden group">
                        <div class="absolute -right-10 -top-10 bg-white opacity-10 w-40 h-40 rounded-full blur-2xl group-hover:opacity-20 transition-all"></div>
                        <div class="absolute -left-10 -bottom-10 bg-black opacity-10 w-32 h-32 rounded-full blur-xl"></div>
                        
                        <p class="text-indigo-100 font-medium mb-1 flex items-center gap-2"><i class="fas fa-wallet"></i> ยอดเงินคงเหลือ</p>
                        <h1 class="text-5xl font-bold mb-4 tracking-tight">฿ <span id="userBalance">0.00</span></h1>
                        <div class="flex gap-2">
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs backdrop-blur-md border border-white/20"><i class="fas fa-check-circle text-green-300 mr-1"></i> Active</span>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs backdrop-blur-md border border-white/20">ID: <span id="userIdDisplay">...</span></span>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl p-6 border border-gray-100">
                        <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
                            <button onclick="setTxnType('deposit')" id="btnDep" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow-md text-indigo-600 transition-all duration-300">
                                <i class="fas fa-arrow-down mr-2"></i>ฝากเงิน
                            </button>
                            <button onclick="setTxnType('withdraw')" id="btnWdr" class="flex-1 py-3 rounded-xl font-bold text-sm text-gray-500 hover:text-red-500 transition-all duration-300">
                                <i class="fas fa-arrow-up mr-2"></i>ถอนเงิน
                            </button>
                        </div>

                        <div id="depositInfo" class="mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                            <p class="font-bold mb-1"><i class="fas fa-info-circle mr-1"></i> วิธีการฝากเงิน:</p>
                            <p>โอนเงินไปที่บัญชี: <span class="font-mono bg-white px-1 rounded border">012-3-45678-9</span> (กสิกร)</p>
                            <p class="text-xs text-blue-500 mt-1">*ระบบทดสอบ: กรอกยอดเงินแล้วกดยืนยันได้เลย</p>
                        </div>

                        <form onsubmit="submitTransaction(event)">
                            <label class="block text-sm font-bold text-gray-700 mb-2">จำนวนเงิน (THB)</label>
                            <div class="relative mb-6 group">
                                <span class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors">฿</span>
                                <input type="number" id="txnAmount" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-bold text-lg" placeholder="0.00" step="0.01" min="1" required oninput="calcFee()">
                            </div>

                            <div id="feeInfo" class="hidden bg-red-50 p-4 rounded-xl border border-red-100 mb-6 text-sm space-y-2">
                                <div class="flex justify-between text-red-500"><span>ค่าธรรมเนียม (5%)</span><span id="txtFee">0.00</span></div>
                                <div class="h-px bg-red-200 w-full"></div>
                                <div class="flex justify-between font-bold text-gray-800 text-lg"><span>ยอดได้รับจริง</span><span id="txtNet">0.00</span></div>
                            </div>

                            <button type="submit" id="btnSubmit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-paper-plane"></i> ยืนยันรายการ
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-7">
                    <div class="bg-white rounded-3xl shadow-xl p-6 border border-gray-100 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
                            <h3 class="font-bold text-xl text-gray-800"><i class="fas fa-history text-indigo-500 mr-2"></i>ประวัติธุรกรรม</h3>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-md text-gray-500">ล่าสุด 20 รายการ</span>
                        </div>
                        
                        <div class="overflow-y-auto flex-1 pr-2 max-h-[500px] custom-scrollbar">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">ประเภท</th>
                                        <th class="px-4 py-3">วันที่/เวลา</th>
                                        <th class="px-4 py-3 text-right">ยอดเงิน</th>
                                        <th class="px-4 py-3 text-center rounded-r-lg">สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable" class="text-sm divide-y divide-gray-100">
                                    </tbody>
                            </table>
                            <div id="noHistory" class="flex flex-col items-center justify-center py-10 text-gray-400 hidden">
                                <i class="fas fa-inbox fa-3x mb-3 text-gray-200"></i>
                                <p>ยังไม่มีประวัติการทำรายการ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config เดิมของคุณ
        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.firebasestorage.app",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419",
            measurementId: "G-Q73X8Q841W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let txnType = 'deposit';

        // Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        if (userData.role === 'admin') {
                            window.location.href = 'admin.html';
                            return;
                        }
                        renderUI();
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('dashboardSection').classList.remove('hidden');
                    }
                    hideLoader();
                });
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
                hideLoader();
            }
        });

        function hideLoader() {
            document.getElementById('loader').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);
        }

        function renderUI() {
            document.getElementById('navName').textContent = userData.displayName;
            document.getElementById('navEmail').textContent = userData.email;
            document.getElementById('userIdDisplay').textContent = userData.uid.substring(0,6);
            
            // Animate Balance Number
            const balanceEl = document.getElementById('userBalance');
            const targetBalance = userData.balance;
            balanceEl.textContent = targetBalance.toLocaleString('th-TH', {minimumFractionDigits: 2});

            loadHistory();
            loadNews();
        }

        window.toggleAuth = (mode) => {
            if(mode === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50 transition-all";
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-gray-400 hover:text-indigo-500 hover:bg-gray-50 transition-all";
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('tabRegister').className = "flex-1 py-4 font-bold text-green-600 border-b-2 border-green-600 bg-green-50 transition-all";
                document.getElementById('tabLogin').className = "flex-1 py-4 font-bold text-gray-400 hover:text-indigo-500 hover:bg-gray-50 transition-all";
            }
        }

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch(err) { Swal.fire('เข้าสู่ระบบไม่สำเร็จ', 'อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error'); }
        }

        window.handleRegister = async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const role = email === 'farisxuma1@gmail.com' ? 'admin' : 'user';
                await setDoc(doc(db, "users", res.user.uid), {
                    uid: res.user.uid, email, displayName: name, role, balance: 0, createdAt: new Date()
                });
                Swal.fire('สำเร็จ', 'สมัครสมาชิกเรียบร้อยแล้ว', 'success');
            } catch(err) { Swal.fire('เกิดข้อผิดพลาด', err.message, 'error'); }
        }

        window.handleLogout = () => {
            Swal.fire({
                title: 'ออกจากระบบ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, ออกจากระบบ'
            }).then((result) => {
                if (result.isConfirmed) signOut(auth);
            });
        };

        window.setTxnType = (type) => {
            txnType = type;
            const btnDep = document.getElementById('btnDep');
            const btnWdr = document.getElementById('btnWdr');
            const btnSubmit = document.getElementById('btnSubmit');
            const feeInfo = document.getElementById('feeInfo');
            const depositInfo = document.getElementById('depositInfo');

            if(type === 'deposit') {
                btnDep.className = "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow-md text-indigo-600 transition-all";
                btnWdr.className = "flex-1 py-3 rounded-xl font-bold text-sm text-gray-500 hover:text-red-500 transition-all";
                btnSubmit.className = "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2";
                btnSubmit.innerHTML = '<i class="fas fa-arrow-down"></i> ยืนยันการฝากเงิน';
                feeInfo.classList.add('hidden');
                depositInfo.classList.remove('hidden');
            } else {
                btnWdr.className = "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow-md text-red-600 transition-all";
                btnDep.className = "flex-1 py-3 rounded-xl font-bold text-sm text-gray-500 hover:text-indigo-600 transition-all";
                btnSubmit.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2";
                btnSubmit.innerHTML = '<i class="fas fa-arrow-up"></i> ยืนยันการถอนเงิน';
                feeInfo.classList.remove('hidden');
                depositInfo.classList.add('hidden');
            }
            calcFee();
        }

        window.calcFee = () => {
            const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
            if(txnType === 'withdraw') {
                const fee = amount * 0.05;
                document.getElementById('txtFee').textContent = fee.toLocaleString();
                document.getElementById('txtNet').textContent = (amount - fee).toLocaleString();
            }
        }

        window.submitTransaction = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('txnAmount').value);
            if(amount <= 0) return Swal.fire('ข้อมูลไม่ถูกต้อง', 'กรุณาระบุจำนวนเงิน', 'warning');
            if(txnType === 'withdraw' && amount > userData.balance) return Swal.fire('ยอดเงินไม่พอ', 'กรุณาตรวจสอบยอดเงินคงเหลือ', 'error');

            let fee = txnType === 'withdraw' ? amount * 0.05 : 0;

            try {
                // Show loading
                Swal.fire({title: 'กำลังดำเนินการ...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
                
                await addDoc(collection(db, "transactions"), {
                    uid: currentUser.uid,
                    email: userData.email,
                    userDisplayName: userData.displayName,
                    type: txnType,
                    amount: amount,
                    fee: fee,
                    netAmount: amount - fee,
                    status: 'pending',
                    timestamp: new Date()
                });
                
                Swal.fire('ส่งคำขอสำเร็จ', 'กรุณารอแอดมินอนุมัติรายการ', 'success');
                document.getElementById('txnAmount').value = "";
                calcFee();
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        }

        function loadHistory() {
            const q = query(collection(db, "transactions"), where("uid", "==", currentUser.uid), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = "";
                if(snapshot.empty) {
                    document.getElementById('noHistory').classList.remove('hidden');
                } else {
                    document.getElementById('noHistory').classList.add('hidden');
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const isDep = t.type === 'deposit';
                        
                        let badgeColor = '';
                        let statusText = '';
                        let statusIcon = '';

                        if(t.status === 'pending') {
                            badgeColor = 'bg-yellow-100 text-yellow-700 border-yellow-200';
                            statusText = 'รออนุมัติ';
                            statusIcon = 'fa-clock';
                        } else if(t.status === 'completed') {
                            badgeColor = 'bg-green-100 text-green-700 border-green-200';
                            statusText = 'สำเร็จ';
                            statusIcon = 'fa-check';
                        } else {
                            badgeColor = 'bg-red-100 text-red-700 border-red-200';
                            statusText = 'ปฏิเสธ';
                            statusIcon = 'fa-times';
                        }

                        const tr = `
                            <tr class="hover:bg-slate-50 transition group">
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isDep ? 'bg-indigo-100 text-indigo-600' : 'bg-red-100 text-red-600'}">
                                            <i class="fas ${isDep ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-gray-800">${isDep ? 'ฝากเงิน' : 'ถอนเงิน'}</p>
                                            <p class="text-xs text-gray-400">Transaction ID: ...${doc.id.slice(-4)}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-gray-500 text-xs">
                                    <div>${new Date(t.timestamp.seconds*1000).toLocaleDateString('th-TH')}</div>
                                    <div>${new Date(t.timestamp.seconds*1000).toLocaleTimeString('th-TH')}</div>
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <span class="font-bold text-lg ${isDep ? 'text-green-600' : 'text-red-600'}">
                                        ${isDep ? '+' : '-'}${t.amount.toLocaleString()}
                                    </span>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeColor} inline-flex items-center gap-1">
                                        <i class="fas ${statusIcon}"></i> ${statusText}
                                    </span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    });
                }
            });
        }

        function loadNews() {
            const q = query(collection(db, "announcements"), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snaps) => {
                if(!snaps.empty) {
                    const news = snaps.docs[0].data();
                    document.getElementById('newsBox').classList.remove('hidden');
                    document.getElementById('newsTitle').textContent = news.title;
                    document.getElementById('newsContent').textContent = news.content;
                }
            });
        }
    </script>
</body>
</html>
